<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GMYZGXFPCE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GMYZGXFPCE');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Mobility Intelligence | Better Call Immigration</title>
    <meta name="description" content="AI-Powered Career Assessment for Global Migration">

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    
    <!-- ICONS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lenis@1.0.45/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>

    <!-- TAILWIND CONFIG -->
    <script>
        console.warn = function() {}; 

        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Plus Jakarta Sans', 'Outfit', 'Noto Sans', 'sans-serif'],
                            barcode: ['"Libre Barcode 39 Text"', 'cursive'],
                        },
                        colors: {
                            'brand-dark': '#ffffff',
                            'brand-primary': '#2563eb', 
                            'brand-secondary': '#7c3aed',
                            'brand-accent': '#f43f5e', 
                            'brand-gold': '#d97706',
                        },
                        animation: {
                            'blob': 'blob 20s infinite alternate',
                            'slide-up-fade': 'slideUpFade 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                            'pop-in': 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                        },
                        keyframes: {
                            blob: {
                                '0%': { transform: 'translate(0, 0) scale(1)' },
                                '33%': { transform: 'translate(50px, -50px) scale(1.1)' },
                                '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                                '100%': { transform: 'translate(0, 0) scale(1)' },
                            },
                            slideUpFade: {
                                '0%': { transform: 'translateY(20px)', opacity: '0' },
                                '100%': { transform: 'translateY(0)', opacity: '1' }
                            },
                            popIn: {
                                '0%': { transform: 'scale(0.9)', opacity: '0' },
                                '100%': { transform: 'scale(1)', opacity: '1' }
                            }
                        }
                    }
                }
            };
        }
    </script>

    <style>
        :root { --glass-border: 1px solid rgba(255, 255, 255, 0.25); }
        body {
            background-color: #f0f9ff;
            background: radial-gradient(ellipse at 60% 40%, rgba(255, 255, 255, 0.8) 0%, transparent 60%),
                        radial-gradient(circle at 0% 0%, rgba(186, 230, 253, 0.8) 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, rgba(232, 121, 249, 0.4) 0%, transparent 50%),
                        linear-gradient(135deg, #e0f2fe 0%, #eef2ff 50%, #fce7f3 100%);
            background-attachment: fixed;
            background-size: cover;
            color: #1e293b;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        html.lenis { height: auto; }
        .lenis.lenis-smooth { scroll-behavior: auto !important; }
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(40px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            position: relative;
        }
        
        .form-input, .date-input-container, .geo-input {
            height: 3rem; 
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: #1e293b;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border-radius: 0.75rem;
            width: 100%;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
        }
        @media (min-width: 768px) {
            .form-input, .date-input-container, .geo-input {
                height: 3.5rem;
                font-size: 1.125rem;
            }
        }
        .form-input:focus, .geo-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        
        .orb { position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; animation: blob 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.6; mix-blend-mode: multiply; }
        .orb-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: #bae6fd; }
        .orb-2 { bottom: -20%; right: -10%; width: 70vw; height: 70vw; background: #e879f9; animation-delay: -5s; opacity: 0.4; }
        .orb-3 { top: 30%; right: 20%; width: 40vw; height: 40vw; background: #c4b5fd; animation-delay: -10s; opacity: 0.5; }

        .date-input-container { display: flex; align-items: center; overflow: hidden; padding: 0; }
        .date-icon-box { padding: 0 1rem; color: #7c3aed; background: rgba(245, 243, 255, 0.5); height: 100%; display: flex; align-items: center; border-right: 1px solid rgba(237, 233, 254, 0.6); }
        .date-input-container input { background: transparent; border: none; color: #1e293b; width: 100%; padding: 0 1rem; height: 100%; outline: none; font-weight: 600; font-size: 0.95rem; }
        @media (min-width: 768px) { .date-input-container input { font-size: 1.125rem; } .date-icon-box { padding: 0 1.25rem; } }

        .flatpickr-calendar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            font-family: 'Plus Jakarta Sans', sans-serif;
            padding: 1rem;
        }
        .flatpickr-day.selected {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            border-color: transparent;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            color: white;
        }
        
        /* FIX: FORCE YEAR VISIBILITY IN FLATPICKR */
        .flatpickr-months .flatpickr-month {
            height: 50px; /* Ensure header has height */
            background: transparent;
            color: #1e293b;
            fill: #1e293b;
            overflow: visible; /* Prevent clipping */
        }
        .flatpickr-current-month {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 10px;
            font-size: 110%;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            appearance: none;
            background: transparent;
            border: none;
            border-radius: 0;
            box-sizing: border-box;
            color: inherit;
            cursor: pointer;
            font-size: inherit;
            font-family: inherit;
            font-weight: bold;
            height: auto;
            line-height: inherit;
            margin: 0;
            outline: none;
            padding: 0 0 0 .5ch;
            position: relative;
            vertical-align: initial;
            width: auto;
            color: #1e293b !important; /* Explicit color */
        }
        .flatpickr-current-month .numInputWrapper {
            width: 7ch !important;
            display: inline-block;
        }
        .flatpickr-current-month input.cur-year {
            background: transparent;
            box-sizing: border-box;
            color: #1e293b !important; /* Force dark color */
            cursor: text;
            padding: 0 0 0 .5ch;
            margin: 0;
            display: inline-block;
            font-size: inherit;
            font-family: inherit;
            font-weight: 800 !important; /* Bold year */
            line-height: inherit;
            height: auto;
            border: 0;
            border-radius: 0;
            vertical-align: initial;
            appearance: textfield;
        }
        
        /* FIX: RESTORE ARROWS FOR EASIER YEAR NAVIGATION */
        .flatpickr-current-month .numInputWrapper span.arrowUp,
        .flatpickr-current-month .numInputWrapper span.arrowDown {
            display: block !important;
            opacity: 0.4;
            cursor: pointer;
            border: none;
        }
        .flatpickr-current-month .numInputWrapper:hover span.arrowUp,
        .flatpickr-current-month .numInputWrapper:hover span.arrowDown {
            opacity: 1;
        }
        .flatpickr-current-month .numInputWrapper span.arrowUp::after {
            border-bottom-color: #1e293b; /* Dark arrows */
            top: 30%;
        }
        .flatpickr-current-month .numInputWrapper span.arrowDown::after {
            border-top-color: #1e293b; /* Dark arrows */
        }

        .uppercase-input { text-transform: uppercase; }
        .valid-field { border-color: #10b981 !important; background-color: rgba(236, 253, 245, 0.8) !important; }
        .invalid-field { border-color: #f43f5e !important; background-color: rgba(255, 241, 242, 0.8) !important; }
        
        .category-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); }
        .category-card:hover { transform: translateY(-4px); background: rgba(255, 255, 255, 0.9); border-color: #2563eb; }
        .category-card.active { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border-color: #2563eb; box-shadow: 0 10px 30px -5px rgba(37, 99, 235, 0.15); position: relative; }
        
        .btn-gradient { background-size: 200% auto; background-image: linear-gradient(to right, #2563eb 0%, #7c3aed 51%, #2563eb 100%); transition: 0.5s; }
        .btn-gradient:hover { background-position: right center; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .country-pill {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }
        .country-pill:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.1); }
        
        /* UPDATED: High Contrast Selection State */
        .country-pill.selected { 
            transform: scale(1.05); 
            box-shadow: 0 0 0 4px #2563eb, 0 12px 25px -5px rgba(37, 99, 235, 0.4); /* Thicker Ring */
            background-color: #eff6ff; /* Light Blue BG */
            border-color: #2563eb; 
            font-weight: 900;
            color: #1e3a8a; /* Dark Blue Text */
            z-index: 10; 
        }
        .country-pill .check-icon { transform: scale(0) rotate(-45deg); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .country-pill.selected .check-icon { transform: scale(1) rotate(0deg); }

        .time-slot.selected {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }
    </style>
</head>
<body class="antialiased selection:bg-pink-500 selection:text-white relative">

    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <nav class="fixed top-0 md:top-4 left-0 right-0 z-50 flex justify-center px-0 md:px-4" id="navbar-container">
        <div class="glass-card !rounded-none md:!rounded-[2rem] !border-t-0 w-full max-w-7xl px-4 py-3 md:px-5 md:py-2 flex justify-between items-center transition-all duration-300 min-h-[60px]" id="navbar">
            <a href="index.html" class="flex items-center gap-2 group px-1">
                <div class="w-9 h-9 md:w-10 md:h-10 rounded-xl flex items-center justify-center bg-white/60 backdrop-blur-md overflow-hidden p-1 flex-shrink-0 border border-white/50">
                    <img src="https://raw.githubusercontent.com/sujeshunni-del/bettercall/6673d6ec4830e402627b97c4adf422593b2ec907/Bettercall%20Logo%20SVG%2003.svg" alt="Better Call Logo" class="w-full h-full object-contain">
                </div>
                <div class="block leading-tight"> 
                    <h1 class="font-bold text-slate-800 text-sm md:text-lg tracking-wide group-hover:text-indigo-600 transition-colors">BETTER CALL</h1>
                    <p class="text-[9px] md:text-xs font-bold text-amber-500 uppercase tracking-[0.2em]">Immigration</p>
                </div>
            </a>
            <div class="hidden lg:flex items-center gap-1">
                <a href="index.html" class="px-4 py-2 text-sm text-slate-600 hover:text-indigo-600 font-bold transition rounded-full hover:bg-white/50">Home</a>
                <a href="assessment.html" class="px-4 py-2 text-sm text-indigo-600 font-bold transition rounded-full bg-white/50 shadow-sm border border-white/60">Free Assessment</a>
            </div>
             <div class="flex items-center gap-2 px-1">
                <button class="group p-2 rounded-full hover:bg-white/50 transition-all duration-300 relative">
                    <i class="fa-solid fa-magnifying-glass text-slate-400 group-hover:text-indigo-600 text-lg md:text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow pt-24 md:pt-32 pb-12 px-2 md:px-4 relative z-20">
        <div class="max-w-6xl mx-auto">
            
            <div class="mb-8 md:mb-16 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 md:w-96 h-0.5 bg-white/30"></div>
                <div class="flex items-center justify-center gap-6 md:gap-24 relative z-10">
                    <div id="step-1-indicator" class="flex flex-col items-center gap-1 md:gap-3 transition-all duration-500">
                        <div class="w-8 h-8 md:w-12 md:h-12 rounded-full bg-white/80 backdrop-blur border-2 md:border-4 border-brand-primary shadow-lg flex items-center justify-center text-brand-primary text-xs md:text-lg font-bold">1</div>
                        <span class="font-bold text-[9px] md:text-sm text-brand-primary tracking-widest uppercase">Identity</span>
                    </div>
                    <div id="step-2-indicator" class="flex flex-col items-center gap-1 md:gap-3 transition-all duration-500 opacity-40 grayscale">
                        <div class="w-8 h-8 md:w-12 md:h-12 rounded-full bg-white/40 border-2 md:border-4 border-gray-200 flex items-center justify-center text-gray-500 text-xs md:text-lg font-bold">2</div>
                        <span class="font-bold text-[9px] md:text-sm text-slate-500 tracking-widest uppercase">Analysis</span>
                    </div>
                    <div id="step-3-indicator" class="flex flex-col items-center gap-1 md:gap-3 transition-all duration-500 opacity-40 grayscale">
                        <div class="w-8 h-8 md:w-12 md:h-12 rounded-full bg-white/40 border-2 md:border-4 border-gray-200 flex items-center justify-center text-gray-500 text-xs md:text-lg font-bold">3</div>
                        <span class="font-bold text-[9px] md:text-sm text-slate-500 tracking-widest uppercase">Booking</span>
                    </div>
                </div>
            </div>

            <!-- TAB 1: Personal Details -->
            <div id="tab-1" class="glass-card p-5 md:p-12 animate-slide-up-fade max-w-4xl mx-auto">
                 <div class="mb-6 md:mb-10 text-center">
                    <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-blue-50 to-indigo-50 mb-4 shadow-sm border border-white animate-pulse-slow">
                        <i class="fa-solid fa-earth-americas text-2xl text-brand-primary"></i>
                    </div>
                    <h2 class="text-3xl md:text-5xl font-black text-slate-900 mb-3 tracking-tight">
                        Unlock Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-primary to-brand-secondary">Global Future</span>
                    </h2>
                    <p class="text-slate-500 text-xs md:text-sm tracking-wide font-medium max-w-lg mx-auto leading-relaxed">
                        Your journey to a new horizon begins here. Enter your credentials to initialize the AI compatibility scan.
                    </p>
                </div>

                <form id="personalForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                     <div class="group">
                        <label class="block text-[10px] md:text-xs font-bold text-brand-primary uppercase tracking-widest mb-1.5 md:mb-3 ml-1">First Name (As per Passport)</label>
                        <input type="text" id="firstName" required class="form-input uppercase-input px-4 md:px-5" placeholder="JOHN" oninput="this.value = this.value.toUpperCase(); validateName(this, 'firstNameError')">
                        <p id="firstNameError" class="text-brand-accent text-[10px] hidden mt-1 font-bold animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> Letters and spaces only.</p>
                    </div>
                    <div class="group">
                        <label class="block text-[10px] md:text-xs font-bold text-brand-primary uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Surname (Family Name)</label>
                        <input type="text" id="lastName" required class="form-input uppercase-input px-4 md:px-5" placeholder="DOE" oninput="this.value = this.value.toUpperCase(); validateName(this, 'lastNameError')">
                        <p id="lastNameError" class="text-brand-accent text-[10px] hidden mt-1 font-bold animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> Letters and spaces only.</p>
                    </div>
                    <div class="group">
                        <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Email Address</label>
                        <div class="relative">
                            <input type="email" id="email" required class="form-input pl-10 md:pl-12 font-semibold" placeholder="name@example.com" oninput="validateEmail(this, 'emailError')" onblur="validateEmail(this, 'emailError', true)">
                            <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                        </div>
                        <p id="emailError" class="text-brand-accent text-[10px] hidden mt-1 font-bold animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> Invalid email format.</p>
                    </div>
                    <div>
                        <label class="block text-[10px] md:text-xs font-bold text-brand-secondary uppercase tracking-widest mb-1.5 md:mb-3 ml-1"><i class="fa-regular fa-calendar-days mr-1"></i> Date of Birth</label>
                        <div class="date-input-container rounded-xl h-12 md:h-14">
                            <div class="date-icon-box"><i class="fa-solid fa-cake-candles text-sm"></i></div>
                            <input type="text" id="dob" required placeholder="Select Date" class="font-medium">
                        </div>
                    </div>
                    <div class="group">
                        <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Age</label>
                        <input type="text" id="age" readonly class="form-input w-full rounded-xl px-4 md:px-5 bg-gray-50/50 text-slate-500 cursor-not-allowed font-mono font-bold">
                        <p id="ageError" class="text-brand-accent text-[11px] hidden mt-1 md:mt-2 font-bold flex items-center gap-2 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> Must be 20+ years.</p>
                    </div>

                    <!-- Geography -->
                    <div class="relative group" id="residenceWrapper">
                        <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 md:mb-3 ml-1"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i> Present Residence</label>
                        <input type="hidden" id="presentResidence" onchange="handleResidenceChange()">
                        <button type="button" class="form-input w-full text-left rounded-xl px-4 md:px-5 flex justify-between items-center cursor-pointer bg-white/60 hover:bg-white transition-colors" onclick="toggleCountryDropdown('residence', event)">
                            <span id="residenceDisplay" class="text-slate-500 font-bold uppercase truncate">Select Residence</span>
                            <i class="fa-solid fa-chevron-down text-slate-400 transition-transform duration-300" id="residenceArrow"></i>
                        </button>
                        <div id="residenceList" data-lenis-prevent class="hidden absolute top-full left-0 w-full mt-2 bg-white/95 backdrop-blur-xl border border-white/60 rounded-2xl shadow-xl max-h-60 overflow-y-auto z-[60] custom-scrollbar transform origin-top transition-all duration-300">
                        </div>
                    </div>
                    
                    <div class="relative group" id="nationalityWrapper">
                        <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 md:mb-3 ml-1"><i class="fa-solid fa-earth-americas mr-1 text-slate-400"></i> Nationality</label>
                        <input type="hidden" id="nationality">
                        <button type="button" class="form-input w-full text-left rounded-xl px-4 md:px-5 flex justify-between items-center cursor-pointer bg-white/60 hover:bg-white transition-colors" onclick="toggleCountryDropdown('nationality', event)">
                            <span id="nationalityDisplay" class="text-slate-500 font-bold uppercase truncate">Select Origin</span>
                            <i class="fa-solid fa-chevron-down text-slate-400 transition-transform duration-300" id="nationalityArrow"></i>
                        </button>
                        <div id="nationalityList" data-lenis-prevent class="hidden absolute top-full left-0 w-full mt-2 bg-white/95 backdrop-blur-xl border border-white/60 rounded-2xl shadow-xl max-h-60 overflow-y-auto z-[60] custom-scrollbar transform origin-top transition-all duration-300">
                        </div>
                    </div>

                    <!-- Contact -->
                    <div>
                        <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Mobile Contact</label>
                        <div class="relative group">
                            <input type="tel" id="mobile" required class="form-input w-full rounded-xl px-4 md:px-5 pl-10 md:pl-12 font-mono font-semibold" placeholder="+..." oninput="enforcePhoneInput(this); validatePhone('mobile')">
                            <i class="fa-solid fa-phone absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand-primary transition-colors text-sm"></i>
                            <div id="mobileFeedback" class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold"></div>
                        </div>
                        <p id="mobileHint" class="text-[10px] md:text-xs text-brand-primary mt-1 md:mt-2 pl-1 font-mono font-medium opacity-0 transition-opacity">Format: </p>
                        <p id="mobileError" class="text-brand-accent text-[10px] md:text-[11px] hidden mt-1 font-bold">Invalid Format.</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1.5 md:mb-3">
                            <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest ml-1">WhatsApp</label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="sameAsMobile" class="w-3 h-3 md:w-4 md:h-4 rounded border-gray-300 text-brand-primary focus:ring-brand-primary cursor-pointer">
                                <label for="sameAsMobile" class="text-[9px] md:text-[10px] text-slate-500 cursor-pointer select-none font-bold uppercase tracking-wider">Same as Mobile</label>
                            </div>
                        </div>
                        <div class="relative group">
                            <input type="tel" id="whatsapp" required class="form-input w-full rounded-xl px-4 md:px-5 pl-10 md:pl-12 font-mono font-semibold" placeholder="+..." oninput="enforcePhoneInput(this); validatePhone('whatsapp')">
                            <i class="fa-brands fa-whatsapp absolute left-4 top-1/2 -translate-y-1/2 text-green-500 opacity-60 group-focus-within:opacity-100 transition-opacity text-sm"></i>
                            <div id="waFeedback" class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold"></div>
                        </div>
                        <p id="waHint" class="text-[10px] md:text-xs text-brand-secondary mt-1 md:mt-2 pl-1 font-mono font-medium opacity-0 transition-opacity">Format: </p>
                    </div>

                    <div class="md:col-span-2">
                         <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Alternative Phone (Optional)</label>
                         <div class="relative group">
                            <input type="tel" id="altPhone" class="form-input w-full rounded-xl px-4 md:px-5 pl-10 md:pl-12 font-mono font-semibold" placeholder="+..." oninput="enforcePhoneInput(this); validatePhone('altPhone')">
                            <i class="fa-solid fa-phone-volume absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand-gold transition-colors text-sm"></i>
                            <div id="altPhoneFeedback" class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold"></div>
                        </div>
                    </div>

                    <!-- Qualifications -->
                    <div class="md:col-span-2">
                         <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 md:mb-4 ml-1">Highest Academic Qualification</label>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="qualification" value="UNDER 10 TH" class="peer sr-only" required>
                                    <div class="h-full rounded-2xl border-2 border-slate-200 bg-white p-3 flex flex-col items-center justify-center text-center gap-2 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg peer-checked:border-transparent peer-checked:bg-gradient-to-br peer-checked:from-brand-primary peer-checked:to-brand-secondary peer-checked:text-white peer-checked:shadow-xl peer-checked:shadow-brand-primary/40 peer-checked:scale-105 peer-checked:[&_i]:text-white peer-checked:[&_span]:text-white peer-checked:[&_.indicator-dot]:bg-white relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-br from-transparent to-slate-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <i class="fa-solid fa-school text-2xl text-slate-300 group-hover:text-brand-primary/70 transition-colors relative z-10"></i>
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wide relative z-10">Under 10th</span>
                                        <div class="indicator-dot absolute top-2 right-2 w-2 h-2 rounded-full bg-brand-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="qualification" value="SCHOOL" class="peer sr-only">
                                    <div class="h-full rounded-2xl border-2 border-slate-200 bg-white p-3 flex flex-col items-center justify-center text-center gap-2 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg peer-checked:border-transparent peer-checked:bg-gradient-to-br peer-checked:from-brand-primary peer-checked:to-brand-secondary peer-checked:text-white peer-checked:shadow-xl peer-checked:shadow-brand-primary/40 peer-checked:scale-105 peer-checked:[&_i]:text-white peer-checked:[&_span]:text-white peer-checked:[&_.indicator-dot]:bg-white relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-br from-transparent to-slate-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <i class="fa-solid fa-book-open text-2xl text-slate-300 group-hover:text-brand-primary/70 transition-colors relative z-10"></i>
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wide relative z-10">School</span>
                                        <div class="indicator-dot absolute top-2 right-2 w-2 h-2 rounded-full bg-brand-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="qualification" value="PLUS TWO" class="peer sr-only">
                                    <div class="h-full rounded-2xl border-2 border-slate-200 bg-white p-3 flex flex-col items-center justify-center text-center gap-2 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg peer-checked:border-transparent peer-checked:bg-gradient-to-br peer-checked:from-brand-primary peer-checked:to-brand-secondary peer-checked:text-white peer-checked:shadow-xl peer-checked:shadow-brand-primary/40 peer-checked:scale-105 peer-checked:[&_i]:text-white peer-checked:[&_span]:text-white peer-checked:[&_.indicator-dot]:bg-white relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-br from-transparent to-slate-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <i class="fa-solid fa-graduation-cap text-2xl text-slate-300 group-hover:text-brand-primary/70 transition-colors relative z-10"></i>
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wide relative z-10">Plus Two</span>
                                        <div class="indicator-dot absolute top-2 right-2 w-2 h-2 rounded-full bg-brand-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="qualification" value="DIPLOMA" class="peer sr-only">
                                    <div class="h-full rounded-2xl border-2 border-slate-200 bg-white p-3 flex flex-col items-center justify-center text-center gap-2 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg peer-checked:border-transparent peer-checked:bg-gradient-to-br peer-checked:from-brand-primary peer-checked:to-brand-secondary peer-checked:text-white peer-checked:shadow-xl peer-checked:shadow-brand-primary/40 peer-checked:scale-105 peer-checked:[&_i]:text-white peer-checked:[&_span]:text-white peer-checked:[&_.indicator-dot]:bg-white relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-br from-transparent to-slate-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <i class="fa-solid fa-scroll text-2xl text-slate-300 group-hover:text-brand-primary/70 transition-colors relative z-10"></i>
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wide relative z-10">Diploma</span>
                                        <div class="indicator-dot absolute top-2 right-2 w-2 h-2 rounded-full bg-brand-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="qualification" value="BACHELOR" class="peer sr-only">
                                    <div class="h-full rounded-2xl border-2 border-slate-200 bg-white p-3 flex flex-col items-center justify-center text-center gap-2 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg peer-checked:border-transparent peer-checked:bg-gradient-to-br peer-checked:from-brand-primary peer-checked:to-brand-secondary peer-checked:text-white peer-checked:shadow-xl peer-checked:shadow-brand-primary/40 peer-checked:scale-105 peer-checked:[&_i]:text-white peer-checked:[&_span]:text-white peer-checked:[&_.indicator-dot]:bg-white relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-br from-transparent to-slate-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <i class="fa-solid fa-user-graduate text-2xl text-slate-300 group-hover:text-brand-primary/70 transition-colors relative z-10"></i>
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wide relative z-10">Bachelor</span>
                                        <div class="indicator-dot absolute top-2 right-2 w-2 h-2 rounded-full bg-brand-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="qualification" value="MASTER" class="peer sr-only">
                                    <div class="h-full rounded-2xl border-2 border-slate-200 bg-white p-3 flex flex-col items-center justify-center text-center gap-2 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg peer-checked:border-transparent peer-checked:bg-gradient-to-br peer-checked:from-brand-primary peer-checked:to-brand-secondary peer-checked:text-white peer-checked:shadow-xl peer-checked:shadow-brand-primary/40 peer-checked:scale-105 peer-checked:[&_i]:text-white peer-checked:[&_span]:text-white peer-checked:[&_.indicator-dot]:bg-white relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-br from-transparent to-slate-100 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <i class="fa-solid fa-medal text-2xl text-slate-300 group-hover:text-brand-primary/70 transition-colors relative z-10"></i>
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wide relative z-10">Master</span>
                                        <div class="indicator-dot absolute top-2 right-2 w-2 h-2 rounded-full bg-brand-primary opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                    </div>
                                </label>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2 p-4 md:p-6 rounded-2xl border border-indigo-100 bg-gradient-to-br from-indigo-50/30 to-white/50">
                         <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-passport text-brand-secondary text-lg"></i>
                            <span class="text-[10px] md:text-xs font-bold text-brand-secondary uppercase tracking-widest">Travel Document Details</span>
                            <div class="h-px bg-indigo-100 flex-grow ml-2"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 ml-1">Passport No. (Optional)</label>
                                <input type="text" id="passportNo" class="form-input uppercase-input w-full rounded-xl px-4 md:px-5 font-mono font-medium bg-white/60 focus:bg-white" placeholder="X1234567" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div>
                                <label class="block text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5 ml-1">Passport Expiry</label>
                                <div class="date-input-container rounded-xl h-12 md:h-14 bg-white/60 focus-within:bg-white">
                                    <div class="date-icon-box"><i class="fa-solid fa-hourglass-half text-sm"></i></div>
                                    <input type="text" id="passportExp" placeholder="Select Date" class="font-medium">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 mt-2 md:mt-4 bg-gradient-to-br from-white/60 to-blue-50/30 rounded-2xl border border-blue-100/50 p-4 md:p-6 shadow-sm relative overflow-hidden backdrop-blur-sm">
                         <div class="absolute top-0 right-0 -mt-10 -mr-10 w-32 h-32 bg-brand-primary/10 rounded-full blur-2xl pointer-events-none"></div>
                        <label class="block text-xs md:text-sm font-bold text-slate-700 mb-3 md:mb-4 flex items-center gap-2"><i class="fa-solid fa-file-circle-question text-brand-primary"></i> Accelerate Your Assessment: Attach Professional Portfolio</label>
                        <div class="flex gap-4 md:gap-6 mb-4 relative z-10">
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="hasCv" value="yes" class="peer sr-only" onchange="toggleCvUpload(true)" checked>
                                <div class="px-4 py-1.5 md:px-6 md:py-2 rounded-full border border-gray-200 bg-white/80 text-slate-500 text-xs md:text-sm font-bold peer-checked:bg-brand-primary peer-checked:text-white peer-checked:border-brand-primary peer-checked:shadow-lg transition-all shadow-sm group-hover:border-brand-primary/40">Yes</div>
                            </label>
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="hasCv" value="no" class="peer sr-only" onchange="toggleCvUpload(false)">
                                <div class="px-4 py-1.5 md:px-6 md:py-2 rounded-full border border-gray-200 bg-white/80 text-slate-500 text-xs md:text-sm font-bold peer-checked:bg-brand-secondary peer-checked:text-white peer-checked:border-brand-secondary peer-checked:shadow-lg transition-all shadow-sm group-hover:border-brand-secondary/40">No</div>
                            </label>
                        </div>
                        <div id="cvUploadContainer" class="animate-pop-in relative z-10">
                            <div class="rounded-xl border-2 border-dashed border-slate-300 hover:border-brand-primary hover:bg-blue-50/50 p-4 md:p-8 text-center cursor-pointer relative group transition-all">
                                <input type="file" id="cvFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept=".pdf,.doc,.docx" onchange="handleFileSelect(this)">
                                <div class="transition-transform duration-300 group-hover:-translate-y-1">
                                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-white text-brand-primary shadow-md flex items-center justify-center mx-auto mb-2 md:mb-3 text-lg md:text-xl group-hover:text-white group-hover:bg-brand-primary transition-colors">
                                        <i class="fa-solid fa-cloud-arrow-up"></i>
                                    </div>
                                    <p class="text-xs md:text-sm font-bold text-slate-700" id="fileNameDisplay">Upload Curriculum Vitae (PDF/DOC)</p>
                                    <p class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">PDF, DOC, DOCX (Max 5MB)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 mt-4 md:mt-8 flex justify-end">
                        <button type="button" onclick="goToStep2()" id="nextBtn" class="w-full md:w-auto btn-gradient text-white font-bold py-3 md:py-4 px-12 rounded-xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 flex items-center justify-center gap-3">
                            <span class="tracking-wider text-xs md:text-base">PROCEED TO EVALUATION</span>
                            <i class="fa-solid fa-arrow-right-long"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- TAB 2: AI Job Report -->
            <div id="tab-2" class="hidden animate-slide-up-fade">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6 md:mb-10 max-w-4xl mx-auto">
                    <div id="cardUnskilled" onclick="setSkillMode('Unskilled')" class="category-card rounded-2xl md:rounded-3xl p-4 md:p-8 flex items-center gap-4 md:gap-6 cursor-pointer relative overflow-hidden">
                        <div class="w-12 h-12 md:w-16 md:h-16 rounded-xl md:rounded-2xl bg-blue-50 text-brand-primary flex items-center justify-center text-2xl md:text-3xl shadow-sm"><i class="fa-solid fa-hands-holding-circle"></i></div>
                        <div class="z-10"><h3 class="text-base md:text-xl font-bold text-slate-800 mb-1">Unskilled - Non Experience</h3><p class="text-[10px] md:text-xs text-slate-500 tracking-wide font-medium">Industrial, Logistics, Agritech</p></div>
                        <div class="ml-auto z-10"><div class="w-6 h-6 md:w-8 md:h-8 rounded-full border-2 border-gray-300 flex items-center justify-center transition-all" id="checkUnskilled"><div class="w-3 h-3 md:w-4 md:h-4 rounded-full bg-brand-primary hidden shadow-lg"></div></div></div>
                    </div>
                    <div id="cardSkilled" onclick="setSkillMode('Skilled')" class="category-card rounded-2xl md:rounded-3xl p-4 md:p-8 flex items-center gap-4 md:gap-6 cursor-pointer relative overflow-hidden">
                        <div class="w-12 h-12 md:w-16 md:h-16 rounded-xl md:rounded-2xl bg-purple-50 text-brand-secondary flex items-center justify-center text-2xl md:text-3xl shadow-sm"><i class="fa-solid fa-user-tie"></i></div>
                        <div class="z-10"><h3 class="text-base md:text-xl font-bold text-slate-800 mb-1">Skilled - Experience</h3><p class="text-[10px] md:text-xs text-slate-500 tracking-wide font-medium">Engineering, Healthcare, Skilled Trades</p></div>
                        <div class="ml-auto z-10"><div class="w-6 h-6 md:w-8 md:h-8 rounded-full border-2 border-gray-300 flex items-center justify-center transition-all" id="checkSkilled"><div class="w-3 h-3 md:w-4 md:h-4 rounded-full bg-brand-secondary hidden shadow-lg"></div></div></div>
                    </div>
                </div>

                <div id="jobDetailsPanel" class="glass-card p-5 md:p-8 mb-8 md:mb-12 hidden animate-pop-in relative z-20 max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 items-end">
                        <div class="relative group" id="customJobSelect">
                            <label class="block text-[10px] md:text-xs font-bold text-brand-primary uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Target Position</label>
                            <button type="button" class="form-input w-full text-left rounded-xl px-4 md:px-5 py-2 md:py-4 flex justify-between items-center cursor-pointer h-12 md:h-auto" onclick="toggleJobDropdown(event)">
                                <span id="selectedJobText" class="text-slate-500 font-medium text-sm md:text-base">Select Job Role</span>
                                <i class="fa-solid fa-chevron-down transition-transform duration-300 text-brand-primary" id="jobDropdownIcon"></i>
                            </button>
                            <input type="hidden" id="currentJob">
                            <input type="hidden" id="hiddenPrimaryMatch">
                            <input type="hidden" id="hiddenAltMatches">
                            
                            <div id="jobDropdownList" data-lenis-prevent class="hidden absolute top-full left-0 w-full mt-2 bg-white/90 backdrop-blur-xl border border-white/60 rounded-2xl shadow-xl max-h-60 md:max-h-80 overflow-y-auto z-[60] custom-scrollbar transform origin-top transition-all duration-300">
                            </div>
                        </div>

                        <div id="experienceWrapper" class="hidden animate-pop-in">
                            <label class="block text-[10px] md:text-xs font-bold text-brand-secondary uppercase tracking-widest mb-1.5 md:mb-3 ml-1">Years of Experience</label>
                            <div class="relative">
                                <select id="experience" class="form-input w-full rounded-xl px-4 md:px-5 py-2 md:py-4 font-bold text-lg h-12 md:h-auto appearance-none cursor-pointer bg-white/60 focus:bg-white transition-colors text-slate-700 shadow-sm">
                                </select>
                                <div class="absolute right-5 top-1/2 -translate-y-1/2 flex items-center gap-2 pointer-events-none">
                                    <span class="text-[10px] md:text-xs font-black tracking-widest">YEARS</span>
                                    <i class="fa-solid fa-chevron-down text-brand-secondary text-xs"></i>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2 flex justify-end mt-2 md:mt-4">
                             <button type="button" onclick="generateReport()" class="w-full md:w-auto btn-gradient text-white font-bold py-3 md:py-4 px-10 rounded-xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 flex items-center justify-center gap-3 group">
                                <i class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition-transform"></i> 
                                <span class="text-xs md:text-base">CALCULATE MIGRATION PATHWAYS</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="reportContainer" class="hidden max-w-5xl mx-auto">
                     <div class="glass-card p-1 rounded-3xl animate-slide-up-fade">
                        <div class="bg-white/80 backdrop-blur-xl rounded-[22px] p-5 md:p-12 relative overflow-hidden shadow-sm">
                             <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-primary to-brand-secondary"></div>
                             <div class="flex flex-col md:flex-row justify-between items-start md:items-end border-b border-gray-100 pb-4 md:pb-8 mb-4 md:mb-8 gap-4 md:gap-6">
                                <div>
                                    <div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded bg-blue-50 text-brand-primary flex items-center justify-center"><i class="fa-solid fa-layer-group"></i></div><span class="text-[9px] md:text-xs font-bold text-slate-400 tracking-widest uppercase">Global Mobility Intelligence Unit</span></div>
                                    <h2 class="text-2xl md:text-4xl font-black text-slate-900 tracking-tight">Strategic Viability Audit</h2>
                                    <p class="text-xs md:text-sm text-slate-500 font-medium mt-1">Algorithmic Match Analysis & Country Compatibility</p>
                                </div>
                                <div class="text-left md:text-right hidden md:block">
                                    <div class="font-barcode text-4xl text-slate-300 mb-1" id="barcodeRef"></div>
                                    <div class="text-xs font-mono text-slate-400">REF: <span id="refId" class="text-slate-600 font-bold"></span></div>
                                    <div class="text-xs font-mono text-slate-400">DATE: <span id="reportDate"></span></div>
                                </div>
                             </div>
                             
                             <div class="bg-slate-50/50 rounded-2xl p-4 md:p-6 mb-6 md:mb-10 border border-gray-100">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 items-start">
                                    <div class="md:col-span-2 flex justify-center md:justify-start"><div class="w-16 h-16 md:w-20 md:h-20 rounded-2xl bg-white shadow-sm border border-gray-100 flex items-center justify-center text-2xl md:text-3xl font-bold text-brand-primary" id="avatarInitial"></div></div>
                                    <div class="md:col-span-10 grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                                        <div class="overflow-hidden"><p class="text-[9px] md:text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Candidate</p><h3 class="text-sm md:text-lg font-bold text-slate-900 leading-tight break-words" id="reportName"></h3></div>
                                        <div class="overflow-hidden"><p class="text-[9px] md:text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Job Role</p><div class="text-xs md:text-sm font-semibold text-brand-primary leading-tight break-words" id="reportRole"></div></div>
                                        <div class="overflow-hidden"><p class="text-[9px] md:text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Qualification</p><div class="text-xs md:text-sm font-semibold text-slate-700 leading-tight break-words" id="reportQualification"></div></div>
                                         <div class="overflow-hidden"><p class="text-[9px] md:text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Experience</p><div class="text-xs md:text-sm font-bold text-slate-900" id="reportExp"></div></div>
                                    </div>
                                </div>
                             </div>

                             <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
                                <div class="lg:col-span-8 flex flex-col h-full">
                                    <div class="h-full rounded-3xl border border-gray-200 bg-white/60 shadow-sm p-1 relative overflow-hidden group hover:shadow-md transition-shadow">
                                        <div class="absolute top-0 right-0 w-48 h-48 bg-brand-primary/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                                        
                                        <div class="p-6 md:p-8 relative z-10 flex flex-col h-full">
                                            <div class="flex items-start justify-between mb-6">
                                                <div>
                                                    <span class="inline-flex items-center gap-2 bg-green-50 text-green-700 border border-green-200 text-[10px] font-bold px-3 py-1.5 rounded-full uppercase tracking-wider mb-3">
                                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Prime Pathway
                                                    </span>
                                                    <h2 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tight leading-none" id="topMatchCountry"></h2>
                                                </div>
                                                <i class="fa-solid fa-medal text-brand-gold text-3xl drop-shadow-sm"></i>
                                            </div>

                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                                <div class="bg-slate-50/80 rounded-2xl p-4 border border-slate-100 hover:border-brand-primary/20 transition-colors">
                                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Target Role</p>
                                                    <div class="flex items-center gap-2 text-slate-700 font-bold text-sm">
                                                        <i class="fa-solid fa-briefcase text-brand-primary"></i> <span id="topMatchRole_2"></span>
                                                    </div>
                                                </div>
                                                <div class="bg-slate-50/80 rounded-2xl p-4 border border-slate-100 hover:border-brand-primary/20 transition-colors">
                                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Est. Salary</p>
                                                    <div class="flex items-center gap-2 text-slate-700 font-bold text-sm">
                                                        <i class="fa-solid fa-wallet text-brand-secondary"></i> <span id="mainSalaryRange"></span>
                                                    </div>
                                                </div>
                                                <div class="bg-slate-50/80 rounded-2xl p-4 border border-slate-100 hover:border-brand-primary/20 transition-colors">
                                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Visa Category</p>
                                                    <div class="flex items-center gap-2 text-slate-700 font-bold text-sm">
                                                        <i class="fa-solid fa-passport text-blue-400"></i> Work Permit (D-Type)
                                                    </div>
                                                </div>
                                                <div class="bg-slate-50/80 rounded-2xl p-4 border border-slate-100 hover:border-brand-primary/20 transition-colors">
                                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Timeline</p>
                                                    <div class="flex items-center gap-2 text-slate-700 font-bold text-sm">
                                                        <i class="fa-solid fa-clock text-orange-400"></i> 3-5 Months
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="bg-gradient-to-r from-slate-50 to-white rounded-2xl p-5 border border-slate-100 mb-6 shadow-inner">
                                                <div class="flex justify-between items-end mb-3">
                                                    <div class="flex flex-col">
                                                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wide">Compatibility Score</span>
                                                        <span class="text-[10px] text-slate-400">Based on age, skills & market demand</span>
                                                    </div>
                                                    <span class="text-3xl font-black text-brand-primary tracking-tighter">98%</span>
                                                </div>
                                                <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                                                    <div class="h-full bg-gradient-to-r from-brand-primary via-blue-500 to-brand-secondary w-[98%] rounded-full shadow-[0_0_15px_rgba(37,99,235,0.4)] relative">
                                                        <div class="absolute inset-0 bg-white/20 animate-[pulse_2s_infinite]"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-auto">
                                                <h4 class="text-xs font-bold text-slate-800 uppercase tracking-widest mb-2 flex items-center gap-2">
                                                    <i class="fa-solid fa-robot text-brand-secondary"></i> AI Analysis
                                                </h4>
                                                <div class="prose prose-sm max-w-none text-slate-500 text-xs md:text-sm leading-relaxed bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                                                    <p id="aiReasoning" class="italic m-0">AI Reasoning loading...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="lg:col-span-4 flex flex-col gap-5">
                                    <div class="glass-card !rounded-[2rem] p-1.5 shadow-xl transition-all hover:scale-[1.01] duration-300 group order-1">
                                        <div class="relative rounded-[1.7rem] bg-gradient-to-br from-white/90 via-purple-50/90 to-indigo-100/90 p-6 text-slate-800 overflow-hidden border border-white/50">
                                            <div class="absolute top-0 right-0 w-40 h-40 bg-brand-secondary/10 rounded-full blur-[50px] -mr-10 -mt-10 animate-pulse-slow"></div>
                                            <div class="absolute bottom-0 left-0 w-32 h-32 bg-brand-primary/10 rounded-full blur-[40px] -ml-5 -mb-5"></div>
                                            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 mix-blend-overlay"></div>

                                            <div class="relative z-10 flex flex-col items-center text-center">
                                                <div class="relative mb-4 group-hover:scale-105 transition-transform duration-500">
                                                    <div class="absolute inset-0 bg-gradient-to-tr from-brand-secondary via-indigo-500 to-blue-500 rounded-full blur opacity-50 group-hover:opacity-100 transition-opacity"></div>
                                                    <div class="relative w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-brand-secondary via-indigo-500 to-blue-500">
                                                        <div class="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden border-2 border-slate-100">
                                                            <div class="relative top-1">
                                                                <i class="fa-solid fa-user text-4xl text-slate-400 absolute left-1/2 -translate-x-1/2 top-1"></i>
                                                                <i class="fa-solid fa-headset text-3xl text-brand-secondary relative z-10 drop-shadow-[0_2px_10px_rgba(124,58,237,0.3)]"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="absolute bottom-1 right-1 w-5 h-5 bg-[#10b981] border-[3px] border-white rounded-full flex items-center justify-center">
                                                        <div class="w-1.5 h-1.5 bg-white rounded-full animate-ping"></div>
                                                    </div>
                                                </div>

                                                <div class="mb-5">
                                                    <h4 class="text-xl font-black tracking-tight mb-1 text-slate-900">Expert Advisor</h4>
                                                    <p class="text-[10px] uppercase tracking-widest text-brand-secondary font-bold mb-3">Connect</p>
                                                    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/50 border border-slate-200 backdrop-blur-md">
                                                        <i class="fa-solid fa-earth-americas text-xs text-brand-primary"></i>
                                                        <span class="text-[10px] font-medium text-slate-600/90">Multi-Lingual Support</span>
                                                    </div>
                                                </div>

                                                <div class="flex flex-wrap justify-center gap-1.5 mb-6 opacity-90 max-w-[280px]">
                                                    <span class="text-[9px] font-bold px-2 py-1 rounded bg-slate-100/50 border border-slate-200 text-slate-600">English</span>
                                                    <span class="text-[9px] font-bold px-2 py-1 rounded bg-slate-100/50 border border-slate-200 text-slate-600 font-['Noto_Sans_Malayalam']"></span>
                                                    <span class="text-[9px] font-bold px-2 py-1 rounded bg-slate-100/50 border border-slate-200 text-slate-600 font-['Noto_Sans']"></span>
                                                    <span class="text-[9px] font-bold px-2 py-1 rounded bg-slate-100/50 border border-slate-200 text-slate-600 font-['Noto_Sans_Tamil']"></span>
                                                </div>

                                                <div class="w-full mt-2">
                                                    <button id="mainActionBtn" onclick="goToStep3()" class="group/btn relative w-full overflow-hidden rounded-xl bg-brand-secondary p-[1px] shadow-lg shadow-brand-secondary/40 transition-all duration-300 hover:shadow-brand-secondary/60 hover:-translate-y-0.5 active:scale-95">
                                                        <div class="relative flex items-center justify-center gap-3 rounded-[11px] bg-gradient-to-r from-brand-secondary to-indigo-600 py-4 px-4 transition-all duration-300 group-hover/btn:brightness-110">
                                                            <div class="absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.3)_50%,transparent_75%)] bg-[length:250%_250%,100%_100%] bg-[position:-100%_0,0_0] bg-no-repeat transition-[background-position_0s] duration-0 group-hover/btn:bg-[position:200%_0,0_0] group-hover/btn:duration-[1500ms]"></div>
                                                            <span class="font-black tracking-widest text-xs uppercase text-white relative z-10">Start Free Consultation</span>
                                                            <div class="flex items-center justify-center w-6 h-6 rounded-full bg-white/20 text-white group-hover/btn:bg-white group-hover/btn:text-brand-secondary transition-all relative z-10 border border-white/30 group-hover/btn:border-white backdrop-blur-sm">
                                                                <i class="fa-solid fa-arrow-right text-[10px] group-hover/btn:-rotate-45 transition-transform duration-300"></i>
                                                            </div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: BOOKING -->
            <div id="tab-3" class="hidden animate-slide-up-fade max-w-7xl mx-auto">
                <div class="glass-card p-5 md:p-10">
                    <div class="mb-6 md:mb-8 text-center border-b border-gray-200 pb-6">
                        <h2 class="text-2xl md:text-3xl font-black text-slate-900 mb-2 tracking-tight">Finalize Appointment</h2>
                        <p class="text-slate-500 text-xs md:text-sm tracking-wide font-medium">Select your advisor and preferred slot to lock in your strategy session.</p>
                    </div>

                    <!-- 1. COUNTRY SELECTOR (Consolidated Box) -->
                    <div class="mb-8 md:mb-10">
                        <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center justify-center md:justify-start">
                            <span class="w-5 h-5 rounded-full bg-brand-primary text-white inline-flex items-center justify-center mr-2">1</span> Select Target Destination
                        </h3>
                        
                        <!-- SINGLE BOX CONTAINER -->
                        <div class="rounded-3xl bg-white border border-slate-200 shadow-sm relative overflow-hidden">
                            <!-- Background Elements -->
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-brand-primary/5 rounded-full blur-xl"></div>
                            
                            <div class="p-5 md:p-6">
                                <!-- Schengen Section -->
                                <h4 class="text-[10px] font-black text-brand-primary uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span class="text-lg"></span> Schengen Zone
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 md:gap-3" id="schengenContainer">
                                    <!-- Schengen Countries injected here -->
                                </div>

                                <!-- DIVIDER LINE -->
                                <div class="w-full h-px bg-slate-100 my-6 md:my-8 relative">
                                    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-3 text-[9px] font-bold text-slate-300 uppercase tracking-widest">
                                        Or
                                    </div>
                                </div>

                                <!-- Non-Schengen Section -->
                                <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-globe text-slate-400"></i> Non-Schengen
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 md:gap-3" id="nonSchengenContainer">
                                    <!-- Non-Schengen Countries injected here -->
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="targetCountry" required>
                        <p id="countryError" class="text-center text-brand-accent text-[11px] hidden mt-2 font-bold flex items-center justify-center gap-2 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> Please select a destination.</p>
                    </div>

                    <!-- 2. ADVISOR SELECTION -->
                    <div class="mb-8 md:mb-10">
                        <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center justify-center md:justify-start">
                            <span class="w-5 h-5 rounded-full bg-brand-primary text-white inline-flex items-center justify-center mr-2">2</span> Select Immigration Advisor
                        </h3>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="advisorGrid">
                            <!-- Professional Advisors injected via JS -->
                        </div>
                        <input type="hidden" id="selectedAdvisor">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">
                        
                        <!-- LEFT COLUMN: Consultation Method (Span 3 on LG, 4 on MD) -->
                        <div class="md:col-span-4 lg:col-span-3 flex flex-col gap-6">
                            
                            <!-- 3. Consultation Mode -->
                            <div>
                                <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-4"><span class="w-5 h-5 rounded-full bg-brand-secondary text-white inline-flex items-center justify-center mr-2">3</span> Consultation Mode</h3>
                                <div class="grid grid-cols-1 gap-3"> <!-- Vertical Stack for this narrow column -->
                                    <div class="method-card p-4 rounded-2xl bg-white border border-slate-200 flex items-center gap-4 group hover:border-brand-primary hover:shadow-md transition-all cursor-pointer" onclick="selectMethod('In-Person', this)">
                                        <!-- ADDED CLASS: icon-wrapper -->
                                        <div class="icon-wrapper w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-slate-400 group-hover:text-brand-primary group-hover:scale-110 transition-all shrink-0">
                                            <i class="fa-solid fa-building text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <!-- ADDED CLASS: label-text -->
                                            <span class="label-text block text-xs font-bold text-slate-700">In-Office</span>
                                            <span class="block text-[10px] text-slate-400 font-medium">Face to face</span>
                                        </div>
                                    </div>
                                    <div class="method-card p-4 rounded-2xl bg-white border border-slate-200 flex items-center gap-4 group hover:border-brand-primary hover:shadow-md transition-all cursor-pointer" onclick="selectMethod('Video Call', this)">
                                        <!-- ADDED CLASS: icon-wrapper -->
                                        <div class="icon-wrapper w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-slate-400 group-hover:text-purple-600 group-hover:scale-110 transition-all shrink-0">
                                            <i class="fa-solid fa-video text-sm"></i>
                                        </div>
                                        <div class="text-left">
                                            <!-- ADDED CLASS: label-text -->
                                            <span class="label-text block text-xs font-bold text-slate-700">Video Call</span>
                                            <span class="block text-[10px] text-slate-400 font-medium">Zoom / GMeet</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedMethod">
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Calendar & Time (Span 9 on LG, 8 on MD) -->
                        <div class="md:col-span-8 lg:col-span-9">
                            <div class="bg-white rounded-[2rem] border border-slate-200 p-6 md:p-8 shadow-sm h-full flex flex-col">
                                <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-6"><span class="w-5 h-5 rounded-full bg-brand-gold text-white inline-flex items-center justify-center mr-2">4</span> Select Date & Time</h3>
                                
                                <!-- Calendar Internal Layout: Stack on MD, Side-by-side on LG -->
                                <div class="flex flex-col lg:flex-row gap-8 lg:gap-12 flex-grow">
                                    <!-- Calendar Side -->
                                    <div class="lg:w-1/2 flex flex-col relative">
                                        <div class="bg-slate-50 rounded-3xl p-4 border border-slate-100 flex-grow h-full max-h-[400px] flex items-center justify-center relative overflow-hidden">
                                            <input type="text" id="bookingDate" class="hidden" placeholder="Select Date">
                                            
                                            <!-- CREATIVE LOCK OVERLAY -->
                                            <div id="calendarOverlay" class="absolute inset-0 z-20 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6 transition-all duration-500">
                                                <div class="relative mb-4 group cursor-help">
                                                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center shadow-inner transition-transform group-hover:scale-105">
                                                        <i class="fa-solid fa-lock text-slate-300 text-2xl group-hover:text-slate-400 transition-colors"></i>
                                                    </div>
                                                    <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-brand-primary rounded-full flex items-center justify-center text-white animate-bounce shadow-lg border-2 border-white">
                                                        <i class="fa-solid fa-key text-[10px]"></i>
                                                    </div>
                                                </div>
                                                <h4 class="text-slate-800 font-bold text-sm uppercase tracking-wider mb-2">Timeline Locked</h4>
                                                <p class="text-slate-500 text-[10px] md:text-xs max-w-[220px] leading-relaxed font-medium">
                                                    Unlock the calendar by selecting an <span class="text-brand-primary font-bold border-b border-brand-primary/30">Advisor</span> & <span class="text-brand-secondary font-bold border-b border-brand-secondary/30">Consultation Mode</span>.
                                                </p>
                                            </div>
                                        </div>
                                        <p class="text-center text-[10px] text-slate-400 font-bold mt-4"><i class="fa-solid fa-circle-info text-brand-primary mr-1"></i> Times displayed in your local timezone</p>
                                    </div>

                                    <!-- Divider -->
                                    <div class="hidden lg:block w-px bg-slate-100 my-2"></div>

                                    <!-- Time Side -->
                                    <div class="lg:w-1/2 flex flex-col h-full">
                                        <div class="flex justify-between items-center mb-4">
                                            <span class="text-xs font-bold text-slate-700">Available Slots</span>
                                            <div class="flex gap-2">
                                                <span class="w-2 h-2 rounded-full bg-white border border-slate-300"></span><span class="text-[9px] text-slate-400 font-bold mr-2">Free</span>
                                                <span class="w-2 h-2 rounded-full bg-brand-primary"></span><span class="text-[9px] text-slate-400 font-bold">Selected</span>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-3 overflow-y-auto custom-scrollbar pr-2 h-[340px] content-start" id="timeSlotGrid">
                                            <!-- JS Generated -->
                                        </div>
                                        <input type="hidden" id="selectedTime">
                                        <input type="hidden" id="selectedTimeIso">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation -->
                    <div class="mt-8 pt-6 border-t border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-brand-primary flex items-center justify-center"><i class="fa-solid fa-shield-halved"></i></div>
                            <div>
                                <p class="text-xs font-bold text-slate-900">Secure Booking</p>
                                <p class="text-[10px] text-slate-500">Instant confirmation via Email</p>
                            </div>
                        </div>
                        <button onclick="submitBooking()" class="w-full md:w-auto bg-slate-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-3">
                            <span>CONFIRM APPOINTMENT</span>
                            <i class="fa-solid fa-check"></i>
                        </button>
                    </div>

                </div>
            </div>

        </div>
    </main>
    
    <footer class="mt-0 border-t border-white/20 relative z-10 backdrop-blur-[2px] hidden md:block">
        <div class="border-t border-white/20 py-8 text-center text-xs text-slate-500 font-medium bg-white/10 backdrop-blur-sm">
            <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <p>&copy; 2025 Better Call Immigration. All rights reserved.</p>
                <div class="flex gap-4">
                    <a href="#" class="hover:text-indigo-600 transition">Privacy</a>
                    <a href="#" class="hover:text-indigo-600 transition">Terms</a>
                </div>
            </div>
        </div>
    </footer>

    <div id="loadingOverlay" class="fixed inset-0 z-[200] hidden flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-md transition-opacity duration-500 opacity-0">
        <div class="relative w-32 h-32 mb-8">
            <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-[ping_3s_cubic-bezier(0,0,0.2,1)_infinite]"></div>
            <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full animate-[ping_3s_cubic-bezier(0,0,0.2,1)_infinite]" style="animation-delay: 1s"></div>
            <div class="absolute inset-2 border-4 border-t-brand-primary border-r-transparent border-b-brand-secondary border-l-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fa-solid fa-satellite-dish text-4xl text-white animate-pulse"></i>
            </div>
        </div>
        <h3 id="loaderTitle" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 tracking-widest uppercase mb-2 animate-pulse">Establishing Link</h3>
        <div class="flex items-center gap-2 mb-4">
            <div class="w-1.5 h-1.5 bg-brand-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-1.5 h-1.5 bg-brand-secondary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
        <p id="loaderSubtitle" class="text-slate-400 text-[10px] font-mono border border-slate-700 px-3 py-1 rounded-full bg-slate-800/50">SECURE HANDSHAKE :: CLICKUP_DB_SYNC</p>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 transform translate-y-32 opacity-0 transition-all duration-500 z-[100]">
        <div class="glass-card border-l-4 border-brand-primary text-slate-800 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 bg-white">
            <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-brand-primary">
                <i class="fa-solid fa-check"></i>
            </div>
            <div>
                <h4 class="font-bold text-sm">Success</h4>
                <span class="text-xs text-slate-500" id="toastMsg">Action Completed Successfully</span>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/40 opacity-0 transition-opacity duration-300">
        <div class="modal-content glass-card !bg-white/95 w-[90%] md:w-full max-w-sm rounded-2xl p-6 transform scale-90 transition-transform duration-300 text-center">
            <div id="modalContent">
                <div class="w-12 h-12 rounded-full bg-red-50 text-brand-accent flex items-center justify-center text-xl mx-auto mb-4">
                    <i class="fa-solid fa-circle-exclamation"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Attention Needed</h3>
                <p id="modalText" class="text-slate-500 text-sm mb-6">Please check your inputs.</p>
                <button onclick="closeModal()" class="w-full bg-brand-accent hover:bg-rose-600 text-white font-bold py-3 rounded-xl transition-all shadow-lg">UNDERSTOOD</button>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL FUNCTIONS
        function setLanguage(lang, el) { console.log("Language set to:", lang); }
    
        function getUnixTime(dateStr) {
            if(!dateStr) return null;
            const parts = dateStr.split('/');
            if(parts.length !== 3) return null;
            const d = new Date(parts[2], parts[1] - 1, parts[0]);
            return d.getTime();
        }

        function validateName(input, errorId) {
            const regex = /^[a-zA-Z\s]*$/;
            const errorEl = document.getElementById(errorId);
            if (regex.test(input.value)) {
                input.classList.remove('border-red-500', 'bg-red-50');
                input.classList.add('border-green-500', 'bg-green-50');
                if(errorEl) errorEl.classList.add('hidden');
                return true;
            } else {
                input.classList.remove('border-green-500', 'bg-green-50');
                input.classList.add('border-red-500', 'bg-red-50');
                if(errorEl) errorEl.classList.remove('hidden');
                return false;
            }
        }

        function validateEmail(input, errorId, isBlur = false) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const errorEl = document.getElementById(errorId);
            if (isBlur) {
                if (regex.test(input.value)) {
                    input.classList.remove('border-red-500', 'bg-red-50');
                    input.classList.add('border-green-500', 'bg-green-50');
                    if(errorEl) errorEl.classList.add('hidden');
                    return true;
                } else {
                    if(input.value.length > 0) {
                        input.classList.remove('border-green-500', 'bg-green-50');
                        input.classList.add('border-red-500', 'bg-red-50');
                        if(errorEl) errorEl.classList.remove('hidden');
                    }
                    return false;
                }
            } else {
                if (input.value.includes('@')) {
                     if(errorEl) errorEl.classList.add('hidden');
                }
            }
        }

        function enforcePhoneInput(el) { 
            el.value = el.value.replace(/[^0-9+ ]/g, ''); 
        }

        function validatePhone(id) {
            const el = document.getElementById(id);
            const rawVal = el.value.replace(/\s/g, '');
            const feedback = document.getElementById(id === 'mobile' ? 'mobileFeedback' : id === 'whatsapp' ? 'waFeedback' : 'altPhoneFeedback');
            const regex = currentPhoneRegex || /^\+\d{8,15}$/;

            if (regex.test(rawVal)) {
                el.classList.add('valid-field'); 
                el.classList.remove('invalid-field');
                if(feedback) feedback.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>';
                if(id === 'mobile') document.getElementById('mobileError').classList.add('hidden');
            } else {
                el.classList.remove('valid-field');
                if(rawVal.length > 6) {
                    el.classList.add('invalid-field');
                    if(feedback) feedback.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500"></i>';
                } else {
                    if(feedback) feedback.innerHTML = '';
                }
            }
        }

        // --- GLOBAL CONFIGURATION ---
        const CLICKUP_API_KEY = "pk_260468481_S4KLO3ZGV6P1PL1POHKXNS1LA5ISSG0P"; 
        const CLICKUP_LIST_ID = "901813907839"; 
        let globalTaskId = null; 
        let currentMode = 'Unskilled';
        let currentPhoneRegex = null;
        // CAL.COM INTEGRATION CONFIG
        const CAL_CONFIG = {
            "Better Call": "cal_live_56464d96cd70d67aa7588d6735ad55ed",
            "Anju M Nair": "cal_live_82b9340d588920d9c9270052d13db98a",
            "Benitta": "cal_live_005b958e38d7722c363233d6b97a4ce4", // Confirmed Key
            "Eunice Kingoo": "cal_live_9489b42b4b6e4cdb8c144e8150fa62c9"
        };
        const eventTypeCache = {};

        const advisors = [
            { name: "Benitta", country: "India", flag: "", lang: "Malayalam ()", image: "https://raw.githubusercontent.com/sujeshunni-del/bettercall/b12a70e6439f530d20db63dae86358a47793a4f3/Bettercall%20Logo%20SVG%2003.svg", calId: "Benitta" },
            { name: "Anju M Nair", country: "India", flag: "", lang: "Malayalam (), Hindi (), English", image: "https://raw.githubusercontent.com/sujeshunni-del/bettercall/b12a70e6439f530d20db63dae86358a47793a4f3/Bettercall%20Logo%20SVG%2003.svg", calId: "Anju M Nair" },
            { name: "Better Call", country: "Philippines", flag: "", lang: "English, Malayalam", image: "https://raw.githubusercontent.com/sujeshunni-del/bettercall/b12a70e6439f530d20db63dae86358a47793a4f3/Bettercall%20Logo%20SVG%2003.svg", calId: "Better Call" },
            { name: "Eunice Kingoo", country: "Africa", flag: "", lang: "English, Kiswahili", image: "https://raw.githubusercontent.com/sujeshunni-del/bettercall/b12a70e6439f530d20db63dae86358a47793a4f3/Bettercall%20Logo%20SVG%2003.svg", calId: "Eunice Kingoo" }
        ];

        // CLICKUP FIELDS CONFIGURATION
        const CLICKUP_FIELDS = {
            "SUR NAME": "34d446a2-fe50-45bc-8e3b-64660ebdd6f7",  
            "MOBILE": "5693724c-ee50-469b-a4a9-3848fe6d3115", 
            "WHATSAPP": "87b4eee7-444f-4ec4-9882-441965757a68", 
            "PHONE": "8efe7c3f-70cc-46d4-b6db-1324e5071b29", 
            "DATE OF BIRTH": "72d7dec6-eb69-4d1d-b5ea-af6e99d28a38",    
            "AGE": "f4ba427f-6e9c-4aa2-ae5c-8159e1254d2c",    
            "QUALIFICATION": "2cd34df4-98b5-4c82-8d86-a34bf3c1618b",
            "JOB ROLE": "5e3fdff6-e1ea-4ca3-8ce5-190f2ce09082", 
            "NATIONALITY": "e79e1c4e-b123-4bd9-8051-34859ea4b87e", 
            "EXPERIENCE": "267d8fd1-cc80-4343-972a-4a1d45cab5d7", 
            "PASSPORT NUMBER": "b8798515-8962-40a7-a8cd-2685f9fd676c",
            "PASSPORT EXPIRY": "5aa1bec5-f188-4ef7-8f7d-2b4778fbe738", 
            "Case Reference ID": "a25c1d42-6191-4fde-8eb4-7f2059fd71e3",
            "EMAIL": "2e18821e-1c19-4de5-afb8-77ff11ee6327", 
            "PRESENT RESIDENCE": "dbb3620a-3cc3-44c0-8a01-d92a1594d6f5",
            "ADVISOR": "a220503d-5a45-4f0b-b83d-6547a28ca0b5",
            "BOOKING_DATE": "a4a8197d-eb13-4e90-ad56-d56108137e2e",
            "BOOKING_TIME": "584f279f-8f78-4e2b-ac91-ccf2c4e48b00",
            "BOOKING_TYPE": "03414f61-a879-4d14-bee0-7186a3de27d5",
            "TARGET_COUNTRY": "dd59c787-da25-4760-ab85-2974e1ae8838"
        };

        const targetCountries = [
            { name: "SWEDEN", type: "schengen", color: "hover:shadow-blue-300 hover:border-blue-400", bg: "bg-blue-50", icon: "" },
            { name: "FINLAND", type: "schengen", color: "hover:shadow-sky-200 hover:border-sky-300", bg: "bg-sky-50", icon: "" },
            { name: "NETHERLANDS", type: "schengen", color: "hover:shadow-orange-300 hover:border-orange-400", bg: "bg-orange-50", icon: "" },
            { name: "GERMANY", type: "schengen", color: "hover:shadow-yellow-400 hover:border-yellow-500", bg: "bg-yellow-50", icon: "" },
            { name: "ITALY", type: "schengen", color: "hover:shadow-green-300 hover:border-green-400", bg: "bg-green-50", icon: "" },
            { name: "FRANCE", type: "schengen", color: "hover:shadow-blue-400 hover:border-blue-500", bg: "bg-indigo-50", icon: "" },
            { name: "CROATIA", type: "schengen", color: "hover:shadow-red-300 hover:border-red-400", bg: "bg-red-50", icon: "" },
            { name: "LATVIA", type: "schengen", color: "hover:shadow-rose-400 hover:border-rose-500", bg: "bg-rose-50", icon: "" },
            { name: "POLAND", type: "schengen", color: "hover:shadow-red-400 hover:border-red-500", bg: "bg-red-50", icon: "" },
            { name: "CZECH REPUBLIC", type: "schengen", color: "hover:shadow-blue-300 hover:border-blue-400", bg: "bg-blue-50", icon: "" },
            { name: "SLOVAKIA", type: "schengen", color: "hover:shadow-blue-300 hover:border-blue-400", bg: "bg-blue-50", icon: "" },
            { name: "SERBIA", type: "non-schengen", color: "hover:shadow-red-300 hover:border-red-400", bg: "bg-red-50", icon: "" },
            { name: "ALBANIA", type: "non-schengen", color: "hover:shadow-red-500 hover:border-red-600", bg: "bg-red-50", icon: "" },
            { name: "MACEDONIA", type: "non-schengen", color: "hover:shadow-yellow-300 hover:border-yellow-400", bg: "bg-yellow-50", icon: "" },
            { name: "MONTENEGRO", type: "non-schengen", color: "hover:shadow-red-400 hover:border-red-500", bg: "bg-red-50", icon: "" },
            { name: "BELARUS", type: "non-schengen", color: "hover:shadow-green-300 hover:border-green-400", bg: "bg-green-50", icon: "" }
        ];

        const salaryDb = {
            "SWEDEN": { u: "1,800 - 2,200", s: "2,700 - 6,500" },
            "FINLAND": { u: "1,500 - 2,000", s: "2,500 - 5,000" },
            "NETHERLANDS": { u: "2,200 - 2,800", s: "5,000+" },
            "GERMANY": { u: "2,000 - 2,600", s: "5,000+" },
            "ITALY": { u: "1,200 - 1,600", s: "1,800 - 3,500" },
            "FRANCE": { u: "1,200 - 1,600", s: "1,800 - 3,500" },
            "CROATIA": { u: "600 - 1,200", s: "800 - 1,500" },
            "LATVIA": { u: "1,000 - 1,500", s: "1,537 - 5,000" },
            "POLAND": { u: "4,000 - 5,500 PLN", s: "5,500 - 8,000+ PLN" },
            "CZECH REPUBLIC": { u: "900 - 1,300", s: "1,400 - 5,000" },
            "SLOVAKIA": { u: "900 - 1,200", s: "1,250 - 1,500" },
            "SERBIA": { u: "340 - 600", s: "500 - 1,500" },
            "MACEDONIA": { u: "400 - 700", s: "550 - 1,200" },
            "ALBANIA": { u: "600 - 1,200", s: "600 - 1,200" },
            "BELARUS": { u: "700 - 1,200", s: "700 - 1,200" },
            "MONTENEGRO": { u: "700 - 1,000", s: "900 - 1,000" }
        };

        const jobMasterList = [
            // --- SWEDEN ---
            {r:"Civil Engineer",type:"S",c:"SWEDEN"},
            {r:"Civil Draughtsman",type:"S",c:"SWEDEN"},
            {r:"Land Surveyor",type:"S",c:"SWEDEN"},
            {r:"Civil Site Supervisor",type:"S",c:"SWEDEN"},
            {r:"Construction Safety Engineer",type:"S",c:"SWEDEN"},
            {r:"Construction Safety Officer",type:"S",c:"SWEDEN"},
            {r:"Welder",type:"S",c:"SWEDEN"},
            {r:"Fabricator",type:"S",c:"SWEDEN"},
            {r:"Scaffolder",type:"S",c:"SWEDEN"},
            {r:"RCC Fitter",type:"S",c:"SWEDEN"},
            {r:"Wall Painter",type:"S",c:"SWEDEN"},
            {r:"Concrete Mix Operator",type:"S",c:"SWEDEN"},
            {r:"Dozer Operator",type:"S",c:"SWEDEN"},
            {r:"Excavator Operator",type:"S",c:"SWEDEN"},
            {r:"Tower Crane Operator",type:"S",c:"SWEDEN"},
            {r:"Mobile Crane Operator",type:"S",c:"SWEDEN"},
            {r:"Grader Operator",type:"S",c:"SWEDEN"},
            {r:"Steel Fixer",type:"S",c:"SWEDEN"},
            {r:"Mechanical Engineer",type:"S",c:"SWEDEN"},
            {r:"Mechanical Supervisor",type:"S",c:"SWEDEN"},
            {r:"Diesel Mechanical Technician",type:"S",c:"SWEDEN"},
            {r:"Mechanical Draughtsman",type:"S",c:"SWEDEN"},
            {r:"CCTV Technician",type:"S",c:"SWEDEN"},
            {r:"Generator Mechanic",type:"S",c:"SWEDEN"},
            {r:"Lift Technician",type:"S",c:"SWEDEN"},
            {r:"Alarm Technician",type:"S",c:"SWEDEN"},
            {r:"Store Keeper",type:"S",c:"SWEDEN"},
            {r:"Data Entry Operator",type:"S",c:"SWEDEN"},
            {r:"Office Assistant",type:"S",c:"SWEDEN"},
            {r:"Accountant",type:"S",c:"SWEDEN"},
            {r:"System Service Engineer",type:"S",c:"SWEDEN"},
            {r:"Computer Operator",type:"S",c:"SWEDEN"},
            {r:"Staff Bus Driver / Heavy Duty",type:"S",c:"SWEDEN"},
            {r:"Tanker Driver / Heavy Duty",type:"S",c:"SWEDEN"},
            {r:"Head Nurse",type:"S",c:"SWEDEN"},
            {r:"Assistant Nurse",type:"S",c:"SWEDEN"},
            {r:"Chief Laboratory Technician",type:"S",c:"SWEDEN"},
            {r:"Radiology X-Ray Technician",type:"S",c:"SWEDEN"},
            {r:"Chief Pharmacist",type:"S",c:"SWEDEN"},
            {r:"Ambulance Driver",type:"S",c:"SWEDEN"},
            {r:"Ward Assistant",type:"S",c:"SWEDEN"},
            {r:"Assistant Pharmacist",type:"S",c:"SWEDEN"},
            {r:"Loading/Unloading Worker",type:"U",c:"SWEDEN"},
            {r:"Aircraft Cleaning Worker",type:"U",c:"SWEDEN"},
            {r:"Trolley Helper",type:"U",c:"SWEDEN"},
            {r:"Sweeper",type:"U",c:"SWEDEN"},

            // --- FINLAND ---
            {r:"Sales Supervisor",type:"S",c:"FINLAND"},
            {r:"Cam Supervisor",type:"S",c:"FINLAND"},
            {r:"Transport Supervisor",type:"S",c:"FINLAND"},
            {r:"Laundry Supervisor",type:"S",c:"FINLAND"},
            {r:"System Engineer",type:"S",c:"FINLAND"},
            {r:"System Operator",type:"S",c:"FINLAND"},
            {r:"Data Entry Operator",type:"S",c:"FINLAND"},
            {r:"Accountant",type:"S",c:"FINLAND"},
            {r:"Sales Workers",type:"S",c:"FINLAND"},
            {r:"Office Clerk",type:"S",c:"FINLAND"},
            {r:"Office Assistant",type:"S",c:"FINLAND"},
            {r:"Store Keeper",type:"S",c:"FINLAND"},
            {r:"Time Keeper",type:"S",c:"FINLAND"},
            {r:"Security Guard",type:"S",c:"FINLAND"},
            {r:"Laundry Worker",type:"S",c:"FINLAND"},
            {r:"Tanker Driver Head Duty",type:"S",c:"FINLAND"},
            {r:"Staff Bus Driver Head Duty",type:"S",c:"FINLAND"},
            {r:"Driver Light Duty",type:"S",c:"FINLAND"},
            {r:"Forklift Operator",type:"S",c:"FINLAND"},
            {r:"Restaurant Supervisor",type:"S",c:"FINLAND"},
            {r:"Bar Supervisor",type:"S",c:"FINLAND"},
            {r:"Housekeeping Supervisor",type:"S",c:"FINLAND"},
            {r:"F & B Supervisor",type:"S",c:"FINLAND"},
            {r:"Steward Supervisor",type:"S",c:"FINLAND"},
            {r:"Health and Safety Officer",type:"S",c:"FINLAND"},
            {r:"Food Quality Inspector",type:"S",c:"FINLAND"},
            {r:"Chief Cook",type:"S",c:"FINLAND"},
            {r:"Assistant Cook",type:"S",c:"FINLAND"},
            {r:"Head Chef",type:"S",c:"FINLAND"},
            {r:"Assistant Chef",type:"S",c:"FINLAND"},
            {r:"Baker/Pastry Chef",type:"S",c:"FINLAND"},
            {r:"Food and Beverage",type:"S",c:"FINLAND"},
            {r:"Waiter",type:"S",c:"FINLAND"},
            {r:"Captain",type:"S",c:"FINLAND"},
            {r:"Steward",type:"S",c:"FINLAND"},
            {r:"Commis III",type:"S",c:"FINLAND"},
            {r:"Pizza Makers",type:"S",c:"FINLAND"},
            {r:"Chef de Partie",type:"S",c:"FINLAND"},
            {r:"Bartender / Barman",type:"S",c:"FINLAND"},
            {r:"Packing Helper",type:"U",c:"FINLAND"},
            {r:"Trolley Helper",type:"U",c:"FINLAND"},
            {r:"Loading Unloading Workers",type:"U",c:"FINLAND"},
            {r:"Cleaning Helper",type:"U",c:"FINLAND"},
            {r:"Kitchen Helper",type:"U",c:"FINLAND"},

            // --- NETHERLANDS ---
            {r:"Office Clerk / Receptionist",type:"S",c:"NETHERLANDS"},
            {r:"Accountant",type:"S",c:"NETHERLANDS"},
            {r:"Manager",type:"S",c:"NETHERLANDS"},
            {r:"HR Assistant / Executive",type:"S",c:"NETHERLANDS"},
            {r:"Administrative Assistant",type:"S",c:"NETHERLANDS"},
            {r:"Front Office Executive",type:"S",c:"NETHERLANDS"},
            {r:"Secretary / Personal Assistant",type:"S",c:"NETHERLANDS"},
            {r:"Document Controller",type:"S",c:"NETHERLANDS"},
            {r:"Sales & Marketing Executive",type:"S",c:"NETHERLANDS"},
            {r:"Business Development Executive",type:"S",c:"NETHERLANDS"},
            {r:"Customer Service Executive",type:"S",c:"NETHERLANDS"},
            {r:"Call Centre Executive",type:"S",c:"NETHERLANDS"},
            {r:"IT Professional",type:"S",c:"NETHERLANDS"},
            {r:"Engineer (Various Disciplines)",type:"S",c:"NETHERLANDS"},
            {r:"Project Coordinator",type:"S",c:"NETHERLANDS"},
            {r:"Data Entry Operator",type:"S",c:"NETHERLANDS"},
            {r:"Logistics Coordinator",type:"S",c:"NETHERLANDS"},
            {r:"Store Supervisor",type:"S",c:"NETHERLANDS"},
            {r:"Agriculture Farm Workers",type:"U",c:"NETHERLANDS"},
            {r:"Poultry Farm Worker",type:"U",c:"NETHERLANDS"},
            {r:"Greenhouse Worker",type:"U",c:"NETHERLANDS"},
            {r:"Vegetable Packer",type:"U",c:"NETHERLANDS"},

            // --- FRANCE ---
            {r:"Office Clerk / Receptionist",type:"S",c:"FRANCE"},
            {r:"Accountant",type:"S",c:"FRANCE"},
            {r:"Manager",type:"S",c:"FRANCE"},
            {r:"HR Assistant",type:"S",c:"FRANCE"},
            {r:"Sales & Marketing Exec",type:"S",c:"FRANCE"},
            {r:"Business Development",type:"S",c:"FRANCE"},
            {r:"IT Professional",type:"S",c:"FRANCE"},
            {r:"Engineer",type:"S",c:"FRANCE"},
            {r:"Logistics Coordinator",type:"S",c:"FRANCE"},
            {r:"Store Supervisor",type:"S",c:"FRANCE"},
            {r:"Care Home Assistant",type:"U",c:"FRANCE"},
            {r:"Nursing Assistant",type:"U",c:"FRANCE"},
            {r:"Elderly Care Staff",type:"U",c:"FRANCE"},
            {r:"Healthcare Support",type:"U",c:"FRANCE"},

            // --- GERMANY ---
            {r:"Office Clerk / Receptionist",type:"S",c:"GERMANY"},
            {r:"Accountant",type:"S",c:"GERMANY"},
            {r:"Manager",type:"S",c:"GERMANY"},
            {r:"HR Assistant / Executive",type:"S",c:"GERMANY"},
            {r:"Administrative Assistant",type:"S",c:"GERMANY"},
            {r:"Front Office Executive",type:"S",c:"GERMANY"},
            {r:"Secretary / Personal Assistant",type:"S",c:"GERMANY"},
            {r:"Document Controller",type:"S",c:"GERMANY"},
            {r:"Sales & Marketing Executive",type:"S",c:"GERMANY"},
            {r:"Business Development Executive",type:"S",c:"GERMANY"},
            {r:"Customer Service Executive",type:"S",c:"GERMANY"},
            {r:"Call Centre Executive",type:"S",c:"GERMANY"},
            {r:"IT Professional",type:"S",c:"GERMANY"},
            {r:"Engineer (Various Disciplines)",type:"S",c:"GERMANY"},
            {r:"Project Coordinator",type:"S",c:"GERMANY"},
            {r:"Data Entry Operator",type:"S",c:"GERMANY"},
            {r:"Logistics Coordinator",type:"S",c:"GERMANY"},
            {r:"Store Supervisor",type:"S",c:"GERMANY"},
            {r:"Procurement / Purchase Assistant",type:"S",c:"GERMANY"},
            {r:"Care Home Jobs",type:"U",c:"GERMANY"},

            // --- ITALY ---
            {r:"Office Clerk / Receptionist",type:"S",c:"ITALY"},
            {r:"Accountant",type:"S",c:"ITALY"},
            {r:"Manager",type:"S",c:"ITALY"},
            {r:"HR Assistant",type:"S",c:"ITALY"},
            {r:"Sales & Marketing Exec",type:"S",c:"ITALY"},
            {r:"Business Development",type:"S",c:"ITALY"},
            {r:"IT Professional",type:"S",c:"ITALY"},
            {r:"Engineer",type:"S",c:"ITALY"},
            {r:"Logistics Coordinator",type:"S",c:"ITALY"},
            {r:"Store Supervisor",type:"S",c:"ITALY"},
            {r:"Care Home Assistant",type:"U",c:"ITALY"},
            {r:"Nursing Assistant",type:"U",c:"ITALY"},
            {r:"Elderly Care Staff",type:"U",c:"ITALY"},
            {r:"Healthcare Support",type:"U",c:"ITALY"},

            // --- CZECH REPUBLIC ---
            {r:"Warehouse Staff",type:"S",c:"CZECH REPUBLIC"},
            {r:"Welder (Certified)",type:"S",c:"CZECH REPUBLIC"},
            {r:"CNC Operator",type:"S",c:"CZECH REPUBLIC"},
            {r:"Auto Electrician",type:"S",c:"CZECH REPUBLIC"},
            {r:"Automotive Technician",type:"S",c:"CZECH REPUBLIC"},
            {r:"Heavy Goods Driver (C+E)",type:"S",c:"CZECH REPUBLIC"},
            {r:"Software Developer",type:"S",c:"CZECH REPUBLIC"},
            {r:"Production Line Worker",type:"U",c:"CZECH REPUBLIC"},
            {r:"Construction Helper",type:"U",c:"CZECH REPUBLIC"},

            // --- CROATIA ---
            {r:"Truck Driver",type:"S",c:"CROATIA"},
            {r:"Welder",type:"S",c:"CROATIA"},
            {r:"Construction Worker",type:"U",c:"CROATIA"},
            {r:"Hotel Staff",type:"U",c:"CROATIA"},
            {r:"Warehouse Packer",type:"U",c:"CROATIA"},
            {r:"Farm Worker",type:"U",c:"CROATIA"},
            {r:"Butcher",type:"U",c:"CROATIA"},

            // --- LATVIA ---
            {r:"Welder / Fitter",type:"S",c:"LATVIA"},
            {r:"Electrician (Certified)",type:"S",c:"LATVIA"},
            {r:"Bricklayer / Mason",type:"S",c:"LATVIA"},
            {r:"CNC Operator",type:"S",c:"LATVIA"},
            {r:"Aircraft Mechanic",type:"S",c:"LATVIA"},
            {r:"Truck Driver (Code 95)",type:"S",c:"LATVIA"},
            {r:"Warehouse Packer",type:"S",c:"LATVIA"},
            {r:"Software Developer",type:"S",c:"LATVIA"},
            {r:"IT Systems Analyst",type:"S",c:"LATVIA"},
            {r:"Specialist Doctor",type:"S",c:"LATVIA"},
            {r:"Chef / Cook",type:"S",c:"LATVIA"},

            // --- POLAND ---
            {r:"Machine Operator",type:"S",c:"POLAND"},
            {r:"Forklift Operator",type:"S",c:"POLAND"},
            {r:"Inventory Clerk",type:"S",c:"POLAND"},
            {r:"Welder (Certified)",type:"S",c:"POLAND"},
            {r:"Electrician",type:"S",c:"POLAND"},
            {r:"Mason / Plasterer",type:"S",c:"POLAND"},
            {r:"Scaffolder",type:"S",c:"POLAND"},
            {r:"Production Line Worker",type:"U",c:"POLAND"},
            {r:"Quality Control (QC)",type:"U",c:"POLAND"},
            {r:"Packaging Staff",type:"U",c:"POLAND"},
            {r:"Assembly Operator",type:"U",c:"POLAND"},
            {r:"Picker / Packer",type:"U",c:"POLAND"},
            {r:"Warehouse Assistant",type:"U",c:"POLAND"},
            {r:"General Laborer",type:"U",c:"POLAND"},
            {r:"Harvesting Worker",type:"U",c:"POLAND"},

            // --- MACEDONIA ---
            {r:"Welder",type:"S",c:"MACEDONIA"},
            {r:"Electrician",type:"S",c:"MACEDONIA"},
            {r:"Plumber",type:"S",c:"MACEDONIA"},
            {r:"Mason",type:"S",c:"MACEDONIA"},
            {r:"Machine Operator",type:"S",c:"MACEDONIA"},
            {r:"Chef / Cook",type:"S",c:"MACEDONIA"},
            {r:"Hotel Staff",type:"S",c:"MACEDONIA"},
            {r:"Assembly Worker",type:"U",c:"MACEDONIA"},
            {r:"General Laborer",type:"U",c:"MACEDONIA"},

            // --- SERBIA ---
            {r:"Truck Driver",type:"S",c:"SERBIA"},
            {r:"Delivery Driver",type:"S",c:"SERBIA"},
            {r:"Warehouse Staff",type:"S",c:"SERBIA"},
            {r:"Certified Welder",type:"S",c:"SERBIA"},
            {r:"Automotive Mechanic",type:"S",c:"SERBIA"},
            {r:"Professional Cook",type:"S",c:"SERBIA"},
            {r:"Hospitality Staff",type:"S",c:"SERBIA"},
            {r:"Agriculture Worker",type:"U",c:"SERBIA"},

            // --- ALBANIA ---
            {r:"Truck Driver",type:"S",c:"ALBANIA"},
            {r:"Welder",type:"S",c:"ALBANIA"},
            {r:"Hotel Staff",type:"S",c:"ALBANIA"},
            {r:"Construction Worker",type:"U",c:"ALBANIA"},
            {r:"Warehouse Packer",type:"U",c:"ALBANIA"},
            {r:"Farm Worker",type:"U",c:"ALBANIA"},
            {r:"Butcher",type:"U",c:"ALBANIA"},

            // --- BELARUS ---
            {r:"Tractor Driver",type:"S",c:"BELARUS"},
            {r:"Professional Tailor",type:"S",c:"BELARUS"},
            {r:"Seamstress",type:"S",c:"BELARUS"},
            {r:"Textile Worker",type:"S",c:"BELARUS"},
            {r:"General Agriculture",type:"U",c:"BELARUS"},
            {r:"Dairy Farm Worker",type:"U",c:"BELARUS"},

            // --- SLOVAKIA ---
            {r:"Automotive Assembly Operator",type:"S",c:"SLOVAKIA"},
            {r:"Chassis Line Worker",type:"S",c:"SLOVAKIA"},
            {r:"Quality Control Specialist",type:"S",c:"SLOVAKIA"},
            {r:"Paint Shop Assistant",type:"S",c:"SLOVAKIA"},
            {r:"CNC Machine Operator",type:"S",c:"SLOVAKIA"},
            {r:"Electronics Assembler",type:"S",c:"SLOVAKIA"},
            {r:"Forklift Operator",type:"S",c:"SLOVAKIA"},
            {r:"Construction Specialist",type:"S",c:"SLOVAKIA"},
            {r:"Site Support Worker",type:"S",c:"SLOVAKIA"},
            {r:"Production Line Operator",type:"U",c:"SLOVAKIA"},
            {r:"Warehouse Associate",type:"U",c:"SLOVAKIA"},
            {r:"Loader / Unloader",type:"U",c:"SLOVAKIA"},
            {r:"Factory Assistant",type:"U",c:"SLOVAKIA"},
            {r:"Packaging Helper",type:"U",c:"SLOVAKIA"},
            {r:"Maintenance Helper",type:"U",c:"SLOVAKIA"},

            // --- MONTENEGRO ---
            {r:"Machine Operator",type:"S",c:"MONTENEGRO"},
            {r:"General Worker",type:"U",c:"MONTENEGRO"},
            {r:"Cleaner",type:"U",c:"MONTENEGRO"},
            {r:"Maintenance Helper",type:"U",c:"MONTENEGRO"},
            {r:"Construction Helper",type:"U",c:"MONTENEGRO"},
            {r:"Factory Worker",type:"U",c:"MONTENEGRO"},
            {r:"Assembly Line Worker",type:"U",c:"MONTENEGRO"},
            {r:"Production Assistant",type:"U",c:"MONTENEGRO"},
            {r:"Packing Helper",type:"U",c:"MONTENEGRO"},
            {r:"Warehouse Assistant",type:"U",c:"MONTENEGRO"},
            {r:"Loader / Unloader",type:"U",c:"MONTENEGRO"},
            {r:"Logistics Helper",type:"U",c:"MONTENEGRO"}
        ];

        const countryRules = {
            "AFGHANISTAN": { regex: /^\+93\d{9}$/, hint: "+93 700123456" },
            "ALBANIA": { regex: /^\+355\d{8,9}$/, hint: "+355 691234567" },
            "ALGERIA": { regex: /^\+213\d{9}$/, hint: "+213 555123456" },
            "ANDORRA": { regex: /^\+376\d{6}$/, hint: "+376 123456" },
            "ANGOLA": { regex: /^\+244\d{9}$/, hint: "+244 923123456" },
            "ARGENTINA": { regex: /^\+54\d{10,11}$/, hint: "+54 91123456789" },
            "ARMENIA": { regex: /^\+374\d{8}$/, hint: "+374 91123456" },
            "AUSTRALIA": { regex: /^\+614\d{8}$/, hint: "+61 412345678" },
            "AUSTRIA": { regex: /^\+43\d{10,13}$/, hint: "+43 6641234567" },
            "AZERBAIJAN": { regex: /^\+994\d{9}$/, hint: "+994 501234567" },
            "BAHRAIN": { regex: /^\+973\d{8}$/, hint: "+973 39123456" },
            "BANGLADESH": { regex: /^\+8801\d{9}$/, hint: "+880 1712345678" },
            "BELARUS": { regex: /^\+375\d{9}$/, hint: "+375 291234567" },
            "BELGIUM": { regex: /^\+324\d{8}$/, hint: "+32 470123456" },
            "BENIN": { regex: /^\+229\d{8}$/, hint: "+229 97123456" },
            "BHUTAN": { regex: /^\+975\d{8}$/, hint: "+975 17123456" },
            "BOLIVIA": { regex: /^\+591\d{8}$/, hint: "+591 71234567" },
            "BOSNIA AND HERZEGOVINA": { regex: /^\+3876\d{7,8}$/, hint: "+387 61123456" },
            "BOTSWANA": { regex: /^\+267\d{8}$/, hint: "+267 72123456" },
            "BRAZIL": { regex: /^\+55\d{10,11}$/, hint: "+55 11912345678" },
            "BRUNEI": { regex: /^\+673\d{7}$/, hint: "+673 8123456" },
            "BULGARIA": { regex: /^\+3598\d{8}$/, hint: "+359 881234567" },
            "BURKINA FASO": { regex: /^\+226\d{8}$/, hint: "+226 70123456" },
            "BURUNDI": { regex: /^\+257\d{8}$/, hint: "+257 79123456" },
            "CAMBODIA": { regex: /^\+855\d{8,9}$/, hint: "+855 12345678" },
            "CAMEROON": { regex: /^\+237\d{9}$/, hint: "+237 671234567" },
            "CANADA": { regex: /^\+1\d{10}$/, hint: "+1 4161234567" },
            "CAPE VERDE": { regex: /^\+238\d{7}$/, hint: "+238 9912345" },
            "CENTRAL AFRICAN REPUBLIC": { regex: /^\+236\d{8}$/, hint: "+236 75123456" },
            "CHAD": { regex: /^\+235\d{8}$/, hint: "+235 66123456" },
            "CHILE": { regex: /^\+569\d{8}$/, hint: "+56 912345678" },
            "CHINA": { regex: /^\+861\d{10}$/, hint: "+86 13912345678" },
            "COLOMBIA": { regex: /^\+573\d{9}$/, hint: "+57 3001234567" },
            "COMOROS": { regex: /^\+269\d{7}$/, hint: "+269 3312345" },
            "CONGO (DRC)": { regex: /^\+243\d{9}$/, hint: "+243 811234567" },
            "CONGO (REPUBLIC)": { regex: /^\+242\d{9}$/, hint: "+242 061234567" },
            "COSTA RICA": { regex: /^\+506\d{8}$/, hint: "+506 81234567" },
            "CROATIA": { regex: /^\+3859\d{8}$/, hint: "+385 911234567" },
            "CUBA": { regex: /^\+535\d{7}$/, hint: "+53 51234567" },
            "CYPRUS": { regex: /^\+357\d{8}$/, hint: "+357 99123456" },
            "CZECH REPUBLIC": { regex: /^\+420\d{9}$/, hint: "+420 712345678" },
            "DENMARK": { regex: /^\+45\d{8}$/, hint: "+45 12345678" },
            "DJIBOUTI": { regex: /^\+253\d{8}$/, hint: "+253 77123456" },
            "DOMINICAN REPUBLIC": { regex: /^\+18\d{9}$/, hint: "+1 8091234567" },
            "ECUADOR": { regex: /^\+5939\d{8}$/, hint: "+593 912345678" },
            "EGYPT": { regex: /^\+201\d{9}$/, hint: "+20 1012345678" },
            "EL SALVADOR": { regex: /^\+503\d{8}$/, hint: "+503 71234567" },
            "EQUATORIAL GUINEA": { regex: /^\+240\d{9}$/, hint: "+240 222123456" },
            "ERITREA": { regex: /^\+291\d{7}$/, hint: "+291 7123456" },
            "ESTONIA": { regex: /^\+372\d{7,8}$/, hint: "+372 51234567" },
            "ESWATINI": { regex: /^\+268\d{8}$/, hint: "+268 76123456" },
            "ETHIOPIA": { regex: /^\+251\d{9}$/, hint: "+251 911234567" },
            "FIJI": { regex: /^\+679\d{7}$/, hint: "+679 7123456" },
            "FINLAND": { regex: /^\+358\d{7,10}$/, hint: "+358 401234567" },
            "FRANCE": { regex: /^\+33[67]\d{8}$/, hint: "+33 612345678" },
            "GABON": { regex: /^\+241\d{7,8}$/, hint: "+241 07123456" },
            "GAMBIA": { regex: /^\+220\d{7}$/, hint: "+220 7123456" },
            "GEORGIA": { regex: /^\+995\d{9}$/, hint: "+995 599123456" },
            "GERMANY": { regex: /^\+491\d{9,11}$/, hint: "+49 17012345678" },
            "GHANA": { regex: /^\+233\d{9}$/, hint: "+233 241234567" },
            "GREECE": { regex: /^\+3069\d{8}$/, hint: "+30 6912345678" },
            "GUATEMALA": { regex: /^\+502\d{8}$/, hint: "+502 51234567" },
            "GUINEA": { regex: /^\+224\d{9}$/, hint: "+224 621234567" },
            "GUINEA-BISSAU": { regex: /^\+245\d{9}$/, hint: "+245 961234567" },
            "GUYANA": { regex: /^\+592\d{7}$/, hint: "+592 6123456" },
            "HAITI": { regex: /^\+509\d{8}$/, hint: "+509 31234567" },
            "HONDURAS": { regex: /^\+504\d{8}$/, hint: "+504 91234567" },
            "HONG KONG": { regex: /^\+852\d{8}$/, hint: "+852 91234567" },
            "HUNGARY": { regex: /^\+36\d{9}$/, hint: "+36 301234567" },
            "ICELAND": { regex: /^\+354\d{7}$/, hint: "+354 7123456" },
            "INDIA": { regex: /^\+91[6-9]\d{9}$/, hint: "+91 9876543210" },
            "INDONESIA": { regex: /^\+628\d{9,11}$/, hint: "+62 8123456789" },
            "IRAN": { regex: /^\+989\d{9}$/, hint: "+98 9123456789" },
            "IRAQ": { regex: /^\+9647\d{9}$/, hint: "+964 7501234567" },
            "IRELAND": { regex: /^\+3538\d{8}$/, hint: "+353 871234567" },
            "ISRAEL": { regex: /^\+9725\d{8}$/, hint: "+972 501234567" },
            "ITALY": { regex: /^\+393\d{9}$/, hint: "+39 3331234567" },
            "IVORY COAST": { regex: /^\+225\d{10}$/, hint: "+225 0701234567" },
            "JAMAICA": { regex: /^\+1876\d{7}$/, hint: "+1 8761234567" },
            "JAPAN": { regex: /^\+81[789]0\d{8}$/, hint: "+81 9012345678" },
            "JORDAN": { regex: /^\+9627\d{8}$/, hint: "+962 791234567" },
            "KAZAKHSTAN": { regex: /^\+77\d{9}$/, hint: "+7 7012345678" },
            "KENYA": { regex: /^\+2547\d{8}$/, hint: "+254 712345678" },
            "KUWAIT": { regex: /^\+965\d{8}$/, hint: "+965 91234567" },
            "KYRGYZSTAN": { regex: /^\+996\d{9}$/, hint: "+996 555123456" },
            "LAOS": { regex: /^\+85620\d{8}$/, hint: "+856 2012345678" },
            "LEBANON": { regex: /^\+961\d{7,8}$/, hint: "+961 70123456" },
            "LESOTHO": { regex: /^\+266\d{8}$/, hint: "+266 58123456" },
            "LIBERIA": { regex: /^\+231\d{8,9}$/, hint: "+231 77123456" },
            "LIBYA": { regex: /^\+2189\d{8}$/, hint: "+218 911234567" },
            "LIECHTENSTEIN": { regex: /^\+423\d{7}$/, hint: "+423 6612345" },
            "LITHUANIA": { regex: /^\+3706\d{7}$/, hint: "+370 61234567" },
            "LUXEMBOURG": { regex: /^\+3526\d{8}$/, hint: "+352 691234567" },
            "MACAU": { regex: /^\+8536\d{7}$/, hint: "+853 66123456" },
            "MADAGASCAR": { regex: /^\+261\d{9}$/, hint: "+261 341234567" },
            "MALAWI": { regex: /^\+265\d{9}$/, hint: "+265 881234567" },
            "MALAYSIA": { regex: /^\+601\d{8,9}$/, hint: "+60 123456789" },
            "MALDIVES": { regex: /^\+960\d{7}$/, hint: "+960 7712345" },
            "MALI": { regex: /^\+223\d{8}$/, hint: "+223 76123456" },
            "MALTA": { regex: /^\+356\d{8}$/, hint: "+356 79123456" },
            "MAURITANIA": { regex: /^\+222\d{8}$/, hint: "+222 46123456" },
            "MAURITIUS": { regex: /^\+2305\d{7}$/, hint: "+230 57123456" },
            "MEXICO": { regex: /^\+521\d{10}$/, hint: "+52 15512345678" },
            "MOLDOVA": { regex: /^\+373\d{8}$/, hint: "+373 69123456" },
            "MONACO": { regex: /^\+377\d{8}$/, hint: "+377 61234567" },
            "MONGOLIA": { regex: /^\+976\d{8}$/, hint: "+976 99123456" },
            "MONTENEGRO": { regex: /^\+3826\d{7}$/, hint: "+382 69123456" },
            "MOROCCO": { regex: /^\+212\d{9}$/, hint: "+212 612345678" },
            "MOZAMBIQUE": { regex: /^\+258\d{9}$/, hint: "+258 841234567" },
            "MYANMAR (BURMA)": { regex: /^\+959\d{7,9}$/, hint: "+95 912345678" },
            "NAMIBIA": { regex: /^\+2648\d{8}$/, hint: "+264 811234567" },
            "NEPAL": { regex: /^\+9779\d{9}$/, hint: "+977 9812345678" },
            "NETHERLANDS": { regex: /^\+316\d{8}$/, hint: "+31 612345678" },
            "NEW ZEALAND": { regex: /^\+642\d{7,9}$/, hint: "+64 211234567" },
            "NICARAGUA": { regex: /^\+505\d{8}$/, hint: "+505 81234567" },
            "NIGER": { regex: /^\+227\d{8}$/, hint: "+227 96123456" },
            "NIGERIA": { regex: /^\+234[789]\d{9}$/, hint: "+234 8012345678" },
            "NORTH KOREA": { regex: /^\+850\d{8,10}$/, hint: "+850 191234567" },
            "NORTH MACEDONIA": { regex: /^\+3897\d{7}$/, hint: "+389 70123456" },
            "NORWAY": { regex: /^\+47\d{8}$/, hint: "+47 91234567" },
            "OMAN": { regex: /^\+968\d{8}$/, hint: "+968 99123456" },
            "PAKISTAN": { regex: /^\+923\d{9}$/, hint: "+92 3001234567" },
            "PALESTINE": { regex: /^\+9705\d{8}$/, hint: "+970 591234567" },
            "PANAMA": { regex: /^\+507\d{8}$/, hint: "+507 61234567" },
            "PAPUA NEW GUINEA": { regex: /^\+675\d{8}$/, hint: "+675 71234567" },
            "PARAGUAY": { regex: /^\+5959\d{8}$/, hint: "+595 981123456" },
            "PERU": { regex: /^\+519\d{8}$/, hint: "+51 912345678" },
            "PHILIPPINES": { regex: /^\+639\d{9}$/, hint: "+63 9171234567" },
            "POLAND": { regex: /^\+48\d{9}$/, hint: "+48 512345678" },
            "PORTUGAL": { regex: /^\+3519\d{8}$/, hint: "+351 912345678" },
            "QATAR": { regex: /^\+974\d{8}$/, hint: "+974 33123456" },
            "ROMANIA": { regex: /^\+407\d{8}$/, hint: "+40 721234567" },
            "RUSSIA": { regex: /^\+79\d{9}$/, hint: "+7 9123456789" },
            "RWANDA": { regex: /^\+2507\d{8}$/, hint: "+250 781234567" },
            "SAUDI ARABIA": { regex: /^\+9665\d{8}$/, hint: "+966 501234567" },
            "SENEGAL": { regex: /^\+221\d{9}$/, hint: "+221 771234567" },
            "SERBIA": { regex: /^\+3816\d{7,8}$/, hint: "+381 641234567" },
            "SEYCHELLES": { regex: /^\+248\d{7}$/, hint: "+248 2512345" },
            "SIERRA LEONE": { regex: /^\+232\d{8}$/, hint: "+232 76123456" },
            "SINGAPORE": { regex: /^\+65\d{8}$/, hint: "+65 81234567" },
            "SLOVAKIA": { regex: /^\+4219\d{8}$/, hint: "+421 901234567" },
            "SLOVENIA": { regex: /^\+386\d{8}$/, hint: "+386 41123456" },
            "SOMALIA": { regex: /^\+252\d{8,9}$/, hint: "+252 615123456" },
            "SOUTH AFRICA": { regex: /^\+27\d{9}$/, hint: "+27 821234567" },
            "SOUTH KOREA": { regex: /^\+8210\d{8}$/, hint: "+82 1012345678" },
            "SOUTH SUDAN": { regex: /^\+2119\d{8}$/, hint: "+211 912345678" },
            "SPAIN": { regex: /^\+346\d{8}$/, hint: "+34 612345678" },
            "SRI LANKA": { regex: /^\+947\d{8}$/, hint: "+94 771234567" },
            "SUDAN": { regex: /^\+249\d{9}$/, hint: "+249 912345678" },
            "SURINAME": { regex: /^\+597\d{7}$/, hint: "+597 8123456" },
            "SWEDEN": { regex: /^\+467\d{8}$/, hint: "+46 701234567" },
            "SWITZERLAND": { regex: /^\+417\d{8}$/, hint: "+41 791234567" },
            "SYRIA": { regex: /^\+9639\d{8}$/, hint: "+963 941234567" },
            "TAIWAN": { regex: /^\+8869\d{8}$/, hint: "+886 912345678" },
            "TAJIKISTAN": { regex: /^\+9929\d{8}$/, hint: "+992 901234567" },
            "TANZANIA": { regex: /^\+255\d{9}$/, hint: "+255 712345678" },
            "THAILAND": { regex: /^\+66\d{9}$/, hint: "+66 812345678" },
            "TIMOR-LESTE": { regex: /^\+6707\d{7}$/, hint: "+670 77123456" },
            "TOGO": { regex: /^\+228\d{8}$/, hint: "+228 90123456" },
            "TUNISIA": { regex: /^\+216\d{8}$/, hint: "+216 20123456" },
            "TURKEY": { regex: /^\+905\d{9}$/, hint: "+90 5321234567" },
            "TURKMENISTAN": { regex: /^\+9936\d{7}$/, hint: "+993 65123456" },
            "UAE": { regex: /^\+9715\d{8}$/, hint: "+971 501234567" },
            "UGANDA": { regex: /^\+2567\d{8}$/, hint: "+256 771234567" },
            "UK": { regex: /^\+447\d{9}$/, hint: "+44 7912345678" },
            "UKRAINE": { regex: /^\+380\d{9}$/, hint: "+380 501234567" },
            "URUGUAY": { regex: /^\+5989\d{8}$/, hint: "+598 99123456" },
            "USA": { regex: /^\+1\d{10}$/, hint: "+1 2121234567" },
            "UZBEKISTAN": { regex: /^\+9989\d{8}$/, hint: "+998 901234567" },
            "VENEZUELA": { regex: /^\+584\d{9}$/, hint: "+58 4121234567" },
            "VIETNAM": { regex: /^\+84\d{9}$/, hint: "+84 901234567" },
            "YEMEN": { regex: /^\+9677\d{8}$/, hint: "+967 712345678" },
            "ZAMBIA": { regex: /^\+2609\d{8}$/, hint: "+260 971234567" },
            "ZIMBABWE": { regex: /^\+2637\d{8}$/, hint: "+263 771234567" },
            "OTHER": { regex: /^\+\d{8,15}$/, hint: "+ [CountryCode][Number]" }
        };

        window.onload = function() {
            setSkillMode('Unskilled'); 
            setupListeners();
            const rId = Math.random().toString(36).substr(2, 9).toUpperCase();
            document.getElementById('refId').innerText = rId;
            document.getElementById('barcodeRef').innerText = "*" + rId + "*";
            
            populateCountryDropdowns();
            renderTargetCountries();
            renderAdvisors();
            updateTimeSlots();
            
            const expSelect = document.getElementById('experience');
            if(expSelect) {
                for(let i=1; i<=30; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = i;
                    expSelect.appendChild(opt);
                }
            }
            
            selectCountry("UAE", "residence");
            
            toggleCvUpload(true);
            
            // --- DOB FIXES ---
            const today = new Date();
            const minAgeDate = new Date(today.getFullYear() - 20, today.getMonth(), today.getDate()); // Must be at least 20
            const maxAgeDate = new Date(today.getFullYear() - 60, today.getMonth(), today.getDate()); // Max age 60

            flatpickr("#dob", {
                dateFormat: "d/m/Y",
                disableMobile: true, // Force Custom UI to ensure Year visibility
                altInput: true,
                altFormat: "F j, Y",
                animate: false, // Disable animation for smoother year switching
                maxDate: minAgeDate, // Block dates that make user < 20
                minDate: maxAgeDate,
                defaultDate: new Date(today.getFullYear() - 25, 0, 1),
                theme: "airbnb",
                onChange: function(selectedDates, dateStr, instance) {
                    if(selectedDates.length > 0) {
                        const birthDate = selectedDates[0];
                        let age = today.getFullYear() - birthDate.getFullYear();
                        const m = today.getMonth() - birthDate.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                            age--;
                        }
                        
                        const el = document.getElementById('age');
                        const errEl = document.getElementById('ageError');
                        el.value = age;
                        
                        // Strict Age Validation Update
                        if(age < 20 || age > 60) {
                            el.classList.add('invalid-field');
                            errEl.classList.remove('hidden');
                            errEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Eligibility: 20-60 years only.';
                        } else {
                            el.classList.remove('invalid-field');
                            el.classList.add('valid-field');
                            errEl.classList.add('hidden');
                        }
                    }
                }
            });
            
            const maxBookingDate = new Date();
            maxBookingDate.setDate(maxBookingDate.getDate() + 20);

            flatpickr("#bookingDate", {
                inline: true,
                dateFormat: "d/m/Y",
                minDate: "today",
                maxDate: maxBookingDate,
                disableMobile: true,
                animate: true,
                disable: [
                    function(date) {
                        return (date.getDay() === 0);
                    }
                ],
                theme: "airbnb",
                onChange: function(selectedDates, dateStr) {
                    document.getElementById('bookingDate').value = dateStr;
                    updateTimeSlots();
                }
            });
            
            flatpickr("#passportExp", { 
                dateFormat: "d/m/Y", 
                disableMobile: false,
                altInput: true,
                altFormat: "F j, Y",
                minDate: "today",
                theme: "airbnb" 
            });
            
            handleResidenceChange();
            
            // Initial check to lock calendar
            checkCalendarLock();

            if (typeof Lenis !== 'undefined') {
                const lenis = new Lenis({ duration: 1.2, smooth: true });
                function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
                requestAnimationFrame(raf);
            }
        };

        function setupListeners() {
            document.getElementById('sameAsMobile').addEventListener('change', function() {
                if(this.checked) {
                    const m = document.getElementById('mobile');
                    const w = document.getElementById('whatsapp');
                    w.value = m.value;
                    validatePhone('whatsapp');
                }
            });
            
            document.addEventListener('click', function(event) {
                const jobDropdown = document.getElementById('customJobSelect');
                const jobList = document.getElementById('jobDropdownList');
                if (jobDropdown && !jobDropdown.contains(event.target)) {
                    jobList.classList.add('hidden');
                    document.getElementById('jobDropdownIcon').classList.remove('rotate-180');
                }

                ['nationality', 'residence'].forEach(type => {
                    const wrapper = document.getElementById(type + 'Wrapper');
                    const list = document.getElementById(type + 'List');
                    const arrow = document.getElementById(type + 'Arrow');
                    if(wrapper && !wrapper.contains(event.target)) {
                        list.classList.add('hidden');
                        if(arrow) arrow.classList.remove('rotate-180');
                    }
                });
            });
        }

        function selectTargetCountry(name, el) {
            document.getElementById('targetCountry').value = name;
            const pills = document.querySelectorAll('.country-pill');
            pills.forEach(p => {
                p.classList.remove('selected', 'ring-2', 'ring-brand-primary', 'bg-indigo-50');
                p.classList.add('bg-white');
                p.querySelector('.check-icon').classList.add('opacity-0');
            });
            
            el.classList.remove('bg-white');
            el.classList.add('selected', 'ring-2', 'ring-brand-primary', 'bg-indigo-50');
            el.querySelector('.check-icon').classList.remove('opacity-0');
        }

        // --- MISSING FUNCTION ADDED HERE ---
        function renderTargetCountries() {
            const sContainer = document.getElementById('schengenContainer');
            const nsContainer = document.getElementById('nonSchengenContainer');
            
            if(!sContainer || !nsContainer) return;
            
            sContainer.innerHTML = '';
            nsContainer.innerHTML = '';

            targetCountries.forEach(country => {
                const btn = document.createElement('button');
                btn.className = `country-pill group relative flex flex-col items-center justify-center p-3 rounded-2xl border border-slate-100 bg-white shadow-sm transition-all duration-300 ${country.color}`;
                btn.onclick = function() { selectTargetCountry(country.name, this); };
                
                btn.innerHTML = `
                    <span class="text-2xl mb-1 filter drop-shadow-sm group-hover:scale-110 transition-transform">${country.icon}</span>
                    <span class="text-[9px] font-bold text-slate-600 uppercase tracking-tight">${country.name}</span>
                    <div class="check-icon absolute top-1 right-1 w-4 h-4 rounded-full bg-brand-primary text-white flex items-center justify-center text-[8px] shadow-sm opacity-0 transition-all duration-300">
                        <i class="fa-solid fa-check"></i>
                    </div>
                `;

                if(country.type === 'schengen') {
                    sContainer.appendChild(btn);
                } else {
                    nsContainer.appendChild(btn);
                }
            });
        }
        // -----------------------------------

        function renderAdvisors() {
            const grid = document.getElementById('advisorGrid');
            if(!grid) return;
            grid.innerHTML = '';
            
            const palettes = [
                { 
                    bg: 'bg-gradient-to-r from-rose-50 to-pink-50', 
                    border: 'border-rose-100', 
                    hover: 'hover:border-rose-300 hover:shadow-rose-100', 
                    selected: 'ring-2 ring-rose-500 !bg-gradient-to-r !from-rose-100 !to-pink-100',
                    iconBg: 'bg-white text-rose-500',
                    text: 'text-rose-700',
                    subtext: 'text-rose-400',
                    tag: 'bg-white/80 text-rose-600 border-rose-200',
                    check: 'bg-rose-500'
                },
                { 
                    bg: 'bg-gradient-to-r from-violet-50 to-indigo-50', 
                    border: 'border-violet-100', 
                    hover: 'hover:border-violet-300 hover:shadow-violet-100', 
                    selected: 'ring-2 ring-violet-500 !bg-gradient-to-r !from-violet-100 !to-indigo-100',
                    iconBg: 'bg-white text-violet-500',
                    text: 'text-violet-700',
                    subtext: 'text-violet-400',
                    tag: 'bg-white/80 text-violet-600 border-violet-200',
                    check: 'bg-violet-500'
                },
                { 
                    bg: 'bg-gradient-to-r from-amber-50 to-orange-50', 
                    border: 'border-orange-100', 
                    hover: 'hover:border-orange-300 hover:shadow-orange-100', 
                    selected: 'ring-2 ring-orange-500 !bg-gradient-to-r !from-amber-100 !to-orange-100',
                    iconBg: 'bg-white text-orange-500',
                    text: 'text-orange-700',
                    subtext: 'text-orange-400',
                    tag: 'bg-white/80 text-orange-600 border-orange-200',
                    check: 'bg-orange-500'
                },
                { 
                    bg: 'bg-gradient-to-r from-blue-50 to-indigo-50', 
                    border: 'border-blue-100', 
                    hover: 'hover:border-blue-300 hover:shadow-blue-100', 
                    selected: 'ring-2 ring-brand-primary !bg-gradient-to-r !from-blue-100 !to-indigo-100',
                    iconBg: 'bg-white text-brand-primary',
                    text: 'text-brand-primary',
                    subtext: 'text-blue-400',
                    tag: 'bg-white/80 text-blue-600 border-blue-200',
                    check: 'bg-brand-primary'
                }
            ];
            
            advisors.forEach((adv, index) => {
                const theme = palettes[index % palettes.length];
                const div = document.createElement('div');
                // UPDATED: Adjusted padding and layout for 2-column grid
                div.className = `relative rounded-2xl border p-3 cursor-pointer transition-all duration-300 flex flex-col items-center text-center gap-2 group shadow-sm hover:-translate-y-1 h-full ${theme.bg} ${theme.border} ${theme.hover}`;
                div.dataset.activeClasses = theme.selected;
                div.dataset.baseClasses = div.className;
                
                div.onclick = () => selectAdvisor(adv.name, div);
                
                let avatarContent = `<span class="relative z-10">${adv.flag}</span>`;
                if(adv.isLogo) {
                    avatarContent = `<img src="https://raw.githubusercontent.com/sujeshunni-del/bettercall/6673d6ec4830e402627b97c4adf422593b2ec907/Bettercall%20Logo%20SVG%2003.svg" class="w-full h-full object-contain p-1 relative z-10">`;
                }

                div.innerHTML = `
                    <div class="w-12 h-12 rounded-full ${theme.iconBg} flex items-center justify-center text-xl shadow-sm border-2 border-white shrink-0 relative overflow-hidden">
                        ${avatarContent}
                        <div class="absolute inset-0 bg-current opacity-10"></div>
                    </div>
                    <div class="w-full">
                        <h4 class="text-xs font-black ${theme.text} uppercase tracking-tight truncate">${adv.name}</h4>
                        <p class="text-[9px] font-bold ${theme.subtext} uppercase tracking-wider mb-1.5">Senior Consultant</p>
                        <div class="flex flex-wrap justify-center gap-1">
                            ${adv.lang.split(',').slice(0, 1).map(l => `<span class="text-[8px] font-bold px-1.5 py-0.5 rounded-md border ${theme.tag} shadow-sm">${l.trim()}</span>`).join('')}
                            ${adv.lang.split(',').length > 1 ? `<span class="text-[8px] font-bold px-1.5 py-0.5 rounded-md border ${theme.tag} shadow-sm">+${adv.lang.split(',').length - 1}</span>` : ''}
                        </div>
                    </div>
                    <div class="opacity-0 group-[.selected-card]:opacity-100 transition-all duration-300 transform scale-50 group-[.selected-card]:scale-100 absolute top-2 right-2">
                         <div class="w-5 h-5 rounded-full ${theme.check} text-white flex items-center justify-center text-[10px] shadow-md ring-2 ring-white">
                            <i class="fa-solid fa-check"></i>
                         </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function selectAdvisor(name, el) {
            document.getElementById('selectedAdvisor').value = name;
            const grid = document.getElementById('advisorGrid');
            Array.from(grid.children).forEach(child => {
                child.className = child.dataset.baseClasses;
                child.classList.remove('selected-card');
            });
            const activeClasses = el.dataset.activeClasses.split(' ');
            el.classList.add(...activeClasses);
            el.classList.add('selected-card');
            
            checkCalendarLock(); // Check if we can unlock
            updateTimeSlots();
        }

        function selectMethod(method, el) {
            document.getElementById('selectedMethod').value = method;
            const allCards = document.querySelectorAll('.method-card');
            allCards.forEach(c => {
                // ... existing styles reset ...
                // Reset card base style
                c.className = 'method-card p-4 rounded-2xl bg-white border border-slate-200 flex items-center gap-4 cursor-pointer transition-all duration-300 hover:shadow-md group';
                
                const wrapper = c.querySelector('.icon-wrapper');
                if (wrapper) {
                    wrapper.className = 'icon-wrapper w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 transition-all duration-300 group-hover:scale-110 shrink-0';
                }
                
                const lbl = c.querySelector('.label-text');
                const text = lbl ? lbl.innerText : '';
                
                // Add specific hover colors based on type
                if(text === 'In-Office' && wrapper) {
                    wrapper.classList.add('group-hover:text-brand-primary', 'bg-blue-50');
                }
                if(text === 'Video Call' && wrapper) {
                    wrapper.classList.add('group-hover:text-purple-600', 'bg-purple-50');
                }
                
                if (lbl) {
                    lbl.className = 'label-text block text-xs font-bold text-slate-700 transition-colors duration-300';
                }
            });

            // Active State for Selected Card
            el.classList.remove('bg-white', 'border-slate-200');
            el.classList.add('ring-2', 'shadow-lg', 'scale-[1.02]');
            
            const wrapper = el.querySelector('.icon-wrapper');
            const lbl = el.querySelector('.label-text');
            
            if (wrapper) {
                wrapper.classList.remove('bg-slate-50', 'text-slate-400');
            }
            if (lbl) {
                lbl.classList.remove('text-slate-700');
            }

            if(method === 'In-Person') {
                el.classList.add('bg-blue-50', 'border-blue-500', 'ring-blue-400');
                if(wrapper) wrapper.classList.add('bg-blue-500', 'text-white', 'shadow-lg', 'shadow-blue-200');
                if(lbl) lbl.classList.add('text-blue-700');
            } else { 
                // Video Call
                el.classList.add('bg-purple-50', 'border-purple-500', 'ring-purple-400');
                if(wrapper) wrapper.classList.add('bg-purple-500', 'text-white', 'shadow-lg', 'shadow-purple-200');
                if(lbl) lbl.classList.add('text-purple-700');
            }
            
            checkCalendarLock(); // Check if we can unlock
            updateTimeSlots();
        }

        function checkCalendarLock() {
            const advisor = document.getElementById('selectedAdvisor').value;
            const method = document.getElementById('selectedMethod').value;
            const overlay = document.getElementById('calendarOverlay');
            
            if (advisor && method) {
                // Unlock
                overlay.classList.add('opacity-0', 'pointer-events-none', 'scale-90');
                overlay.classList.remove('backdrop-blur-sm');
            } else {
                // Lock
                overlay.classList.remove('opacity-0', 'pointer-events-none', 'scale-90');
                overlay.classList.add('backdrop-blur-sm');
            }
        }

        async function updateTimeSlots() {
            const advisor = document.getElementById('selectedAdvisor').value;
            const dateStr = document.getElementById('bookingDate').value;
            const method = document.getElementById('selectedMethod').value;
            const grid = document.getElementById('timeSlotGrid');

            if (!dateStr) {
                grid.innerHTML = '<div class="col-span-3 text-center p-6 text-slate-400 text-xs font-bold">Select a date to view slots</div>';
                return;
            }

            const advisorObj = advisors.find(a => a.name === advisor);
            if (advisorObj && advisorObj.calId && CAL_CONFIG[advisorObj.calId]) {
                let slug = '30min'; 
                if (method === 'Video Call') slug = 'google-meet';

                await fetchAndRenderCalSlots(advisorObj.calId, dateStr, slug);
            } else {
                renderStaticTimeSlots();
            }
        }

        async function fetchAndRenderCalSlots(advisorCalId, dateStr, slug) {
            const apiKey = CAL_CONFIG[advisorCalId];
            const grid = document.getElementById('timeSlotGrid');
            
            grid.innerHTML = '<div class="col-span-3 text-center p-8 flex flex-col items-center justify-center"><i class="fa-solid fa-circle-notch fa-spin text-brand-primary text-2xl mb-2"></i><p class="text-xs text-slate-400 font-bold tracking-wide">SYNCING WITH CALENDAR...</p></div>';

            try {
                let eventTypeId = eventTypeCache[`${advisorCalId}_${slug}`];
                if (!eventTypeId) {
                    const typeRes = await fetch(`https://api.cal.com/v1/event-types?apiKey=${apiKey}`);
                    if(!typeRes.ok) throw new Error("Failed to fetch event types");
                    
                    const typeData = await typeRes.json();
                    const typeObj = typeData.event_types.find(t => t.slug === slug);
                    
                    if (typeObj) {
                        eventTypeId = typeObj.id;
                        eventTypeCache[`${advisorCalId}_${slug}`] = eventTypeId;
                    } else {
                        const fallback = typeData.event_types.find(t => t.slug === '30min') || typeData.event_types[0];
                        if(fallback) {
                            eventTypeId = fallback.id;
                            eventTypeCache[`${advisorCalId}_${slug}`] = eventTypeId;
                        } else {
                            throw new Error("No matching event type found");
                        }
                    }
                }

                const [day, month, year] = dateStr.split('/');
                const startDate = new Date(`${year}-${month}-${day}T00:00:00Z`);
                const endDate = new Date(`${year}-${month}-${day}T23:59:59Z`);
                
                const startTimeIso = startDate.toISOString();
                const endTimeIso = endDate.toISOString();

                const slotsUrl = `https://api.cal.com/v1/slots?apiKey=${apiKey}&eventTypeId=${eventTypeId}&startTime=${startTimeIso}&endTime=${endTimeIso}`;
                const slotsRes = await fetch(slotsUrl);
                if(!slotsRes.ok) throw new Error("Failed to fetch slots");
                
                const slotsData = await slotsRes.json();
                
                const apiDateKey = `${year}-${month}-${day}`;
                const rawSlots = slotsData.slots ? (slotsData.slots[apiDateKey] || []) : [];

                if (rawSlots.length === 0) {
                    grid.innerHTML = '<div class="col-span-3 text-center p-6 text-slate-400 text-xs font-bold">No slots available for this date.</div>';
                    return;
                }

                grid.innerHTML = '';
                
                rawSlots.forEach(slot => {
                    const slotDate = new Date(slot.time);
                    const timeStr = slotDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    
                    const btn = document.createElement('button');
                    btn.className = "time-slot py-3 md:py-4 rounded-xl text-xs md:text-sm font-bold text-slate-600 bg-white border border-slate-200 shadow-sm transition-all hover:scale-[1.02] hover:shadow-md hover:border-brand-primary/30";
                    btn.innerText = timeStr;
                    btn.onclick = () => selectTime(timeStr, btn, slot.time); 
                    grid.appendChild(btn);
                });

            } catch (e) {
                console.error("Cal.com sync failed:", e);
                renderStaticTimeSlots(); 
                const warn = document.createElement('div');
                warn.className = "col-span-3 text-[9px] text-red-400 text-center font-bold mt-1";
                warn.innerText = "Offline Mode (Live sync failed)";
                grid.appendChild(warn);
            }
        }

        function renderStaticTimeSlots() {
            const grid = document.getElementById('timeSlotGrid');
            if(!grid) return;
            grid.innerHTML = ''; 
            const startHour = 10;
            const endHour = 19; 
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeStr = `${h > 12 ? h - 12 : h}:${m === 0 ? '00' : m} ${h >= 12 ? 'PM' : 'AM'}`;
                    const btn = document.createElement('button');
                    btn.className = "time-slot py-3 md:py-4 rounded-xl text-xs md:text-sm font-bold text-slate-600 bg-white border border-slate-200 shadow-sm transition-all hover:scale-[1.02] hover:shadow-md hover:border-brand-primary/30";
                    btn.innerText = timeStr;
                    btn.onclick = () => selectTime(timeStr, btn, null);
                    grid.appendChild(btn);
                }
            }
        }

        function selectTime(time, el, isoTime) {
            document.getElementById('selectedTime').value = time;
            document.getElementById('selectedTimeIso').value = isoTime || "";
            document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function goToStep2() {
            const fName = document.getElementById('firstName');
            const lName = document.getElementById('lastName');
            const email = document.getElementById('email');
            const mobile = document.getElementById('mobile');
            const whatsapp = document.getElementById('whatsapp');
            const ageEl = document.getElementById('age');

            validateName(fName, 'firstNameError');
            validateName(lName, 'lastNameError');
            validateEmail(email, 'emailError', true);
            validatePhone('mobile');
            validatePhone('whatsapp');

            const requiredFields = [fName, lName, email, mobile, whatsapp, document.getElementById('dob')];
            let firstEmpty = null;
            
            requiredFields.forEach(el => {
                if(!el.value) {
                    el.classList.add('invalid-field');
                    if(!firstEmpty) firstEmpty = el;
                }
            });

            if(firstEmpty) {
                showModal("Please fill in all required fields.");
                firstEmpty.focus();
                return;
            }

            const invalidElements = document.querySelectorAll('.invalid-field');
            if(invalidElements.length > 0) {
                showModal("Please correct the highlighted errors before proceeding.");
                invalidElements[0].focus();
                return;
            }

            const age = parseInt(ageEl.value);
            if(isNaN(age) || age < 20 || age > 60) { 
                showModal("Sorry, you are not eligible. (Age requirement: 20-60 years)"); 
                ageEl.scrollIntoView({behavior: "smooth", block: "center"});
                return; 
            }

            const mVal = mobile.value.replace(/\s/g, '');
            if(currentPhoneRegex && !currentPhoneRegex.test(mVal)) {
                showModal("Invalid Mobile Number Format. Please check the country code and length."); 
                mobile.focus();
                return;
            }

            const altEl = document.getElementById('altPhone');
            if(altEl && altEl.value.length > 5) {
                const altVal = altEl.value.replace(/\s/g, '');
                if(altVal === mVal) {
                    showModal("Alternative number must be different from mobile number.");
                    altEl.focus();
                    return;
                }
            }

            document.getElementById('tab-1').classList.add('hidden');
            document.getElementById('tab-2').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            updateStepIndicator(2);
            
            const name = fName.value + " " + lName.value;
            document.getElementById('reportName').innerText = name || "TEST USER";
            document.getElementById('avatarInitial').innerText = (name.charAt(0) || "T");
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function goToStep3() {
            document.getElementById('tab-2').classList.add('hidden');
            document.getElementById('tab-3').classList.remove('hidden');
            window.scrollTo(0, 0); // Instant scroll to top to prevent "coming down" issue
            updateStepIndicator(3);
        }
        
        function exitApp() {
            const modalContent = `
                <div class="text-center p-2">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                        <i class="fa-solid fa-earth-americas text-3xl text-brand-primary"></i>
                    </div>
                    <h3 class="text-xl font-black text-slate-800 mb-2">Explore Possibilities</h3>
                    <p class="text-slate-500 text-sm mb-6">Redirecting you to our comprehensive global program listings...</p>
                    <div class="h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-brand-primary w-1/2 animate-[pulse_1s_infinite]"></div>
                    </div>
                </div>
            `;
            
            const m = document.getElementById('messageModal');
            document.getElementById('modalContent').innerHTML = modalContent;
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('.modal-content').classList.add('scale-100'); }, 10);

            setTimeout(() => {
                window.location.href = "https://bettercall.online";
            }, 2000);
        }

        function updateStepIndicator(step) {
             const update = (id, active) => {
                const el = document.getElementById(id);
                const box = el.querySelector('div');
                const txt = el.querySelector('span');
                
                if (active) {
                    el.classList.remove('opacity-40', 'grayscale');
                    box.classList.remove('border-gray-200', 'text-gray-500', 'bg-white/40');
                    box.classList.add('border-brand-primary', 'text-brand-primary', 'bg-white/80', 'backdrop-blur', 'shadow-lg');
                    txt.classList.remove('text-slate-500');
                    txt.classList.add('text-brand-primary');
                } else {
                    el.classList.add('opacity-40', 'grayscale');
                    box.classList.add('border-gray-200', 'text-gray-500', 'bg-white/40');
                    box.classList.remove('border-brand-primary', 'text-brand-primary', 'bg-white/80', 'backdrop-blur', 'shadow-lg');
                    txt.classList.add('text-slate-500');
                    txt.classList.remove('text-brand-primary');
                }
            }
            update('step-2-indicator', step >= 2);
            update('step-3-indicator', step >= 3);
        }

        function toggleCvUpload(show) {
            const container = document.getElementById('cvUploadContainer');
            if(show) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                document.getElementById('cvFile').value = '';
            }
        }
        
        function handleFileSelect(input) {
            const file = input.files[0];
            const display = document.getElementById('fileNameDisplay');
            if(file) {
                if(file.size > 5 * 1024 * 1024) { showModal("File size exceeds 5MB limit."); input.value = ''; return; }
                display.innerText = file.name;
                display.classList.add('text-brand-primary');
            }
        }

        function populateCountryDropdowns() {
              const sortedCountries = Object.keys(countryRules).sort();
            const buildList = (type) => {
                const list = document.getElementById(type + 'List');
                if(!list) return;
                list.innerHTML = '';
                const searchBox = document.createElement('div');
                searchBox.className = "sticky top-0 bg-white/95 backdrop-blur-sm p-3 border-b border-gray-100 z-10";
                searchBox.innerHTML = `
                    <div class="relative group">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs group-focus-within:text-brand-primary transition-colors"></i>
                        <input type="text" placeholder="Search Country..." 
                            class="w-full pl-9 pr-3 py-2.5 text-xs font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:bg-white focus:ring-2 focus:ring-brand-primary/10 transition-all placeholder:text-slate-400 placeholder:font-semibold uppercase"
                            onkeyup="filterCountries(this, '${type}')" onclick="event.stopPropagation()">
                    </div>
                `;
                list.appendChild(searchBox);
                const itemsWrapper = document.createElement('div');
                itemsWrapper.id = type + 'Items';
                sortedCountries.forEach(c => {
                    if(c === 'OTHER') return;
                    const div = document.createElement('div');
                    div.className = "country-option px-5 py-3 text-xs md:text-sm text-slate-600 hover:bg-blue-50 hover:text-brand-primary cursor-pointer border-b border-gray-50 last:border-0 transition-colors font-bold uppercase block";
                    div.innerText = c;
                    div.onclick = function() { selectCountry(c, type); };
                    itemsWrapper.appendChild(div);
                });
                const otherDiv = document.createElement('div');
                otherDiv.className = "country-option px-5 py-3 text-xs md:text-sm text-slate-600 hover:bg-blue-50 hover:text-brand-primary cursor-pointer border-b border-gray-50 last:border-0 transition-colors font-bold uppercase block";
                otherDiv.innerText = "OTHER";
                otherDiv.onclick = function() { selectCountry("OTHER", type); };
                itemsWrapper.appendChild(otherDiv);
                list.appendChild(itemsWrapper);
            };
            buildList('nationality');
            buildList('residence');
        }

        function toggleCountryDropdown(type, event) {
              event.stopPropagation(); 
            const list = document.getElementById(type + 'List');
            const arrow = document.getElementById(type + 'Arrow');
            const otherType = type === 'nationality' ? 'residence' : 'nationality';
            const otherList = document.getElementById(otherType + 'List');
            const otherArrow = document.getElementById(otherType + 'Arrow');
            if(otherList) otherList.classList.add('hidden');
            if(otherArrow) otherArrow.classList.remove('rotate-180');
            if(list) list.classList.toggle('hidden');
            if(arrow) arrow.classList.toggle('rotate-180');
            if (list && !list.classList.contains('hidden')) {
                const searchInput = list.querySelector('input');
                if (searchInput) setTimeout(() => searchInput.focus(), 100);
            }
        }

        function filterCountries(input, type) {
             const filter = input.value.toUpperCase();
            const list = document.getElementById(type + 'Items');
            if(!list) return;
            const items = list.getElementsByClassName('country-option');
            for (let i = 0; i < items.length; i++) {
                const txt = items[i].innerText;
                if (txt.toUpperCase().indexOf(filter) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function selectCountry(val, type) {
              const hiddenInput = document.getElementById(type === 'nationality' ? 'nationality' : 'presentResidence');
            const display = document.getElementById(type + 'Display');
            const list = document.getElementById(type + 'List');
            const arrow = document.getElementById(type + 'Arrow');
            if (hiddenInput) hiddenInput.value = val;
            if (display) {
                display.innerText = val;
                display.classList.remove('text-slate-500');
                display.classList.add('text-slate-900');
            }
            if (list) list.classList.add('hidden');
            if (arrow) arrow.classList.remove('rotate-180');
            if (type === 'residence') {
                handleResidenceChange();
            }
        }

        function handleResidenceChange() {
              const sel = document.getElementById('presentResidence');
            const country = sel ? (sel.value || "OTHER") : "OTHER";
            const rule = countryRules[country] || countryRules["OTHER"];
            currentPhoneRegex = rule.regex;
            const parts = rule.hint.split(' ');
            const code = parts[0] + " "; 
            ['mobile', 'whatsapp', 'altPhone'].forEach(id => {
                const el = document.getElementById(id);
                if(el && el.value.length < 5) el.value = code;
            });
            const hintEl = document.getElementById('mobileHint');
            if(hintEl) {
                hintEl.innerText = "Format: " + rule.hint;
                hintEl.classList.remove('opacity-0');
            }
        }

        function toggleJobDropdown(e) {
              e.stopPropagation();
            const list = document.getElementById('jobDropdownList');
            const icon = document.getElementById('jobDropdownIcon');
            list.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        function selectJob(jobRole) {
             document.getElementById('currentJob').value = jobRole;
            document.getElementById('selectedJobText').innerText = jobRole;
            document.getElementById('selectedJobText').classList.remove('text-slate-500');
            document.getElementById('selectedJobText').classList.add('text-slate-900');
            document.getElementById('jobDropdownList').classList.add('hidden');
            document.getElementById('jobDropdownIcon').classList.remove('rotate-180');
        }

        function populateDropdown(mode) {
             const listContainer = document.getElementById('jobDropdownList');
            listContainer.innerHTML = '';
            const searchBox = document.createElement('div');
            searchBox.className = "sticky top-0 bg-white/95 backdrop-blur-sm p-3 border-b border-gray-100 z-10";
            searchBox.innerHTML = `
                <div class="relative group">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs group-focus-within:text-brand-primary transition-colors"></i>
                    <input type="text" placeholder="Search roles..." 
                        class="w-full pl-9 pr-3 py-2.5 text-xs font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-brand-primary focus:bg-white focus:ring-2 focus:ring-brand-primary/10 transition-all placeholder:text-slate-400 placeholder:font-semibold"
                        onkeyup="filterJobs(this)" onclick="event.stopPropagation()">
                </div>
            `;
            listContainer.appendChild(searchBox);
            const itemsWrapper = document.createElement('div');
            itemsWrapper.id = "jobItemsList";
            const typeCode = mode === 'Unskilled' ? 'U' : 'S';
            // UPDATED: Filter out duplicates
            const roles = [...new Set(jobMasterList.filter(j => j.type === typeCode).map(j => j.r))].sort();
            
            roles.forEach(r => {
                const div = document.createElement('div');
                div.className = "job-option px-4 md:px-5 py-3 md:py-3.5 text-xs md:text-sm text-slate-600 hover:bg-blue-50 hover:text-brand-primary cursor-pointer border-b border-gray-50 last:border-0 transition-colors font-bold";
                div.innerText = r;
                div.onclick = function() { selectJob(r); };
                itemsWrapper.appendChild(div);
            });
            listContainer.appendChild(itemsWrapper);
            document.getElementById('currentJob').value = "";
            document.getElementById('selectedJobText').innerText = "Select Job Role";
        }

        function filterJobs(input) {
              const filter = input.value.toUpperCase();
            const list = document.getElementById("jobItemsList");
            const items = list.getElementsByClassName("job-option");
            let visibleCount = 0;
            for (let i = 0; i < items.length; i++) {
                const txt = items[i].innerText;
                if (txt.toUpperCase().indexOf(filter) > -1) {
                    items[i].style.display = "";
                    visibleCount++;
                } else {
                    items[i].style.display = "none";
                }
            }
            let noRes = document.getElementById("noJobResults");
            if(visibleCount === 0) {
                if(!noRes) {
                    noRes = document.createElement('div');
                    noRes.id = "noJobResults";
                    noRes.className = "p-6 text-center text-xs text-slate-400 font-bold italic flex flex-col items-center gap-2 animate-pop-in";
                    noRes.innerHTML = `<i class="fa-solid fa-ghost text-lg opacity-50"></i><span>No matching roles found</span>`;
                    list.appendChild(noRes);
                }
            } else if(noRes) {
                noRes.remove();
            }
        }

        function setSkillMode(mode) {
              currentMode = mode;
            const uCard = document.getElementById('cardUnskilled');
            const sCard = document.getElementById('cardSkilled');
            const uCheck = document.getElementById('checkUnskilled');
            const sCheck = document.getElementById('checkSkilled');
            uCard.classList.remove('active'); sCard.classList.remove('active');
            uCheck.querySelector('div').classList.add('hidden'); sCheck.querySelector('div').classList.add('hidden');
            uCheck.className = sCheck.className = "w-6 h-6 md:w-8 md:h-8 rounded-full border-2 border-gray-300 flex items-center justify-center transition-all";
            if (mode === 'Unskilled') {
                uCard.classList.add('active');
                uCheck.className = "w-6 h-6 md:w-8 md:h-8 rounded-full border-brand-primary flex items-center justify-center bg-blue-100 shadow-sm";
                uCheck.querySelector('div').classList.remove('hidden');
                document.getElementById('experienceWrapper').classList.add('hidden');
            } else {
                sCard.classList.add('active');
                sCheck.className = "w-6 h-6 md:w-8 md:h-8 rounded-full border-brand-secondary flex items-center justify-center bg-purple-100 shadow-sm";
                sCheck.querySelector('div').classList.remove('hidden');
                document.getElementById('experienceWrapper').classList.remove('hidden');
            }
            document.getElementById('jobDetailsPanel').classList.remove('hidden');
            populateDropdown(mode); 
        }

        function getSalary(c, s) { const k=s==='Unskilled'?'u':'s'; return (salaryDb[c] && salaryDb[c][k]) ? salaryDb[c][k]+" / Month" : "800 - 2,000 / Month"; }

        // NEW: Helper to determine sector for smarter AI reasoning
        function getJobSector(role) {
            const r = role.toLowerCase();
            if(r.includes('engineer') || r.includes('technician') || r.includes('mechanic') || r.includes('electrician') || r.includes('operator')) return 'Industrial & Technical';
            if(r.includes('nurse') || r.includes('doctor') || r.includes('pharmacist') || r.includes('care') || r.includes('medical')) return 'Healthcare & Medical';
            if(r.includes('driver') || r.includes('transport') || r.includes('logistics')) return 'Logistics & Transport';
            if(r.includes('cook') || r.includes('chef') || r.includes('waiter') || r.includes('restaurant') || r.includes('hotel') || r.includes('bar')) return 'Hospitality & Tourism';
            if(r.includes('farm') || r.includes('agriculture') || r.includes('picker') || r.includes('harvest') || r.includes('greenhouse')) return 'Agriculture & Farming';
            if(r.includes('mason') || r.includes('carpenter') || r.includes('welder') || r.includes('construction') || r.includes('plumber') || r.includes('painter') || r.includes('steel')) return 'Construction & Infrastructure';
            if(r.includes('sales') || r.includes('manager') || r.includes('accountant') || r.includes('office') || r.includes('admin') || r.includes('clerk')) return 'Business & Administration';
            if(r.includes('warehouse') || r.includes('packer') || r.includes('loader')) return 'Warehousing & Supply Chain';
            return 'General Services';
        }

        function toggleLoader(show, title = "Processing", subtitle = "Please wait...") {
              const loader = document.getElementById('loadingOverlay');
            const t = document.getElementById('loaderTitle');
            const s = document.getElementById('loaderSubtitle');
            if(show) {
                if(t) t.innerText = title;
                if(s) s.innerText = subtitle;
                loader.classList.remove('hidden');
                void loader.offsetWidth; 
                loader.classList.remove('opacity-0');
            } else {
                loader.classList.add('opacity-0');
                setTimeout(() => loader.classList.add('hidden'), 500);
            }
        }

         async function generateReport() {
            let role = document.getElementById('currentJob').value;
            if(!role) { showModal("Please select a target position to continue."); return; }
            
            let yearsExp = 0;
            if(currentMode === 'Skilled') {
                yearsExp = parseInt(document.getElementById('experience').value);
                if(isNaN(yearsExp) || yearsExp < 1 || yearsExp > 30) { showModal("Valid experience (1-30 yrs) required for Skilled Migration."); return; }
            }
            
            toggleLoader(true, "Report Generating", "Analyzing Global Compatibility...");
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const qualRadio = document.querySelector('input[name="qualification"]:checked');
            const qual = qualRadio ? qualRadio.value : "BACHELOR"; 
            const age = parseInt(document.getElementById('age').value) || 30;
            
            document.getElementById('reportContainer').classList.remove('hidden');
            setTimeout(() => { document.getElementById('reportContainer').scrollIntoView({ behavior: 'smooth' }); }, 100);
            
            const jobData = jobMasterList.find(j => j.r === role);
            const sector = getJobSector(role);
            
            // 1. DYNAMIC SCORE CALCULATION
            let score = 82; // Base score
            
            // Age Weighting
            if(age >= 24 && age <= 35) score += 8;
            else if(age >= 36 && age <= 45) score += 5;
            else if(age > 50) score -= 5;
            
            // Experience Weighting (Dependent on Mode)
            if(currentMode === 'Skilled') {
                if(yearsExp >= 5) score += 8;
                else if(yearsExp >= 3) score += 5;
                else if(yearsExp < 2) score -= 3;
            } else {
                // Unskilled: Less focus on exp, more on age/fitness implied by age
                if(age < 40) score += 5;
            }
            
            // Country Specific Weighting (Sample logic)
            if(['GERMANY', 'SWEDEN', 'NETHERLANDS'].includes(jobData.c) && currentMode === 'Skilled') score -= 2; // Harder entry
            if(['POLAND', 'CROATIA', 'LITHUANIA'].includes(jobData.c)) score += 3; // Easier entry
            
            // Cap Score
            score = Math.min(Math.max(score, 65), 99);
            
            // UPDATE SCORE UI
            const scoreEl = document.querySelector('.text-3xl.font-black.text-brand-primary.tracking-tighter');
            const barEl = document.querySelector('.w-\\[98\\%\\]'); // Selector for the bar inside the rounded-full div
            
            if(scoreEl) scoreEl.innerText = score + "%";
            // Find the progress bar inner div safely
            const progressContainer = scoreEl.parentElement.nextElementSibling; 
            if(progressContainer) {
                const bar = progressContainer.firstElementChild;
                if(bar) bar.style.width = score + "%";
            }

            // 2. FILL DATA
            document.getElementById('topMatchCountry').innerText = jobData.c;
            document.getElementById('reportRole').innerText = role;
            document.getElementById('reportQualification').innerText = qual;
            document.getElementById('topMatchRole_2').innerText = role;
            document.getElementById('mainSalaryRange').innerText = getSalary(jobData.c, currentMode);
            
            let expDisplay = currentMode === 'Unskilled' ? "Entry Level" : yearsExp + " Years";
            document.getElementById('reportExp').innerText = expDisplay;

            // 3. GENERATE REASONING
            const reasoning = document.getElementById('aiReasoning');
            let text = "";
            
            if(currentMode === 'Unskilled') {
                text = `The ${sector} sector in ${jobData.c} is currently experiencing critical labor shortages. `;
                text += `Candidates applying for ${role} roles have a high approval probability (${score}%) regardless of prior academic tenure. `;
                text += `Your profile matches the demand criteria for the D-Type work permit category.`;
            } else {
                text = `Your profile indicates strong potential for the ${sector} industry in ${jobData.c}. `;
                if(yearsExp > 4) {
                    text += `With ${yearsExp} years of specialized experience, you qualify as a High-Value Professional, increasing visa priority. `;
                } else {
                    text += `With ${yearsExp} years experience, you meet the essential skilled migration threshold. `;
                }
                text += `The ${jobData.c} market offers long-term residency pathways for ${role}s with your specific qualification background.`;
            }
            reasoning.innerText = text;

            const others = jobMasterList.filter(j => j.type === jobData.type && j.c !== jobData.c).sort(() => 0.5 - Math.random()).slice(0, 3);
            const altCountriesString = others.map(o => o.c).join(', ');
            document.getElementById('hiddenPrimaryMatch').value = jobData.c;
            document.getElementById('hiddenAltMatches').value = altCountriesString;
            await saveData(false, false);
            toggleLoader(false);
        }

        async function saveData(showSuccess = true, useLoader = true) {
            if (globalTaskId) return true; 
            if (useLoader) {
                toggleLoader(true, "Synchronizing Profile", "SECURE HANDSHAKE :: CLICKUP_DB_SYNC");
            }

            // 1. NAME SEPARATION (Don't Combine)
            const firstName = document.getElementById('firstName').value.toUpperCase();
            const lastName = document.getElementById('lastName').value.toUpperCase();
            
            const taskName = firstName; 

            const dobVal = getUnixTime(document.getElementById('dob').value);
            const passExpVal = getUnixTime(document.getElementById('passportExp').value);
            
            // Get values 
            const qual = document.querySelector('input[name="qualification"]:checked');
            const qualVal = qual ? qual.value : null;
            const targetCountry = document.getElementById('targetCountry').value;
            const nationality = document.getElementById('nationality').value;
            const residence = document.getElementById('presentResidence').value;
            const jobRole = document.getElementById('currentJob').value;

            // CLEAN PHONE NUMBERS (Remove spaces/tabs)
            const cleanPhone = (val) => val ? val.replace(/\s+/g, '').trim() : "";
            
            const mobileVal = cleanPhone(document.getElementById('mobile').value);
            const whatsappVal = cleanPhone(document.getElementById('whatsapp').value);
            const altPhoneRaw = cleanPhone(document.getElementById('altPhone').value);

            // 2. BASE FIELDS (Text/Number/Date)
            let customFieldsArray = [
                { id: CLICKUP_FIELDS["SUR NAME"], value: lastName }, 
                { id: CLICKUP_FIELDS["EMAIL"], value: document.getElementById('email').value },
                { id: CLICKUP_FIELDS["AGE"], value: parseInt(document.getElementById('age').value) || 0 },
                { id: CLICKUP_FIELDS["EXPERIENCE"], value: parseInt(document.getElementById('experience').value) || 0 },
                { id: CLICKUP_FIELDS["Case Reference ID"], value: document.getElementById('refId').innerText }
            ];

            // Only add Phone numbers if they are valid
            if(mobileVal && mobileVal.length > 7) {
                customFieldsArray.push({ id: CLICKUP_FIELDS["MOBILE"], value: mobileVal });
            }
            if(whatsappVal && whatsappVal.length > 7) {
                customFieldsArray.push({ id: CLICKUP_FIELDS["WHATSAPP"], value: whatsappVal });
            }
            if(altPhoneRaw && altPhoneRaw.length > 7) {
                customFieldsArray.push({ id: CLICKUP_FIELDS["PHONE"], value: altPhoneRaw });
            }

            if(document.getElementById('passportNo').value) {
                customFieldsArray.push({ id: CLICKUP_FIELDS["PASSPORT NUMBER"], value: document.getElementById('passportNo').value });
            }
            
            if(dobVal) {
                customFieldsArray.push({ id: CLICKUP_FIELDS["DATE OF BIRTH"], value: dobVal });
            }
            if(passExpVal) {
                customFieldsArray.push({ id: CLICKUP_FIELDS["PASSPORT EXPIRY"], value: passExpVal });
            }

            // 3. DYNAMIC DROPDOWN MAPPING (Fixed logic from appointment.html)
            try {
                // Fetch field definitions to get Option IDs
                const fieldRes = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/field`, { 
                    headers: { 'Authorization': CLICKUP_API_KEY } 
                });
                
                if(fieldRes.ok) {
                    const fieldData = await fieldRes.json();
                    const fieldDefs = fieldData.fields || [];

                    const addDropdown = (key, val) => {
                        if(!val) return;
                        const fid = CLICKUP_FIELDS[key];
                        const def = fieldDefs.find(f => f.id === fid);
                        
                        if(def && (def.type === 'drop_down' || def.type === 'labels')) {
                            // Find matching option by name (case-insensitive)
                            const opt = def.type_config.options.find(o => o.name.toLowerCase() === val.toLowerCase()) 
                                     || def.type_config.options.find(o => o.name === "OTHER"); // Fallback
                            
                            if(opt) {
                                customFieldsArray.push({ id: fid, value: opt.id });
                            }
                        } else if (fid) {
                            // If it's just a text field, save raw value
                            customFieldsArray.push({ id: fid, value: val });
                        }
                    };

                    // Map the problem fields
                    addDropdown("NATIONALITY", nationality);
                    addDropdown("PRESENT RESIDENCE", residence);
                    addDropdown("QUALIFICATION", qualVal);
                    addDropdown("JOB ROLE", jobRole);
                    if(targetCountry) addDropdown("TARGET_COUNTRY", targetCountry);

                } else {
                    console.warn("Failed to fetch ClickUp fields for mapping.");
                }
            } catch(e) {
                console.error("Field Mapping Error:", e);
                // Fallback: If mapping fails, try sending raw text (might fail for dropdowns but worth a try)
                if(qualVal) customFieldsArray.push({ id: CLICKUP_FIELDS["QUALIFICATION"], value: qualVal });
                if(jobRole) customFieldsArray.push({ id: CLICKUP_FIELDS["JOB ROLE"], value: jobRole });
            }
            
            const payload = {
                name: taskName, 
                description: `
**AI ASSESSMENT REPORT**
-----------------------
Primary Match: ${document.getElementById('hiddenPrimaryMatch').value}
Alternatives: ${document.getElementById('hiddenAltMatches').value}
Estimated Salary: ${document.getElementById('mainSalaryRange').innerText}

**CANDIDATE SUMMARY**
 Full Name: ${firstName} ${lastName}
 Nationality: ${nationality}
 Residence: ${residence}
 Job Role: ${jobRole}
 Qualification: ${qualVal}
 Target Country: ${targetCountry || 'Pending'}

Advisor Assigned: PENDING
-----------------------
Generated via Better Call Web App
                `.trim(),
                custom_fields: customFieldsArray
            };

            try {
                const res = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task`, {
                    method: 'POST',
                    headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if(res.ok) {
                    const data = await res.json();
                    globalTaskId = data.id; 
                    const cvInput = document.getElementById('cvFile');
                    if(cvInput.files.length > 0) {
                        const formData = new FormData();
                        formData.append("attachment", cvInput.files[0]);
                        await fetch(`https://api.clickup.com/api/v2/task/${globalTaskId}/attachment`, {
                            method: 'POST',
                            headers: { 'Authorization': CLICKUP_API_KEY },
                            body: formData
                        });
                    }
                    if(showSuccess) showToast("Profile Created Successfully");
                    return true;
                } else {
                    const err = await res.json();
                    console.error("ClickUp Error:", err);
                    if(err.ECODE === 'FIELD_016') {
                        showModal("Submission Error: Invalid Phone Number format.");
                    } else if (err.err && err.err.includes("option index")) {
                        showModal("System Error: One of the dropdown fields (Nationality/Job) does not match the options in ClickUp.");
                    } else {
                        showModal("Submission Error: " + (err.err || "Check Custom Fields configuration"));
                    }
                    return false;
                }
            } catch(e) { 
                showModal("Network Error. Please check connection.");
                return false;
            } finally {
                if (useLoader) {
                    setTimeout(() => {
                        const loader = document.getElementById('loadingOverlay');
                        loader.classList.add('opacity-0');
                        setTimeout(() => loader.classList.add('hidden'), 500);
                    }, 500); 
                }
            }
        }

        async function createCalBooking(advisorName, dateStr, timeStr, userData) {
            const advisorObj = advisors.find(a => a.name === advisorName);
            const calId = advisorObj ? advisorObj.calId : null;
            const apiKey = CAL_CONFIG[calId];
            
            if (!apiKey) {
                console.error("Cal.com API Key missing for:", advisorName);
                return { success: false, msg: "Advisor calendar configuration missing" };
            }

            try {
                let slug = '30min';
                const method = document.getElementById('selectedMethod').value;
                if(method === 'Video Call') slug = 'google-meet';

                let eventTypeId = eventTypeCache[`${calId}_${slug}`];
                if (!eventTypeId) {
                     const typeRes = await fetch(`https://api.cal.com/v1/event-types?apiKey=${apiKey}`);
                     const typeData = await typeRes.json();
                     const typeObj = typeData.event_types.find(t => t.slug === slug);
                     eventTypeId = typeObj ? typeObj.id : typeData.event_types[0].id;
                }
                
                const startTimeIso = document.getElementById('selectedTimeIso').value;
                if(!startTimeIso) throw new Error("ISO Time missing for booking");
                
                let locationData = null;

                if (method === 'Phone Call') {
                     let safePhone = userData.phone.trim();
                     if(!safePhone.startsWith('+') && safePhone.length > 5) safePhone = '+' + safePhone;
                     locationData = { value: "phone", optionValue: safePhone || "+971500000000" }; 
                } 

                // COMPACT NOTE FORMAT TO PREVENT API CHAR LIMIT ERRORS
                const aiSummary = (userData.aiAnalysis || "N/A").substring(0, 200) + (userData.aiAnalysis?.length > 200 ? "..." : "");
                
                const descriptionNote = `
CANDIDATE: ${userData.name} (${userData.age} / ${userData.nationality})
RESIDENCE: ${userData.residence}
ROLE: ${userData.role} (${userData.experience} Yrs)
TARGET: ${userData.targetCountry} | SALARY: ${userData.salaryRange}

CONTACT
Mobile: ${userData.phone}
Email: ${userData.email}
WhatsApp: ${userData.whatsapp || 'N/A'}

AI INSIGHT (REF:${userData.refId})
${aiSummary}
`.trim();

                const payload = {
                    eventTypeId: eventTypeId,
                    start: startTimeIso, 
                    responses: {
                        name: userData.name,
                        email: userData.email,
                        notes: descriptionNote 
                    },
                    metadata: { referenceId: userData.refId, targetCountry: userData.targetCountry },
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: "en",
                    title: `Consultation: ${userData.name} (${userData.targetCountry})`,
                    description: descriptionNote
                };

                if (locationData) {
                    payload.responses.location = locationData;
                }

                const bookRes = await fetch(`https://api.cal.com/v1/bookings?apiKey=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const bookData = await bookRes.json();
                
                if (!bookRes.ok) {
                    console.error("Cal.com Booking Failed:", bookData);
                    // Extract meaningful error message
                    let errMsg = bookData.message || "Booking API rejected request";
                    if(errMsg.includes('max_characters_allowed')) errMsg = "Booking notes too long (Character Limit Exceeded).";
                    return { success: false, msg: errMsg }; 
                } 
                return { success: true, data: bookData };

            } catch (error) {
                console.error("Cal.com Integration Error:", error);
                return { success: false, msg: error.message };
            }
        }

        function createICSFile(date, time, advisor) {
            const [day, month, year] = date.split('/');
            let [timePart, modifier] = time.split(' ');
            let [hours, minutes] = timePart.split(':');
            
            if (hours === '12') hours = '00';
            if (modifier === 'PM') hours = parseInt(hours, 10) + 12;
            
            const pad = (n) => n < 10 ? '0' + n : n;
            
            const startStr = `${year}${month}${day}T${pad(hours)}${minutes}00`;
            let endHours = parseInt(hours);
            let endMinutes = parseInt(minutes) + 30;
            if (endMinutes >= 60) {
                endMinutes -= 60;
                endHours += 1;
            }
            const endStr = `${year}${month}${day}T${pad(endHours)}${pad(endMinutes)}00`;

            return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Better Call Immigration//Global Mobility//EN
BEGIN:VEVENT
UID:${Date.now()}@bettercall.online
DTSTAMP:${startStr}Z
DTSTART:${startStr}
DTEND:${endStr}
SUMMARY:Consultation with ${advisor}
DESCRIPTION:Immigration Strategy Session via Better Call.
LOCATION:Better Call HQ / Online
END:VEVENT
END:VCALENDAR`;
        }

        // ADDED: generatePDF function to fix ReferenceError
        async function generatePDF() {
            const btn = document.getElementById('btn-download-pdf');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Generating Report...';
            btn.disabled = true;

            try {
                if (!window.jspdf) throw new Error("PDF Library not loaded");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // --- DESIGN CONFIG ---
                const brandPrimary = [37, 99, 235];   // #2563eb
                const brandSecondary = [124, 58, 237]; // #7c3aed
                const brandDark = [15, 23, 42];       // #0f172a
                const textGray = [71, 85, 105];       // #475569
                const bgLight = [248, 250, 252];      // #f8fafc
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let y = 0;

                // --- DATA FETCH ---
                const firstName = document.getElementById('firstName').value.toUpperCase();
                const lastName = document.getElementById('lastName').value.toUpperCase();
                const fullName = firstName + " " + lastName;
                const refId = document.getElementById('refId').innerText;
                const reportDate = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                
                const age = document.getElementById('age').value || "N/A";
                const nationality = document.getElementById('nationality').value || "N/A";
                const residence = document.getElementById('presentResidence').value || "N/A";
                const qual = document.querySelector('input[name="qualification"]:checked')?.value || "N/A";
                const role = document.getElementById('currentJob').value || "N/A";
                const exp = document.getElementById('experience').value || "0";
                
                // CRITICAL FIX: Ensure PDF data matches the FINAL selection, not just the initial AI report
                const selectedCountry = document.getElementById('targetCountry').value;
                const initialMatchCountry = document.getElementById('topMatchCountry').innerText;
                const finalCountry = selectedCountry || initialMatchCountry;

                // RECALCULATE SALARY based on final country (Fixes Sweden Header + Latvia Salary bug)
                let finalSalary = "TBD";
                if(salaryDb[finalCountry]) {
                     finalSalary = currentMode === 'Unskilled' ? salaryDb[finalCountry].u : salaryDb[finalCountry].s;
                     if(!finalSalary.includes("Month")) finalSalary += " / Month";
                } else {
                    finalSalary = document.getElementById('mainSalaryRange').innerText;
                }

                // RECALCULATE REASONING based on final country
                let finalAiText = document.getElementById('aiReasoning').innerText;
                // If the text mentions a country that isn't our final country, regenerate a generic specific string
                if(!finalAiText.includes(finalCountry) && selectedCountry) {
                     const sector = getJobSector(role);
                     if(currentMode === 'Unskilled') {
                        finalAiText = `The ${sector} sector in ${finalCountry} is currently experiencing labor shortages. Candidates applying for ${role} roles have a high approval probability regardless of prior academic tenure. Your profile matches the demand criteria for the ${finalCountry} work permit category.`;
                    } else {
                        finalAiText = `Your profile indicates strong potential for the ${sector} industry in ${finalCountry}. The ${finalCountry} market offers long-term residency pathways for ${role}s with your specific qualification background. With ${exp} years experience, you meet the essential skilled migration threshold.`;
                    }
                }

                const score = document.querySelector('.text-3xl.font-black.text-brand-primary')?.innerText || "85%";

                // Appointment Data
                const advisor = document.getElementById('selectedAdvisor').value;
                const bookDate = document.getElementById('bookingDate').value;
                const bookTime = document.getElementById('selectedTime').value;
                const bookMode = document.getElementById('selectedMethod').value;

                // --- RENDER HELPERS ---
                const drawSectionHeader = (text, yPos) => {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.setTextColor(...brandPrimary);
                    doc.text(text.toUpperCase(), margin, yPos);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(margin, yPos + 3, pageWidth - margin, yPos + 3);
                };

                const drawLabelVal = (label, value, x, y) => {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(7);
                    doc.setTextColor(150, 150, 150);
                    doc.text(label.toUpperCase(), x, y);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.setTextColor(...brandDark);
                    doc.text(value.toString(), x, y + 5);
                };

                // --- 1. HEADER ---
                // Header Background
                doc.setFillColor(...brandPrimary);
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                // Logo Area
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, 10, 20, 20, 2, 2, 'F');
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.setTextColor(...brandPrimary);
                doc.text("BC", margin + 5, 22); // Fake Logo Text

                // Company Name
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(255, 255, 255);
                doc.text("BETTER CALL", margin + 25, 18);
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.text("GLOBAL IMMIGRATION INTELLIGENCE", margin + 25, 25);
                
                // Report Details (Top Right)
                doc.setFontSize(8);
                doc.text("REPORT REFERENCE", pageWidth - margin, 15, { align: "right" });
                doc.setFont("helvetica", "bold");
                doc.text(refId, pageWidth - margin, 20, { align: "right" });
                
                doc.setFont("helvetica", "normal");
                doc.text(reportDate, pageWidth - margin, 28, { align: "right" });

                y = 60;

                // --- 2. CANDIDATE PROFILE ---
                drawSectionHeader("Professional Profile", y);
                y += 15;
                
                // Data Grid for Profile
                drawLabelVal("Full Name", fullName, margin, y);
                drawLabelVal("Nationality", nationality, margin + 60, y);
                drawLabelVal("Residence", residence, margin + 120, y);
                
                y += 15;
                drawLabelVal("Target Role", role, margin, y);
                drawLabelVal("Qualification", qual, margin + 60, y);
                drawLabelVal("Experience", `${exp} Years`, margin + 120, y);

                y += 25;

                // --- 3. AI ASSESSMENT ---
                drawSectionHeader("Strategic Viability Assessment", y);
                y += 15;

                // Assessment Box
                doc.setDrawColor(230, 230, 230);
                doc.setFillColor(...bgLight);
                doc.roundedRect(margin, y - 5, pageWidth - (margin * 2), 60, 3, 3, 'FD');

                // Country & Salary
                doc.setFont("helvetica", "bold");
                doc.setFontSize(24);
                doc.setTextColor(...brandPrimary);
                doc.text(finalCountry, margin + 10, y + 10);
                
                doc.setFontSize(8);
                doc.setTextColor(...textGray);
                doc.text("PRIMARY MARKET MATCH", margin + 10, y + 16);

                doc.setFontSize(10);
                doc.setTextColor(...brandDark);
                doc.text(`Estimated Salary: ${finalSalary}`, margin + 10, y + 26);

                // Score Badge (Right Side of Box)
                doc.setFillColor(...brandPrimary);
                doc.circle(pageWidth - margin - 30, y + 15, 16, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text(score, pageWidth - margin - 30, y + 17, { align: "center" });
                doc.setFontSize(6);
                doc.text("MATCH", pageWidth - margin - 30, y + 22, { align: "center" });

                // AI Text Body
                y += 35;
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(...textGray);
                const splitAI = doc.splitTextToSize(finalAiText, pageWidth - (margin * 2) - 20);
                doc.text(splitAI, margin + 10, y);
                
                y += 40;

                // --- 4. APPOINTMENT CONFIRMATION (Redesigned) ---
                if (advisor && bookDate && bookTime) {
                    drawSectionHeader("Appointment Details", y);
                    y += 15;

                    // Ticket Container
                    doc.setDrawColor(...brandPrimary);
                    doc.setLineWidth(0.5);
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(margin, y, pageWidth - (margin * 2), 45, 2, 2, 'FD');

                    // Left Block (Advisor)
                    doc.setFillColor(...brandPrimary);
                    doc.rect(margin, y, 4, 45, 'F'); // Blue strip

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text("IMMIGRATION ADVISOR", margin + 12, y + 10);
                    
                    doc.setFontSize(12);
                    doc.setTextColor(...brandDark);
                    doc.text(advisor, margin + 12, y + 18);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...brandSecondary);
                    doc.text("Senior Consultant", margin + 12, y + 23);

                    // Divider Line
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.2);
                    doc.line(margin + 80, y + 5, margin + 80, y + 40);

                    // Middle Block (Time/Date)
                    drawLabelVal("Date", bookDate, margin + 90, y + 10);
                    drawLabelVal("Time", bookTime, margin + 90, y + 25);
                    
                    // Divider Line 2
                    doc.line(margin + 130, y + 5, margin + 130, y + 40);

                    // Right Block (Status & Mode)
                    drawLabelVal("Mode", bookMode, margin + 140, y + 10);
                    
                    // Status Badge (Visual)
                    doc.setFillColor(220, 252, 231); // Green bg
                    doc.roundedRect(margin + 140, y + 25, 25, 8, 1, 1, 'F');
                    doc.setTextColor(22, 101, 52); // Green text
                    doc.setFontSize(7);
                    doc.text("CONFIRMED", margin + 142, y + 30);

                } else {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(10);
                    doc.setTextColor(...textGray);
                    doc.text("Consultation Pending.", margin, y + 10);
                }
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(180, 180, 180);
                doc.text("Better Call Immigration Services | Automated Report System", margin, pageHeight - 10);
                doc.text(`Page 1 of 1`, pageWidth - margin, pageHeight - 10, { align: "right" });

                // --- SAVE ---
                const cleanName = firstName.replace(/[^a-zA-Z0-9]/g, '');
                doc.save(`BetterCall_Report_${cleanName}.pdf`);
                
                showToast("PDF Report Downloaded");

            } catch (err) {
                console.error("PDF Gen Error:", err);
                showModal("Failed to generate PDF. Please try again.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function showModal(msg) {
             const m = document.getElementById('messageModal');
            document.getElementById('modalText').innerText = msg;
            const contentDiv = document.getElementById('modalContent');
            if(contentDiv.querySelector('.fa-earth-americas')) {
                contentDiv.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-red-50 text-brand-accent flex items-center justify-center text-xl mx-auto mb-4">
                        <i class="fa-solid fa-circle-exclamation"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">Attention Needed</h3>
                    <p id="modalText" class="text-slate-500 text-sm mb-6">${msg}</p>
                    <button onclick="closeModal()" class="w-full bg-brand-accent hover:bg-rose-600 text-white font-bold py-3 rounded-xl transition-all shadow-lg">
                        UNDERSTOOD
                    </button>
                `;
            }
            m.classList.remove('hidden');
            setTimeout(() => { 
                m.classList.remove('opacity-0'); 
                m.querySelector('.modal-content').classList.add('scale-100'); 
            }, 10);
        }

        function closeModal() {
            const m = document.getElementById('messageModal');
            m.classList.add('opacity-0');
            m.querySelector('.modal-content').classList.remove('scale-100');
            setTimeout(() => { m.classList.add('hidden'); }, 300);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => {
                t.classList.add('translate-y-32', 'opacity-0');
            }, 3000);
        }

        async function submitBooking() {
            const advisor = document.getElementById('selectedAdvisor').value;
            const method = document.getElementById('selectedMethod').value;
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('selectedTime').value;
            const targetCountry = document.getElementById('targetCountry').value;

            if(!targetCountry) { showModal("Please select a Target Destination."); return; } 
            if(!advisor) { showModal("Please select an Immigration Advisor to proceed."); return; }
            if(!method) { showModal("Please select a Consultation Mode."); return; }
            if(!date) { showModal("Please select a Date for your appointment."); return; }
            if(!time) { showModal("Please select a Time Slot."); return; }

            if (!globalTaskId) {
                await saveData(false, false); 
                if(!globalTaskId) {
                    showModal("Session Error. Could not save profile data. Please refresh."); return;
                }
            }

            toggleLoader(true, "Confirming Booking", "Syncing with Advisor Calendar...");

            try {
                const userData = {
                    name: (document.getElementById('firstName').value + " " + document.getElementById('lastName').value) || "Guest",
                    email: document.getElementById('email').value || "no-email@example.com",
                    phone: document.getElementById('mobile').value || "N/A",
                    whatsapp: document.getElementById('whatsapp').value,
                    altPhone: document.getElementById('altPhone').value || "N/A",
                    
                    role: document.getElementById('currentJob').value || "Unknown",
                    residence: document.getElementById('presentResidence').value || "Unknown",
                    nationality: document.getElementById('nationality').value || "Unknown",
                    experience: document.getElementById('experience').value || "0",
                    qualification: document.querySelector('input[name="qualification"]:checked')?.value || "N/A",
                    
                    dob: document.getElementById('dob').value || "N/A",
                    age: document.getElementById('age').value || "N/A",
                    passportNo: document.getElementById('passportNo').value || "N/A",
                    passportExp: document.getElementById('passportExp').value || "N/A",
                    
                    refId: document.getElementById('refId').innerText,
                    targetCountry: targetCountry,
                    salaryRange: document.getElementById('mainSalaryRange').innerText || "N/A",
                    aiAnalysis: document.getElementById('aiReasoning').innerText || "N/A"
                };

                const calResult = await createCalBooking(advisor, date, time, userData);
                
                if (!calResult.success) {
                     // Ensure loader is turned off before showing error
                     toggleLoader(false);
                     console.warn("Cal.com booking failed:", calResult.msg);
                     showModal(`Booking System Error: ${calResult.msg}. Please try a different slot or contact support.`);
                     return; 
                }

                const icsContent = createICSFile(date, time, advisor);
                const icsBlob = new Blob([icsContent], { type: 'text/calendar' });
                const icsUrl = URL.createObjectURL(icsBlob);
                const firstName = document.getElementById('firstName').value || "Guest";

                const successHtml = `
                    <div class="text-center p-0 md:p-2">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-5 shadow-xl shadow-green-100 border-4 border-white animate-[popIn_0.5s_ease-out]">
                            <i class="fa-solid fa-check text-4xl text-green-600"></i>
                        </div>
                        
                        <h3 class="text-xl md:text-2xl font-black text-slate-900 mb-6 px-4 leading-tight">Your Appointment with <span class="text-brand-primary">${advisor}</span> is Confirmed</h3>
                        
                        <div class="bg-slate-50 text-left rounded-2xl p-6 border border-slate-200 shadow-inner mb-6 relative overflow-hidden mx-1">
                            <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-brand-primary to-brand-secondary"></div>
                            
                            <p class="text-sm font-bold text-slate-800 mb-3">Hello ${firstName},</p>
                            <p class="text-xs text-slate-500 mb-6 font-medium">This confirms your scheduled session with ${advisor}.</p>
                            
                            <div class="space-y-3 bg-white rounded-xl p-4 border border-slate-100 shadow-sm">
                                 <div class="flex items-center justify-between border-b border-slate-50 pb-2">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Date</span>
                                    <span class="text-xs font-bold text-slate-800">${date}</span>
                                </div>
                                 <div class="flex items-center justify-between border-b border-slate-50 pb-2">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Time</span>
                                    <span class="text-xs font-bold text-brand-primary">${time}</span>
                                </div>
                                 <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Mode of Appointment</span>
                                    <span class="text-xs font-bold text-slate-800">${method}</span>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs font-bold text-brand-secondary mb-6 italic">We look forward to helping you!</p>

                        <div class="flex flex-col gap-3">
                            <button id="btn-download-pdf" onclick="generatePDF()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-3 group relative overflow-hidden">
                                 <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                                 <i class="fa-solid fa-file-pdf text-white/90 text-lg group-hover:scale-110 transition-transform relative z-10"></i> 
                                <span class="relative z-10">Download Official Report</span>
                            </button>
                            
                            <a href="http://bettercall.online" class="w-full bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 font-bold py-4 rounded-xl transition-all shadow-sm hover:shadow-md flex items-center justify-center gap-2 group">
                                <span>Return to Homepage</span>
                                <i class="fa-solid fa-arrow-right-from-bracket group-hover:translate-x-1 transition-transform text-slate-400"></i>
                            </a>
                        </div>
                    </div>
                `;

                // Update ClickUp - Wrap in try/catch to not block success screen if it fails
                try {
                    let updateFields = [
                        { id: CLICKUP_FIELDS["BOOKING_DATE"], value: getUnixTime(date) },
                        { id: CLICKUP_FIELDS["BOOKING_TIME"], value: time }
                    ];

                    if(CLICKUP_API_KEY) {
                        // Fetch field defs to map dropdowns for Advisor/Type
                        const fieldRes = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/field`, { 
                            headers: { 'Authorization': CLICKUP_API_KEY } 
                        });
                        
                        if(fieldRes.ok) {
                            const fieldData = await fieldRes.json();
                            const fieldDefs = fieldData.fields || [];

                            const getVal = (fid, val) => {
                                const def = fieldDefs.find(f => f.id === fid);
                                if(def && (def.type === 'drop_down' || def.type === 'labels')) {
                                    const opt = def.type_config.options.find(o => o.name.toLowerCase() === val.toLowerCase());
                                    return opt ? opt.id : val;
                                }
                                return val;
                            };

                            updateFields.push({ id: CLICKUP_FIELDS["ADVISOR"], value: getVal(CLICKUP_FIELDS["ADVISOR"], advisor) });
                            updateFields.push({ id: CLICKUP_FIELDS["BOOKING_TYPE"], value: getVal(CLICKUP_FIELDS["BOOKING_TYPE"], method) });
                        }

                        for (let f of updateFields) {
                            // Non-blocking fetch
                            fetch(`https://api.clickup.com/api/v2/task/${globalTaskId}/field/${f.id}`, {
                                method: 'POST',
                                headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ value: f.value })
                            }).catch(e => console.warn("ClickUp field update warning:", e));
                        }
                    }
                } catch(clickUpErr) {
                    console.warn("ClickUp update logic failed, but booking confirmed:", clickUpErr);
                }

                toggleLoader(false);

                const m = document.getElementById('messageModal');
                document.getElementById('modalContent').innerHTML = successHtml;
                m.classList.remove('hidden');
                setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('.modal-content').classList.add('scale-100'); }, 10);
                
                const submitBtn = document.querySelector('button[onclick="submitBooking()"]');
                if(submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'BOOKING CONFIRMED <i class="fa-solid fa-check"></i>';
                }
                
            } catch(e) {
                toggleLoader(false);
                console.error("Critical Booking Error:", e);
                // Fallback success message if Cal.com succeeded but something else failed
                // Check if we reached a point where it should be considered success?
                // For safety, show a generic error but instruct user to check email if payment/booking went through.
                showModal("Booking process encountered an error. If you receive a confirmation email, your booking is secure. Otherwise, please contact support.");
            }
        }
    </script>
</body>
</html>