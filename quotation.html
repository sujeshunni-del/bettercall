<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visa Quotation Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-in { animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Remove Number Input Spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Custom Radio/Checkbox Styling */
        .option-card:checked + div {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
        }
        .option-card:checked + div .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Currency Tag Styling */
        .currency-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin-right: 4px;
        }
        .cur-usd { background: #dbeafe; color: #1e40af; }
        .cur-aed { background: #dcfce7; color: #166534; }
        .cur-eur { background: #f3e8ff; color: #6b21a8; }
        .cur-local { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        
        /* Glassmorphism for Receipt */
        .receipt-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .mono-num { font-family: 'JetBrains Mono', monospace; }
        
        /* Admin specific styles */
        .admin-card { transition: all 0.2s ease-in-out; }
        .admin-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px);
            z-index: 50; display: none; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 2rem;
        }
        .modal-backdrop.active { display: flex; animation: fadeIn 0.2s ease-out; }
        
        /* A4 Paper Simulation */
        .a4-paper {
            width: 210mm; min-height: 297mm; 
            background: white; 
            padding: 12mm; /* Optimized padding */
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            color: #1e293b;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
        }
        
        /* Updated Typography for A4 */
        .print-header { border-bottom: 2px solid #0f172a; padding-bottom: 15px; margin-bottom: 20px; }
        .print-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 700; margin-bottom: 4px; }
        .print-value { font-size: 13px; font-weight: 600; color: #0f172a; line-height: 1.4; }
        
        /* Larger Table Fonts */
        .print-table th { 
            background: #f8fafc; 
            font-size: 10px; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: #475569; 
            padding: 10px 12px; 
            font-weight: 800; 
            border-bottom: 2px solid #e2e8f0; 
        }
        .print-table td { 
            padding: 12px 12px; 
            font-size: 12px; 
            border-bottom: 1px solid #f1f5f9; 
            color: #334155; 
        }
        .print-table tr:last-child td { border-bottom: none; }
        .print-total-row td { border-top: 2px solid #0f172a; background: #f8fafc; font-weight: 800; color: #0f172a; font-size: 14px; padding-top: 15px; }

        @media screen and (max-width: 800px) {
            .a4-paper { 
                /* Mobile Preview: Scale down to fit width, user can zoom if needed */
                transform: scale(0.45); 
                transform-origin: top center; 
                margin-bottom: -140mm; /* Compensate for empty space from scaling */
            }
            .prop-header, .prop-body { padding: 20px; }
            
            /* Adjust Modal Layout for Mobile */
            #previewModal {
                align-items: flex-start;
                padding-top: 20px;
                overflow-x: hidden; /* Prevent horizontal scroll on body from scale */
            }
            
            /* Stack buttons in toolbar */
            #previewModal .flex.justify-end {
                justify-content: center;
                width: 100%;
                gap: 10px;
                flex-wrap: wrap;
                margin-bottom: 10px;
            }
        }
        
        /* UPDATED PRINT STYLES FOR VECTOR QUALITY */
        @media print {
            @page { 
                size: A4; 
                margin: 0; 
            }
            
            html, body {
                width: 210mm;
                height: 297mm;
                background: white;
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Hide everything by default */
            body * { 
                visibility: hidden; 
                animation: none !important; 
                transition: none !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }

            /* Show only the preview modal container and content */
            #previewModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: white;
                visibility: visible;
                overflow: visible;
                z-index: 9999;
                display: block !important;
            }

            .a4-paper {
                visibility: visible;
                position: relative; /* Flow naturally */
                width: 210mm !important;
                height: 296mm !important; /* Precise height */
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                overflow: hidden !important; /* Keep layout strict */
                transform: none !important;
                
                /* Ensure Vector Rendering */
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
                text-rendering: geometricPrecision !important;
            }

            /* Ensure all children of the paper are visible */
            .a4-paper * {
                visibility: visible;
            }

            /* Hide toolbar */
            .no-print { 
                display: none !important; 
            }
            
            /* Fix Backgrounds */
            .prop-header {
                background-color: #0f172a !important; /* Ensure header color prints */
                color: white !important;
            }
            
            /* Ensure text colors are solid for vector output */
            p, h1, h2, h3, span, div {
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-slate-900 text-white w-64 flex-shrink-0 hidden md:flex flex-col transition-all duration-300 shadow-xl z-20">
        <div class="p-6 border-b border-slate-700 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/sujeshunni-del/bettercall/b42b6aac234ae66a83e4b31e4b2d61a3f67ffa87/Bettercall%20Logo%20SVG%2003.svg" alt="Better Call Logo" class="h-10 w-auto">
                <div class="leading-none">
                    <h1 class="font-bold text-sm tracking-wide text-blue-400">BETTER CALL</h1>
                    <h2 class="font-bold text-[10px] tracking-widest text-white uppercase">Immigration</h2>
                </div>
            </div>
            <button id="mobileCloseBtn" class="md:hidden text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <div class="px-6 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Workspace</div>
            <a href="#" onclick="app.navigate('dashboard')" class="nav-item block px-6 py-3 hover:bg-slate-800 border-r-4 border-transparent hover:border-blue-500 transition-all duration-200 group" data-target="dashboard">
                <i class="fa-solid fa-chart-pie w-6 group-hover:text-blue-400 transition-colors"></i> Dashboard
            </a>
            <a href="#" onclick="app.navigate('quotation-new')" class="nav-item block px-6 py-3 hover:bg-slate-800 border-r-4 border-transparent hover:border-blue-500 transition-all duration-200 group" data-target="quotation-new">
                <i class="fa-solid fa-file-invoice-dollar w-6 group-hover:text-blue-400 transition-colors"></i> Proposal
            </a>
            <a href="#" onclick="app.navigate('quotation-history')" class="nav-item block px-6 py-3 hover:bg-slate-800 border-r-4 border-transparent hover:border-blue-500 transition-all duration-200 group" data-target="quotation-history">
                <i class="fa-solid fa-magnifying-glass w-6 group-hover:text-blue-400 transition-colors"></i> Search
            </a>

            <div id="adminLinks" class="hidden">
                <div class="px-6 mt-8 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Admin Panel</div>
                <a href="#" onclick="app.navigate('admin-users')" class="nav-item block px-6 py-3 hover:bg-slate-800 border-r-4 border-transparent hover:border-purple-500 transition-all duration-200 group" data-target="admin-users">
                    <i class="fa-solid fa-users-gear w-6 group-hover:text-purple-400 transition-colors"></i> User Management
                </a>
                <a href="#" onclick="app.navigate('admin-visas')" class="nav-item block px-6 py-3 hover:bg-slate-800 border-r-4 border-transparent hover:border-purple-500 transition-all duration-200 group" data-target="admin-visas">
                    <i class="fa-brands fa-cc-visa w-6 group-hover:text-purple-400 transition-colors"></i> Visa Management
                </a>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-800/50">
            <div class="flex items-center gap-3 mb-3 p-2 rounded-lg bg-slate-800">
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-xs font-bold shadow" id="userAvatar">U</div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm truncate" id="userNameDisplay">Guest User</p>
                    <p class="text-xs text-slate-400 truncate" id="userRoleDisplay">Agent</p>
                </div>
            </div>
            <button onclick="auth.logout()" class="w-full py-2 px-3 hover:bg-red-500/10 hover:text-red-400 rounded text-sm transition-colors text-left text-slate-400 flex items-center gap-2">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-100">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-8 sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <button id="mobileMenuBtn" class="md:hidden text-slate-600 text-xl"><i class="fa-solid fa-bars"></i></button>
                <h2 class="text-xl font-bold text-slate-800 tracking-tight" id="pageTitle">Dashboard</h2>
            </div>
            <div class="flex gap-4 items-center">
                <div id="currencyStatus" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-medium border border-green-100">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Fetching Rates...
                </div>
                <button class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-colors relative">
                    <i class="fa-regular fa-bell"></i>
                    <span class="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
            </div>
        </header>

        <!-- Content Views -->
        <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            <!-- Views are injected here -->
        </div>
    </main>

    <!-- PREVIEW MODAL -->
    <div id="previewModal" class="modal-backdrop">
        <div class="flex flex-col gap-4">
            <!-- Toolbar -->
            <div class="flex justify-end gap-2 no-print sticky top-0 z-50">
                <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm font-bold text-xs hover:bg-blue-700 transition flex items-center">
                    <i class="fa-solid fa-file-pdf mr-2"></i> Save PDF
                </button>
                <button onclick="window.print()" class="bg-white text-slate-700 px-4 py-2 rounded-lg shadow-sm font-bold text-xs hover:bg-slate-50 transition flex items-center border border-slate-200">
                    <i class="fa-solid fa-print mr-2"></i> Print
                </button>
                <button onclick="app.closePreview()" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-sm font-bold text-xs hover:bg-red-700 transition flex items-center">
                    <i class="fa-solid fa-xmark mr-2"></i> Close
                </button>
            </div>

            <!-- A4 Document (Redesigned) -->
            <div class="a4-paper" id="a4Content">
                
                <!-- 1. HEADER SECTION -->
                <div class="flex justify-between items-start mb-6 pb-6 border-b-2 border-slate-900 pt-10 px-12">
                    <div>
                        <!-- Logo + Company Name -->
                        <div class="flex items-center gap-5 mb-4">
                            <img src="https://raw.githubusercontent.com/sujeshunni-del/bettercall/b42b6aac234ae66a83e4b31e4b2d61a3f67ffa87/Bettercall%20Logo%20SVG%2003.svg" alt="Better Call Logo" class="h-16 w-auto">
                            <div>
                                <h1 class="text-2xl font-black text-slate-900 uppercase tracking-tight leading-none">Better Call</h1>
                                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-[0.25em] leading-none mt-1">Immigration</p>
                            </div>
                        </div>
                        
                        <div class="text-[10px] text-slate-500 font-medium uppercase tracking-widest leading-relaxed pl-1">
                            <p>Dubai Healthcare City, Building 64</p>
                            <p>R320, 12th Floor, Citibank</p>
                            <p>Dubai, United Arab Emirates</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <h1 class="text-5xl font-black text-slate-900 uppercase tracking-tighter mb-3 opacity-90">Quotation</h1>
                        <div class="space-y-1">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Reference No.</p>
                            <p class="text-xl font-mono font-bold text-blue-600" id="p_ref_full">---</p>
                        </div>
                        <div class="mt-3 space-y-1">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Date Issued</p>
                            <p class="text-base font-bold text-slate-700" id="p_date">---</p>
                        </div>
                    </div>
                </div>

                <!-- 2. ADDRESS / DETAILS GRID -->
                <div class="px-12 mb-6">
                    <div class="flex gap-16">
                        <!-- Client Info -->
                        <div class="flex-1">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-200 pb-1">Prepared For</p>
                            <h3 class="text-xl font-bold text-slate-900 uppercase mb-3 leading-tight" id="p_client">Client Name</h3>
                            <div class="space-y-2 text-xs text-slate-600">
                                <p class="flex items-center gap-3"><span class="w-20 text-slate-400 uppercase font-bold text-[10px]">Position</span> <span class="font-semibold" id="p_job">---</span></p>
                                <p class="flex items-center gap-3"><span class="w-20 text-slate-400 uppercase font-bold text-[10px]">Nationality</span> <span class="font-semibold" id="p_nation">---</span></p>
                                <p class="flex items-center gap-3"><span class="w-20 text-slate-400 uppercase font-bold text-[10px]">Contact</span> <span class="font-mono font-semibold" id="p_phone">---</span></p>
                            </div>
                        </div>

                        <!-- Visa Info -->
                        <div class="flex-1">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-200 pb-1">Visa Details</p>
                            <h3 class="text-xl font-bold text-blue-600 uppercase mb-3 leading-tight" id="p_dest">Destination</h3>
                            <div class="space-y-2 text-xs text-slate-600">
                                <p class="flex items-center gap-3"><span class="w-24 text-slate-400 uppercase font-bold text-[10px]">Visa Type</span> <span class="font-semibold" id="p_visa">---</span></p>
                                <p class="flex items-center gap-3"><span class="w-24 text-slate-400 uppercase font-bold text-[10px]">Applicants</span> <span class="font-semibold" id="p_pax">1 Pax</span></p>
                                <p class="flex items-center gap-3"><span class="w-24 text-slate-400 uppercase font-bold text-[10px]">Service</span> <span class="font-semibold">Standard Processing</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. FINANCIAL TABLE & TOTAL -->
                <div class="px-12 mb-4">
                    <table class="w-full text-left border-collapse mb-4">
                        <thead id="p_table_head">
                            <!-- Populated via JS -->
                            <tr class="border-b-2 border-slate-900">
                                <th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider w-1/2">Description / Service</th>
                                <th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider text-right">Amount (EUR)</th>
                                <th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider text-right">Amount (AED)</th>
                            </tr>
                        </thead>
                        <tbody id="p_table_body" class="text-xs text-slate-700">
                            <!-- Content Populated via JS -->
                        </tbody>
                    </table>
                    
                    <!-- TOTAL BLOCK (Fixed visibility) -->
                    <div class="flex justify-end mt-4">
                        <div id="p_total_container">
                            <!-- Dynamic Content via JS -->
                        </div>
                    </div>
                </div>

                <!-- 4. PAYMENT SCHEDULE & FOOTER -->
                <div class="px-12 pb-10 mt-auto bg-white">
                    
                    <!-- Schedule -->
                    <div class="mb-6">
                        <div class="flex items-center gap-3 mb-2">
                            <h4 class="text-xs font-bold text-slate-900 uppercase tracking-widest">Payment Schedule</h4>
                            <span class="text-[9px] px-2 py-0.5 bg-slate-100 text-slate-600 rounded border border-slate-200 uppercase font-bold" id="p_plan_name">Standard</span>
                        </div>
                        <div class="grid grid-cols-1 gap-1.5 border-l-2 border-slate-200 pl-5" id="p_payment_schedule">
                            <!-- Content Populated via JS -->
                        </div>
                    </div>

                    <!-- Terms & Signature Grid -->
                    <div class="border-t border-slate-200 pt-4 grid grid-cols-4 gap-8">
                        <div class="col-span-3">
                            <h5 class="text-[9px] font-bold text-slate-900 uppercase mb-2">Terms & Conditions</h5>
                            <ul class="text-[8px] text-slate-500 space-y-1 list-disc pl-3 leading-relaxed">
                                <li><strong>Non-Refundable:</strong> All registration and processing fees are strictly non-refundable under any circumstance.</li>
                                <li><strong>Consultancy Only:</strong> Visa issuance is at the sole discretion of the Embassy. We act as consultants only.</li>
                                <li><strong>Validity:</strong> This quotation is valid for 7 days. Exchange rates are subject to change.</li>
                                <li><strong>Documents:</strong> The applicant is responsible for the authenticity of provided documents.</li>
                            </ul>
                        </div>
                        
                        <!-- Advisor Card -->
                        <div class="col-span-1">
                            <div class="bg-white border border-slate-200 p-3 rounded-lg shadow-sm">
                                <p class="text-[7px] font-bold text-slate-400 uppercase tracking-widest mb-2">Immigration Consultant</p>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs font-bold shadow-md" id="p_advisor_initial">A</div>
                                    <div>
                                        <p class="text-[10px] font-bold text-slate-900 uppercase leading-none" id="p_advisor_name">Name</p>
                                        <p class="text-[8px] text-slate-500 mt-1 font-mono font-medium" id="p_advisor_phone">+971...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6 pt-4 border-t border-slate-100">
                        <p class="text-[8px] text-slate-300 uppercase tracking-widest font-medium">Better Call Immigration • Dubai Healthcare City • Building 64</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-300 bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-4 border border-slate-700">
        <div class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center">
            <i class="fa-solid fa-check"></i>
        </div>
        <div>
            <h4 class="font-bold text-sm">Success</h4>
            <p class="text-xs text-slate-300" id="toastMsg">Operation completed successfully</p>
        </div>
    </div>

    <script>
        // --- CLICKUP CONFIG ---
        const clickUpConfig = {
            apiKey: 'pk_260468481_S4KLO3ZGV6P1PL1POHKXNS1LA5ISSG0P',
            
            quotationListId: '901814727530', 
            visaListId: '901814730704', 
            userListId: '901814735410', // ADDED: User Management List

            // Fields for Visa Management
            customFields: {
                visaName: 'fc2f03f2-5efc-46f1-84c3-f2eaa442d72d', 
                regFee: '0c4d60c4-56a9-4836-9360-6609b3ae8082',    
                cost: 'a317dee6-d60f-4107-b989-8af60ab6cd78',
                visaCode: 'a907808c-1625-4f56-acfe-cb1732e13ae6' 
            },

            // Fields for User Management (ADDED)
            userFields: {
                userId: '1c82819f-441e-4a4d-9e49-178f411678f8',
                password: '7f7c5b14-2a6d-4082-975f-d9f78982901d',
                role: '751e69f7-abd4-4da2-927d-df5aff0830c4',
                phone: '5788588a-e1a5-4b4e-b900-42e1b5dd7822', // Added Phone Field
                designation: '493fab15-7086-40cd-9648-311bbc3dfc1a' // Added Designation Field
            },
            
            // Fields for Quotations (Client Tasks)
            quoteFields: {
                phone: '5788588a-e1a5-4b4e-b900-42e1b5dd7822',
                cost: 'a317dee6-d60f-4107-b989-8af60ab6cd78',
                nationality: '4402d5e4-93b4-447e-8647-3417abf1a6e2',
                applyCountry: '8c370b02-cfe5-48e2-879c-9ad34d3f25e7',
                discountName: '65a86e67-7750-4706-bbf5-0068192350ee',
                grandTotal: '9cc78971-82ea-439e-b2a4-30cde167183a',
                instalment1: 'be077d9d-04a0-48e3-9bb8-6215a91d5b89', 
                instalment2: '0be8fd5b-671d-4b96-83df-380dc52734df', // UPDATED ID
                instalment3: '67d9c792-ad16-445e-b3fe-a60ab86f4b11',
                instalment4: 'ddc9ad23-7474-472f-901f-31c6b7aa0881',
                jobTitle: '410dd336-f23f-4893-859f-d04e420f6431',
                regFee: '0c4d60c4-56a9-4836-9360-6609b3ae8082',
                vat: '45ddb7c9-6b61-467d-95a0-d870a704dfb8',
                visaName: 'fc2f03f2-5efc-46f1-84c3-f2eaa442d72d',
                advisor: 'a220503d-5a45-4f0b-b83d-6547a28ca0b5',
                discountAmount: '3d35cc71-402f-473a-9f52-d269d5f896c3',
                date: 'ab0db3a0-6b1e-44fd-9ff3-692168c0cc1b',
                refId: 'c3742a3d-db81-4aaa-b13b-50fafe0b82e5'
            }
        };

        // --- CURRENCY LAYER ---
        const currencyLayer = {
            apiKey: '928a37b0f3a549c28987e1b16bfff8ef',
            rates: null,
            base: 'USD',
            nationalityMap: {
                'PAKISTAN': 'PKR',
                'SRI LANKA': 'LKR',
                'NEPAL': 'NPR',
                'BANGLADESH': 'BDT',
                'PHILIPPINES': 'PHP',
                'KENYA': 'KES',
                'EGYPT': 'EGP',
                'UNITED KINGDOM': 'GBP',
                'INDIA': 'INR',
                'UAE': 'AED'
            },
            
            async init() {
                try {
                    const response = await fetch(`https://api.currencyfreaks.com/v2.0/rates/latest?apikey=${this.apiKey}`);
                    if (!response.ok) throw new Error("API Response Not OK");
                    const data = await response.json();
                    this.rates = data.rates;
                    
                    const statusEl = document.getElementById('currencyStatus');
                    if(statusEl) {
                        statusEl.innerHTML = `<i class="fa-solid fa-check-circle"></i> Rates Live`;
                        statusEl.classList.remove('bg-yellow-50', 'text-yellow-700');
                        statusEl.classList.add('bg-green-50', 'text-green-700');
                    }
                } catch (e) {
                    console.warn("Currency API Failed, using fallback rates.", e);
                    
                    // FALLBACK RATES (Approximate)
                    this.rates = {
                        "USD": "1",
                        "EUR": "0.96", 
                        "AED": "3.6725",
                        "GBP": "0.79",
                        "INR": "84.0",
                        "PKR": "278.0",
                        "LKR": "290.0",
                        "NPR": "135.0",
                        "BDT": "120.0",
                        "PHP": "58.0",
                        "KES": "129.0",
                        "EGP": "49.0"
                    };

                    const statusEl = document.getElementById('currencyStatus');
                    if(statusEl) {
                        statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Offline Rates`;
                        statusEl.classList.remove('bg-green-50', 'text-green-700');
                        statusEl.classList.add('bg-yellow-50', 'text-yellow-700');
                    }
                }
            },

            convert(amountUSD, targetCurrency) {
                if (!this.rates || !this.rates[targetCurrency]) return 0;
                return amountUSD * parseFloat(this.rates[targetCurrency]);
            },

            format(amount, currency) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(amount);
            },

            getEuroToAED(amountEuro) {
                if (!this.rates || !this.rates['EUR'] || !this.rates['AED']) return 0;
                const usd = amountEuro / parseFloat(this.rates['EUR']);
                return usd * parseFloat(this.rates['AED']);
            },

            getNationalityCurrency(nationality) {
                return this.nationalityMap[nationality] || null;
            }
        };

        // --- DATA LAYER ---
        const db = {
            init() {
                if (!localStorage.getItem('vs_countries')) {
                    const countryList = [ "GERMANY", "SWEDEN", "FINLAND", "SLOVAKIA", "ITALY", "NETHERLANDS", "FRANCE", "POLAND", "CZECH REPUBLIC", "LATVIA", "CROATIA", "MONTENEGRO", "SERBIA", "MACEDONIA", "ALBANIA", "BELARUS" ];
                    const formattedCountries = countryList.map((name, index) => ({ id: index + 1, name: name }));
                    localStorage.setItem('vs_countries', JSON.stringify(formattedCountries));
                }

                if (!localStorage.getItem('vs_visas')) {
                    localStorage.setItem('vs_visas', JSON.stringify([]));
                }

                if (!localStorage.getItem('vs_quotes')) localStorage.setItem('vs_quotes', JSON.stringify([]));
            },
            get(table) { return JSON.parse(localStorage.getItem('vs_' + table) || '[]'); },
            set(table, data) { localStorage.setItem('vs_' + table, JSON.stringify(data)); },
            add(table, item) { const data = this.get(table); item.id = Date.now(); data.push(item); this.set(table, data); return item; },
            update(table, item) { const data = this.get(table); const idx = data.findIndex(i => i.id == item.id); if (idx !== -1) { data[idx] = item; this.set(table, data); return true; } return false; },
            delete(table, id) { const data = this.get(table); this.set(table, data.filter(i => i.id != id)); },
            
            getOrCreateCountry(name) {
                const countries = this.get('countries');
                const existing = countries.find(c => c.name.toUpperCase() === name.toUpperCase());
                if (existing) return existing.id;
                
                const newId = countries.length > 0 ? Math.max(...countries.map(c => c.id)) + 1 : 1;
                const newCountry = { id: newId, name: name.toUpperCase() };
                countries.push(newCountry);
                this.set('countries', countries);
                return newId;
            }
        };

        // --- AUTH SYSTEM ---
        const auth = {
            user: null,
            init() {
                // Hide App UI initially
                const sidebar = document.getElementById('sidebar');
                const main = document.querySelector('main');
                
                // We use inline styles to override Tailwind temporarily without messing up responsive classes
                if(sidebar) sidebar.style.display = 'none';
                if(main) main.style.display = 'none';

                this.renderLoginUI();
            },

            renderLoginUI() {
                // Create Login Overlay
                const div = document.createElement('div');
                div.id = 'loginOverlay';
                div.className = 'fixed inset-0 z-[100] flex items-center justify-center p-4 fade-in overflow-hidden bg-slate-900';
                
                // Dubai Skyline Image
                const bgUrl = "https://images.unsplash.com/photo-1512453979798-5ea904ac66de?q=80&w=2000&auto=format&fit=crop"; 
                
                div.innerHTML = `
                    <!-- Background Image with Overlay -->
                    <div class="absolute inset-0 z-0">
                        <!-- Animated Background -->
                        <div class="absolute inset-0 bg-cover bg-center bg-no-repeat transform animate-[slowZoom_30s_infinite_alternate]" style="background-image: url('${bgUrl}');"></div>
                        <!-- Dark Gradient Overlay for Readability -->
                        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-[1px]"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/50 to-slate-900/20"></div>
                    </div>

                    <!-- Login Card -->
                    <div class="relative z-10 w-full max-w-[380px] bg-white/10 backdrop-blur-xl rounded-3xl border border-white/20 shadow-2xl p-8 overflow-hidden transform transition-all duration-500 hover:shadow-blue-900/30">
                        <!-- Decorative Glass Reflection -->
                        <div class="absolute -top-24 -right-24 w-48 h-48 bg-blue-500/30 rounded-full blur-[60px] pointer-events-none"></div>
                        <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-purple-500/20 rounded-full blur-[60px] pointer-events-none"></div>
                        
                        <!-- Header -->
                        <div class="text-center mb-8 relative">
                            <!-- UPDATED: Logo with Beat & Glow Animation (No Twist) -->
                            <div class="w-24 h-24 mx-auto bg-white/95 rounded-2xl flex items-center justify-center mb-4 p-4 animate-[beatGlow_3s_ease-in-out_infinite]">
                                <img src="https://raw.githubusercontent.com/sujeshunni-del/bettercall/b42b6aac234ae66a83e4b31e4b2d61a3f67ffa87/Bettercall%20Logo%20SVG%2003.svg" alt="Better Call Logo" class="w-full h-full object-contain">
                            </div>
                            
                            <!-- UPDATED: Company Name near Logo -->
                            <h2 class="text-2xl font-black text-white tracking-tight drop-shadow-lg uppercase leading-none">
                                Better Call<br>
                                <span class="text-blue-400 text-lg tracking-widest">Immigration</span>
                            </h2>
                        </div>

                        <!-- Form -->
                        <form onsubmit="event.preventDefault(); auth.login(this.username.value, this.password.value)" class="space-y-5 relative z-10">
                            <div class="space-y-1">
                                <label class="text-[9px] uppercase font-bold text-blue-100/70 ml-1 tracking-wider">User Identity</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-white/50 group-focus-within:text-white transition-colors">
                                        <i class="fa-regular fa-user"></i>
                                    </div>
                                    <input type="text" name="username" required placeholder="Enter User ID" autocomplete="off"
                                        class="w-full pl-11 pr-4 py-3 bg-slate-900/60 border border-white/10 rounded-xl text-white placeholder-white/30 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400/50 focus:border-blue-400/50 transition-all font-medium backdrop-blur-sm hover:bg-slate-900/70">
                                </div>
                            </div>

                            <div class="space-y-1">
                                <label class="text-[9px] uppercase font-bold text-blue-100/70 ml-1 tracking-wider">Secure Key</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-white/50 group-focus-within:text-white transition-colors">
                                        <i class="fa-solid fa-lock"></i>
                                    </div>
                                    <input type="password" name="password" required placeholder="••••••••"
                                        class="w-full pl-11 pr-4 py-3 bg-slate-900/60 border border-white/10 rounded-xl text-white placeholder-white/30 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400/50 focus:border-blue-400/50 transition-all font-medium backdrop-blur-sm hover:bg-slate-900/70">
                                </div>
                            </div>

                            <button type="submit" id="btnLogin" class="w-full py-3.5 mt-2 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/50 transform transition-all hover:-translate-y-0.5 active:scale-[0.98] flex items-center justify-center gap-2 group">
                                <span>Sign In</span>
                                <i class="fa-solid fa-arrow-right-long group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </form>

                        <!-- Footer -->
                        <div class="mt-8 text-center pt-4 border-t border-white/10">
                            <p class="text-[8px] text-white/40 font-light tracking-wide flex items-center justify-center gap-2">
                                <i class="fa-solid fa-building-shield"></i> Secure Session • Dubai Healthcare City
                            </p>
                        </div>
                    </div>

                    <style>
                        @keyframes slowZoom {
                            0% { transform: scale(1); }
                            100% { transform: scale(1.1); }
                        }
                        /* Added Beat & Glow Animation */
                        @keyframes beatGlow {
                            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); }
                            50% { transform: scale(1.05); box-shadow: 0 0 35px rgba(59, 130, 246, 0.6); }
                        }
                    </style>
                `;
                document.body.appendChild(div);
            },

            async login(username, password) {
                const btn = document.getElementById('btnLogin');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verifying...';
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                btn.disabled = true;

                try {
                    // Use existing clickUpConfig
                    const url = `https://api.clickup.com/api/v2/list/${clickUpConfig.userListId}/task?archived=false&include_closed=true`;
                    const res = await fetch(url, { 
                        headers: { 'Authorization': clickUpConfig.apiKey } 
                    });
                    
                    if (!res.ok) throw new Error("Failed to fetch users");
                    
                    const data = await res.json();
                    
                    const validUser = data.tasks.find(t => {
                        // Helper to extract fields using existing structure logic
                        const getVal = (fid) => {
                            const f = t.custom_fields.find(x => x.id === fid);
                            if (!f) return null;
                            if (f.type === 'drop_down' && typeof f.value === 'number') return f.type_config.options[f.value]?.name;
                            if (typeof f.value === 'object' && f.value !== null) return f.value.status || f.value.text || f.value.name; 
                            return f.value;
                        };

                        const uId = getVal(clickUpConfig.userFields.userId);
                        const uPass = getVal(clickUpConfig.userFields.password);
                        const uStatus = t.status.status.toLowerCase();
                        
                        // Check Credentials AND Status
                        const isActive = ['active', 'to do', 'open'].includes(uStatus);
                        return isActive && String(uId).trim().toLowerCase() === String(username).trim().toLowerCase() && String(uPass) === String(password);
                    });

                    if (validUser) {
                        const getVal = (fid) => {
                            const f = validUser.custom_fields.find(x => x.id === fid);
                            if (!f) return null;
                            if (f.type === 'drop_down' && typeof f.value === 'number') return f.type_config.options[f.value]?.name;
                            if (typeof f.value === 'object' && f.value !== null) return f.value.status || f.value.text || f.value.name; 
                            return f.value;
                        };

                        this.user = {
                            name: validUser.name,
                            role: (getVal(clickUpConfig.userFields.role) || 'Agent').toLowerCase(),
                            id: validUser.id,
                            phone: getVal(clickUpConfig.userFields.phone) || '', // Capture Phone
                            designation: getVal(clickUpConfig.userFields.designation) || 'Immigration Consultant' // Capture Designation
                        };
                        this.finishLogin();
                    } else {
                        app.showToast('Invalid ID or Password', 'error');
                        const modal = document.querySelector('#loginOverlay > div');
                        if(modal) {
                            modal.classList.add('animate-[shake_0.5s_ease-in-out]');
                            setTimeout(() => modal.classList.remove('animate-[shake_0.5s_ease-in-out]'), 500);
                        }
                        
                        btn.innerHTML = originalText;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        btn.disabled = false;
                    }
                } catch (e) {
                    console.error("Login Error", e);
                    app.showToast('Connection failed. Check network.', 'error');
                    btn.innerHTML = originalText;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    btn.disabled = false;
                }
            },

            finishLogin() {
                const overlay = document.getElementById('loginOverlay');
                if(overlay) {
                    overlay.classList.add('opacity-0');
                    setTimeout(() => overlay.remove(), 300);
                }

                // Show App UI (Remove inline styles to let CSS take over)
                const sidebar = document.getElementById('sidebar');
                const main = document.querySelector('main');
                
                if(sidebar) sidebar.style.display = '';
                if(main) main.style.display = '';

                // Update UI Profile
                document.getElementById('userNameDisplay').innerText = this.user.name;
                document.getElementById('userRoleDisplay').innerText = this.user.role.charAt(0).toUpperCase() + this.user.role.slice(1);
                document.getElementById('userAvatar').innerText = this.user.name.charAt(0).toUpperCase();
                
                // Permission Handling
                if(this.user.role.includes('admin')) {
                    document.getElementById('adminLinks').classList.remove('hidden');
                } else {
                    document.getElementById('adminLinks').classList.add('hidden');
                }

                app.navigate('dashboard');
                app.showToast(`Welcome, ${this.user.name}`);
            },

            logout() {
                // Clear session if we stored any (current impl is memory only)
                location.reload(); 
            }
        };

        // --- APPLICATION LOGIC ---
        const app = {
            currentView: 'dashboard',
            selectedLocalCurrency: null,
            editingVisaId: null,
            selectedVisas: new Set(),
            
            init() {
                db.init();
                currencyLayer.init(); 
                auth.init(); 
                
                if (db.get('visas').length === 0) {
                     this.fetchVisasFromClickUp(true); 
                }

                const sidebar = document.getElementById('sidebar');
                document.getElementById('mobileMenuBtn').onclick = () => { sidebar.classList.remove('hidden'); sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-40'); };
                document.getElementById('mobileCloseBtn').onclick = () => { sidebar.classList.add('hidden'); sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-40'); };
            },

            navigate(view) {
                this.currentView = view;
                document.querySelectorAll('.nav-item').forEach(el => {
                    if(el.dataset.target === view) { el.classList.add('bg-slate-800', 'border-blue-500'); el.classList.remove('border-transparent'); } 
                    else { el.classList.remove('bg-slate-800', 'border-blue-500'); el.classList.add('border-transparent'); }
                });

                const titles = { 'dashboard': 'Dashboard Overview', 'quotation-new': 'Advanced Proposal', 'quotation-history': 'Quotation Archive', 'admin-users': 'User Management', 'admin-visas': 'Visa Management' };
                document.getElementById('pageTitle').innerText = titles[view];
                const container = document.getElementById('contentArea');
                container.innerHTML = ''; 

                switch(view) {
                    case 'dashboard': this.renderDashboard(container); break;
                    case 'quotation-new': 
                        this.renderAdvancedQuotation(container); 
                        this.createNewProposal(); // Auto-trigger Setup and Sync on Tab Click
                        break;
                    case 'quotation-history': this.renderHistory(container); break;
                    case 'admin-users': this.renderAdminUsers(container); break;
                    case 'admin-visas': this.renderAdminVisas(container); break;
                }
                if(window.innerWidth < 768) document.getElementById('mobileCloseBtn').click();
            },

            showToast(msg, type = 'success') {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                const icon = t.querySelector('i');
                if(type === 'error') {
                   icon.className = 'fa-solid fa-circle-exclamation';
                   t.querySelector('div').className = 'w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center';
                } else {
                   icon.className = 'fa-solid fa-check';
                   t.querySelector('div').className = 'w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center';
                }
                t.classList.remove('translate-y-24', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
            },

            // --- DASHBOARD & HISTORY ---
            async renderDashboard(container) {
                // Show Loading State
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full fade-in">
                        <div class="relative">
                            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                            <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                                <i class="fa-solid fa-cloud text-blue-500 text-lg"></i>
                            </div>
                        </div>
                        <h3 class="mt-4 text-slate-600 font-bold text-lg">Syncing Live Dashboard</h3>
                        <p class="text-slate-400 text-sm">Fetching analytics from ClickUp...</p>
                    </div>
                `;

                try {
                    // 1. Fetch Data from ClickUp (Live Sync)
                    // Fetching latest 100 tasks for dashboard overview
                    const url = `https://api.clickup.com/api/v2/list/${clickUpConfig.quotationListId}/task?include_closed=true&order_by=created&reverse=true&page=0`;
                    const res = await fetch(url, { headers: { 'Authorization': clickUpConfig.apiKey } });
                    
                    if (!res.ok) throw new Error("Failed to fetch ClickUp data");
                    
                    const data = await res.json();
                    
                    // 2. Map Data
                    const quotes = data.tasks.map(t => this.mapClickUpTaskToQuote(t));

                    // 3. ROLE-BASED RENDERING
                    if (auth.user.role !== 'admin') {
                        this.renderAgentDashboard(container, quotes);
                        return;
                    }

                    // 4. Analytics Calculations (Admin)
                    const totalRevenue = quotes.reduce((acc, q) => acc + (parseFloat(q.grandTotal) || 0), 0);
                    
                    const now = new Date();
                    const thisMonthQuotes = quotes.filter(q => {
                        const d = new Date(q.date); // q.date is timestamp from mapping
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                    
                    const revenueMonth = thisMonthQuotes.reduce((acc, q) => acc + (parseFloat(q.grandTotal) || 0), 0);
                    const avgTicket = quotes.length ? totalRevenue / quotes.length : 0;
                    
                    // Destination Stats
                    const destCounts = {};
                    quotes.forEach(q => { 
                        const d = q.destination || 'Unknown';
                        destCounts[d] = (destCounts[d] || 0) + 1; 
                    });
                    const sortedDest = Object.entries(destCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);

                    const recentQuotes = quotes.slice(0, 6); // Already sorted by API (newest first)

                    // 5. Render Admin Dashboard
                    container.innerHTML = `
                        <div class="fade-in space-y-6">
                            <!-- Welcome Header (Mobile Fixed Alignment) -->
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-2">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-800">Executive Overview</h2>
                                    <div class="flex items-center gap-2 text-sm text-slate-500">
                                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                        Live ClickUp Data Synced
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-500 flex items-center gap-2 shadow-sm">
                                        <i class="fa-regular fa-calendar"></i> ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                    </span>
                                    <button onclick="app.navigate('quotation-new')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-blue-200 transition-all">
                                        <i class="fa-solid fa-plus mr-1"></i> Quick Action
                                    </button>
                                </div>
                            </div>

                            <!-- KPI Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <!-- Revenue Card -->
                                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                        <i class="fa-solid fa-sack-dollar text-5xl text-emerald-600"></i>
                                    </div>
                                    <div class="relative z-10">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total Revenue</div>
                                        <div class="text-2xl font-extrabold text-slate-800 mb-2">€${totalRevenue.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
                                        <div class="flex items-center gap-2 text-xs">
                                            <span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded font-bold flex items-center gap-1">
                                                <i class="fa-solid fa-arrow-trend-up"></i> +${(revenueMonth/1000).toFixed(1)}k
                                            </span>
                                            <span class="text-slate-400">this month</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quotes Card -->
                                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                        <i class="fa-solid fa-file-invoice text-5xl text-blue-600"></i>
                                    </div>
                                    <div class="relative z-10">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Active Proposals</div>
                                        <div class="text-2xl font-extrabold text-slate-800 mb-2">${quotes.length}</div>
                                        <div class="flex items-center gap-2 text-xs">
                                            <span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">
                                                ${thisMonthQuotes.length} New
                                            </span>
                                            <span class="text-slate-400">this month</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Avg Value Card -->
                                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                        <i class="fa-solid fa-chart-pie text-5xl text-purple-600"></i>
                                    </div>
                                    <div class="relative z-10">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Avg. Ticket Size</div>
                                        <div class="text-2xl font-extrabold text-slate-800 mb-2">€${avgTicket.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
                                        <div class="text-xs text-slate-400">
                                            Per approved quotation
                                        </div>
                                    </div>
                                </div>

                                <!-- Destinations Card -->
                                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                                        <i class="fa-solid fa-earth-europe text-5xl text-amber-500"></i>
                                    </div>
                                    <div class="relative z-10">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Global Reach</div>
                                        <div class="text-2xl font-extrabold text-slate-800 mb-2">${Object.keys(destCounts).length}</div>
                                        <div class="text-xs text-slate-400">
                                            Active destinations
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Charts & Stats Row -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                
                                <!-- Left: Visual Revenue Breakdown (CSS Chart) -->
                                <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="font-bold text-slate-700">Recent Trend</h3>
                                        <i class="fa-solid fa-chart-simple text-slate-300"></i>
                                    </div>
                                    
                                    <div class="flex items-end gap-2 md:gap-4 h-48 w-full px-2">
                                        <!-- Mock Data Bars using CSS (Static for UI Demo, could be dynamic) -->
                                        ${[35, 55, 45, 70, 60, 85, 95].map((h, i) => `
                                            <div class="flex-1 flex flex-col justify-end gap-2 group cursor-pointer">
                                                <div class="w-full bg-slate-100 rounded-t-lg relative overflow-hidden h-full">
                                                    <div class="absolute bottom-0 w-full bg-blue-500 rounded-t-lg transition-all duration-500 group-hover:bg-blue-600" style="height: ${h}%"></div>
                                                </div>
                                                <div class="text-center text-[10px] font-bold text-slate-400 uppercase">W${i+1}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Right: Top Destinations -->
                                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                    <h3 class="font-bold text-slate-700 mb-4">Top Destinations</h3>
                                    <div class="space-y-4">
                                        ${sortedDest.map(([name, count], idx) => {
                                            const pct = (count / quotes.length) * 100;
                                            const colors = ['bg-blue-500', 'bg-emerald-500', 'bg-purple-500', 'bg-amber-500', 'bg-slate-400'];
                                            return `
                                                <div>
                                                    <div class="flex justify-between text-xs font-bold text-slate-600 mb-1">
                                                        <span>${name}</span>
                                                        <span>${count}</span>
                                                    </div>
                                                    <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                                        <div class="h-full ${colors[idx]} rounded-full" style="width: ${pct}%"></div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('') || '<div class="text-xs text-slate-400 italic">No data available</div>'}
                                    </div>
                                    <div class="mt-6 pt-4 border-t border-slate-100">
                                        <button onclick="app.navigate('admin-countries')" class="w-full py-2 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                                            Manage Destinations
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity Table -->
                            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h3 class="font-bold text-slate-700">Recent Proposals</h3>
                                    <button onclick="app.navigate('quotation-history')" class="text-xs font-bold text-blue-600 hover:text-blue-700">View All</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-[10px] tracking-wider">
                                            <tr>
                                                <th class="p-4 pl-6">Reference</th>
                                                <th class="p-4">Client Profile</th>
                                                <th class="p-4">Visa Details</th>
                                                <th class="p-4">Advisor</th>
                                                <th class="p-4 text-right pr-6">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            ${recentQuotes.map(q => `
                                                <tr class="hover:bg-slate-50/80 transition-colors group">
                                                    <td class="p-4 pl-6">
                                                        <span class="font-mono text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded border border-slate-200">${q.refId || '---'}</span>
                                                    </td>
                                                    <td class="p-4">
                                                        <div class="font-bold text-slate-700 text-xs">${q.customerName}</div>
                                                        <div class="text-[10px] text-slate-400">${q.nationality}</div>
                                                    </td>
                                                    <td class="p-4">
                                                        <div class="flex items-center gap-2">
                                                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                                            <span class="text-xs font-medium text-slate-600">${q.destination}</span>
                                                        </div>
                                                        <div class="text-[10px] text-slate-400 ml-4">${q.visaName}</div>
                                                    </td>
                                                    <td class="p-4">
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-5 h-5 rounded-full bg-slate-200 text-[9px] font-bold flex items-center justify-center text-slate-600">
                                                                ${(q.advisor || 'A').charAt(0)}
                                                            </div>
                                                            <span class="text-xs text-slate-500">${q.advisor || 'System'}</span>
                                                        </div>
                                                    </td>
                                                    <td class="p-4 pr-6 text-right">
                                                        <div class="font-bold text-emerald-600 text-xs">€${parseFloat(q.grandTotal).toFixed(2)}</div>
                                                        <div class="text-[9px] text-slate-400">${new Date(q.date).toLocaleDateString()}</div>
                                                    </td>
                                                </tr>`).join('') || '<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">No recent proposals found.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;

                } catch (e) {
                    console.error("Dashboard Sync Error", e);
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center p-6">
                            <i class="fa-solid fa-triangle-exclamation text-4xl text-amber-500 mb-4"></i>
                            <h3 class="font-bold text-slate-700 text-lg">Sync Error</h3>
                            <p class="text-slate-500 max-w-md mb-6">Could not fetch live data from ClickUp. Check your internet connection or API key.</p>
                            <button onclick="app.renderDashboard(document.getElementById('contentArea'))" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">Try Again</button>
                        </div>
                    `;
                }
            },

            // --- AGENT DASHBOARD (Restricted View - Live Data) ---
            renderAgentDashboard(container, quotes) {
                // Filter quotes for this agent from the Live Data passed in
                const agentQuotes = quotes.filter(q => q.advisor === auth.user.name).slice(0, 5);
                
                container.innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto py-10">
                        <div class="text-center mb-10">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl shadow-sm border border-blue-200">
                                <i class="fa-solid fa-user-astronaut"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-slate-800 mb-2">Welcome back, ${auth.user.name}</h2>
                            <p class="text-slate-500">
                                <span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span> Live Data Synced
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                            <button onclick="app.navigate('quotation-new')" class="p-6 bg-slate-900 text-white rounded-2xl shadow-xl shadow-slate-200 hover:scale-[1.02] transition-transform flex flex-col items-center justify-center gap-3 border border-slate-700">
                                <i class="fa-solid fa-file-circle-plus text-3xl text-blue-400"></i>
                                <span class="font-bold text-lg">Create New Proposal</span>
                                <span class="text-xs text-slate-400">Start a fresh quotation for a client</span>
                            </button>

                            <button onclick="app.navigate('quotation-history')" class="p-6 bg-white text-slate-700 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-300 hover:shadow-md transition-all flex flex-col items-center justify-center gap-3">
                                <i class="fa-solid fa-clock-rotate-left text-3xl text-slate-300"></i>
                                <span class="font-bold text-lg">View History</span>
                                <span class="text-xs text-slate-400">Access your past quotations</span>
                            </button>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                            <h3 class="font-bold text-slate-700 mb-4 border-b border-slate-100 pb-2">Your Recent Activity (Live)</h3>
                            <div class="space-y-3">
                                ${agentQuotes.map(q => `
                                    <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg bg-white border border-slate-200 flex items-center justify-center font-bold text-slate-700 shadow-sm">
                                                ${q.customerName.charAt(0)}
                                            </div>
                                            <div>
                                                <div class="font-bold text-sm text-slate-800">${q.customerName}</div>
                                                <div class="text-xs text-slate-500">${q.refId} • ${new Date(q.date).toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                        <div class="font-mono font-bold text-slate-600 text-sm">€${parseFloat(q.grandTotal).toFixed(2)}</div>
                                    </div>
                                `).join('') || '<div class="text-center text-slate-400 py-4 text-sm">No recent proposals found on cloud.</div>'}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderHistory(container) {
                // Initial State: Show Local History
                let localQuotes = db.get('quotes').reverse();
                
                // VALIDATION: Filter local quotes based on user role
                if (auth.user.role !== 'admin') {
                    localQuotes = localQuotes.filter(q => (q.advisor || '').toUpperCase() === auth.user.name.toUpperCase());
                }

                container.innerHTML = `
                    <div class="fade-in h-full flex flex-col">
                        <!-- Advanced Search Toolbar -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                            <div class="flex flex-col md:flex-row gap-4 items-end">
                                <div class="flex-1 w-full">
                                    <h3 class="font-bold text-slate-700 text-lg mb-1">Archive Search</h3>
                                    <p class="text-xs text-slate-500 mb-3">Search global quotations synced in ClickUp</p>
                                    <div class="relative group">
                                        <input type="text" id="historySearchInput" placeholder="Search by Client Name, Ref ID (e.g. BCIQ-1002), or Phone..." 
                                            class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all group-hover:bg-white"
                                            onkeydown="if(event.key === 'Enter') app.handleHistorySearch()">
                                        <div class="absolute left-4 top-3.5 text-slate-400 group-focus-within:text-blue-500 transition-colors">
                                            <i class="fa-solid fa-magnifying-glass"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2 w-full md:w-auto">
                                    <button onclick="app.handleHistorySearch()" id="btnSearchHistory" class="px-6 py-3 bg-slate-900 text-white rounded-xl text-sm font-bold hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20 flex items-center justify-center gap-2 flex-1 md:flex-none">
                                        <i class="fa-solid fa-search"></i> Search Cloud
                                    </button>
                                    <button onclick="app.renderHistory(document.getElementById('contentArea'))" class="px-4 py-3 bg-white text-slate-500 border border-slate-200 rounded-xl text-sm font-bold hover:bg-slate-50 transition-all" title="Reset / Reload Local">
                                        <i class="fa-solid fa-rotate"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Container -->
                        <div id="historyResultsArea" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-10">
                            <!-- Default: Local History -->
                            ${this.generateHistoryCardsHTML(localQuotes, auth.user.role === 'admin' ? 'Recent Local History (All)' : 'Your Recent History')}
                        </div>
                    </div>
                `;
            },

            // --- HISTORY SEARCH LOGIC ---
            async handleHistorySearch() {
                const query = document.getElementById('historySearchInput').value.trim();
                if (!query) {
                    this.showToast('Please enter a search term', 'warning');
                    return;
                }

                const btn = document.getElementById('btnSearchHistory');
                const area = document.getElementById('historyResultsArea');
                
                // UI Loading State
                const originalBtn = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Searching...';
                btn.disabled = true;
                area.innerHTML = `
                    <div class="col-span-full py-20 text-center text-slate-400 fade-in">
                        <i class="fa-solid fa-satellite-dish fa-spin text-3xl mb-4 text-blue-200"></i>
                        <p class="text-sm font-medium">Searching ClickUp Database...</p>
                    </div>
                `;

                try {
                    // 1. Search ClickUp List
                    // Note: ClickUp's API fuzzy search can be broad (checking descriptions/comments).
                    // We fetch potential matches then strict filter client-side.
                    const url = `https://api.clickup.com/api/v2/list/${clickUpConfig.quotationListId}/task?search=${encodeURIComponent(query)}&include_closed=true`;
                    const res = await fetch(url, { headers: { 'Authorization': clickUpConfig.apiKey } });
                    
                    if (!res.ok) throw new Error('API Error');
                    const data = await res.json();
                    
                    // 2. Map Results
                    let mappedQuotes = data.tasks.map(t => this.mapClickUpTaskToQuote(t));
                    
                    // VALIDATION 1: Filter search results based on user role (Advisor Check)
                    if (auth.user.role !== 'admin') {
                        mappedQuotes = mappedQuotes.filter(q => (q.advisor || '').toUpperCase() === auth.user.name.toUpperCase());
                    }

                    // VALIDATION 2: Strict Keyword Filter (Client Side)
                    // Ensure the query actually exists in the visible fields (Name, Ref, Phone) 
                    // This prevents "showing all files" or unrelated files that happen to mention the name in hidden logs.
                    const qLower = query.toLowerCase();
                    mappedQuotes = mappedQuotes.filter(q => {
                        return (q.customerName && q.customerName.toLowerCase().includes(qLower)) ||
                               (q.refId && q.refId.toLowerCase().includes(qLower)) ||
                               (q.phone && q.phone.includes(query));
                    });

                    // 3. Render
                    if (mappedQuotes.length > 0) {
                        area.innerHTML = this.generateHistoryCardsHTML(mappedQuotes, `Found ${mappedQuotes.length} results for "${query}"`);
                    } else {
                        area.innerHTML = `
                            <div class="col-span-full py-16 text-center text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                                <i class="fa-solid fa-folder-open text-3xl mb-3 opacity-50"></i>
                                <p>No quotations found matching "${query}"</p>
                            </div>`;
                    }

                } catch (e) {
                    console.error(e);
                    this.showToast('Search failed. Please try again.', 'error');
                    area.innerHTML = `<div class="col-span-full text-center text-red-400 py-10">Connection Error</div>`;
                } finally {
                    btn.innerHTML = originalBtn;
                    btn.disabled = false;
                }
            },

            mapClickUpTaskToQuote(task) {
                // Helper to safely extract Custom Field Values
                const getVal = (fieldId) => {
                    if (!task.custom_fields) return null;
                    const f = task.custom_fields.find(x => x.id === fieldId);
                    if (!f) return null;
                    // Handle dropdowns, text, numbers
                    if (f.type === 'drop_down' && typeof f.value === 'number') return f.type_config.options[f.value]?.name;
                    if (typeof f.value === 'object' && f.value !== null) return f.value.status || f.value.text || f.value.name; 
                    return f.value;
                };

                const qf = clickUpConfig.quoteFields;
                
                // Parse Financials
                const grandTotal = parseFloat(getVal(qf.grandTotal)) || 0;
                const baseCost = parseFloat(getVal(qf.cost)) || 0;
                const regFee = parseFloat(getVal(qf.regFee)) || 0;
                const vat = parseFloat(getVal(qf.vat)) || 0;
                const discAmt = parseFloat(getVal(qf.discountAmount)) || 0;
                
                // Calculate Plan Adjustment (derived)
                // Adjustment = GrandTotal - (Base + Reg + VAT - Discount)
                const calculatedSub = baseCost + regFee + vat - discAmt;
                const planAdj = grandTotal - calculatedSub;

                const inst1 = parseFloat(getVal(qf.instalment1)) || 0;
                const inst2 = parseFloat(getVal(qf.instalment2)) || 0;
                const inst3 = parseFloat(getVal(qf.instalment3)) || 0;
                const inst4 = parseFloat(getVal(qf.instalment4)) || 0;

                return {
                    id: task.id, // ClickUp ID
                    isRemote: true,
                    refId: getVal(qf.refId) || '---',
                    customerName: task.name,
                    jobTitle: getVal(qf.jobTitle) || '---',
                    nationality: getVal(qf.nationality) || '---',
                    phone: getVal(qf.phone) || '---',
                    destination: getVal(qf.applyCountry) || 'Unknown',
                    visaName: getVal(qf.visaName) || '---',
                    advisor: getVal(qf.advisor) || 'System',
                    date: getVal(qf.date) || parseInt(task.date_created), 
                    grandTotal: grandTotal.toFixed(2),
                    financials: {
                        baseCost: baseCost,
                        regFee: regFee,
                        vat: vat,
                        discountName: getVal(qf.discountName) || 'None',
                        discountAmount: discAmt,
                        planAdjustment: planAdj,
                        grandTotal: grandTotal,
                        instalments: [inst1, inst2, inst3, inst4]
                    },
                    status: task.status.status
                };
            },

            generateHistoryCardsHTML(quotes, title) {
                if (!quotes || quotes.length === 0) return '';
                
                const titleBlock = title ? `<div class="col-span-full text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 px-1 flex items-center gap-2"><div class="h-px bg-slate-200 flex-1"></div>${title}<div class="h-px bg-slate-200 flex-1"></div></div>` : '';

                const cards = quotes.map(q => {
                    // Financials & Instalment Logic
                    const f = q.financials || {};
                    const insts = f.instalments || [0,0,0,0];
                    const activeInsts = insts.filter(x => x > 0);
                    const total = parseFloat(q.grandTotal);
                    
                    // Advisor Initials
                    const advName = q.advisor || 'Admin';
                    const advInit = advName.charAt(0).toUpperCase();

                    // Generate Instalment Bars
                    let barsHtml = '';
                    if (total > 0 && activeInsts.length > 0) {
                        barsHtml = activeInsts.map((amt, idx) => {
                            const pct = (amt / total) * 100;
                            const color = ['bg-emerald-500', 'bg-blue-500', 'bg-violet-500', 'bg-amber-500'][idx % 4];
                            return `
                                <div class="flex-1 flex flex-col gap-1 group/bar relative">
                                    <div class="h-1.5 w-full rounded-full bg-slate-100 overflow-hidden">
                                        <div class="h-full ${color}" style="width: 100%"></div>
                                    </div>
                                    <div class="text-[9px] font-mono text-slate-400 font-medium opacity-60">#${idx+1}</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                         barsHtml = `<div class="text-[10px] text-slate-400 italic">No plan data</div>`;
                    }

                    const dateStr = new Date(Number(q.date)).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const badgeColor = q.isRemote ? 'bg-purple-50 text-purple-600 border-purple-200' : 'bg-slate-50 text-slate-600 border-slate-200';
                    const icon = q.isRemote ? 'fa-cloud' : 'fa-database';

                    // Financial Items for Grid
                    const formatMoney = (val) => `€${(parseFloat(val)||0).toFixed(2)}`;
                    
                    return `
                    <div id="card-${q.id}" class="col-span-full md:col-span-1 bg-white rounded-lg border border-slate-200 shadow-sm transition-all duration-200 cursor-pointer hover:border-blue-300 group" onclick="app.toggleHistoryCard('${q.id}')">
                        
                        <!-- 1. COMPACT HEADER (Always Visible) -->
                        <div class="p-4 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 font-bold text-sm group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                    ${q.customerName.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm truncate w-32 sm:w-40" title="${q.customerName}">${q.customerName}</h4>
                                    <div class="text-[10px] text-slate-500 font-medium flex items-center gap-1.5">
                                        <span class="bg-white px-1.5 py-0.5 rounded border border-slate-100">${q.refId}</span>
                                        <span>${dateStr}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-6">
                                <div class="text-right hidden sm:block">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Total</div>
                                    <div class="text-sm font-bold text-slate-900 font-mono">€${Math.floor(total)}</div>
                                </div>
                                <i id="icon-${q.id}" class="fa-solid fa-chevron-down text-slate-300 transition-transform duration-300 group-hover:text-blue-400"></i>
                            </div>
                        </div>

                        <!-- 2. EXPANDED DETAILS (Hidden by Default) -->
                        <div id="details-${q.id}" class="hidden border-t border-slate-100 bg-slate-50/50">
                            
                            <!-- Primary Data Grid -->
                            <div class="p-4 grid grid-cols-2 gap-y-4 gap-x-6">
                                <!-- Col 1: Application -->
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Visa Details</p>
                                    <div class="text-xs font-bold text-slate-700">${q.destination}</div>
                                    <div class="text-xs text-slate-500">${q.visaName}</div>
                                    <div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-users text-slate-300 mr-1"></i> ${q.pax || 1} Pax</div>
                                </div>

                                <!-- Col 2: Contact -->
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Contact Info</p>
                                    <div class="text-xs text-slate-700">${q.phone}</div>
                                    <div class="text-xs text-slate-500">${q.nationality}</div>
                                    <div class="text-xs text-slate-500 mt-1">${q.jobTitle || '---'}</div>
                                </div>
                            </div>

                            <!-- Financial Breakdown Strip -->
                            <div class="px-4 py-3 bg-white border-y border-slate-100">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">Financial Breakdown</p>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                                    <div><span class="text-slate-400 text-[10px]">Base:</span> <span class="font-mono font-medium">${formatMoney(f.baseCost)}</span></div>
                                    <div><span class="text-slate-400 text-[10px]">Reg:</span> <span class="font-mono font-medium">${formatMoney(f.regFee)}</span></div>
                                    <div><span class="text-slate-400 text-[10px]">VAT:</span> <span class="font-mono font-medium">${formatMoney(f.vat)}</span></div>
                                    <div class="${f.discountAmount > 0 ? 'text-emerald-600' : 'text-slate-300'}"><span class="text-[10px]">Disc:</span> <span class="font-mono font-bold">-${formatMoney(f.discountAmount)}</span></div>
                                </div>
                            </div>

                            <!-- Footer: Advisor & Plan -->
                            <div class="p-4 flex flex-col gap-3">
                                <div>
                                    <div class="flex justify-between items-end mb-1">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase">Payment Schedule</span>
                                        <span class="text-[9px] font-bold text-slate-400 uppercase">Advisor: <span class="text-slate-600">${advName}</span></span>
                                    </div>
                                    <div class="flex gap-2 items-end h-6">
                                        ${barsHtml}
                                    </div>
                                </div>
                                
                                <div class="flex justify-end gap-2 pt-2 border-t border-slate-100/50">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold border ${badgeColor} flex items-center gap-1">
                                        <i class="fa-solid ${icon}"></i> ${q.status || 'Active'}
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div>`;
                }).join('');

                return titleBlock + cards;
            },

            // --- PROPOSAL VIEW ---
            renderAdvancedQuotation(container) {
                const allVisas = db.get('visas');
                const availableCountryIds = new Set(allVisas.map(v => v.countryId));
                const allCountries = db.get('countries');
                const validCountries = allCountries.filter(c => availableCountryIds.has(c.id));
                const nationalities = ["PAKISTAN", "SRI LANKA", "NEPAL", "BANGLADESH", "PHILIPPINES", "KENYA", "EGYPT", "UNITED KINGDOM", "INDIA", "UAE", "OTHER"];
                
                // Job List Configuration
                const jobPositions = [
                    "Civil Engineer", "Civil Draughtsman", "Land Surveyor", "Civil Site Supervisor", "Construction Safety Engineer", "Construction Safety Officer", 
                    "Welder", "Fabricator", "Scaffolder", "RCC Fitter", "Wall Painter", "Concrete Mix Operator", "Dozer Operator", "Excavator Operator", 
                    "Tower Crane Operator", "Mobile Crane Operator", "Grader Operator", "Steel Fixer", "Mechanical Engineer", "Mechanical Supervisor", 
                    "Diesel Mechanical Tech", "Mechanical Draughtsman", "Electrical Engineer", "Electrical Supervisor", "Electrical Tech (HV)", 
                    "Electrical Draughtsman", "Auto Electrician", "Auto Spray Painter", "Auto AC Tech", "TV Mechanic", "Tire Man", "Water Helper", 
                    "Fuel Station Worker", "Workshop Helper", "Liner", "Tinker", "Roller Operator", "Glass Cutter", "Construction Helper", 
                    "Carpenter Shuttering", "Carpenter Furniture", "Mason Plaster", "Chief Cook", "Continental Cook", "Assistant Cook", "Head Chef", 
                    "Assistant Chef", "Pastry Chef", "Commis Chef", "Sous Chef", "Kitchen Helper", "Chef de Partie", "Catering Supervisor", 
                    "Restaurant Supervisor", "Steward Supervisor", "F&B Supervisor", "Housekeeping Supervisor", "Dishwasher", "Barista", "F&B Staff", 
                    "Pizza Chef", "Housekeeping Worker", "Laundry Worker", "Laundry Supervisor", "Food Quality Inspector", "Safety Engineer", "H&S Officer", 
                    "Fire Safety Officer", "Commis I, II", "Stewards", "Captain", "Waiter/Waitress", "Butcher", "Food Packing Worker", "Driver Light Duty", 
                    "Forklift Operator", "AC Technician", "Security Guard", "Electrician", "Plumber", "Time Keeper", "Transport Supervisor", 
                    "Sales (Duty-Free)", "Cashier (Duty-Free)", "CCTV Tech", "Generator Mechanic", "Lift Tech", "Alarm Tech", "Loading Worker", 
                    "Aircraft Cleaner", "Trolley Helper", "Store Keeper", "Data Entry Operator", "Office Assistant", "Accountant", "System Service Engineer", 
                    "Computer Operator", "Staff Bus Driver", "Heavy Tanker Driver", "Head Nurse", "Assistant Nurse", "Chief Lab Tech", "X-Ray Technician", 
                    "Chief Pharmacist", "Ambulance Driver", "Ward Assistant", "Sweeper", "Asst Pharmacist", "Asst Lab Tech", "Sales Supervisor", 
                    "Cam Supervisor", "System Engineer", "System Operator", "Sales Workers", "Office Clerk", "Tanker Driver Head Duty", 
                    "Staff Bus Driver Head Duty", "Packing Helper", "Loading Unloading Workers", "Cleaning Helper", "Cashier", "Hair Stylist (Barber)", 
                    "Tailor", "Tailor Cutting Master", "CCTV Technician", "Air Conditioning Technician", "Electrical Supervisor", "Fire & Safety Officer", 
                    "Fire Alarm Technician", "RO Water Technician", "Poultry Farm Worker", "Poultry Yard Cleaner", "Poultry Farm Supervisor", 
                    "Dairy Farm Worker", "Dairy Farm Supervisor", "Egg Collector", "Egg Packer", "Veterinary Technician", "Veterinary Pharmacist", 
                    "Agriculture Farm Supervisor", "Agriculture Pharmacist Technician", "Agriculture Field Officer", "Agriculture Farm Workers", 
                    "Automotive Assembly Operator", "Chassis Line Worker", "Quality Control Specialist", "Paint Shop Assistant", "Production Line Operator", 
                    "CNC Machine Operator", "Electronics Assembler", "Warehouse Associate", "Construction Specialist", "Factory Assistant", 
                    "Nursing Assistant (Pflegehelfer)", "Registered Nurse", "Truck Driver (LKW)", "IT Specialist", "Hotel Staff", "Greenhouse Worker", 
                    "Flower Picker", "Warehouse Order Picker", "IT Developer", "Marketing Specialist", "Solar Panel Installer", "Welder / Fitter", 
                    "Aircraft Mechanic", "Truck Driver (Code 95)", "Software Developer", "Specialist Doctor", "Construction Worker", "Truck Driver", 
                    "Hotel Staff (Albania)", "Farm Worker", "Butcher (Albania)", "Care Home Assistant (France)", "Office Clerk (France)", "HR Assistant", 
                    "Care Home Assistant (Italy)", "Sales Executive", "IT Professional", "Logistics Coordinator", "General Agriculture", 
                    "Tractor Driver (Belarus)", "Professional Tailor", "Factory Worker"
                ].sort();

                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in lg:h-full h-auto pb-20 lg:pb-0">
                        <!-- Left Column: Inputs -->
                        <div class="lg:col-span-2 space-y-6 lg:overflow-y-auto h-auto pr-1 lg:pr-2 pb-2">
                            
                            <!-- NEW PROPOSAL BUTTON ROW -->
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                <div>
                                    <h3 class="font-bold text-slate-700 text-lg">Proposal Details</h3>
                                    <p class="text-xs text-slate-500">Fill in client information below</p>
                                </div>
                                <div class="flex items-center gap-3 w-full md:w-auto">
                                    <!-- MOVED: Advisor Name Display -->
                                    <div class="hidden sm:flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl border border-slate-200 shadow-sm">
                                         <div class="relative">
                                            <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center text-[10px] font-bold border-2 border-slate-100">
                                                ${auth.user.name.charAt(0)}
                                            </div>
                                            <div class="absolute -bottom-0.5 -right-0.5 bg-green-500 w-2.5 h-2.5 rounded-full border-2 border-white" title="Online"></div>
                                         </div>
                                         <div class="leading-tight pr-1">
                                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Advisor</div>
                                            <div class="text-xs font-bold text-slate-700">${auth.user.name}</div>
                                         </div>
                                    </div>

                                    <!-- NEW BUTTON -->
                                    <button onclick="app.createNewProposal()" id="btnNewProposal" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20 flex-1 md:flex-none flex items-center justify-center gap-2 border border-slate-700">
                                        <i class="fa-solid fa-plus"></i> New
                                    </button>
                                </div>
                            </div>

                            <!-- Card 1: Client & Trip Details -->
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2">APPLICATION DETAILS</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div class="space-y-1"><label class="text-xs font-semibold text-slate-600">Client Name</label><input type="text" id="f_name" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter Full Name" oninput="app.updateReceipt()"></div>
                                    
                                    <!-- UPDATED: Apply Position Dropdown -->
                                    <div class="space-y-1">
                                        <label class="text-xs font-semibold text-slate-600">Apply Position</label>
                                        <select id="f_job" onchange="app.handleJobChange(this); app.updateReceipt()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="">Select Position</option>
                                            ${jobPositions.map(j => `<option value="${j}">${j}</option>`).join('')}
                                            <option value="OTHER" class="text-blue-600 font-bold">+ Other / Custom</option>
                                        </select>
                                        <input type="text" id="f_job_custom" class="w-full p-2.5 mt-2 bg-blue-50 border border-blue-200 text-blue-700 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none hidden placeholder-blue-300" placeholder="Enter Custom Position" oninput="app.updateReceipt()">
                                    </div>

                                    <div class="space-y-1"><label class="text-xs font-semibold text-slate-600">Phone</label><input type="tel" id="f_phone" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="+971..." oninput="app.updateReceipt()"></div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-semibold text-slate-600">Nationality</label>
                                        <select id="f_nation" onchange="app.handleNationalityChange(this)" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="">Select Nationality</option>
                                            ${nationalities.map(n => `<option value="${n}">${n}</option>`).join('')}
                                        </select>
                                        <div id="customNationalityDiv" class="hidden mt-2"><input type="text" id="customNationalityInput" placeholder="Specify Nationality" class="w-full p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700" oninput="app.validateProposal()"></div>
                                    </div>
                                    <div class="space-y-1"><label class="text-xs font-semibold text-slate-600">No. of Applicants</label><input type="number" id="paxInput" value="1" min="1" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" oninput="app.calculateTotal()"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-4">
                                    <div class="space-y-1"><label class="text-xs font-semibold text-slate-600">Destination</label><select id="countrySelect" onchange="app.handleCountryChange(this.value)" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">Select Destination</option>${validCountries.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                                    <div class="space-y-1"><label class="text-xs font-semibold text-slate-600">Visa Type</label><select id="visaSelect" disabled onchange="app.handleVisaChange(this.value)" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">Select Destination First</option></select></div>
                                </div>
                            </div>

                            <!-- Card 2: Financial Configuration -->
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Pricing Configuration</h3>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-200 text-slate-500">Auto-Calc</span>
                                </div>
                                
                                <div class="p-6 space-y-6">
                                    <!-- Cost Inputs -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Base Cost -->
                                        <div class="relative p-4 rounded-xl border border-slate-200 bg-white hover:border-blue-300 transition-colors group">
                                            <div class="absolute top-3 right-3 text-slate-300 group-hover:text-blue-200 transition-colors"><i class="fa-solid fa-tag"></i></div>
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Visa Cost</p>
                                            <div class="flex items-baseline gap-1">
                                                <span class="text-2xl font-bold text-slate-800 tracking-tight">€<span id="disp_cost">0</span></span>
                                                <span class="text-xs text-slate-400 font-medium">/ pax</span>
                                            </div>
                                            <div class="text-[10px] text-slate-400 font-mono mt-1" id="disp_cost_aed">AED 0.00</div>
                                            <input type="hidden" id="costInput">
                                        </div>

                                        <!-- Reg Fee -->
                                        <div class="relative p-4 rounded-xl border border-slate-200 bg-white hover:border-purple-300 transition-colors group">
                                            <div class="absolute top-3 right-3 text-slate-300 group-hover:text-purple-200 transition-colors"><i class="fa-solid fa-file-signature"></i></div>
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Registration</p>
                                            <div class="flex items-baseline gap-1">
                                                <span class="text-2xl font-bold text-slate-800 tracking-tight">€<span id="disp_reg">0</span></span>
                                                <span class="text-xs text-slate-400 font-medium">/ pax</span>
                                            </div>
                                            <div class="text-[10px] text-slate-400 font-mono mt-1" id="disp_reg_aed">AED 0.00</div>
                                            <input type="hidden" id="regFeeInput">
                                        </div>
                                    </div>

                                    <!-- VAT Strip -->
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 border border-slate-200 border-dashed">
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center text-xs"><i class="fa-solid fa-percent"></i></div>
                                            <div>
                                                <div class="text-xs font-bold text-slate-700">VAT (5%)</div>
                                                <div class="text-[10px] text-slate-400">Applied to Total</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="flex items-center justify-end">
                                                <span class="text-sm font-bold text-slate-600 mr-1">€</span>
                                                <!-- UPDATED: Changed type to text and increased width for visibility -->
                                                <input type="text" id="vatInput" readonly class="w-24 bg-transparent text-right font-bold text-slate-800 outline-none border-none p-0 focus:ring-0" value="0.00">
                                            </div>
                                            <div class="text-[10px] text-slate-400 font-mono" id="disp_vat_aed">AED 0.00</div>
                                        </div>
                                    </div>

                                    <!-- Discount Section -->
                                    <div>
                                        <div class="flex justify-between items-center mb-3">
                                            <label class="text-xs font-bold text-slate-700 uppercase tracking-wide">Select Discount</label>
                                            <span id="groupWarning" class="text-[10px] text-red-500 font-bold hidden bg-red-50 px-2 py-0.5 rounded border border-red-100"><i class="fa-solid fa-circle-exclamation mr-1"></i> Min 4 Pax Required</span>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            <!-- Custom Amount (Replaces Standard) -->
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="discountName" value="custom" class="peer sr-only" checked onchange="app.syncPaymentOptions('discount')">
                                                <div class="h-full p-3 rounded-xl border border-dashed border-slate-300 bg-white hover:border-blue-400 hover:bg-blue-50/10 transition-all peer-checked:border-solid peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:shadow-sm group">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <span class="text-xs font-bold text-slate-600 group-hover:text-blue-600">Custom</span>
                                                        <i class="fa-solid fa-pen-nib text-xs text-slate-300 peer-checked:text-blue-600"></i>
                                                    </div>
                                                    <div class="relative flex items-center group/input">
                                                        <span class="absolute left-2 text-xs font-bold text-slate-400 group-hover/input:text-blue-400">€</span>
                                                        <input type="number" id="customDiscountInput" placeholder="0" 
                                                            class="w-full pl-5 pr-2 py-1 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-right placeholder-slate-300"
                                                            onclick="this.closest('label').querySelector('input[type=radio]').checked = true; app.syncPaymentOptions('discount')"
                                                            oninput="app.calculateTotal()">
                                                    </div>
                                                </div>
                                            </label>

                                            <!-- Full Pay (10%) -->
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="discountName" value="full_pay" class="peer sr-only" onchange="app.syncPaymentOptions('discount')">
                                                <div class="h-full p-3 rounded-xl border border-emerald-100 bg-emerald-50/30 hover:bg-emerald-50 transition-all peer-checked:border-emerald-600 peer-checked:bg-emerald-600 peer-checked:text-white peer-checked:shadow-lg peer-checked:shadow-emerald-500/20 group">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <span class="text-xs font-bold text-emerald-800 peer-checked:text-white">Full Pay</span>
                                                        <span class="text-[9px] font-bold bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded peer-checked:bg-white/20 peer-checked:text-white">-10%</span>
                                                    </div>
                                                    <div class="text-[10px] text-emerald-600/70 peer-checked:text-emerald-100">Immediate payment</div>
                                                </div>
                                            </label>

                                            <!-- Couple (5%) -->
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="discountName" value="couple" class="peer sr-only" onchange="app.syncPaymentOptions('discount')">
                                                <div class="h-full p-3 rounded-xl border border-pink-100 bg-pink-50/30 hover:bg-pink-50 transition-all peer-checked:border-pink-500 peer-checked:bg-pink-500 peer-checked:text-white peer-checked:shadow-lg peer-checked:shadow-pink-500/20 group">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <span class="text-xs font-bold text-pink-800 peer-checked:text-white">Couple</span>
                                                        <span class="text-[9px] font-bold bg-pink-100 text-pink-700 px-1.5 py-0.5 rounded peer-checked:bg-white/20 peer-checked:text-white">-5%</span>
                                                    </div>
                                                    <div class="text-[10px] text-pink-600/70 peer-checked:text-pink-100">Joint application</div>
                                                </div>
                                            </label>

                                            <!-- Group (10%) -->
                                            <label class="cursor-pointer relative">
                                                <input type="radio" id="groupDiscBtn" name="discountName" value="group" class="peer sr-only" onchange="app.syncPaymentOptions('discount')">
                                                <div id="groupDiscUI" class="h-full p-3 rounded-xl border border-blue-100 bg-blue-50/30 hover:bg-blue-50 transition-all peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:shadow-lg peer-checked:shadow-blue-500/20 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed group">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <span class="text-xs font-bold text-blue-800 peer-checked:text-white">Group</span>
                                                        <span class="text-[9px] font-bold bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded peer-checked:bg-white/20 peer-checked:text-white">-10%</span>
                                                    </div>
                                                    <div class="text-[10px] text-blue-600/70 peer-checked:text-blue-100">4+ applicants</div>
                                                </div>
                                            </label>

                                            <!-- Skilled (5%) -->
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="discountName" value="skilled" class="peer sr-only" onchange="app.syncPaymentOptions('discount')">
                                                <div class="h-full p-3 rounded-xl border border-violet-100 bg-violet-50/30 hover:bg-violet-50 transition-all peer-checked:border-violet-600 peer-checked:bg-violet-600 peer-checked:text-white peer-checked:shadow-lg peer-checked:shadow-violet-500/20 group">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <span class="text-xs font-bold text-violet-800 peer-checked:text-white">Skilled</span>
                                                        <span class="text-[9px] font-bold bg-violet-100 text-violet-700 px-1.5 py-0.5 rounded peer-checked:bg-white/20 peer-checked:text-white">-5%</span>
                                                    </div>
                                                    <div class="text-[10px] text-violet-600/70 peer-checked:text-violet-100">Qualified Pro</div>
                                                </div>
                                            </label>

                                            <!-- Reference (4%) -->
                                            <label class="cursor-pointer relative">
                                                <input type="radio" name="discountName" value="reference" class="peer sr-only" onchange="app.syncPaymentOptions('discount')">
                                                <div class="h-full p-3 rounded-xl border border-orange-100 bg-orange-50/30 hover:bg-orange-50 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:shadow-lg peer-checked:shadow-orange-500/20 group">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <span class="text-xs font-bold text-orange-800 peer-checked:text-white">Reference</span>
                                                        <span class="text-[9px] font-bold bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded peer-checked:bg-white/20 peer-checked:text-white">-4%</span>
                                                    </div>
                                                    <div class="text-[10px] text-orange-600/70 peer-checked:text-orange-100">Referral code</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 3: Payment Plan (Updated Creative Grid) -->
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2">Select Payment Schedule</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    
                                    <!-- Plan 1: Full Payment (Emerald) -->
                                    <label class="cursor-pointer relative group">
                                        <input type="radio" name="instalment" value="1" class="peer sr-only" onchange="app.syncPaymentOptions('plan')">
                                        <div class="p-5 rounded-2xl border border-slate-200 bg-white transition-all duration-200 
                                            hover:shadow-md hover:border-emerald-300 hover:-translate-y-1
                                            peer-checked:border-emerald-500 peer-checked:bg-emerald-50/40 peer-checked:ring-1 peer-checked:ring-emerald-500
                                            h-full flex flex-col relative overflow-hidden group-hover:shadow-emerald-100">
                                            
                                            <div class="absolute top-0 right-0 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg shadow-sm">
                                                BEST VALUE
                                            </div>

                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-lg shadow-sm ring-4 ring-white">
                                                    <i class="fa-solid fa-check-double"></i>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-slate-700 leading-tight group-hover:text-emerald-700 transition-colors">Full Payment</h4>
                                                    <span class="text-[10px] text-emerald-600 font-bold bg-emerald-100 px-1.5 py-0.5 rounded-full">10% OFF</span>
                                                </div>
                                            </div>
                                            
                                            <div id="plan_1_details" class="mt-auto">
                                                <!-- Populated by JS -->
                                            </div>
                                        </div>
                                    </label>

                                    <!-- Plan 2: 2 Instalments (Blue) -->
                                    <label class="cursor-pointer relative group">
                                        <input type="radio" name="instalment" value="2" checked class="peer sr-only" onchange="app.syncPaymentOptions('plan')">
                                        <div class="p-5 rounded-2xl border border-slate-200 bg-white transition-all duration-200 
                                            hover:shadow-md hover:border-blue-300 hover:-translate-y-1
                                            peer-checked:border-blue-500 peer-checked:bg-blue-50/40 peer-checked:ring-1 peer-checked:ring-blue-500
                                            h-full flex flex-col relative overflow-hidden group-hover:shadow-blue-100">
                                            
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg shadow-sm ring-4 ring-white">
                                                    <span class="font-bold font-mono">2</span>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-slate-700 leading-tight group-hover:text-blue-700 transition-colors">Two-Part</h4>
                                                    <span class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 py-0.5 rounded">50% / 50%</span>
                                                </div>
                                            </div>
                                            
                                            <div id="plan_2_details" class="mt-auto"></div>
                                        </div>
                                    </label>

                                    <!-- Plan 3: 3 Instalments (Violet) -->
                                    <label class="cursor-pointer relative group">
                                        <input type="radio" name="instalment" value="3" class="peer sr-only" onchange="app.calculateTotal()">
                                        <div class="p-5 rounded-2xl border border-slate-200 bg-white transition-all duration-200 
                                            hover:shadow-md hover:border-violet-300 hover:-translate-y-1
                                            peer-checked:border-violet-500 peer-checked:bg-violet-50/40 peer-checked:ring-1 peer-checked:ring-violet-500
                                            h-full flex flex-col relative overflow-hidden group-hover:shadow-violet-100">
                                            
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="w-10 h-10 rounded-full bg-violet-100 text-violet-600 flex items-center justify-center text-lg shadow-sm ring-4 ring-white">
                                                    <span class="font-bold font-mono">3</span>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-slate-700 leading-tight group-hover:text-violet-700 transition-colors">Three-Part</h4>
                                                    <span class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 py-0.5 rounded">30% / 40% / 30%</span>
                                                </div>
                                            </div>
                                            
                                            <div id="plan_3_details" class="mt-auto"></div>
                                        </div>
                                    </label>
                                    
                                    <!-- Plan 4: 4 Instalments (Amber) -->
                                    <label class="cursor-pointer relative group">
                                        <input type="radio" name="instalment" value="4" class="peer sr-only" onchange="app.calculateTotal()">
                                        <div class="p-5 rounded-2xl border border-slate-200 bg-white transition-all duration-200 
                                            hover:shadow-md hover:border-amber-300 hover:-translate-y-1
                                            peer-checked:border-amber-500 peer-checked:bg-amber-50/40 peer-checked:ring-1 peer-checked:ring-amber-500
                                            h-full flex flex-col relative overflow-hidden group-hover:shadow-amber-100">
                                            
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center text-lg shadow-sm ring-4 ring-white">
                                                    <span class="font-bold font-mono">4</span>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold text-slate-700 leading-tight group-hover:text-amber-700 transition-colors">Four-Part</h4>
                                                    <span class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 py-0.5 rounded">30% / 30% / 20% / 20%</span>
                                                </div>
                                            </div>
                                            
                                            <div id="plan_4_details" class="mt-auto"></div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                            <!-- Right Column: Sticky Receipt -->
                            <div class="lg:col-span-1">
                                <!-- Creative Ticket Design -->
                                <div class="sticky top-6 bg-white rounded-3xl shadow-2xl border-0 overflow-hidden flex flex-col relative z-10 ring-1 ring-slate-900/5">
                                    <!-- Decorative Elements -->
                                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                                    <div class="absolute -top-10 -right-10 w-24 h-24 bg-blue-50 rounded-full blur-2xl opacity-50"></div>
                                    
                                    <!-- Header -->
                                    <div class="bg-slate-900 p-6 pt-8 pb-10 text-center relative overflow-hidden">
                                        <div class="absolute top-0 left-0 w-full h-full opacity-10" style="background-image: radial-gradient(#4f46e5 1px, transparent 1px); background-size: 10px 10px;"></div>
                                        
                                        <!-- NEW: Date and Ref Row in Live Preview -->
                                        <div class="relative z-10 flex justify-between items-center text-[10px] text-slate-400 font-mono mb-4 px-2">
                                            <span id="r_date">---</span>
                                            <!-- UPDATED: Added data-fixed-ref attribute logic -->
                                            <span>REF: <span id="r_ref" class="text-white font-bold">DRAFT</span></span>
                                        </div>

                                        <div class="relative z-10">
                                            <div class="w-14 h-14 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 text-white shadow-inner border border-white/20">
                                                <i class="fa-solid fa-plane-departure text-2xl"></i>
                                            </div>
                                            <!-- UPDATED: Uppercase Name -->
                                            <h3 class="font-bold text-white text-lg tracking-wide uppercase" id="r_client">CLIENT NAME</h3>
                                            <!-- NEW: Job Title in Live Preview -->
                                            <p class="text-xs text-blue-200 font-medium tracking-widest uppercase mt-1" id="r_job">---</p>
                                            <p class="text-xs text-slate-400 mt-1" id="r_phone">---</p>
                                        </div>
                                    </div>

                                    <!-- Ticket Jagged Edge Effect -->
                                    <div class="h-4 bg-slate-900 relative">
                                        <div class="absolute bottom-0 w-full h-4 bg-white rounded-t-2xl"></div>
                                    </div>

                                    <div class="p-6 pt-2 flex-1 space-y-5 bg-white">
                                        <!-- Receipt Details Grid -->
                                        <div class="grid grid-cols-3 gap-2 text-xs">
                                            <div class="p-2 bg-slate-50 rounded-xl border border-slate-100 col-span-2">
                                                <span class="block text-[9px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">Destination</span>
                                                <span class="font-bold text-slate-700 block truncate" id="r_dest">---</span>
                                            </div>
                                            <div class="p-2 bg-slate-50 rounded-xl border border-slate-100">
                                                <span class="block text-[9px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">Pax</span>
                                                <span class="font-bold text-slate-700 block truncate" id="r_pax">1 Pax</span>
                                            </div>
                                            <div class="p-2 bg-slate-50 rounded-xl border border-slate-100 col-span-3">
                                                <span class="block text-[9px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">Visa Type</span>
                                                <span class="font-bold text-slate-700 block truncate" id="r_visa">---</span>
                                            </div>
                                        </div>

                                        <div class="space-y-3 text-sm">
                                            <!-- Dynamic Rows injected via JS -->
                                            <div class="flex justify-between items-start group">
                                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide mt-1">Base Cost</span>
                                                <div class="text-right" id="row_cost_values">
                                                    <!-- Values injected by JS -->
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-start group">
                                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide mt-1">Registration</span>
                                                <div class="text-right" id="row_reg_values"></div>
                                            </div>
                                            <div class="flex justify-between items-start group">
                                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wide mt-1">VAT (5%)</span>
                                                <div class="text-right" id="row_vat_values"></div>
                                            </div>
                                            
                                            <div class="h-px bg-gradient-to-r from-transparent via-slate-200 to-transparent my-2"></div>
                                            
                                            <div class="flex justify-between items-start text-emerald-600 hidden" id="r_disc_row">
                                                <span class="text-xs font-bold uppercase tracking-wide mt-1" id="r_disc_label">Discount</span>
                                                <div class="text-right" id="row_disc_values"></div>
                                            </div>
                                            <div class="flex justify-between items-start text-blue-600 hidden" id="r_sur_row">
                                                <span class="text-xs font-bold uppercase tracking-wide mt-1" id="r_sur_label">Adjustment</span>
                                                <div class="text-right" id="row_sur_values"></div>
                                            </div>
                                            
                                            <!-- Payment Schedule Breakdown -->
                                            <div id="r_instalments_container" class="hidden pt-3 mt-3 border-t border-dashed border-slate-200">
                                                <div class="flex items-center gap-2 mb-3">
                                                    <div class="h-px bg-slate-200 flex-1"></div>
                                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Payment Plan</span>
                                                    <div class="h-px bg-slate-200 flex-1"></div>
                                                </div>
                                                <div id="r_instalments_list" class="space-y-3"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Total Block -->
                                        <div class="pt-4 mt-2">
                                            <div id="r_multi_currency" class="space-y-2"></div>
                                        </div>

                                        <!-- REMOVED: Previous Advisor Card from here -->

                                    </div>

                                    <!-- Actions (Save & Preview Disabled by Default) -->
                                    <div class="p-4 bg-slate-50 border-t border-slate-100 grid grid-cols-2 gap-3">
                                        <button onclick="app.openPreview()" id="btnPreviewProposal" disabled class="py-2.5 rounded-xl text-xs font-bold bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:text-slate-600 disabled:hover:border-slate-200">
                                            <i class="fa-regular fa-eye mr-1"></i> Preview
                                        </button>
                                        <button onclick="app.saveQuotation()" id="btnSaveProposal" disabled class="py-2.5 rounded-xl text-xs font-bold bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-purple-600 hover:border-purple-200 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:text-slate-600 disabled:hover:border-slate-200">
                                            <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => this.calculateTotal(), 50); 
            },

            // --- PROPOSAL LOGIC ---
            handleCountryChange(countryId) {
                const visaSelect = document.getElementById('visaSelect');
                visaSelect.innerHTML = '<option value="">Select Visa Type</option>';
                visaSelect.disabled = true;
                
                document.getElementById('r_dest').innerText = "---";
                document.getElementById('r_visa').innerText = "---";
                
                if (!countryId) {
                    this.validateProposal();
                    return;
                }

                const country = db.get('countries').find(c => c.id == countryId);
                if (country) {
                    document.getElementById('r_dest').innerText = country.name;
                    // Filter visas for this country
                    const visas = db.get('visas').filter(v => v.countryId == countryId);
                    if (visas.length > 0) {
                        visaSelect.disabled = false;
                        visas.forEach(v => {
                            const opt = document.createElement('option');
                            opt.value = v.id; // Using ID to lookup specific cost
                            opt.text = v.name;
                            visaSelect.appendChild(opt);
                        });
                    }
                }
                this.calculateTotal();
            },

            handleVisaChange(visaId) {
                const visa = db.get('visas').find(v => v.id == visaId);
                if (visa) {
                    document.getElementById('r_visa').innerText = visa.name;
                    document.getElementById('costInput').value = visa.cost;
                    document.getElementById('regFeeInput').value = visa.regFee;
                    document.getElementById('disp_cost').innerText = visa.cost;
                    document.getElementById('disp_reg').innerText = visa.regFee;
                    
                    // Update AED displays immediately for these inputs
                    document.getElementById('disp_cost_aed').innerText = `AED ${currencyLayer.getEuroToAED(visa.cost).toFixed(2)}`;
                    document.getElementById('disp_reg_aed').innerText = `AED ${currencyLayer.getEuroToAED(visa.regFee).toFixed(2)}`;
                } else {
                    document.getElementById('r_visa').innerText = "---";
                    document.getElementById('costInput').value = 0;
                    document.getElementById('regFeeInput').value = 0;
                }
                this.calculateTotal();
            },

            handleNationalityChange(select) {
                const val = select.value;
                const customDiv = document.getElementById('customNationalityDiv');
                if (val === 'OTHER') {
                    customDiv.classList.remove('hidden');
                    this.selectedLocalCurrency = null; // Or default?
                } else {
                    customDiv.classList.add('hidden');
                    this.selectedLocalCurrency = currencyLayer.getNationalityCurrency(val);
                }
                this.calculateTotal();
            },

            // --- HELPER: AUTO GENERATE REF ID ---
            generateLocalRefId() {
                const quotes = db.get('quotes');
                let maxId = 1000;
                quotes.forEach(q => {
                    if (q.refId) {
                        // Extract number regardless of prefix
                        const num = parseInt(String(q.refId).replace(/\D/g, ''), 10);
                        if (!isNaN(num) && num > maxId) {
                            maxId = num;
                        }
                    }
                });
                return `BCIQ-${maxId + 1}`;
            },

            // --- NEW FUNCTION: FETCH LAST REF FROM CLICKUP ---
            async fetchNextRefId() {
                try {
                    // Fetch latest 20 tasks to find max ID
                    const url = `https://api.clickup.com/api/v2/list/${clickUpConfig.quotationListId}/task?include_closed=true&order_by=created&reverse=true&page=0`;
                    const res = await fetch(url, { headers: { 'Authorization': clickUpConfig.apiKey } });
                    
                    if (!res.ok) throw new Error("API Error");
                    
                    const data = await res.json();
                    let maxId = 1000;

                    // 1. Check Local DB first
                    const localNext = this.generateLocalRefId();
                    const localNum = parseInt(localNext.replace(/\D/g, ''), 10);
                    if(localNum > maxId) maxId = localNum - 1; 

                    // 2. Check ClickUp Data
                    if(data.tasks) {
                        data.tasks.forEach(t => {
                            const refField = t.custom_fields.find(f => f.id === clickUpConfig.quoteFields.refId);
                            // Robust check: Custom field value OR Task description/name fallback
                            const valToCheck = (refField && refField.value) ? String(refField.value) : '';
                            
                            if(valToCheck) {
                                 // Extract digits only
                                 const num = parseInt(valToCheck.replace(/\D/g, ''), 10);
                                 if(!isNaN(num) && num > maxId && num < 99999) { // Sanity check < 99999 to avoid phone numbers
                                     maxId = num;
                                 }
                            }
                        });
                    }
                    
                    return `BCIQ-${maxId + 1}`;
                } catch(e) {
                    console.error("Error fetching refs from ClickUp", e);
                    return this.generateLocalRefId(); // Fallback to local
                }
            },

            // --- NEW FUNCTION: RESET AND START NEW PROPOSAL ---
            async createNewProposal() {
                 const btn = document.getElementById('btnNewProposal');
                 if(btn) {
                     btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Generating Ref...';
                     btn.disabled = true;
                 }
                 
                 // Show temporary feedback in the Ref ID display too
                 const rRef = document.getElementById('r_ref');
                 if(rRef) {
                     rRef.innerText = 'SYNCING...';
                     rRef.classList.add('animate-pulse');
                     delete rRef.dataset.fixedRef;
                 }

                 try {
                     const nextRef = await this.fetchNextRefId();
                     
                     // 1. Clear Inputs
                     const inputs = ['f_name', 'f_phone', 'f_nation', 'countrySelect', 'costInput', 'regFeeInput']; 
                     inputs.forEach(id => {
                         const el = document.getElementById(id);
                         if(el) el.value = '';
                     });
                     
                     // Reset Job Dropdown & Custom
                     document.getElementById('f_job').value = '';
                     document.getElementById('f_job_custom').value = '';
                     document.getElementById('f_job_custom').classList.add('hidden');

                     const paxEl = document.getElementById('paxInput');
                     if(paxEl) paxEl.value = '1';
                     
                     const visaSelect = document.getElementById('visaSelect');
                     if(visaSelect) {
                         visaSelect.innerHTML = '<option value="">Select Destination First</option>';
                         visaSelect.disabled = true;
                     }

                     document.getElementById('customNationalityDiv').classList.add('hidden');
                     this.selectedLocalCurrency = null;

                     // 2. Reset Options
                     const discCustom = document.querySelector('input[name="discountName"][value="custom"]');
                     if(discCustom) discCustom.checked = true;
                     const customInput = document.getElementById('customDiscountInput');
                     if(customInput) customInput.value = '';
                     
                     const instTwo = document.querySelector('input[name="instalment"][value="2"]'); 
                     if(instTwo) instTwo.checked = true;

                     // 3. Set Ref & Lock it
                     if(rRef) {
                         rRef.innerText = nextRef;
                         rRef.dataset.fixedRef = nextRef; 
                         rRef.classList.remove('animate-pulse');
                     }
                     
                     // 4. Reset Receipt Text
                     const defaults = { 'r_client': 'CLIENT NAME', 'r_job': '---', 'r_phone': '---', 'r_dest': '---', 'r_visa': '---', 'r_pax': '1 Pax' };
                     for(const [id, txt] of Object.entries(defaults)) {
                         const el = document.getElementById(id);
                         if(el) el.innerText = txt;
                     }

                     // 5. Reset Financial Display
                     document.getElementById('disp_cost').innerText = '0';
                     document.getElementById('disp_reg').innerText = '0';
                     document.getElementById('disp_cost_aed').innerText = 'AED 0.00';
                     document.getElementById('disp_reg_aed').innerText = 'AED 0.00';
                     
                     this.calculateTotal();

                 } catch(e) {
                     this.showToast('Using local reference ID', 'warning');
                     console.error(e);
                     // Fallback in case of critical error
                     if(rRef) {
                         const fallbackRef = this.generateLocalRefId();
                         rRef.innerText = fallbackRef;
                         rRef.dataset.fixedRef = fallbackRef;
                         rRef.classList.remove('animate-pulse');
                     }
                 } finally {
                     if(btn) {
                         // UPDATED BUTTON TEXT RESET
                         btn.innerHTML = '<i class="fa-solid fa-plus"></i> New';
                         btn.disabled = false;
                     }
                 }
            },

            updateReceipt() {
                 const nameEl = document.getElementById('f_name');
                 
                 // Get Job Title (Dropdown or Custom)
                 const jobSelect = document.getElementById('f_job');
                 const jobCustom = document.getElementById('f_job_custom');
                 let jobVal = "---";
                 if(jobSelect) {
                     if(jobSelect.value === 'OTHER') jobVal = jobCustom.value || "---";
                     else if(jobSelect.value) jobVal = jobSelect.value;
                 }

                 const phoneEl = document.getElementById('f_phone');
                 const rClient = document.getElementById('r_client');
                 const rJob = document.getElementById('r_job');
                 const rPhone = document.getElementById('r_phone');
                 const rDate = document.getElementById('r_date');
                 const rRef = document.getElementById('r_ref');

                 // Safe updates
                 if(rClient && nameEl) rClient.innerText = nameEl.value ? nameEl.value.toUpperCase() : "CLIENT NAME";
                 if(rJob) rJob.innerText = jobVal.toUpperCase();
                 if(rPhone && phoneEl) rPhone.innerText = phoneEl.value || "---";
                 
                 if(rDate) rDate.innerText = new Date().toLocaleDateString('en-GB');
                 
                 // UPDATED: Ref Logic to respect Auto-Generated Ref
                 if(rRef) {
                     // If we generated a ref via the button, keep it. Otherwise DRAFT.
                     if(!rRef.dataset.fixedRef) {
                         rRef.innerText = "DRAFT"; 
                     }
                 }
                 
                 this.validateProposal();
            },
            
            // NEW: Handle Job Dropdown Toggle
            handleJobChange(select) {
                const customInput = document.getElementById('f_job_custom');
                if (select.value === 'OTHER') {
                    customInput.classList.remove('hidden');
                    customInput.focus();
                } else {
                    customInput.classList.add('hidden');
                    customInput.value = '';
                }
                this.validateProposal();
            },

            // --- SYNC PAYMENT OPTIONS ---
            syncPaymentOptions(source) {
                const discFullPay = document.querySelector('input[name="discountName"][value="full_pay"]');
                const planFullPay = document.querySelector('input[name="instalment"][value="1"]');
                const discCustom = document.querySelector('input[name="discountName"][value="custom"]');
                const planTwo = document.querySelector('input[name="instalment"][value="2"]');

                if (source === 'plan') {
                    if (planFullPay.checked) {
                        if (discFullPay) discFullPay.checked = true;
                    } else {
                        // If switching AWAY from full payment plan, and discount is currently full pay, reset discount to Custom
                        if (discFullPay && discFullPay.checked) {
                            if (discCustom) discCustom.checked = true;
                        }
                    }
                } else if (source === 'discount') {
                    if (discFullPay.checked) {
                        if (planFullPay) planFullPay.checked = true;
                    } else {
                        // If switching AWAY from full pay discount, and plan is currently full payment, reset plan to 2 Installments
                        if (planFullPay && planFullPay.checked) {
                            if (planTwo) planTwo.checked = true;
                        }
                    }
                }
                
                this.calculateTotal();
            },

            // --- VALIDATION LOGIC ---
            validateProposal() {
                const btnPreview = document.getElementById('btnPreviewProposal');
                const btnSave = document.getElementById('btnSaveProposal');
                if(!btnPreview || !btnSave) return;

                // 1. Application Details Check
                const fName = document.getElementById('f_name')?.value.trim();
                const fPhone = document.getElementById('f_phone')?.value.trim();
                const fNation = document.getElementById('f_nation')?.value;
                const fNationCustom = document.getElementById('customNationalityInput')?.value.trim();
                const fJob = document.getElementById('f_job')?.value;
                const fJobCustom = document.getElementById('f_job_custom')?.value.trim();
                const pax = parseInt(document.getElementById('paxInput')?.value) || 0;
                
                const isNationValid = fNation === 'OTHER' ? (fNationCustom !== '') : (fNation !== '');
                const isJobValid = fJob === 'OTHER' ? (fJobCustom !== '') : (fJob !== '');
                
                // 2. Pricing Check
                const country = document.getElementById('countrySelect')?.value;
                const visa = document.getElementById('visaSelect')?.value;
                // Cost inputs are generally read-only/hidden but populated when visa is selected
                // We ensure visa is selected which implies pricing is active
                
                // 3. Payment Plan Check
                const instalmentChecked = document.querySelector('input[name="instalment"]:checked');

                const isValid = fName && fPhone && isNationValid && isJobValid && 
                                pax > 0 && country && visa && instalmentChecked;

                if(isValid) {
                    btnPreview.removeAttribute('disabled');
                    btnSave.removeAttribute('disabled');
                } else {
                    btnPreview.setAttribute('disabled', 'true');
                    btnSave.setAttribute('disabled', 'true');
                }
            },

            calculateTotal() {
                try {
                    // Update receipt details just in case
                    this.updateReceipt();

                    // Check for inputs before proceeding - Critical safeguard
                    const costEl = document.getElementById('costInput');
                    const regEl = document.getElementById('regFeeInput');
                    const paxEl = document.getElementById('paxInput');
                    
                    if(!costEl || !regEl || !paxEl) return; 

                    const costPerPax = parseFloat(costEl.value) || 0;
                    const regPerPax = parseFloat(regEl.value) || 0;
                    const pax = parseInt(paxEl.value) || 1;
                    
                    // SAFEGUARDED: Update pax in receipt
                    const rPax = document.getElementById('r_pax');
                    if(rPax) rPax.innerText = pax + (pax > 1 ? " Pax" : " Pax");
                    
                    const totalCost = costPerPax * pax;
                    const totalReg = regPerPax * pax;

                    // UPDATED: VAT on Base Cost only (Registration is separate)
                    const vatTotal = totalCost * 0.05;
                    
                    const vatInput = document.getElementById('vatInput');
                    if(vatInput) vatInput.value = vatTotal.toFixed(2);
                    
                    const dispVat = document.getElementById('disp_vat_aed');
                    if(dispVat) dispVat.innerText = `AED ${currencyLayer.getEuroToAED(vatTotal).toFixed(2)}`;
                    
                    // Discount Logic
                    const discRadio = document.querySelector('input[name="discountName"]:checked');
                    let discType = discRadio ? discRadio.value : 'none';
                    
                    // Group Warning Logic
                    const groupWarning = document.getElementById('groupWarning');
                    if (groupWarning) {
                        if (discType === 'group') {
                            if (pax <= 3) groupWarning.classList.remove('hidden');
                            else groupWarning.classList.add('hidden');
                        } else groupWarning.classList.add('hidden');
                    }

                    let discountAmt = 0;
                    let discountLabel = "Discount";

                    // UPDATED: Discounts calculated on Base Amount (totalCost) only
                    if (discType === 'couple') { discountAmt = totalCost * 0.05; discountLabel = "Couple (5%)"; }
                    else if (discType === 'group' && pax > 3) { discountAmt = totalCost * 0.10; discountLabel = "Group (10%)"; }
                    else if (discType === 'reference') { discountAmt = totalCost * 0.04; discountLabel = "Ref (4%)"; }
                    else if (discType === 'skilled') { discountAmt = totalCost * 0.05; discountLabel = "Skilled (5%)"; }
                    else if (discType === 'full_pay') { discountAmt = totalCost * 0.10; discountLabel = "Full Pay (10%)"; }
                    else if (discType === 'custom') {
                        const cVal = parseFloat(document.getElementById('customDiscountInput').value) || 0;
                        discountAmt = cVal;
                        discountLabel = "Special Discount";
                    }

                    // Instalment Logic
                    const instRadio = document.querySelector('input[name="instalment"]:checked');
                    const instType = instRadio ? instRadio.value : '1'; 
                    
                    let planAdjustment = 0;
                    let planAdjustmentLabel = "Adjustment";

                    // UPDATED: Surcharges/Adjustments calculated on Base Amount (totalCost) only
                    if(instType === '1') { 
                        // If discount is already 'full_pay', do NOT apply plan adjustment (avoid double count)
                        if (discType === 'full_pay') {
                            planAdjustment = 0;
                            planAdjustmentLabel = "Included in Discount";
                        } else {
                            planAdjustment = -(totalCost * 0.10); 
                            planAdjustmentLabel = "Full Pay Save (10%)"; 
                        }
                    } 
                    else if (instType === '2') { planAdjustment = (totalCost * 0.10); planAdjustmentLabel = "Split Fee (10%)"; } 
                    else if (instType === '3') { planAdjustment = (totalCost * 0.15); planAdjustmentLabel = "Split Fee (15%)"; } 
                    else if (instType === '4') { planAdjustment = (totalCost * 0.20); planAdjustmentLabel = "Split Fee (20%)"; }
                    
                    // UPDATED: Grand Total Calculation
                    // Base + VAT + Reg - Discount + Surcharge
                    const grandTotal = totalCost + vatTotal + totalReg - discountAmt + planAdjustment;

                    // --- UPDATE RECEIPT ROWS ---
                    this.renderReceiptRow('row_cost_values', totalCost);
                    this.renderReceiptRow('row_reg_values', totalReg);
                    this.renderReceiptRow('row_vat_values', vatTotal);
                    
                    const discRow = document.getElementById('r_disc_row');
                    if (discountAmt > 0) {
                        if(discRow) discRow.classList.remove('hidden');
                        const lbl = document.getElementById('r_disc_label');
                        if(lbl) lbl.innerText = discountLabel;
                        this.renderReceiptRow('row_disc_values', -discountAmt, "text-emerald-600");
                    } else {
                        if(discRow) discRow.classList.add('hidden');
                    }
                    
                    const surRow = document.getElementById('r_sur_row');
                    if (planAdjustment !== 0) {
                        if(surRow) surRow.classList.remove('hidden');
                        const lbl = document.getElementById('r_sur_label');
                        if(lbl) lbl.innerText = planAdjustmentLabel;
                        const color = planAdjustment < 0 ? "text-emerald-600" : "text-blue-600";
                        if(surRow) surRow.className = `flex justify-between items-start ${color}`;
                        this.renderReceiptRow('row_sur_values', planAdjustment, color);
                    } else {
                        if(surRow) surRow.classList.add('hidden');
                    }

                    // --- PAYMENT PLAN BREAKDOWN IN RECEIPT ---
                    const rInstContainer = document.getElementById('r_instalments_container');
                    const rInstList = document.getElementById('r_instalments_list');
                    const splitConfigs = { 1: [1.0], 2: [0.5, 0.5], 3: [0.3, 0.4, 0.3], 4: [0.3, 0.3, 0.2, 0.2] };
                    
                    if (rInstContainer && rInstList) {
                        if (instType && splitConfigs[instType]) {
                            rInstContainer.classList.remove('hidden');
                            let listHtml = '';
                            const selectedSplits = splitConfigs[instType];
                            
                            selectedSplits.forEach((pct, idx) => {
                                const iAmtEur = grandTotal * pct;
                                const iAmtAed = currencyLayer.getEuroToAED(iAmtEur);
                                const label = selectedSplits.length === 1 ? "Full Payment" : `Instalment ${idx + 1}`;
                                
                                let localHtml = '';
                                if (this.selectedLocalCurrency && this.selectedLocalCurrency !== 'EUR' && this.selectedLocalCurrency !== 'AED') {
                                    const eurRate = (currencyLayer.rates && currencyLayer.rates.EUR) ? parseFloat(currencyLayer.rates.EUR) : 0.92;
                                    const usd = iAmtEur / eurRate;
                                    const localRate = (currencyLayer.rates && currencyLayer.rates[this.selectedLocalCurrency]) ? parseFloat(currencyLayer.rates[this.selectedLocalCurrency]) : 0;
                                    const amtLocal = usd * localRate;
                                    localHtml = `<div class="text-[9px] text-blue-500 font-mono font-bold">${currencyLayer.format(amtLocal, this.selectedLocalCurrency)}</div>`;
                                }

                                listHtml += `
                                    <div class="flex justify-between items-center text-xs">
                                        <div class="flex items-center gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>
                                            <span class="text-slate-500 font-medium">${label}</span>
                                        </div>
                                        <div class="text-right leading-none">
                                            <div class="font-bold text-slate-700">€${iAmtEur.toFixed(0)}</div>
                                            <div class="text-[9px] text-slate-400 font-mono mt-0.5">AED ${iAmtAed.toFixed(0)}</div>
                                            ${localHtml ? `<div class="mt-0.5">${localHtml}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            rInstList.innerHTML = listHtml;
                        } else {
                            rInstContainer.classList.add('hidden');
                        }
                    }

                    // --- UPDATE TOTAL BLOCKS ---
                    const totalContainer = document.getElementById('r_multi_currency');
                    if(totalContainer) totalContainer.innerHTML = this.generateCurrencyBlock(grandTotal);
                    
                    // --- UPDATE PLAN CARD DETAILS (Dashboard Middle Column) ---
                    const styleMap = {
                        1: { main: 'text-emerald-700', sub: 'text-emerald-600', border: 'border-emerald-100', bg: 'bg-emerald-50' },
                        2: { main: 'text-blue-700', sub: 'text-blue-600', border: 'border-blue-100', bg: 'bg-blue-50' },
                        3: { main: 'text-violet-700', sub: 'text-violet-600', border: 'border-violet-100', bg: 'bg-violet-50' },
                        4: { main: 'text-amber-700', sub: 'text-amber-600', border: 'border-amber-100', bg: 'bg-amber-50' }
                    };

                    // UPDATED: Calculate specific plan total dynamically for display
                    const calcPlanSpecificTotal = (type) => {
                        let adj = 0;
                        if(type === '1') {
                             if (discType === 'full_pay') adj = 0; 
                             else adj = -(totalCost * 0.10);
                        }
                        else if (type === '2') adj = (totalCost * 0.10);
                        else if (type === '3') adj = (totalCost * 0.15);
                        else if (type === '4') adj = (totalCost * 0.20);
                        
                        return totalCost + vatTotal + totalReg - discountAmt + adj;
                    };

                    for(let i=1; i<=4; i++) {
                        const el = document.getElementById(`plan_${i}_details`);
                        if(el) {
                            const splits = splitConfigs[i];
                            const planTotal = calcPlanSpecificTotal(i.toString());
                            const styles = styleMap[i];
                            
                            let badgeHtml = '';
                            if (i===1) badgeHtml = `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-tight border border-emerald-200">-10% Save</span>`;
                            else if (i===2) badgeHtml = `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-tight border border-blue-200">+10% Fee</span>`;
                            else if (i===3) badgeHtml = `<span class="bg-violet-100 text-violet-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-tight border border-violet-200">+15% Fee</span>`;
                            else badgeHtml = `<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[10px] font-bold tracking-tight border border-amber-200">+20% Fee</span>`;

                            let html = `<div class="mt-3">
                                <div class="flex justify-between items-center border-b border-dashed border-slate-200 pb-2 mb-3">
                                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Breakdown</span>
                                    ${badgeHtml}
                                </div>
                                <div class="space-y-3">`; 
                            
                            splits.forEach((pct, idx) => {
                                const amtEur = planTotal * pct;
                                const amtAed = currencyLayer.getEuroToAED(amtEur);
                                let localLine = '';
                                if (this.selectedLocalCurrency && this.selectedLocalCurrency !== 'EUR' && this.selectedLocalCurrency !== 'AED') {
                                    const eurRate = (currencyLayer.rates && currencyLayer.rates.EUR) ? parseFloat(currencyLayer.rates.EUR) : 0.92;
                                    const usd = amtEur / eurRate;
                                    const localRate = (currencyLayer.rates && currencyLayer.rates[this.selectedLocalCurrency]) ? parseFloat(currencyLayer.rates[this.selectedLocalCurrency]) : 0;
                                    const amtLocal = usd * localRate;
                                    localLine = `
                                        <div class="flex justify-between items-center mt-1 pt-1 border-t border-slate-100/50">
                                            <span class="text-[9px] font-bold text-slate-500 opacity-80 flex items-center gap-1"><i class="fa-solid fa-earth-americas text-[8px]"></i> ${this.selectedLocalCurrency}</span>
                                            <span class="text-[10px] font-mono font-bold text-slate-600">${currencyLayer.format(amtLocal, this.selectedLocalCurrency)}</span>
                                        </div>`;
                                }

                                const labels = ["1st Instalment", "2nd Instalment", "3rd Instalment", "4th Instalment"];
                                const label = i===1 ? "Full Payment" : labels[idx];
                                const borderColor = styles.main.replace('text-', 'border-').replace('700', '200');

                                html += `
                                    <div class="relative pl-3 border-l-2 ${borderColor}">
                                        <div class="absolute -left-[5px] top-1.5 w-2 h-2 rounded-full ${styles.main.replace('text-', 'bg-')} ring-2 ring-white"></div>
                                        <div class="flex justify-between items-center mb-0.5">
                                            <span class="text-xs font-bold text-slate-700 tracking-tight">${label} <span class="text-[9px] text-slate-400 font-normal ml-0.5 bg-slate-100 px-1 rounded">(${(pct*100).toFixed(0)}%)</span></span>
                                            <span class="text-xs font-bold ${styles.main} font-mono bg-white px-1 rounded shadow-sm border border-slate-100">€${amtEur.toFixed(0)}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-[9px] text-slate-400 uppercase font-semibold tracking-wide">AED Equivalent</span>
                                            <span class="text-[10px] font-medium text-slate-500 font-mono">AED ${amtAed.toFixed(0)}</span>
                                        </div>
                                        ${localLine}
                                    </div>
                                `;
                            });

                            html += `</div>
                            <div class="pt-3 mt-3 border-t border-slate-100 flex justify-between items-end bg-gradient-to-r from-transparent via-transparent to-slate-50/50 p-1 -mr-1 rounded">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Plan</span>
                                <div class="text-right leading-none">
                                    <span class="block text-sm font-extrabold ${styles.main}">€${planTotal.toFixed(2)}</span>
                                    <span class="text-[9px] text-slate-400 mt-0.5 block">AED ${currencyLayer.getEuroToAED(planTotal).toFixed(0)}</span>
                                </div>
                            </div>
                            </div>`;
                            el.innerHTML = html;
                        }
                    }
                    
                    this.validateProposal();

                } catch(e) {
                    console.error("Calculation Error", e);
                }
            },

            // --- MISSING HELPER FUNCTIONS ADDED HERE ---

            renderReceiptRow(elementId, amountEur, colorClass = "") {
                const el = document.getElementById(elementId);
                if (!el) return;

                const amountAed = currencyLayer.getEuroToAED(amountEur);
                let html = `<div class="font-bold text-slate-700 ${colorClass}">€${amountEur.toFixed(2)}</div>
                            <div class="text-[10px] text-slate-400 font-mono">AED ${amountAed.toFixed(2)}</div>`;

                if (this.selectedLocalCurrency && this.selectedLocalCurrency !== 'EUR' && this.selectedLocalCurrency !== 'AED') {
                    const eurRate = (currencyLayer.rates && currencyLayer.rates.EUR) ? parseFloat(currencyLayer.rates.EUR) : 0.92;
                    const usd = amountEur / eurRate;
                    const localRate = (currencyLayer.rates && currencyLayer.rates[this.selectedLocalCurrency]) ? parseFloat(currencyLayer.rates[this.selectedLocalCurrency]) : 0;
                    const amountLocal = usd * localRate;
                    
                    html += `<div class="text-[9px] text-blue-500 font-mono font-bold mt-0.5">${currencyLayer.format(amountLocal, this.selectedLocalCurrency)}</div>`;
                }
                
                el.innerHTML = html;
            },

            generateCurrencyBlock(amountEur) {
                const amountAed = currencyLayer.getEuroToAED(amountEur);
                let html = `
                    <div class="bg-slate-900 rounded-lg p-3 text-white">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Total Payable</span>
                            <span class="text-[9px] font-bold bg-white/10 px-1.5 py-0.5 rounded text-blue-200">EUR</span>
                        </div>
                        <div class="text-2xl font-bold tracking-tight mb-2">€${amountEur.toFixed(2)}</div>
                        <div class="pt-2 border-t border-white/10 flex justify-between items-center">
                            <span class="text-[9px] font-bold text-slate-400">AED Equivalent</span>
                            <span class="text-xs font-mono font-bold text-emerald-400">AED ${amountAed.toFixed(2)}</span>
                        </div>
                    </div>
                `;

                if (this.selectedLocalCurrency && this.selectedLocalCurrency !== 'EUR' && this.selectedLocalCurrency !== 'AED') {
                    const eurRate = (currencyLayer.rates && currencyLayer.rates.EUR) ? parseFloat(currencyLayer.rates.EUR) : 0.92;
                    const usd = amountEur / eurRate;
                    const localRate = (currencyLayer.rates && currencyLayer.rates[this.selectedLocalCurrency]) ? parseFloat(currencyLayer.rates[this.selectedLocalCurrency]) : 0;
                    const amountLocal = usd * localRate;

                    html += `
                        <div class="mt-2 p-2 rounded-lg bg-blue-50 border border-blue-100 flex justify-between items-center">
                            <span class="text-[9px] font-bold text-blue-400 uppercase flex items-center gap-1"><i class="fa-solid fa-earth-americas"></i> ${this.selectedLocalCurrency}</span>
                            <span class="text-xs font-mono font-bold text-blue-700">${currencyLayer.format(amountLocal, this.selectedLocalCurrency)}</span>
                        </div>
                    `;
                }

                return html;
            },

            // --- ACTIONS ---
            async saveQuotation() {
                const name = document.getElementById('f_name').value;
                if(!name) { this.showToast('Client Name Required', 'error'); return; }
                
                // Get Job Title (Dropdown or Custom)
                const jobSelect = document.getElementById('f_job');
                const jobCustom = document.getElementById('f_job_custom');
                let jobTitle = "";
                if(jobSelect.value === 'OTHER') jobTitle = jobCustom.value || "";
                else jobTitle = jobSelect.value || "";

                // 1. Gather all financial data (Recalculate to be safe)
                const costPerPax = parseFloat(document.getElementById('costInput').value) || 0;
                const regPerPax = parseFloat(document.getElementById('regFeeInput').value) || 0;
                const pax = parseInt(document.getElementById('paxInput').value) || 1;
                
                const totalCost = costPerPax * pax;
                const totalReg = regPerPax * pax;
                
                // UPDATED: VAT on Base Cost only
                const vatTotal = totalCost * 0.05;
                
                // Discount
                const discRadio = document.querySelector('input[name="discountName"]:checked');
                const discType = discRadio ? discRadio.value : 'none';
                let discountAmt = 0;
                
                // UPDATED: Discounts calculated on Base Amount (totalCost)
                if (discType === 'couple') discountAmt = totalCost * 0.05;
                else if (discType === 'group' && pax > 3) discountAmt = totalCost * 0.10;
                else if (discType === 'reference') discountAmt = totalCost * 0.04;
                else if (discType === 'skilled') discountAmt = totalCost * 0.05;
                else if (discType === 'full_pay') discountAmt = totalCost * 0.10;
                else if (discType === 'custom') {
                     discountAmt = parseFloat(document.getElementById('customDiscountInput').value) || 0;
                }

                // Instalment / Plan Adjustment
                const instRadio = document.querySelector('input[name="instalment"]:checked');
                const instType = instRadio ? instRadio.value : '1';
                let planAdj = 0;
                
                // UPDATED: Surcharge/Adjustment on Base Amount (totalCost)
                if(instType === '1') {
                    if (discType === 'full_pay') planAdj = 0; // Already discounted
                    else planAdj = -(totalCost * 0.10);
                }
                else if (instType === '2') planAdj = totalCost * 0.10;
                else if (instType === '3') planAdj = totalCost * 0.15;
                else if (instType === '4') planAdj = totalCost * 0.20;
                
                // UPDATED: Final Grand Total
                const grandTotal = totalCost + vatTotal + totalReg - discountAmt + planAdj;

                // Calculate individual instalments
                let inst1=0, inst2=0, inst3=0, inst4=0;
                if (instType === '1') { inst1 = grandTotal; }
                else if (instType === '2') { inst1 = grandTotal * 0.5; inst2 = grandTotal * 0.5; }
                else if (instType === '3') { inst1 = grandTotal * 0.3; inst2 = grandTotal * 0.4; inst3 = grandTotal * 0.3; }
                else if (instType === '4') { inst1 = grandTotal * 0.3; inst2 = grandTotal * 0.3; inst3 = grandTotal * 0.2; inst4 = grandTotal * 0.2; }
                
                // UPDATED: Use the Fixed Ref if available, otherwise generate local
                const rRef = document.getElementById('r_ref');
                let refId = rRef && rRef.dataset.fixedRef ? rRef.dataset.fixedRef : this.generateLocalRefId();

                // 2. Prepare Data Object
                const quoteData = {
                    id: Date.now(),
                    date: new Date().toISOString(), 
                    refId: refId,
                    customerName: name.toUpperCase(), 
                    jobTitle: jobTitle.toUpperCase(),
                    phone: document.getElementById('f_phone').value || "",
                    nationality: (document.getElementById('f_nation').value || "Unknown").toUpperCase(),
                    destination: document.getElementById('r_dest').innerText.toUpperCase(),
                    visaName: document.getElementById('r_visa').innerText.toUpperCase(),
                    pax: pax,
                    financials: {
                        baseCost: totalCost,
                        regFee: totalReg,
                        vat: vatTotal,
                        discountName: discType.toUpperCase(),
                        discountAmount: discountAmt,
                        planType: instType,
                        planAdjustment: planAdj,
                        grandTotal: grandTotal,
                        instalments: [inst1, inst2, inst3, inst4]
                    },
                    advisor: auth.user.name.toUpperCase(), 
                    clickupTaskId: null
                };

                // 3. Save Locally
                db.add('quotes', quoteData);

                // 4. Send to ClickUp
                const btn = document.querySelector('button[onclick="app.saveQuotation()"]');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving to ClickUp...';
                btn.disabled = true;

                try {
                    const clickUpTaskId = await this.createClickUpQuotationTask(quoteData);
                    
                    // UPDATE LOCAL RECORD WITH CLICKUP ID
                    quoteData.clickupTaskId = clickUpTaskId;
                    db.update('quotes', quoteData);

                    this.showToast('Proposal Saved & Synced to ClickUp!');
                } catch (e) {
                    console.error("ClickUp Error", e);
                    this.showToast('Saved locally, but ClickUp sync failed.', 'warning');
                } finally {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    this.navigate('quotation-history');
                }
            },

            async createClickUpQuotationTask(data) {
                // USE QUOTATION LIST ID
                const url = `https://api.clickup.com/api/v2/list/${clickUpConfig.quotationListId}/task`;
                const qf = clickUpConfig.quoteFields;
                
                // CLICKUP DATE FIELD expects Unix Timestamp (milliseconds)
                const dateTimestamp = Date.now();

                // Format Description
                const description = `
# New Quotation Generated
**Ref ID:** ${data.refId}
**Date:** ${new Date().toLocaleString()}
**Advisor:** ${data.advisor}

## Client Details
* **Name:** ${data.customerName}
* **Apply Position:** ${data.jobTitle}
* **Phone:** ${data.phone}
* **Nationality:** ${data.nationality}
* **Destination:** ${data.destination} (${data.visaName})
* **Pax:** ${data.pax}

## Financial Breakdown
* **Base Cost:** €${data.financials.baseCost.toFixed(2)}
* **Reg Fee:** €${data.financials.regFee.toFixed(2)}
* **VAT (5%):** €${data.financials.vat.toFixed(2)}
* **Discount:** -€${data.financials.discountAmount.toFixed(2)} (${data.financials.discountName})
* **Plan Adjustment:** €${data.financials.planAdjustment.toFixed(2)}
* **GRAND TOTAL:** €${data.financials.grandTotal.toFixed(2)}

## Payment Schedule
1.  **Instalment 1:** €${data.financials.instalments[0].toFixed(2)}
2.  **Instalment 2:** €${data.financials.instalments[1].toFixed(2)}
3.  **Instalment 3:** €${data.financials.instalments[2].toFixed(2)}
4.  **Instalment 4:** €${data.financials.instalments[3].toFixed(2)}

---
\`\`\`json
${JSON.stringify(data, null, 2)}
\`\`\`
                `;

                // 1. Create Task
                const taskBody = {
                    name: data.customerName,
                    description: description,
                    status: 'TO DO'
                };

                const res = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskBody)
                });

                if (!res.ok) throw new Error('Failed to create task');
                const taskRes = await res.json();
                const taskId = taskRes.id;

                // Helper to ensure 2 decimal precision number
                const toEur = (val) => parseFloat((val || 0).toFixed(2));

                // 2. Set Custom Fields
                const fieldsToUpdate = [
                    { id: qf.phone, value: data.phone },
                    { id: qf.cost, value: toEur(data.financials.baseCost) }, 
                    { id: qf.nationality, value: data.nationality }, 
                    { id: qf.applyCountry, value: data.destination }, 
                    { id: qf.discountName, value: data.financials.discountName },
                    { id: qf.grandTotal, value: toEur(data.financials.grandTotal) },
                    { id: qf.regFee, value: toEur(data.financials.regFee) },
                    { id: qf.vat, value: toEur(data.financials.vat) },
                    { id: qf.visaName, value: data.visaName },
                    { id: qf.advisor, value: data.advisor },
                    { id: qf.discountAmount, value: toEur(data.financials.discountAmount) },
                    { id: qf.jobTitle, value: data.jobTitle },
                    { id: qf.date, value: dateTimestamp }, // Sending Timestamp (Number)
                    { id: qf.refId, value: String(data.refId) } 
                ];

                // --- CONDITIONAL INSTALMENT SAVING ---
                // Only save instalments relevant to the selected plan
                const plan = parseInt(data.financials.planType) || 1;

                if (plan >= 1) fieldsToUpdate.push({ id: qf.instalment1, value: toEur(data.financials.instalments[0]) });
                if (plan >= 2) fieldsToUpdate.push({ id: qf.instalment2, value: toEur(data.financials.instalments[1]) });
                if (plan >= 3) fieldsToUpdate.push({ id: qf.instalment3, value: toEur(data.financials.instalments[2]) });
                if (plan >= 4) fieldsToUpdate.push({ id: qf.instalment4, value: toEur(data.financials.instalments[3]) });

                // Execute field updates sequentially with RETRY logic
                for (const field of fieldsToUpdate) {
                    if (!field.id || field.value === undefined || field.value === null) continue;
                    
                    try {
                        const response = await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${field.id}`, {
                            method: 'POST',
                            mode: 'cors',
                            headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: field.value })
                        });

                        // Retry logic for Number vs String mismatch (Skip Date field from this retry)
                        if (!response.ok && field.id !== qf.date) {
                             if (typeof field.value === 'number') {
                                 await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${field.id}`, {
                                    method: 'POST',
                                    mode: 'cors',
                                    headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ value: String(field.value.toFixed(2)) }) // Try as string with decimals
                                });
                             }
                        }
                    } catch (err) {
                        console.warn(`Failed to update field ${field.id}`, err);
                    }
                }
                
                return taskId;
            },
            
            shareQuotation() {
                const client = document.getElementById('f_name').value || "Client";
                const dest = document.getElementById('r_dest').innerText;
                const total = document.getElementById('r_multi_currency').innerText.split('\n')[0] || "0";
                
                const text = `Hello ${client}, here is your visa quotation for ${dest}. Total: ${total}.`;
                if(confirm("Share via WhatsApp? Click OK to open WhatsApp.")) {
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                }
            },

            openPreview() {
                try {
                    const modal = document.getElementById('previewModal');
                    if (!modal) return;

                    // Populate Basic Data
                    const currentRef = document.getElementById('r_ref').innerText;
                    const refNum = (currentRef && currentRef !== 'DRAFT') ? currentRef : this.generateLocalRefId();
                    const dateStr = new Date().toLocaleDateString('en-GB'); 
                    
                    // UPDATED: Show Full Ref
                    const pRefFull = document.getElementById('p_ref_full');
                    if(pRefFull) pRefFull.innerText = refNum;
                    
                    const pRefFooter = document.getElementById('p_ref_footer');
                    if(pRefFooter) pRefFooter.innerText = refNum;
                    
                    const pDate = document.getElementById('p_date');
                    if(pDate) pDate.innerText = `Date: ${dateStr}`;
                    
                    const fName = document.getElementById('f_name').value || "Client Name";
                    const pClient = document.getElementById('p_client');
                    if(pClient) pClient.innerText = fName.toUpperCase();

                    // POPULATE ADVISOR NAME & CONTACT
                    if(auth.user) {
                        const pAdvisorName = document.getElementById('p_advisor_name');
                        const pAdvisorRole = document.getElementById('p_advisor_role');
                        const pAdvisorPhone = document.getElementById('p_advisor_phone');
                        const pAdvisorInit = document.getElementById('p_advisor_initial');

                        if(pAdvisorName) pAdvisorName.innerText = auth.user.name.toUpperCase();
                        if(pAdvisorRole) pAdvisorRole.innerText = (auth.user.designation || 'IMMIGRATION CONSULTANT').toUpperCase();
                        if(pAdvisorPhone) pAdvisorPhone.innerText = auth.user.phone || '+971 -- --- ----';
                        if(pAdvisorInit) pAdvisorInit.innerText = auth.user.name.charAt(0).toUpperCase();
                    }
                    
                    // JOB TITLE PREVIEW
                    const jobSelect = document.getElementById('f_job');
                    const jobCustom = document.getElementById('f_job_custom');
                    let jobVal = "---";
                    if(jobSelect.value === 'OTHER') jobVal = jobCustom.value || "---";
                    else if(jobSelect.value) jobVal = jobSelect.value || "---";
                    
                    const pJob = document.getElementById('p_job');
                    if(pJob) pJob.innerText = jobVal.toUpperCase();
                    
                    const pPhone = document.getElementById('p_phone');
                    if(pPhone) pPhone.innerText = document.getElementById('f_phone').value || "---";
                    
                    const nationSelect = document.getElementById('f_nation');
                    const pNation = document.getElementById('p_nation');
                    if(pNation) pNation.innerText = (nationSelect && nationSelect.options[nationSelect.selectedIndex]?.text) || "---";
                    
                    const destName = document.getElementById('r_dest').innerText;
                    const visaName = document.getElementById('r_visa').innerText;
                    
                    const pDest = document.getElementById('p_dest');
                    if(pDest) pDest.innerText = destName;
                    
                    const pVisa = document.getElementById('p_visa');
                    if(pVisa) pVisa.innerText = visaName;
                    
                    const rPax = document.getElementById('r_pax');
                    const pPax = document.getElementById('p_pax');
                    if(pPax) pPax.innerText = rPax ? rPax.innerText : "1 Pax";

                    // --- DYNAMIC TABLE GENERATION ---
                    const tbody = document.getElementById('p_table_body');
                    const thead = document.getElementById('p_table_head');
                    
                    // Safely get inputs
                    const costVal = parseFloat(document.getElementById('costInput')?.value) || 0;
                    const regVal = parseFloat(document.getElementById('regFeeInput')?.value) || 0;
                    const paxVal = parseInt(document.getElementById('paxInput')?.value) || 1;
                    const vatVal = parseFloat(document.getElementById('vatInput')?.value) || 0;

                    const costEur = costVal * paxVal;
                    const regEur = regVal * paxVal;
                    const vatEur = vatVal;
                    
                    const subTotal = costEur + regEur + vatEur;
                    
                    let discAmt = 0;
                    let discLabel = "Discount";
                    const discRadio = document.querySelector('input[name="discountName"]:checked');
                    if (discRadio) {
                        if (discRadio.value === 'couple') { discAmt = subTotal * 0.05; discLabel = "Couple Discount (5%)"; }
                        else if (discRadio.value === 'group' && paxVal > 3) { discAmt = subTotal * 0.10; discLabel = "Group Discount (10%)"; }
                        else if (discRadio.value === 'reference') { discAmt = subTotal * 0.04; discLabel = "Reference Discount (4%)"; }
                        else if (discRadio.value === 'skilled') { discAmt = subTotal * 0.05; discLabel = "Skilled Discount (5%)"; }
                        else if (discRadio.value === 'full_pay') { discAmt = subTotal * 0.10; discLabel = "Full Pay Discount (10%)"; }
                        else if (discRadio.value === 'custom') {
                            discAmt = parseFloat(document.getElementById('customDiscountInput').value) || 0;
                            discLabel = "Special Discount";
                        }
                    }

                    let planAdj = 0;
                    let planLabel = "Plan Adjustment";
                    const amtAfterDisc = subTotal - discAmt;
                    const instRadio = document.querySelector('input[name="instalment"]:checked');
                    const instVal = instRadio ? instRadio.value : '1';
                    
                    if (instVal === '1') { planAdj = -(amtAfterDisc * 0.10); planLabel = "Full Pay Discount"; }
                    else if (instVal === '2') { planAdj = amtAfterDisc * 0.10; planLabel = "Installment Fee"; }
                    else if (instVal === '3') { planAdj = amtAfterDisc * 0.15; planLabel = "Installment Fee"; }
                    else if (instVal === '4') { planAdj = amtAfterDisc * 0.20; planLabel = "Installment Fee"; }

                    const finalTotal = amtAfterDisc + planAdj;

                    const hasLocal = this.selectedLocalCurrency && this.selectedLocalCurrency !== 'EUR' && this.selectedLocalCurrency !== 'AED';
                    const localCode = this.selectedLocalCurrency || '';
                    
                    // 1. UPDATE TABLE HEADER DYNAMICALLY
                    if (thead) {
                        let headerHtml = `
                            <tr class="border-b-2 border-slate-900">
                                <th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider w-1/2">Description / Service</th>
                                <th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider text-right">Amount (EUR)</th>
                                <th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider text-right">Amount (AED)</th>
                        `;
                        if (hasLocal) {
                            headerHtml += `<th class="py-3 text-[10px] font-bold text-slate-900 uppercase tracking-wider text-right">Amount (${localCode})</th>`;
                        }
                        headerHtml += `</tr>`;
                        thead.innerHTML = headerHtml;
                    }

                    // 2. CREATE TABLE ROWS
                    const createRow = (label, eur, colorClass = "", extraClass = "") => {
                        const aed = currencyLayer.getEuroToAED(eur);
                        let localHtml = '';
                        if (hasLocal) {
                            const usd = eur / (currencyLayer.rates['EUR'] || 0.92);
                            const local = usd * (currencyLayer.rates[localCode] || 0);
                            localHtml = `<td class="text-right font-mono text-xs ${extraClass}">${currencyLayer.format(local, localCode)}</td>`;
                        }
                        
                        return `
                            <tr class="${colorClass}">
                                <td class="font-medium ${extraClass}">${label}</td>
                                <td class="text-right font-mono ${extraClass}">€${eur.toFixed(2)}</td>
                                <td class="text-right font-mono ${extraClass}">AED ${aed.toFixed(2)}</td>
                                ${localHtml}
                            </tr>
                        `;
                    };

                    let rowsHtml = '';
                    rowsHtml += createRow(`Visa Fee: ${destName} - ${visaName}`, costEur, "", "pb-4 border-b-[8px] border-transparent");
                    rowsHtml += createRow("Registration / Processing Fee", regEur, "", "pb-4 border-b-[8px] border-transparent");
                    rowsHtml += createRow("VAT (5%)", vatEur);
                    
                    if (discAmt > 0) rowsHtml += createRow(discLabel, -discAmt, "text-emerald-700 font-semibold");
                    if (planAdj !== 0) rowsHtml += createRow(planLabel, planAdj, planAdj > 0 ? "text-blue-700 font-semibold" : "text-emerald-700 font-semibold");

                    if(tbody) tbody.innerHTML = rowsHtml;

                    const totalAed = currencyLayer.getEuroToAED(finalTotal);
                    
                    // 3. CREATIVE TOTAL SECTION
                    const totalContainer = document.getElementById('p_total_container');
                    if (totalContainer) {
                        let totalLocalDisplay = '';
                        if (hasLocal) {
                            const usd = finalTotal / (currencyLayer.rates['EUR'] || 0.92);
                            const local = usd * (currencyLayer.rates[localCode] || 0);
                            totalLocalDisplay = `
                                <div class="pl-3 ml-3 border-l border-slate-200">
                                    <span class="block text-[8px] font-bold text-slate-400 uppercase">${localCode}</span>
                                    <span class="block text-xs font-mono font-bold text-slate-600">${currencyLayer.format(local, localCode)}</span>
                                </div>
                            `;
                        }

                        totalContainer.innerHTML = `
                            <div class="bg-white border-2 border-slate-900 rounded-lg p-3 min-w-[200px]">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="text-[9px] font-black text-slate-900 uppercase tracking-widest">Total Payable</p>
                                </div>
                                <div class="text-right mb-2">
                                    <span class="text-2xl font-black text-slate-900 tracking-tight">€${finalTotal.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-end items-center border-t border-slate-100 pt-2">
                                    <div class="text-right">
                                        <span class="block text-[8px] font-bold text-slate-400 uppercase">AED</span>
                                        <span class="block text-xs font-mono font-bold text-slate-600">AED ${totalAed.toFixed(2)}</span>
                                    </div>
                                    ${totalLocalDisplay}
                                </div>
                            </div>
                        `;
                    }

                    const instList = document.getElementById('r_instalments_list');
                    const pScheduleContainer = document.getElementById('p_payment_schedule');
                    
                    if (instList && instList.children.length > 0 && pScheduleContainer) {
                        const splitConfigs = { 1: [1.0], 2: [0.5, 0.5], 3: [0.3, 0.4, 0.3], 4: [0.3, 0.3, 0.2, 0.2] };
                        const splits = splitConfigs[instVal];
                        let printSchedHtml = '';
                        
                        splits.forEach((pct, idx) => {
                            const amtEur = finalTotal * pct;
                            const amtAed = currencyLayer.getEuroToAED(amtEur);
                            const label = splits.length === 1 ? "Full Payment" : `Instalment ${idx + 1}`;
                            
                            let localStr = '';
                            if (hasLocal) {
                                const usd = amtEur / (currencyLayer.rates['EUR'] || 0.92);
                                const local = usd * (currencyLayer.rates[localCode] || 0);
                                localStr = ` / <span class="text-blue-600">${currencyLayer.format(local, localCode)}</span>`;
                            }

                            printSchedHtml += `
                                <div class="flex justify-between items-center py-1.5 border-b border-dashed border-slate-100 last:border-0">
                                    <div class="flex items-center gap-3">
                                        <span class="text-[10px] font-bold text-slate-700 uppercase w-24">${label}</span>
                                        <span class="text-[9px] text-slate-400 bg-white border border-slate-100 px-1.5 rounded">${(pct*100).toFixed(0)}%</span>
                                    </div>
                                    <div class="text-right font-mono text-[10px] font-bold text-slate-700">
                                        €${amtEur.toFixed(2)} <span class="text-slate-400 mx-1">|</span> AED ${amtAed.toFixed(2)} ${localStr}
                                    </div>
                                </div>
                            `;
                        });
                        pScheduleContainer.innerHTML = printSchedHtml;
                    } else if (pScheduleContainer) {
                        pScheduleContainer.innerHTML = '<div class="text-center text-slate-400 italic text-[10px]">See Total Amount above.</div>';
                    }

                    const planNameEl = instRadio ? instRadio.parentElement.querySelector('.font-bold') : null;
                    const pPlanName = document.getElementById('p_plan_name');
                    if(pPlanName) pPlanName.innerText = planNameEl ? planNameEl.innerText : "Standard";

                    modal.classList.add('active');
                } catch (e) {
                    console.error("Preview Error:", e);
                    this.showToast("Error opening preview", "error");
                }
            },

            closePreview() {
                document.getElementById('previewModal').classList.remove('active');
            },

            // --- ADMIN: VISA MANAGEMENT (OPTIMIZED) ---
            renderAdminVisas(container) {
                const visas = db.get('visas');
                const allCountries = db.get('countries'); 
                
                this.editingVisaId = null;
                // Removed selectedVisas set

                visas.sort((a, b) => {
                    const cA = (allCountries.find(c => c.id == a.countryId)?.name || '').toLowerCase();
                    const cB = (allCountries.find(c => c.id == b.countryId)?.name || '').toLowerCase();
                    if (cA < cB) return -1;
                    if (cA > cB) return 1;
                    return a.name.localeCompare(b.name);
                });

                // ... (Visa Types Array) ...
                const allVisaTypes = [
                    "AIRPORT TRANSIT VISA", "SCHENGEN SHORT STAY VISA", "SCHENGEN LONG STAY VISA", "TOURIST VISA", "BUSINESS VISA", 
                    "VISIT VISA", "FAMILY VISIT VISA", "MEDICAL VISA", "CULTURAL VISA", "SPORTS VISA", "STUDENT VISA", 
                    "LANGUAGE COURSE VISA", "INTERNSHIP VISA", "TRAINEE VISA", "RESEARCH VISA", "WORK VISA", "SKILLED WORKER VISA", 
                    "HIGHLY SKILLED WORKER VISA", "SEASONAL WORK VISA", "TEMPORARY WORK VISA", "PERMANENT WORK VISA", 
                    "INTRA COMPANY TRANSFER VISA", "EU BLUE CARD", "JOB SEEKER VISA", "SELF EMPLOYMENT VISA", "FREELANCER VISA", 
                    "ENTREPRENEUR VISA", "STARTUP VISA", "INVESTOR VISA", "GOLDEN VISA", "DIGITAL NOMAD VISA", "REMOTE WORK VISA", 
                    "FAMILY REUNIFICATION VISA", "DEPENDENT VISA", "SPOUSE VISA", "WORKING HOLIDAY VISA", "RESIDENCE VISA", 
                    "TEMPORARY RESIDENCE PERMIT", "PERMANENT RESIDENCE PERMIT", "HUMANITARIAN VISA", "ASYLUM VISA", "REFUGEE VISA", "TRANSIT VISA"
                ].sort();

                container.innerHTML = `
                    <div class="relative h-full flex flex-col">
                        <!-- Toolbar -->
                        <div class="bg-white rounded-xl border border-slate-200 p-4 mb-4 flex flex-col md:flex-row justify-between items-center shadow-sm gap-4">
                            <div class="flex items-center gap-3 w-full md:w-auto">
                                <h3 class="font-bold text-slate-700 text-lg">Visa Management</h3>
                                <span class="px-2.5 py-0.5 bg-slate-100 text-slate-500 rounded-full text-xs font-bold border border-slate-200">${visas.length} Active</span>
                            </div>
                            
                            <div class="flex gap-3 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                                <div class="relative flex-1 min-w-[200px] md:min-w-[250px]">
                                    <input type="text" placeholder="Search visas..." onkeyup="app.filterVisas(this.value)" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                </div>
                                <button onclick="app.fetchVisasFromClickUp()" id="btnSyncClickUp" class="px-4 py-2 bg-purple-50 text-purple-600 rounded-lg text-xs font-bold hover:bg-purple-100 transition-colors border border-purple-200 whitespace-nowrap flex items-center gap-2">
                                    <i class="fa-solid fa-cloud-arrow-down"></i> <span class="hidden sm:inline">Force Sync</span>
                                </button>
                                <button onclick="app.initAddVisa()" class="px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/20 whitespace-nowrap flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> <span>Add New</span>
                                </button>
                            </div>
                        </div>

                        <!-- Main List (Responsive) -->
                        <div class="flex-1 overflow-y-auto bg-white border border-slate-200 rounded-xl shadow-sm relative">
                            <!-- Desktop Header -->
                            <div class="hidden md:grid sticky top-0 bg-slate-50 border-b border-slate-200 z-10 grid-cols-12 gap-4 p-3 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                <div class="col-span-5">Visa Details</div>
                                <div class="col-span-2">Code</div>
                                <div class="col-span-2 text-right">Cost</div>
                                <div class="col-span-2 text-right">Reg Fee</div>
                                <div class="col-span-1 text-right">Action</div>
                            </div>
                            
                            <div id="visaListContainer" class="divide-y divide-slate-100">
                                ${this.generateVisaListHTML(visas, allCountries)}
                            </div>
                        </div>
                    </div>

                    <!-- Side Drawer Form -->
                    <div id="visaDrawerOverlay" onclick="app.closeVisaDrawer()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>
                    <div id="visaDrawer" class="fixed inset-y-0 right-0 w-full md:w-[400px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 class="font-bold text-lg text-slate-800" id="drawerTitle">Visa Details</h3>
                                <p class="text-xs text-slate-500">Syncs automatically to ClickUp</p>
                            </div>
                            <button onclick="app.closeVisaDrawer()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-red-500 hover:border-red-200 flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-6">
                            <form id="visaForm" class="space-y-5" onsubmit="event.preventDefault(); app.handleVisaSubmit();">
                                <!-- Destination Field -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Destination</label>
                                    <select id="adm_country" onchange="app.toggleCustomInput('adm_country', 'adm_country_custom')" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                        <!-- Populated via JS -->
                                    </select>
                                    <input type="text" id="adm_country_custom" placeholder="Enter New Destination Name" class="w-full mt-2 p-3 bg-white border border-blue-200 text-blue-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 hidden placeholder-blue-300">
                                </div>

                                <!-- Visa Name Field -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Visa Name</label>
                                    <select id="adm_name" onchange="app.toggleCustomInput('adm_name', 'adm_name_custom')" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Type</option>
                                        ${allVisaTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                                        <option value="OTHER" class="font-bold text-blue-600">+ Add Custom Name</option>
                                    </select>
                                    <input type="text" id="adm_name_custom" placeholder="Enter Custom Visa Name" class="w-full mt-2 p-3 bg-white border border-blue-200 text-blue-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 hidden placeholder-blue-300">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Visa Code (Auto)</label>
                                    <div class="relative">
                                        <input type="text" id="adm_code" readonly placeholder="Generating..." class="w-full pl-3 pr-10 p-3 bg-slate-100 border border-slate-200 rounded-xl text-sm font-mono uppercase outline-none text-slate-500 cursor-not-allowed">
                                        <div class="absolute right-3 top-3 text-slate-400 text-xs"><i class="fa-solid fa-lock"></i></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Cost (€)</label>
                                        <input type="number" id="adm_cost" step="0.01" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Reg Fee (€)</label>
                                        <input type="number" id="adm_reg" step="0.01" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="p-5 border-t border-slate-100 bg-slate-50 flex gap-3">
                            <button type="button" onclick="app.deleteCurrentVisa()" id="btnDrawerDelete" class="hidden px-4 py-3 bg-white text-red-600 border border-red-200 rounded-xl font-bold hover:bg-red-50 transition-colors flex items-center justify-center">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            <button type="button" onclick="app.handleVisaSubmit()" id="btnDrawerSubmit" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-check"></i> <span>Save & Sync</span>
                            </button>
                        </div>
                        <div id="syncStatus" class="text-center text-xs text-slate-400 h-4 pb-2 bg-slate-50"></div>
                    </div>
                `;

                // AUTO-SYNC TRIGGER ON TAB OPEN
                setTimeout(() => {
                    this.fetchVisasFromClickUp();
                }, 100);
            },

            generateVisaListHTML(visas, countries) {
                if (visas.length === 0) return `<div class="p-10 text-center text-slate-400">No visas found. Sync from ClickUp or Add New.</div>`;
                
                return visas.map(v => {
                    const country = countries.find(c => c.id == v.countryId);
                    const countryName = country ? country.name : 'Unknown';
                    const code = v.visaCode || '<span class="text-slate-300">-</span>';
                    
                    return `
                    <div class="visa-item p-3 hover:bg-slate-50 transition-colors group flex flex-col md:grid md:grid-cols-12 md:gap-4 md:items-center" data-search="${countryName.toLowerCase()} ${v.name.toLowerCase()} ${v.visaCode ? v.visaCode.toLowerCase() : ''}">
                        
                        <!-- Mobile Top Row: Country + Edit Button -->
                        <div class="flex justify-between items-start md:hidden mb-2">
                            <div class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                <i class="fa-solid fa-earth-americas text-blue-500"></i> ${countryName}
                            </div>
                            <button onclick="app.initEditVisa('${v.id}')" class="p-2 text-blue-600 bg-blue-50 rounded-lg"><i class="fa-solid fa-pencil"></i></button>
                        </div>

                        <!-- Desktop: Details -->
                        <div class="md:col-span-5 hidden md:block">
                            <div class="font-bold text-slate-700 text-sm truncate flex items-center gap-2">
                                <i class="fa-solid fa-earth-americas text-blue-500"></i>
                                ${countryName}
                            </div>
                            <div class="text-[10px] text-slate-400 ml-6 truncate" title="${v.name}">${v.name}</div>
                        </div>

                        <!-- Mobile: Visa Name & Code -->
                        <div class="md:hidden text-xs text-slate-500 mb-2">
                            <div class="font-medium text-slate-700 mb-1">${v.name}</div>
                            <div class="font-mono bg-slate-100 px-1 rounded inline-block text-[10px]">${code}</div>
                        </div>

                        <!-- Desktop: Code -->
                        <div class="md:col-span-2 hidden md:block font-mono text-xs text-slate-500">${code}</div>

                        <!-- Pricing (Responsive) -->
                        <div class="flex justify-between items-center md:col-span-4 md:grid md:grid-cols-2 md:gap-4 md:justify-end border-t border-slate-100 pt-2 md:border-0 md:pt-0">
                            <div class="md:text-right">
                                <span class="md:hidden text-[10px] text-slate-400 uppercase font-bold mr-2">Cost</span>
                                <span class="font-mono text-sm font-bold text-slate-700">€${v.cost}</span>
                            </div>
                            <div class="md:text-right">
                                <span class="md:hidden text-[10px] text-slate-400 uppercase font-bold mr-2">Reg</span>
                                <span class="font-mono text-sm text-slate-500">€${v.regFee}</span>
                            </div>
                        </div>

                        <!-- Desktop: Action -->
                        <div class="md:col-span-1 text-right hidden md:block">
                            <button onclick="app.initEditVisa('${v.id}')" class="p-2 text-slate-400 hover:text-blue-600 transition-colors"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                    </div>`;
                }).join('');
            },

            // --- FORM & DRAWER LOGIC ---
            
            populateCountryDropdown() {
                const countries = db.get('countries');
                const select = document.getElementById('adm_country');
                if(select) {
                    select.innerHTML = '<option value="">Select Destination</option>' + 
                        countries.map(c => `<option value="${c.id}">${c.name}</option>`).join('') +
                        '<option value="OTHER" class="font-bold text-blue-600">+ Add Custom Destination</option>';
                }
            },

            toggleCustomInput(selectId, inputId) {
                const select = document.getElementById(selectId);
                const input = document.getElementById(inputId);
                if(select.value === 'OTHER') {
                    input.classList.remove('hidden');
                    input.focus();
                } else {
                    input.classList.add('hidden');
                    input.value = '';
                }
            },

            async initAddVisa() {
                // UI Loading Feedback
                const btn = document.querySelector('button[onclick="app.initAddVisa()"]');
                const originalText = btn ? btn.innerHTML : '';
                if(btn) {
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking Codes...';
                    btn.disabled = true;
                }

                try {
                    // 1. Sync First (Strict Requirement)
                    await this.fetchVisasFromClickUp(true);

                    this.editingVisaId = null;
                    this.resetVisaForm();
                    this.populateCountryDropdown();
                    
                    // Reset Custom Inputs
                    document.getElementById('adm_country_custom').classList.add('hidden');
                    document.getElementById('adm_name_custom').classList.add('hidden');
                    
                    // 2. Auto-generate Code (BCxxx) based on FRESH data
                    const visas = db.get('visas');
                    let max = 0;
                    const regex = /^BC(\d+)$/i;
                    
                    visas.forEach(v => {
                        const match = (v.visaCode || '').match(regex);
                        if(match) {
                            const num = parseInt(match[1], 10);
                            if(!isNaN(num)) max = Math.max(max, num);
                        }
                    });
                    
                    const nextNum = max + 1;
                    const nextCode = `BC${String(nextNum).padStart(3, '0')}`;
                    document.getElementById('adm_code').value = nextCode;
                    
                    document.getElementById('drawerTitle').innerText = "Add New Visa";
                    document.getElementById('btnDrawerSubmit').innerHTML = '<i class="fa-solid fa-plus"></i> <span>Add Visa</span>';
                    document.getElementById('btnDrawerDelete').classList.add('hidden'); 
                    
                    this.openVisaDrawer();

                } catch(e) {
                    console.error(e);
                    this.showToast("Could not sync codes. Check connection.", "error");
                } finally {
                    if(btn) {
                        btn.innerHTML = originalText || '<i class="fa-solid fa-plus"></i> <span>Add New</span>';
                        btn.disabled = false;
                    }
                }
            },

            async initEditVisa(id) {
                const visa = db.get('visas').find(v => v.id == id);
                if(!visa) return;

                // 1. Loading Feedback on the specific Edit Button
                const btn = document.querySelector(`button[onclick="app.initEditVisa('${id}')"]`);
                const originalHtml = btn ? btn.innerHTML : '';
                if(btn) {
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i>';
                    btn.disabled = true;
                }

                // 2. Fetch Latest Data from ClickUp
                if(visa.clickupId) {
                    try {
                        const res = await fetch(`https://api.clickup.com/api/v2/task/${visa.clickupId}`, {
                            headers: { 'Authorization': clickUpConfig.apiKey }
                        });

                        if(res.ok) {
                            const task = await res.json();
                            
                            // Helper to extract fields
                            const getVal = (fid) => {
                                const f = task.custom_fields.find(x => x.id === fid);
                                if (!f) return "";
                                if (f.type === 'drop_down' && typeof f.value === 'number') return f.type_config.options[f.value]?.name || "";
                                if (typeof f.value === 'object' && f.value !== null) return f.value.status || f.value.text || f.value.name || ""; 
                                return f.value;
                            };

                            // Update Local Object with Live Data
                            visa.name = getVal(clickUpConfig.customFields.visaName) || visa.name;
                            visa.cost = parseFloat(getVal(clickUpConfig.customFields.cost)) || visa.cost;
                            visa.regFee = parseFloat(getVal(clickUpConfig.customFields.regFee)) || visa.regFee;
                            visa.visaCode = getVal(clickUpConfig.customFields.visaCode) || visa.visaCode;
                            
                            // Sync Country Name if changed in ClickUp task title
                            if(task.name) {
                                const countryId = db.getOrCreateCountry(task.name);
                                visa.countryId = countryId;
                            }

                            // Save to Local DB
                            db.update('visas', visa);
                        } else if(res.status === 404) {
                            this.showToast("Task deleted in ClickUp. Saving will recreate it.", "warning");
                        }
                    } catch(e) {
                        console.error("Live Sync Error", e);
                        // Fail silently and use local data
                    }
                }

                // 3. Restore Button state
                if(btn) {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }

                // 4. Open Form with Fresh Data
                this.editingVisaId = id;
                this.populateCountryDropdown(); 
                
                document.getElementById('adm_country').value = visa.countryId;
                
                const codeEl = document.getElementById('adm_code');
                const costEl = document.getElementById('adm_cost');
                const regEl = document.getElementById('adm_reg');
                
                if(codeEl) codeEl.value = visa.visaCode || "";
                if(costEl) costEl.value = visa.cost;
                if(regEl) regEl.value = visa.regFee;

                // Handle Custom Visa Name
                const nameSelect = document.getElementById('adm_name');
                const nameInput = document.getElementById('adm_name_custom');
                nameSelect.value = visa.name;
                
                // If the visa name isn't in the dropdown list, it must be custom
                if (nameSelect.value !== visa.name) {
                    nameSelect.value = 'OTHER';
                    nameInput.value = visa.name;
                    nameInput.classList.remove('hidden');
                } else {
                    nameInput.classList.add('hidden');
                    nameInput.value = '';
                }
                
                // Hide custom country input initially (since standard population handles existing)
                const cInput = document.getElementById('adm_country_custom');
                if(cInput) {
                    cInput.classList.add('hidden');
                    cInput.value = '';
                }

                document.getElementById('drawerTitle').innerText = "Edit Visa";
                // UPDATED: Button text explicitly set to Save & Sync
                document.getElementById('btnDrawerSubmit').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> <span>Save & Sync</span>';
                document.getElementById('btnDrawerDelete').classList.remove('hidden'); 
                
                this.openVisaDrawer();
            },

            openVisaDrawer() {
                const overlay = document.getElementById('visaDrawerOverlay');
                const drawer = document.getElementById('visaDrawer');
                if(overlay && drawer) {
                    overlay.classList.remove('hidden');
                    void drawer.offsetWidth;
                    overlay.classList.remove('opacity-0');
                    drawer.classList.remove('translate-x-full');
                }
            },

            closeVisaDrawer() {
                const overlay = document.getElementById('visaDrawerOverlay');
                const drawer = document.getElementById('visaDrawer');
                if(overlay && drawer) {
                    overlay.classList.add('opacity-0');
                    drawer.classList.add('translate-x-full');
                    setTimeout(() => { overlay.classList.add('hidden'); }, 300);
                }
            },

            resetVisaForm() {
                const form = document.getElementById('visaForm');
                if(form) form.reset();
            },

            // --- DELETE LOGIC (From Drawer) ---
            async deleteCurrentVisa() {
                if(!this.editingVisaId) return;
                
                if(confirm('Are you sure you want to delete this visa? This will remove it from ClickUp as well.')) {
                    const visa = db.get('visas').find(v => v.id === this.editingVisaId);
                    const btn = document.getElementById('btnDrawerDelete');
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                    btn.disabled = true;

                    // 1. ClickUp Delete
                    if(visa && visa.clickupId) {
                        try {
                            await this.deleteClickUpTask(visa.clickupId);
                        } catch(e) {
                            console.error("ClickUp delete error", e);
                            this.showToast("Deleted locally, but ClickUp sync failed", "warning");
                        }
                    }
                    
                    // 2. Local Delete
                    db.delete('visas', this.editingVisaId);
                    this.showToast('Visa deleted successfully');
                    
                    this.closeVisaDrawer();
                    const container = document.getElementById('visaListContainer');
                    if(container) container.innerHTML = this.generateVisaListHTML(db.get('visas'), db.get('countries'));
                }
            },

            // --- SUBMIT LOGIC (Strict Sync) ---
            async handleVisaSubmit() {
                let countryId = document.getElementById('adm_country').value;
                let name = document.getElementById('adm_name').value;
                const code = document.getElementById('adm_code').value.toUpperCase().trim();
                const cost = parseFloat(document.getElementById('adm_cost').value);
                const regFee = parseFloat(document.getElementById('adm_reg').value);

                // Handle Custom Country
                if (countryId === 'OTHER') {
                    const customCountry = document.getElementById('adm_country_custom').value.trim().toUpperCase();
                    if (!customCountry) { this.showToast('Please enter destination name', 'error'); return; }
                    countryId = db.getOrCreateCountry(customCountry);
                }

                // Handle Custom Visa Name
                if (name === 'OTHER') {
                    const customName = document.getElementById('adm_name_custom').value.trim().toUpperCase();
                    if (!customName) { this.showToast('Please enter visa name', 'error'); return; }
                    name = customName;
                }

                if(!countryId || !name || isNaN(cost) || isNaN(regFee)) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                // Check Uniqueness
                const existing = db.get('visas').find(v => v.visaCode === code && v.id !== this.editingVisaId);
                if (existing) {
                    this.showToast(`Visa Code "${code}" is already taken`, 'error');
                    return;
                }

                const countryName = db.get('countries').find(c => c.id == countryId)?.name || "Unknown";
                const btn = document.getElementById('btnDrawerSubmit');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking ClickUp...';
                btn.disabled = true;

                try {
                    let finalId = this.editingVisaId;
                    let clickupId = null;

                    if (this.editingVisaId) {
                        // UPDATE Existing
                        const currentVisa = db.get('visas').find(v => v.id == this.editingVisaId);
                        clickupId = currentVisa.clickupId;

                        if (clickupId) {
                            try {
                                // Try updating to check if it exists in ClickUp
                                await this.updateClickUpTask(clickupId, countryName, name, cost, regFee, code);
                            } catch (err) {
                                // If update fails (e.g. task deleted in ClickUp), RECOVER by creating new
                                console.warn("ClickUp update failed (task missing?), creating new task...", err);
                                clickupId = await this.createClickUpTask(countryName, name, cost, regFee, code);
                            }
                        } else {
                            // Missing ID? Create new
                            clickupId = await this.createClickUpTask(countryName, name, cost, regFee, code);
                        }
                    } else {
                        // CREATE New
                        finalId = Date.now();
                        clickupId = await this.createClickUpTask(countryName, name, cost, regFee, code);
                    }

                    // Update Local DB
                    const visaData = {
                        id: finalId,
                        clickupId: clickupId,
                        countryId: parseInt(countryId),
                        name: name,
                        visaCode: code,
                        cost: cost,
                        regFee: regFee
                    };

                    if (this.editingVisaId) db.update('visas', visaData);
                    else db.add('visas', visaData);

                    this.showToast('Visa Saved & Synced Successfully!');
                    this.closeVisaDrawer();
                    
                    // Refresh List
                    const container = document.getElementById('visaListContainer');
                    if(container) container.innerHTML = this.generateVisaListHTML(db.get('visas'), db.get('countries'));

                } catch (e) {
                    console.error(e);
                    this.showToast('ClickUp Sync Failed. Check Console.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            },

            // --- CLICKUP API METHODS (ROBUST VERSION) ---
            async createClickUpTask(countryName, name, cost, regFee, code) {
                // USE VISA LIST ID
                const url = `https://api.clickup.com/api/v2/list/${clickUpConfig.visaListId}/task`;
                
                // 1. Create Basic Task First
                const body = { name: countryName };
                
                const res = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) {
                    const err = await res.text();
                    console.error("ClickUp Basic Create Error:", err);
                    throw new Error('ClickUp Create Failed');
                }
                const data = await res.json();
                const taskId = data.id;

                // 2. Set Custom Fields
                await this.updateClickUpTask(taskId, countryName, name, cost, regFee, code);
                
                return taskId;
            },

            async updateClickUpTask(taskId, countryName, name, cost, regFee, code) {
                // 1. Update Name (Serves as Check)
                const res = await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
                    method: 'PUT',
                    mode: 'cors',
                    headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: countryName })
                });

                // STRICT CHECK: If this fails, we throw so handleVisaSubmit knows to create a new task
                if (!res.ok) {
                    throw new Error(`Task update failed: ${res.status}`);
                }

                // 2. Update Fields Sequentially
                const fields = [
                    { name: 'Visa Name', id: clickUpConfig.customFields.visaName, value: String(name) },
                    { name: 'Cost', id: clickUpConfig.customFields.cost, value: Number(cost) },
                    { name: 'Reg Fee', id: clickUpConfig.customFields.regFee, value: Number(regFee) },
                    { name: 'Visa Code', id: clickUpConfig.customFields.visaCode, value: String(code) }
                ];

                for (const f of fields) {
                    try {
                        const fieldRes = await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${f.id}`, {
                            method: 'POST',
                            mode: 'cors',
                            headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: f.value })
                        });
                        
                        // Retry logic for Number vs String mismatch
                        if(!fieldRes.ok && typeof f.value === 'number') {
                             await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${f.id}`, {
                                method: 'POST',
                                mode: 'cors',
                                headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ value: String(f.value) })
                            });
                        }
                    } catch (e) {
                        console.error(`Failed to update field ${f.name}`, e);
                    }
                }
            },

            async deleteClickUpTask(taskId) {
                if(!taskId) return;
                await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': clickUpConfig.apiKey }
                });
            },

            // --- DELETE & BULK LOGIC ---
            async deleteSelectedVisas() {
                if (this.selectedVisas.size === 0) return;
                if (!confirm(`Permanently delete ${this.selectedVisas.size} visas from ClickUp and Local DB?`)) return;

                const ids = Array.from(this.selectedVisas);
                let failCount = 0;

                for (let id of ids) {
                    const visa = db.get('visas').find(v => v.id == id);
                    if (visa && visa.clickupId) {
                        try {
                            await this.deleteClickUpTask(visa.clickupId);
                        } catch(e) {
                            console.error("Delete failed for", visa.name);
                            failCount++;
                        }
                    }
                    db.delete('visas', id);
                }

                if(failCount > 0) this.showToast(`Deleted with ${failCount} errors`, 'warning');
                else this.showToast('Deleted successfully');

                this.selectedVisas.clear();
                this.updateBulkActionBar();
                
                const container = document.getElementById('visaListContainer');
                if(container) container.innerHTML = this.generateVisaListHTML(db.get('visas'), db.get('countries'));
            },

            toggleSelectAll(cb) {
                document.querySelectorAll('.visa-checkbox').forEach(box => {
                    box.checked = cb.checked;
                    this.toggleVisaSelection(box);
                });
            },

            toggleVisaSelection(box) {
                const id = parseInt(box.value);
                if (box.checked) this.selectedVisas.add(id);
                else this.selectedVisas.delete(id);
                this.updateBulkActionBar();
            },

            // --- NEW: TOGGLE HISTORY CARD ---
            toggleHistoryCard(id) {
                const details = document.getElementById(`details-${id}`);
                const icon = document.getElementById(`icon-${id}`);
                const card = document.getElementById(`card-${id}`);
                
                if (details.classList.contains('hidden')) {
                    // Open
                    details.classList.remove('hidden');
                    details.classList.add('block');
                    icon.classList.add('rotate-180');
                    card.classList.add('ring-2', 'ring-blue-500', 'shadow-lg');
                    card.classList.remove('border-slate-200');
                    card.classList.add('border-blue-500');
                } else {
                    // Close
                    details.classList.add('hidden');
                    details.classList.remove('block');
                    icon.classList.remove('rotate-180');
                    card.classList.remove('ring-2', 'ring-blue-500', 'shadow-lg');
                    card.classList.add('border-slate-200');
                    card.classList.remove('border-blue-500');
                }
            },

            generateHistoryCardsHTML(quotes, title) {
                if (!quotes || quotes.length === 0) return '';
                
                const titleBlock = title ? `<div class="col-span-full text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 px-1 flex items-center gap-2"><div class="h-px bg-slate-200 flex-1"></div>${title}<div class="h-px bg-slate-200 flex-1"></div></div>` : '';

                const cards = quotes.map(q => {
                    // Financials & Instalment Logic
                    const f = q.financials || {};
                    const insts = f.instalments || [0,0,0,0];
                    const activeInsts = insts.filter(x => x > 0);
                    const total = parseFloat(q.grandTotal);
                    
                    // Advisor Initials
                    const advName = q.advisor || 'Admin';
                    const advInit = advName.charAt(0).toUpperCase();

                    // Generate Instalment Bars
                    let barsHtml = '';
                    if (total > 0 && activeInsts.length > 0) {
                        barsHtml = activeInsts.map((amt, idx) => {
                            const pct = (amt / total) * 100;
                            const color = ['bg-emerald-500', 'bg-blue-500', 'bg-violet-500', 'bg-amber-500'][idx % 4];
                            return `
                                <div class="flex-1 flex flex-col gap-1 group/bar relative">
                                    <div class="h-1.5 w-full rounded-full bg-slate-200 overflow-hidden">
                                        <div class="h-full ${color}" style="width: 100%"></div>
                                    </div>
                                    <div class="text-[9px] font-mono text-slate-400 font-medium opacity-60">#${idx+1}</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                         barsHtml = `<div class="text-[10px] text-slate-400 italic">No plan data</div>`;
                    }

                    // Generate Installment List Text
                    let instListHtml = '';
                    if (total > 0 && activeInsts.length > 0) {
                        instListHtml = `<div class="mt-3 pt-2 border-t border-slate-100/50">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">Payment Plan Details</p>
                            <div class="grid grid-cols-2 gap-2">`;
                        
                        activeInsts.forEach((amt, idx) => {
                             instListHtml += `
                                <div class="flex justify-between items-center text-[10px] bg-slate-50 px-2 py-1.5 rounded border border-slate-100">
                                    <span class="text-slate-500 font-bold uppercase tracking-wide">Instalment ${idx+1}</span>
                                    <span class="font-mono font-bold text-slate-700">€${amt.toFixed(2)}</span>
                                </div>`;
                        });
                        instListHtml += `</div></div>`;
                    }

                    const dateStr = new Date(Number(q.date)).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const badgeColor = q.isRemote ? 'bg-purple-50 text-purple-600 border-purple-200' : 'bg-slate-50 text-slate-600 border-slate-200';
                    const icon = q.isRemote ? 'fa-cloud' : 'fa-database';
                    const statusColor = q.status === 'Closed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600';

                    // Financial Items for Grid
                    const formatMoney = (val) => `€${(parseFloat(val)||0).toFixed(2)}`;
                    
                    return `
                    <div id="card-${q.id}" class="col-span-full md:col-span-1 bg-white rounded-lg border border-slate-200 shadow-sm transition-all duration-200 cursor-pointer hover:border-blue-300 group" onclick="app.toggleHistoryCard('${q.id}')">
                        
                        <!-- 1. COMPACT HEADER (Always Visible) -->
                        <div class="p-4 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 font-bold text-sm group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                    ${q.customerName.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm truncate w-32 sm:w-40" title="${q.customerName}">${q.customerName}</h4>
                                    <div class="text-[10px] text-slate-500 font-medium flex items-center gap-1.5">
                                        <span class="bg-white px-1.5 py-0.5 rounded border border-slate-100">${q.refId}</span>
                                        <span>${dateStr}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-6">
                                <div class="text-right hidden sm:block">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Total</div>
                                    <div class="text-sm font-bold text-slate-900 font-mono">€${Math.floor(total)}</div>
                                </div>
                                <i id="icon-${q.id}" class="fa-solid fa-chevron-down text-slate-300 transition-transform duration-300 group-hover:text-blue-400"></i>
                            </div>
                        </div>

                        <!-- 2. EXPANDED DETAILS (Hidden by Default) -->
                        <div id="details-${q.id}" class="hidden border-t border-slate-100 bg-slate-50/50">
                            
                            <!-- Primary Data Grid -->
                            <div class="p-4 grid grid-cols-2 gap-y-4 gap-x-6">
                                <!-- Col 1: Application -->
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Visa Details</p>
                                    <div class="text-xs font-bold text-slate-700">${q.destination}</div>
                                    <div class="text-xs text-slate-500">${q.visaName}</div>
                                    <div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-users text-slate-300 mr-1"></i> ${q.pax || 1} Pax</div>
                                </div>

                                <!-- Col 2: Contact -->
                                <div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Contact Info</p>
                                    <div class="text-xs text-slate-700">${q.phone}</div>
                                    <div class="text-xs text-slate-500">${q.nationality}</div>
                                    <div class="text-xs text-slate-500 mt-1">${q.jobTitle || '---'}</div>
                                </div>
                            </div>

                            <!-- Financial Breakdown Strip -->
                            <div class="px-4 py-3 bg-white border-y border-slate-100">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">Financial Breakdown</p>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                                    <div><span class="text-slate-400 text-[10px]">Base:</span> <span class="font-mono font-medium">${formatMoney(f.baseCost)}</span></div>
                                    <div><span class="text-slate-400 text-[10px]">Reg:</span> <span class="font-mono font-medium">${formatMoney(f.regFee)}</span></div>
                                    <div><span class="text-slate-400 text-[10px]">VAT:</span> <span class="font-mono font-medium">${formatMoney(f.vat)}</span></div>
                                    <div class="${f.discountAmount > 0 ? 'text-emerald-600' : 'text-slate-300'}"><span class="text-[10px]">Disc:</span> <span class="font-mono font-bold">-${formatMoney(f.discountAmount)}</span></div>
                                </div>
                                ${instListHtml}
                            </div>

                            <!-- Footer: Advisor & Plan -->
                            <div class="p-4 flex flex-col gap-3">
                                <div>
                                    <div class="flex justify-between items-end mb-1">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase">Payment Schedule</span>
                                        <span class="text-[9px] font-bold text-slate-400 uppercase">Advisor: <span class="text-slate-600">${advName}</span></span>
                                    </div>
                                    <div class="flex gap-2 items-end h-6">
                                        ${barsHtml}
                                    </div>
                                </div>
                                
                                <div class="flex justify-end gap-2 pt-2 border-t border-slate-100/50">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold border ${badgeColor} flex items-center gap-1">
                                        <i class="fa-solid ${icon}"></i> ${q.status || 'Active'}
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div>`;
                }).join('');

                return titleBlock + cards;
            },

            updateBulkActionBar() {
                const bar = document.getElementById('bulkActionBar');
                const count = this.selectedVisas.size;
                document.getElementById('selectedCount').innerText = `${count} Selected`;
                if (count > 0) bar.classList.remove('hidden');
                else bar.classList.add('hidden');
            },
            
            clearSelection() {
                this.selectedVisas.clear();
                document.querySelectorAll('.visa-checkbox').forEach(c => c.checked = false);
                this.updateBulkActionBar();
            },

            openBulkEditModal() {
                document.getElementById('bulkCountDisplay').innerText = this.selectedVisas.size;
                document.getElementById('bulk_cost').value = '';
                document.getElementById('bulk_reg').value = '';
                document.getElementById('bulkEditModal').classList.add('active');
            },

            applyBulkEdit() {
                const newCost = document.getElementById('bulk_cost').value;
                const newReg = document.getElementById('bulk_reg').value;
                
                if(!newCost && !newReg) {
                    document.getElementById('bulkEditModal').classList.remove('active');
                    return;
                }

                let visas = db.get('visas');
                let updateCount = 0;

                visas = visas.map(v => {
                    if(this.selectedVisas.has(v.id)) {
                        updateCount++;
                        return {
                            ...v,
                            cost: newCost ? parseFloat(newCost) : v.cost,
                            regFee: newReg ? parseFloat(newReg) : v.regFee
                        };
                    }
                    return v;
                });

                db.set('visas', visas);
                this.showToast(`Updated ${updateCount} visas locally. Sync manually if needed.`);
                document.getElementById('bulkEditModal').classList.remove('active');
                this.clearSelection();
                
                const container = document.getElementById('visaListContainer');
                if(container) container.innerHTML = this.generateVisaListHTML(visas, db.get('countries'));
            },

            filterVisas(term) {
                term = term.toLowerCase();
                document.querySelectorAll('.visa-item').forEach(el => {
                    el.style.display = el.dataset.search.includes(term) ? 'grid' : 'none';
                });
            },

            // --- SYNC FETCH LOGIC ---
            async fetchVisasFromClickUp(force = false) {
                const btn = document.getElementById('btnSyncClickUp');
                if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...'; }

                try {
                    // USE VISA LIST ID
                    const res = await fetch(`https://api.clickup.com/api/v2/list/${clickUpConfig.visaListId}/task?archived=false&include_closed=true`, {
                        headers: { 'Authorization': clickUpConfig.apiKey }
                    });
                    const data = await res.json();
                    
                    const newVisas = [];
                    data.tasks.forEach(t => {
                        const countryName = t.name;
                        const countryId = db.getOrCreateCountry(countryName);
                        
                        // Extract Fields - Enhanced to handle Dropdowns objects vs Values
                        const getVal = (fieldId) => {
                            const field = t.custom_fields.find(f => f.id === fieldId);
                            if (!field) return "";
                            // Handle Dropdown object case (usually field.value is index, type_config has labels)
                            // or simple value
                            if (field.type === 'drop_down' && typeof field.value === 'number') {
                                return field.type_config.options[field.value]?.name || "";
                            }
                            // Handle if value is object
                            if (typeof field.value === 'object' && field.value !== null) {
                                return field.value.status || field.value.text || field.value.name || JSON.stringify(field.value); 
                            }
                            return field.value;
                        };

                        const vName = getVal(clickUpConfig.customFields.visaName) || "Unknown";
                        const vCost = parseFloat(getVal(clickUpConfig.customFields.cost)) || 0;
                        const vReg = parseFloat(getVal(clickUpConfig.customFields.regFee)) || 0;
                        const vCode = getVal(clickUpConfig.customFields.visaCode) || "";

                        newVisas.push({
                            id: t.id, // UPDATED: Use string ID directly
                            clickupId: t.id,
                            countryId: countryId,
                            name: String(vName),
                            visaCode: String(vCode),
                            cost: vCost,
                            regFee: vReg
                        });
                    });

                    db.set('visas', newVisas);
                    if(!force) this.showToast(`Synced ${newVisas.length} visas`);
                    
                    if(this.currentView === 'admin-visas') {
                        const container = document.getElementById('visaListContainer');
                        if(container) container.innerHTML = this.generateVisaListHTML(newVisas, db.get('countries'));
                    }

                } catch(e) {
                    console.error(e);
                    if(!force) this.showToast('Sync Failed', 'error');
                } finally {
                    if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i> <span class="hidden sm:inline">Force Sync</span>'; }
                }
            },
            
            // --- ADMIN: USERS ---
            renderAdminUsers(container) {
                container.innerHTML = `
                    <div class="relative h-full flex flex-col fade-in">
                        <!-- Toolbar -->
                        <div class="bg-white rounded-xl border border-slate-200 p-4 mb-4 flex flex-col md:flex-row justify-between items-center shadow-sm gap-4">
                            <div class="flex items-center gap-3 w-full md:w-auto">
                                <h3 class="font-bold text-slate-700 text-lg">User Management</h3>
                                <span class="px-2.5 py-0.5 bg-slate-100 text-slate-500 rounded-full text-xs font-bold border border-slate-200" id="userCountBadge">0 Active</span>
                            </div>
                            
                            <!-- Mobile Responsive Toolbar -->
                            <div class="flex gap-3 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                                <div class="relative flex-1 min-w-[200px] md:min-w-[250px]">
                                    <input type="text" placeholder="Search users..." id="userSearch" onkeyup="app.filterUsers(this.value)" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                </div>
                                <button onclick="app.fetchUsersFromClickUp(true)" id="btnSyncUsers" class="px-4 py-2 bg-white text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-50 transition-colors border border-slate-200 shadow-sm flex items-center gap-2 whitespace-nowrap">
                                    <i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Sync</span>
                                </button>
                                <button onclick="app.initAddUser()" class="px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/20 whitespace-nowrap flex items-center gap-2">
                                    <i class="fa-solid fa-user-plus"></i> <span>Add User</span>
                                </button>
                            </div>
                        </div>

                        <!-- User List (Horizontal Scroll for Mobile) -->
                        <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex-1 overflow-y-auto relative">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left min-w-[800px]">
                                    <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b border-slate-200 tracking-wider sticky top-0 z-10">
                                        <tr>
                                            <th class="px-6 py-4">User Profile</th>
                                            <th class="px-6 py-4">Role</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100" id="userListBody">
                                        <tr>
                                            <td colspan="4" class="px-6 py-10 text-center">
                                                <div class="flex flex-col items-center justify-center text-slate-400">
                                                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                                                    <p>Loading users from ClickUp...</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- USER DRAWER (Side Panel) -->
                    <div id="userDrawerOverlay" onclick="app.closeUserDrawer()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>
                    <div id="userDrawer" class="fixed inset-y-0 right-0 w-full md:w-[400px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 class="font-bold text-lg text-slate-800" id="userDrawerTitle">Add User</h3>
                                <p class="text-xs text-slate-500">Credentials sync to ClickUp</p>
                            </div>
                            <button onclick="app.closeUserDrawer()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-red-500 hover:border-red-200 flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-6">
                            <form id="userForm" class="space-y-5" onsubmit="event.preventDefault(); app.handleUserSubmit();">
                                <input type="hidden" id="edit_clickup_id">
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Full Name</label>
                                    <input type="text" id="u_name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. John Doe">
                                </div>

                                <!-- Added Designation Field -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Designation</label>
                                    <input type="text" id="u_designation" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Senior Consultant">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">User ID</label>
                                    <input type="text" id="u_userid" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter User ID">
                                </div>

                                <!-- Added Phone Field -->
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Phone Number</label>
                                    <input type="tel" id="u_phone" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500" placeholder="+971...">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Password</label>
                                    <div class="relative">
                                        <input type="text" id="u_pass" required class="w-full pl-3 pr-10 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter password">
                                        <button type="button" onclick="document.getElementById('u_pass').value = Math.random().toString(36).slice(-8)" class="absolute right-3 top-3 text-slate-400 hover:text-blue-500 text-xs" title="Generate Random">
                                            <i class="fa-solid fa-shuffle"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Role</label>
                                        <select id="u_role" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="Agent">Agent</option>
                                            <option value="Admin">Admin</option>
                                            <option value="Viewer">Viewer</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Status</label>
                                        <select id="u_status" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="p-5 border-t border-slate-100 bg-slate-50 flex gap-3">
                            <button type="button" onclick="app.handleUserSubmit()" id="btnUserSubmit" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-check"></i> <span>Save User</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Trigger fetch immediately
                setTimeout(() => this.fetchUsersFromClickUp(), 100);
            },

            // --- USER MANAGEMENT LOGIC ---

            async fetchUsersFromClickUp(force = false) {
                const btn = document.getElementById('btnSyncUsers');
                if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...'; }
                const listBody = document.getElementById('userListBody');

                try {
                    const res = await fetch(`https://api.clickup.com/api/v2/list/${clickUpConfig.userListId}/task?archived=false&include_closed=true`, {
                        headers: { 'Authorization': clickUpConfig.apiKey }
                    });
                    
                    if(!res.ok) throw new Error("Failed to fetch users");
                    
                    const data = await res.json();
                    
                    // Store users globally for edit access
                    this.fetchedUsers = data.tasks.map(t => {
                        const getVal = (fid) => {
                            const f = t.custom_fields.find(x => x.id === fid);
                            if (!f) return "---";
                            if (f.type === 'drop_down' && typeof f.value === 'number') return f.type_config.options[f.value]?.name;
                            if (typeof f.value === 'object' && f.value !== null) return f.value.status || f.value.text || f.value.name; 
                            return f.value || "---";
                        };

                        const role = getVal(clickUpConfig.userFields.role);

                        return {
                            id: t.id, // ClickUp Task ID
                            name: t.name,
                            userId: getVal(clickUpConfig.userFields.userId),
                            password: getVal(clickUpConfig.userFields.password),
                            role: role !== "---" ? role : 'Agent',
                            status: t.status.status,
                            avatar: t.name.charAt(0).toUpperCase(),
                            phone: getVal(clickUpConfig.userFields.phone) || '---', // Map phone
                            designation: getVal(clickUpConfig.userFields.designation) || '---' // Map designation
                        };
                    });

                    this.renderUserListHTML(this.fetchedUsers);
                    
                    const badge = document.getElementById('userCountBadge');
                    if(badge) badge.innerText = `${this.fetchedUsers.length} Users`;
                    
                    if(!force && this.fetchedUsers.length > 0) this.showToast(`Synced ${this.fetchedUsers.length} users`);

                } catch(e) {
                    console.error(e);
                    this.showToast('User Sync Failed', 'error');
                    if(listBody) listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-400"><i class="fa-solid fa-circle-exclamation mr-2"></i> Sync Error. Check API Key/Connection.</td></tr>';
                } finally {
                    if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Sync</span>'; }
                }
            },

            renderUserListHTML(users) {
                const container = document.getElementById('userListBody');
                if(!container) return;
                
                if(!users || users.length === 0) {
                    container.innerHTML = '<tr><td colspan="4" class="text-center py-10 text-slate-400 flex flex-col items-center"><i class="fa-solid fa-users-slash text-2xl mb-2"></i>No users found in ClickUp List.</td></tr>';
                    return;
                }

                container.innerHTML = users.map(u => {
                    const isAdmin = u.role.toLowerCase().includes('admin');
                    const isActive = u.status.toLowerCase() === 'active' || u.status.toLowerCase() === 'to do'; // Assuming 'to do' as active state in basic lists
                    
                    return `
                    <tr class="hover:bg-slate-50 transition-colors group user-row" data-search="${u.name.toLowerCase()}">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600 text-xs border border-slate-200 shadow-sm">
                                    ${u.avatar}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-700">${u.name}</div>
                                    <div class="text-[10px] text-slate-500 font-medium tracking-tight mb-0.5">${u.designation}</div>
                                    <div class="text-xs text-slate-400 font-mono">ID: ${u.userId}</div>
                                    <div class="text-[10px] text-slate-400 mt-0.5 flex items-center gap-1"><i class="fa-solid fa-phone text-[9px] opacity-60"></i> ${u.phone}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[10px] font-bold uppercase border ${isAdmin ? 'bg-purple-50 text-purple-700 border-purple-100' : 'bg-blue-50 text-blue-700 border-blue-100'}">
                                <i class="fa-solid ${isAdmin ? 'fa-shield-halved' : 'fa-user-tie'}"></i> ${u.role}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div class="relative flex h-2 w-2">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full ${isActive ? 'bg-emerald-400' : 'hidden'} opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2 w-2 ${isActive ? 'bg-emerald-500' : 'bg-slate-300'}"></span>
                                </div>
                                <span class="text-xs font-medium ${isActive ? 'text-emerald-700' : 'text-slate-400'} uppercase tracking-wide">${u.status}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end items-center gap-2 group/pass">
                                <span class="text-xs font-mono text-slate-300 group-hover/pass:text-slate-600 transition-colors cursor-default">
                                    ${u.password && u.password !== '---' ? '••••••••' : 'No Password'}
                                </span>
                                ${u.password && u.password !== '---' ? `<button onclick="navigator.clipboard.writeText('${u.password}'); app.showToast('Password Copied')" class="text-slate-300 hover:text-blue-500 transition-colors" title="Copy Password"><i class="fa-regular fa-copy"></i></button>` : ''}
                                <button onclick="app.initEditUser('${u.id}')" class="text-slate-400 hover:text-blue-600 ml-2" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                                <button onclick="app.deleteUser('${u.id}')" class="text-slate-400 hover:text-red-500 ml-1" title="Delete"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `}).join('');
            },

            filterUsers(term) {
                term = term.toLowerCase();
                document.querySelectorAll('.user-row').forEach(row => {
                    row.style.display = row.dataset.search.includes(term) ? 'table-row' : 'none';
                });
            },

            // --- USER DRAWER ACTIONS ---

            openUserDrawer() {
                const overlay = document.getElementById('userDrawerOverlay');
                const drawer = document.getElementById('userDrawer');
                if(overlay && drawer) {
                    overlay.classList.remove('hidden');
                    void drawer.offsetWidth;
                    overlay.classList.remove('opacity-0');
                    drawer.classList.remove('translate-x-full');
                }
            },

            closeUserDrawer() {
                const overlay = document.getElementById('userDrawerOverlay');
                const drawer = document.getElementById('userDrawer');
                if(overlay && drawer) {
                    overlay.classList.add('opacity-0');
                    drawer.classList.add('translate-x-full');
                    setTimeout(() => { overlay.classList.add('hidden'); }, 300);
                }
            },

            initAddUser() {
                document.getElementById('userDrawerTitle').innerText = "Add New User";
                document.getElementById('edit_clickup_id').value = ""; 
                document.getElementById('u_name').value = "";
                document.getElementById('u_pass').value = Math.random().toString(36).slice(-8); 
                document.getElementById('u_role').value = "Agent";
                document.getElementById('u_status').value = "active";
                document.getElementById('u_userid').value = "";
                document.getElementById('u_phone').value = ""; 
                document.getElementById('u_designation').value = ""; // Reset designation

                document.getElementById('btnUserSubmit').innerHTML = '<i class="fa-solid fa-check"></i> <span>Create User</span>';
                this.openUserDrawer();
            },

            initEditUser(clickupId) {
                const user = this.fetchedUsers.find(u => u.id === clickupId);
                if(!user) return;

                document.getElementById('userDrawerTitle').innerText = "Edit User Details";
                document.getElementById('edit_clickup_id').value = clickupId;
                document.getElementById('u_name').value = user.name;
                document.getElementById('u_userid').value = user.userId;
                document.getElementById('u_pass').value = user.password !== '---' ? user.password : '';
                document.getElementById('u_phone').value = user.phone !== '---' ? user.phone : ''; 
                document.getElementById('u_designation').value = user.designation !== '---' ? user.designation : ''; // Populate designation
                
                const roleSelect = document.getElementById('u_role');
                roleSelect.value = ["Admin", "Agent", "Viewer"].includes(user.role) ? user.role : "Agent";
                
                const statusSelect = document.getElementById('u_status');
                statusSelect.value = ['active', 'to do', 'open'].includes(user.status.toLowerCase()) ? 'active' : 'inactive';

                document.getElementById('btnUserSubmit').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> <span>Update User</span>';
                this.openUserDrawer();
            },

            async handleUserSubmit() {
                const clickupId = document.getElementById('edit_clickup_id').value;
                const name = document.getElementById('u_name').value;
                const userId = document.getElementById('u_userid').value;
                const pass = document.getElementById('u_pass').value;
                const role = document.getElementById('u_role').value;
                const status = document.getElementById('u_status').value;
                const phone = document.getElementById('u_phone').value;
                const designation = document.getElementById('u_designation').value; // Get designation

                if(!name || !pass) {
                    this.showToast('Name and Password required', 'error');
                    return;
                }

                const btn = document.getElementById('btnUserSubmit');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
                btn.disabled = true;

                try {
                    let taskId = clickupId;
                    
                    if (clickupId) {
                        // UPDATE EXISTING
                        await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                name: name,
                                status: status === 'active' ? 'to do' : 'complete'
                            })
                        });
                        this.showToast('User Updated Successfully');
                    } else {
                        // CREATE NEW
                        const res = await fetch(`https://api.clickup.com/api/v2/list/${clickUpConfig.userListId}/task`, {
                            method: 'POST',
                            headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                name: name,
                                status: status === 'active' ? 'to do' : 'complete'
                            })
                        });
                        if(!res.ok) throw new Error("Create failed");
                        const data = await res.json();
                        taskId = data.id;
                        this.showToast('User Created Successfully');
                    }

                    // Update Custom Fields
                    const fields = [
                        { id: clickUpConfig.userFields.userId, value: userId },
                        { id: clickUpConfig.userFields.password, value: pass },
                        { id: clickUpConfig.userFields.role, value: role },
                        { id: clickUpConfig.userFields.phone, value: phone },
                        { id: clickUpConfig.userFields.designation, value: designation } // Save designation
                    ];

                    for(const f of fields) {
                        await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${f.id}`, {
                            method: 'POST',
                            headers: { 'Authorization': clickUpConfig.apiKey, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: f.value })
                        });
                    }
                    
                    this.closeUserDrawer();
                    this.fetchUsersFromClickUp(); 

                } catch(e) {
                    console.error(e);
                    this.showToast('Operation Failed. Check Console.', 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },

            async deleteUser(clickupId) {
                if(!confirm("Are you sure you want to delete this user? This cannot be undone.")) return;

                try {
                    await fetch(`https://api.clickup.com/api/v2/task/${clickupId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': clickUpConfig.apiKey }
                    });

                    this.showToast('User Deleted');
                    this.fetchUsersFromClickUp();
                } catch(e) {
                    console.error(e);
                    this.showToast('Delete Failed', 'error');
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>