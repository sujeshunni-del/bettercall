<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder Ultimate Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Flatpickr (Modern Date Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Roboto+Mono:wght@400;500&family=Lato:wght@300;400;700&family=Open+Sans:wght@300;400;600&family=Roboto:wght@300;400;500;700&family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600&family=Poppins:wght@300;400;600&family=Lora:wght@400;600&family=Raleway:wght@300;400;600&display=swap');
        
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-merriweather { font-family: 'Merriweather', serif; }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .font-open-sans { font-family: 'Open Sans', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-source-sans { font-family: 'Source Sans Pro', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .font-lora { font-family: 'Lora', serif; }
        .font-raleway { font-family: 'Raleway', sans-serif; }

        /* A4 Page Container */
        .a4-page {
            width: 210mm;
            min-height: 297mm; /* Ensure at least one full page */
            background: white;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
            margin: 0 auto;
            position: relative;
            transform-origin: top center;
            display: flex;
            flex-direction: column; 
            color: #1e293b;
            /* Allow height to grow for preview, print will handle pages */
            height: auto; 
        }

        #preview-container-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100%;
            padding: 40px;
            box-sizing: border-box;
            background-color: #e2e8f0; 
        }

        /* Page Break Marker for Preview */
        .page-break-marker {
            position: absolute;
            left: 0;
            width: 100%;
            height: 0;
            border-top: 2px dashed #f87171; /* Red dashed line */
            z-index: 50;
            pointer-events: none;
            display: flex;
            justify-content: flex-end;
        }
        .page-break-label {
            background: #fef2f2;
            color: #ef4444;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 0 0 4px 4px;
            margin-right: 10px;
            border: 1px solid #fca5a5;
            border-top: none;
        }

        /* Custom Date Picker Styles */
        .flatpickr-calendar {
            border-radius: 12px !important;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
            border: 1px solid #e2e8f0 !important;
            font-family: 'Inter', sans-serif !important;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: #2563eb !important;
            border-color: #2563eb !important;
        }

        /* Rich Text Editor Styles */
        .rich-editor {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #f8fafc;
            transition: all 0.2s;
        }
        .rich-editor:focus-within {
            background: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .rich-toolbar {
            display: flex;
            gap: 4px;
            padding: 8px;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
        }
        .rich-btn {
            padding: 4px 8px;
            border-radius: 6px;
            color: #64748b;
            background: transparent;
            cursor: pointer;
            transition: all 0.15s;
        }
        .rich-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }
        .rich-content {
            padding: 12px;
            min-height: 100px;
            outline: none;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.625; /* leading-relaxed */
            color: #334155;
        }
        .rich-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .rich-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .rich-content b { font-weight: 700; }
        .rich-content i { font-style: italic; }
        .rich-content u { text-decoration: underline; }

        /* PRINT STYLES - CRITICAL FOR VECTOR PDF */
        @media print {
            @page { 
                margin: 0; 
                size: A4 portrait; 
            }
            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* Hide all UI elements */
            header, aside, main, #print-tip, .no-print, .flatpickr-calendar, .page-break-marker { 
                display: none !important; 
            }
            
            /* Promote Preview Area */
            #preview-wrapper { 
                padding: 0 !important; 
                margin: 0 !important; 
                width: 100% !important; 
                height: auto !important; 
                background: white !important; 
                overflow: visible !important; 
                display: block !important;
                position: absolute !important;
                top: 0;
                left: 0;
            }
            
            #preview-container-wrapper {
                padding: 0 !important;
                background: white !important;
                display: block !important;
                width: 210mm !important;
                margin: 0 auto !important;
            }
            
            /* The CV Page */
            .a4-page { 
                width: 210mm !important; 
                /* Allow height to be auto for printing to handle multipage */
                height: auto !important; 
                min-height: 297mm !important;
                box-shadow: none !important; 
                transform: none !important; 
                margin: 0 !important;
                position: relative !important; 
                print-color-adjust: exact;
                display: block !important; /* Block allows natural flow */
            }
            
            .break-inside-avoid { page-break-inside: avoid; }
            
            /* Fix lists in preview for print */
            ul { list-style-type: disc !important; padding-left: 1.2em !important; }
            ol { list-style-type: decimal !important; padding-left: 1.2em !important; }
        }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .input-creative {
            background: #f8fafc; border: 1px solid #e2e8f0; transition: all 0.2s;
        }
        .input-creative:focus {
            background: #ffffff; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none;
        }
        
        .ai-glow { animation: glow 2s ease-in-out infinite; border-color: #a855f7 !important; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(168, 85, 247, 0.2); } 50% { box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); } }
        
        .mic-listening { animation: pulse-red 1.5s infinite; color: #ef4444; border-color: #ef4444; background-color: #fef2f2; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #2563eb; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden text-slate-800 font-inter">

    <!-- Top Navigation -->
    <header class="bg-white border-b border-slate-200 h-16 flex justify-between items-center px-6 shadow-sm z-40 shrink-0 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-600/20">
                <i data-lucide="award" width="20" height="20"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-slate-800">CV Builder <span class="text-blue-600">Pro</span></h1>
                <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">v8.11 AI ENHANCED</p>
            </div>
        </div>
        <div class="flex gap-3">
            <!-- Restored Restore/Backup Buttons -->
            <label class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-full text-sm font-medium transition-colors cursor-pointer shadow-sm">
                <i data-lucide="upload" width="16"></i> Restore
                <input type="file" accept=".json" onchange="app.importJSON(this)" class="hidden" />
            </label>
            <button onclick="app.downloadJSON()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:text-green-600 hover:border-green-200 hover:bg-green-50 text-slate-600 rounded-full text-sm font-medium transition-colors shadow-sm">
                <i data-lucide="save" width="16"></i> Backup
            </button>
            <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:text-gray-900 hover:bg-gray-50 text-slate-600 rounded-full text-sm font-medium transition-colors shadow-sm">
                <i data-lucide="printer" width="16"></i> Print
            </button>
            <button onclick="app.downloadPDF()" class="flex items-center gap-2 px-5 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-full text-sm font-medium transition-colors shadow-lg shadow-slate-900/20" id="download-btn">
                <i data-lucide="download" width="16"></i> Download PDF
            </button>
        </div>
    </header>

    <!-- Main Workspace Area -->
    <div class="flex flex-1 overflow-hidden relative">
        <aside class="w-20 bg-slate-900 flex flex-col items-center py-6 gap-4 z-30 shadow-xl overflow-y-auto no-print shrink-0">
            <div id="tabs-container" class="flex flex-col w-full gap-2 px-2"></div>
        </aside>

        <main class="w-[450px] bg-white border-r border-slate-200 flex flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)] no-print shrink-0 transition-all duration-300">
            <div class="h-16 border-b border-slate-100 flex items-center justify-between px-6 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                <h2 id="section-title" class="text-lg font-bold text-slate-800 uppercase tracking-tight">Editor</h2>
            </div>
            <div id="editor-content" class="flex-1 overflow-y-auto p-6 scrollbar-thin"></div>
        </main>

        <section class="flex-1 bg-slate-200 relative overflow-hidden flex flex-col items-center">
            <div class="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>
            <div id="preview-wrapper" class="flex-1 w-full overflow-y-auto overflow-x-hidden relative z-0 flex justify-center pt-8 pb-32">
                 <div id="preview-container-wrapper">
                    <div id="preview-container" class="a4-page transition-transform duration-200 origin-top bg-white"></div>
                </div>
            </div>
            <div class="absolute bottom-6 right-6 flex items-center gap-2 bg-white p-2 rounded-full shadow-lg border border-slate-200 no-print z-50">
                <button class="p-2 hover:bg-slate-100 rounded-full text-slate-500" onclick="app.adjustScale(-0.1)"><i data-lucide="minus" width="16"></i></button>
                <span class="text-xs font-mono w-12 text-center" id="zoom-level">100%</span>
                <button class="p-2 hover:bg-slate-100 rounded-full text-slate-500" onclick="app.adjustScale(0.1)"><i data-lucide="plus" width="16"></i></button>
                <button class="p-2 hover:bg-slate-100 rounded-full text-slate-500 border-l border-slate-200 ml-1 pl-3" onclick="app.autoFit()" title="Fit to Screen"><i data-lucide="maximize" width="16"></i></button>
            </div>
        </section>
    </div>

    <!-- Cropper Modal -->
    <div id="cropper-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[1000] p-4 hidden transition-opacity opacity-0 no-print">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2 text-slate-800"><i data-lucide="crop"></i> Edit Profile Picture</h3>
                <button onclick="app.closeCropper()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="flex justify-center mb-8">
                <div id="crop-area" class="w-64 h-64 rounded-full border-[6px] border-white ring-4 ring-blue-500/20 shadow-xl overflow-hidden relative bg-slate-100 cursor-move">
                    <img id="crop-img" src="" class="absolute max-w-none origin-center top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none" draggable="false">
                </div>
            </div>
            <div class="mb-8 space-y-2">
                <div class="flex items-center gap-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                    <i data-lucide="zoom-in" class="text-slate-400" width="16"></i>
                    <input type="range" min="0.5" max="3" step="0.1" value="1" id="zoom-slider" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="app.closeCropper()" class="flex-1 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl font-semibold border border-slate-200 transition-colors">Cancel</button>
                <button onclick="app.saveCrop()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold shadow-lg shadow-blue-600/30 flex items-center justify-center gap-2 transition-transform hover:-translate-y-0.5"><i data-lucide="check" width="18"></i> Save Photo</button>
            </div>
        </div>
    </div>

    <!-- Print Tip Toast -->
    <div id="print-tip" class="fixed top-20 right-6 bg-slate-900 text-white p-4 rounded-xl shadow-2xl z-[2000] hidden max-w-sm border border-slate-700 no-print animate-in slide-in-from-right fade-in">
        <div class="flex items-start gap-3">
            <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="info" width="20"></i></div>
            <div>
                <h4 class="font-bold text-sm mb-1">Vector PDF Ready</h4>
                <p class="text-xs text-slate-300 leading-relaxed mb-2">To save as an editable, selectable text PDF:</p>
                <ol class="text-xs text-slate-300 list-decimal pl-4 space-y-1 mb-3">
                    <li>Set Destination to <strong>"Save as PDF"</strong>.</li>
                    <li>Ensure <strong>"Background graphics"</strong> is checked.</li>
                    <li>Set Margins to <strong>"None"</strong>.</li>
                </ol>
                <button onclick="document.getElementById('print-tip').classList.add('hidden')" class="text-xs font-bold text-blue-400 hover:text-blue-300">Continue</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyA5O2TfWGi1BT0aDC-a27-_GoUgwC_VtgI"; 

        // 1. DATA CONSTANTS
        const JOB_DB = {
            "Management & Executive": ["Branch Manager", "Business Development Manager", "Chief Executive Officer (CEO)", "Chief Financial Officer (CFO)", "Chief Operating Officer (COO)", "Chief Technology Officer (CTO)", "Executive Assistant", "General Manager", "Human Resources Manager", "Manager", "Marketing Manager", "Office Manager", "Operations Manager", "Product Manager", "Program Manager", "Project Manager", "Regional Manager", "Sales Manager", "Strategy Director", "Team Leader"],
            "Administrative & Office": ["Accountant", "Admin", "Administrative Assistant", "Bank Assistant / Finance Executive", "Bookkeeper", "Business Development Executive", "Call Centre Executive", "Clerk", "Computer Operator", "Customer Service Executive", "Data Entry Operator", "Document Controller", "Front Office Executive", "HR Assistant", "Inventory Clerk", "Office Assistant", "Receptionist", "Secretary / Personal Assistant"],
            "Medical & Healthcare": ["Doctor", "Nurse", "Anesthesiologist", "Dentist", "Dietitian", "Pharmacist", "Paramedic", "Psychiatrist", "Radiologist", "Surgeon"],
            "Engineering & Tech": ["Software Engineer", "Cloud Architect", "Data Scientist", "DevOps Engineer", "Civil Engineer", "Mechanical Engineer", "Electrical Engineer", "Network Administrator", "UX/UI Designer", "Web Developer"],
            "Construction & Trades": ["Architect", "Electrician", "Plumber", "Welder", "Mason", "Carpenter", "Foreman", "Safety Officer"],
            "Hospitality & Sales": ["Chef", "Waiter", "Hotel Manager", "Sales Executive", "Account Manager", "Brand Manager", "Cashier"],
            "Others": ["Teacher", "Driver", "Artist", "Security Guard", "Lawyer", "Musician"]
        };

        const EDU_CATEGORIES = ["Academic", "Technical", "Training", "Certification"];
        const GENDER_OPTS = ["Male", "Female", "Non-Binary", "Prefer not to say"];
        const MARITAL_OPTS = ["Single", "Married", "Divorced", "Widowed"];
        
        const FONT_OPTIONS = [
            { id: 'font-inter', label: 'Inter', class: 'font-inter' },
            { id: 'font-roboto', label: 'Roboto', class: 'font-roboto' },
            { id: 'font-open-sans', label: 'Open Sans', class: 'font-open-sans' },
            { id: 'font-lato', label: 'Lato', class: 'font-lato' },
            { id: 'font-montserrat', label: 'Montserrat', class: 'font-montserrat' },
            { id: 'font-poppins', label: 'Poppins', class: 'font-poppins' },
            { id: 'font-source-sans', label: 'Source Sans', class: 'font-source-sans' },
            { id: 'font-raleway', label: 'Raleway', class: 'font-raleway' },
            { id: 'font-merriweather', label: 'Merriweather', class: 'font-merriweather' },
            { id: 'font-playfair', label: 'Playfair', class: 'font-playfair' },
            { id: 'font-lora', label: 'Lora', class: 'font-lora' },
            { id: 'font-roboto-mono', label: 'Mono', class: 'font-roboto-mono' }
        ];

        const TEMPLATES = [
            { id: 'euro', name: 'Euro-Standard', desc: 'Structured & Detailed' },
            { id: 'ats', name: 'ATS-Friendly', desc: 'Clean, Single-Column Format' }
        ];

        // 2. UPDATED DUMMY INTERNATIONAL DATA (ISO Dates)
        const INITIAL_DATA = {
            cvType: 'experienced', // New field: 'experienced' or 'fresher'
            personal: {
                fullName: "JOHNATHAN DOE",
                title: "PROJECT MANAGER",
                email: "johndoe.professional@email.com",
                phone: "+1 555 123 4567",
                whatsapp: "+1 555 987 6543",
                alternativePhone: "+1 555 000 9999", 
                location: "New York City, NY, USA",
                postalAddress: "123 Business Avenue, Suite 400, Manhattan, NY 10001, USA",
                nationality: "American",
                passportNumber: "A12345678",
                passportExpiry: "2030-05-20",
                passportIssued: "2020-05-21",
                dob: "1990-08-15",
                placeOfBirth: "Chicago, Illinois",
                gender: "Male",
                maritalStatus: "Single",
                linkedin: "linkedin.com/in/johndoe",
                facebook: "facebook.com/johndoe",
                instagram: "instagram.com/johndoe",
                portfolio: "johndoe-portfolio.com",
                photo: null, 
                summary: "Results-oriented Project Manager with over 8 years of experience leading cross-functional teams in the tech sector. Proven track record of delivering complex software projects on time and under budget ($2M+). Expert in Agile methodologies, risk management, and stakeholder communication. Seeking to leverage leadership skills to drive innovation at a forward-thinking technology firm."
            },
            coverLetter: {
                companyName: "Global Tech Solutions",
                recipient: "Hiring Manager",
                jobDescription: "",
                content: "Dear Hiring Manager,\n\nI am writing to express my strong interest in the Project Manager position at Global Tech Solutions. With over 8 years of experience managing complex software development life cycles and leading diverse teams, I am confident in my ability to contribute effectively to your organization's goals.\n\nThroughout my career, I have successfully delivered multiple high-stakes projects, notably reducing delivery times by 15% through optimized Agile workflows. My background aligns perfectly with your need for a leader who can bridge the gap between technical teams and business stakeholders.\n\nThank you for considering my application. I look forward to the possibility of discussing how my skills and experience can benefit Global Tech Solutions.\n\nSincerely,\nJohnathan Doe"
            },
            experience: [
                { 
                    id: 1, 
                    role: "Senior Project Manager", 
                    company: "Tech Innovators Inc.", 
                    website: "https://techinnovators.com", 
                    location: "New York, USA",
                    start: "2019-01-01", 
                    end: "Present", 
                    description: "<ul><li>Lead a team of 15 developers and designers in the end-to-end delivery of enterprise SaaS products.</li><li>Managed a project portfolio valued at $3.5M annually.</li><li>Implemented Scrum methodologies, resulting in a 20% increase in team productivity.</li><li>Successfully negotiated vendor contracts, saving the company 10% on external resources.</li></ul>" 
                },
                { 
                    id: 2, 
                    role: "Project Coordinator", 
                    company: "Creative Solutions Ltd.", 
                    website: "https://creativesolutions.com", 
                    location: "Chicago, USA",
                    start: "2015-06-01", 
                    end: "2018-12-01", 
                    description: "<ul><li>Assisted senior managers in planning and executing marketing campaigns for Fortune 500 clients.</li><li>Coordinated project schedules, resources, and budgets.</li><li>Maintained client relationships and ensured all deliverables met quality standards and deadlines.</li></ul>" 
                }
            ],
            education: [
                { 
                    id: 1, 
                    degree: "MBA in Project Management", 
                    field: "Business Administration", 
                    school: "New York University", 
                    website: "https://nyu.edu", 
                    year: "2015-05-20", 
                    category: "Academic",
                    cgpa: "3.8/4.0", // New field for Fresher
                    coursework: "Strategic Management, Organizational Behavior" // New field for Fresher
                },
                { 
                    id: 2, 
                    degree: "PMP Certification", 
                    field: "Project Management", 
                    school: "Project Management Institute (PMI)", 
                    website: "", 
                    year: "2016-08-15", 
                    category: "Certification",
                    cgpa: "",
                    coursework: ""
                }
            ],
            skills: ["Project Management", "Agile & Scrum", "Risk Management", "Budgeting & Forecasting", "Team Leadership", "JIRA & Confluence", "Stakeholder Management", "Strategic Planning"],
            hobbies: ["Photography", "Traveling", "Chess", "Reading Tech Blogs"], // Added hobbies
            languages: [
                { id: 1, name: "English", read: "Native", write: "Native", speak: "Native" },
                { id: 2, name: "Spanish", read: "Fluent", write: "Fluent", speak: "Fluent" },
                { id: 3, name: "French", read: "Intermediate", write: "Intermediate", speak: "Intermediate" }
            ],
            theme: { color: "#2563eb", font: "font-inter" }
        };

        // 3. APP OBJECT
        const app = {
            data: JSON.parse(localStorage.getItem('cv_builder_data')) || INITIAL_DATA,
            activeTab: 'personal',
            template: 'euro',
            scale: 1,
            aiLoading: null,
            listening: false,
            listeningTarget: null,
            recognition: null,
            cropper: { img: null, zoom: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 },

            init() {
                // Ensure cvType exists for older saves
                if (!this.data.cvType) this.data.cvType = 'experienced';
                
                if (!TEMPLATES.find(t => t.id === this.template)) this.template = 'euro';
                this.renderTabs();
                this.renderEditor();
                this.renderPreview();
                setTimeout(() => this.autoFit(), 100);
                window.addEventListener('resize', () => this.autoFit());
                this.setupCropperEvents();
                this.initSpeech();
                if (window.lucide) {
                    lucide.createIcons();
                } else {
                    setTimeout(() => window.lucide && lucide.createIcons(), 1000);
                }
            },

            save() {
                localStorage.setItem('cv_builder_data', JSON.stringify(this.data));
                this.renderPreview();
                // Re-render tabs if CV type changes to show/hide Experience tab
                this.renderTabs();
            },

            // --- DATE HELPER ---
            formatDate(dateStr) {
                if (!dateStr) return '';
                if (dateStr === 'Present') return 'Present';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr; 
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            },

            toggleCurrent(section, id, isChecked) {
                const item = this.data[section].find(i => i.id === id);
                if (item) {
                    item.end = isChecked ? 'Present' : '';
                    this.save();
                    this.renderEditor(); 
                }
            },

            // --- DATE PICKER INIT ---
            initDatePickers() {
                flatpickr(".date-picker", {
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "F j, Y",
                    allowInput: true, 
                    disableMobile: "true" 
                });
            },

            // --- PAGE BREAK VISUALIZATION ---
            drawPageBreaks() {
                const container = document.getElementById('preview-container');
                // Remove existing markers
                const existing = container.querySelectorAll('.page-break-marker');
                existing.forEach(el => el.remove());

                const A4_HEIGHT_PX = 1123; 
                const totalHeight = container.scrollHeight;
                
                if (totalHeight <= A4_HEIGHT_PX) return;

                const pages = Math.ceil(totalHeight / A4_HEIGHT_PX);

                for (let i = 1; i < pages; i++) {
                    const top = i * A4_HEIGHT_PX;
                    const marker = document.createElement('div');
                    marker.className = 'page-break-marker';
                    marker.style.top = `${top}px`;
                    marker.innerHTML = `<div class="page-break-label">End of Page ${i}</div>`;
                    container.appendChild(marker);
                }
            },

            // --- DOWNLOAD PDF FUNCTION (VIA NATIVE PRINT) ---
            downloadPDF() {
                // Show tip
                const tip = document.getElementById('print-tip');
                tip.classList.remove('hidden');
                
                // Trigger print after a brief delay
                setTimeout(() => {
                    window.print();
                }, 500);
            },

            // --- AI LOGIC ---
            async callGemini(prompt, systemPrompt) {
                if (!apiKey) {
                    alert("API Key is missing. Please add your API key in the source code or use the demo version.");
                    return "";
                }
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                        });
                        if (!response.ok) throw new Error('API Rate Limit');
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    } catch (error) { if (i === 4) throw error; await new Promise(r => setTimeout(r, delay)); delay *= 2; }
                }
            },

            async aiAssist(type, id) {
                const loadingKey = id ? `${type}-${id}` : type;
                this.aiLoading = loadingKey; 
                this.renderEditor();
                try {
                    let prompt = ""; let system = "You are a professional CV writer. Improve text to be impact-driven. Return text only.";
                    
                    if (type === 'summary') {
                        prompt = `Improve CV summary: ${this.data.personal.summary}`;
                        system = "You are a professional CV writer. Write a compelling, professional summary in a single paragraph.";
                    }
                    else if (type === 'exp') {
                        prompt = `Rewrite these job responsibilities into concise, impact-driven bullet points using HTML <ul> and <li> tags. Content: ${this.data.experience.find(i => i.id === id).description}`;
                        system = "You are a professional CV writer. Return ONLY HTML list items (<ul><li>...</li></ul>). Do not use Markdown.";
                    }
                    else if (type === 'skills') {
                         prompt = `Suggest 10 comma-separated technical and soft skills for a ${this.data.personal.title}. Output format: Skill1, Skill2, Skill3`;
                         system = "Output ONLY a comma-separated list of skills.";
                    }
                    
                    const result = await this.callGemini(prompt, system);
                    if (result) {
                        if (type === 'summary') this.update('personal.summary', result.trim());
                        else if (type === 'skills') this.updateSkills(result.trim());
                        else this.updateArray('experience', id, 'description', result.trim());
                    }
                } catch (e) { console.error(e); alert("AI Service Busy or Error."); } finally { this.aiLoading = null; this.renderEditor(); }
            },

            async generateCoverLetter() {
                this.aiLoading = 'cover-letter'; this.renderEditor();
                try {
                    const cl = this.data.coverLetter; const p = this.data.personal;
                    const prompt = `Write a tailored cover letter for ${p.fullName} applying to ${cl.companyName} as a ${p.title}. 
                        Summary: ${p.summary}. Skills: ${this.data.skills.join(',')}. Description: ${cl.jobDescription}.`;
                    const result = await this.callGemini(prompt, "Write professional cover letter content only. Use standard paragraph formatting.");
                    if (result) this.update('coverLetter.content', result.trim());
                } catch (e) { alert("AI Generation failed."); } finally { this.aiLoading = null; this.renderEditor(); }
            },
            
            // --- SPEECH RECOGNITION ---
            initSpeech() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if (this.listeningTarget) {
                           const currentVal = this.listeningTarget.type === 'summary' ? this.data.personal.summary : this.data.experience.find(i=>i.id===this.listeningTarget.id).description;
                           const newVal = (currentVal ? currentVal + " " : "") + transcript;
                           
                           if (this.listeningTarget.type === 'summary') this.update('personal.summary', newVal);
                           else this.updateArray('experience', this.listeningTarget.id, 'description', newVal);
                        }
                        this.stopListening();
                    };
                    this.recognition.onerror = () => this.stopListening();
                    this.recognition.onend = () => this.stopListening();
                }
            },
            
            startListening(type, id) {
                if (!this.recognition) return alert("Browser not supported");
                this.listening = true;
                this.listeningTarget = { type, id };
                this.renderEditor(); 
                this.recognition.start();
            },
            
            stopListening() {
                this.listening = false;
                this.listeningTarget = null;
                this.renderEditor();
            },

            // --- UI RENDERERS ---
            setTab(id) { this.activeTab = id; this.renderTabs(); this.renderEditor(); this.renderPreview(); },
            setTemplate(id) { this.template = id; this.renderEditor(); this.renderPreview(); },
            setColor(c) { this.data.theme.color = c; this.save(); this.renderEditor(); this.renderPreview(); },
            setFont(f) { this.data.theme.font = f; this.save(); this.renderEditor(); this.renderPreview(); },
            setCvType(type) {
                this.data.cvType = type;
                this.save(); // This triggers renderTabs and renderPreview
                this.renderEditor();
            },

            renderTabs() {
                let tabs = [
                    {id:'personal',label:'Info',icon:'user'},
                    {id:'experience',label:'Work',icon:'briefcase'},
                    {id:'education',label:'Edu',icon:'graduation-cap'},
                    {id:'skills',label:'Skills',icon:'wrench'},
                    {id:'design',label:'Style',icon:'palette'},
                    {id:'cover_letter',label:'Letter',icon:'file-text'}
                ];
                
                // HIDE Work Tab if Fresher
                if (this.data.cvType === 'fresher') {
                    tabs = tabs.filter(t => t.id !== 'experience');
                }

                document.getElementById('tabs-container').innerHTML = tabs.map(t => `
                    <button onclick="app.setTab('${t.id}')" class="w-full flex flex-col items-center justify-center p-3 rounded-xl transition-all duration-200 group ${this.activeTab === t.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}">
                        <i data-lucide="${t.icon}" width="20" height="20"></i>
                        <span class="text-[10px] font-medium tracking-wide mt-1">${t.label}</span>
                    </button>`).join('');
                if (window.lucide) lucide.createIcons();
            },

            // --- HELPER FUNCTIONS ---
            jobSelect(label, value, path, isExp = false, id = null) {
                const onchange = isExp ? `app.updateArray('experience', ${id}, 'role', this.value)` : `app.update('${path}', this.value)`;
                return `
                <div class="space-y-1">
                    <div class="flex justify-between items-center">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">${label}</label>
                         <button onclick="
                            const inputContainer = this.parentElement.nextElementSibling;
                            const isSelect = inputContainer.querySelector('select');
                            if(isSelect) {
                                inputContainer.innerHTML = &quot;<input type='text' value='${value}' onchange=\\&quot;${onchange}\\&quot; class='input-creative w-full p-2.5 rounded-lg text-sm bg-white shadow-sm' placeholder='Type Custom Title...'>&quot;;
                                this.innerHTML = '<i data-lucide=\\'list\\' width=\\'10\\'></i> Pick List';
                            } else {
                                app.renderEditor(); // Reset to default view (select)
                            }
                            if(window.lucide) lucide.createIcons();
                         " class="text-[10px] text-blue-500 hover:text-blue-700 flex items-center gap-1">
                            <i data-lucide="edit-3" width="10"></i> Type Custom
                         </button>
                    </div>
                    <div>
                        <select onchange="${onchange}" class="input-creative w-full p-2.5 rounded-lg text-sm bg-white cursor-pointer shadow-sm">
                            <option value="">-- Select Job Position --</option>
                            ${value ? `<option value="${value}" selected>${value} (Current)</option>` : ''}
                            ${Object.entries(JOB_DB).map(([sector, titles]) => `
                                <optgroup label="${sector}">
                                    ${titles.map(t => `<option value="${t}" ${t === value ? 'selected' : ''}>${t}</option>`).join('')}
                                </optgroup>`).join('')}
                    </select>
                    </div>
                </div>`;
            },
            
            input(label, value, path, type = 'text', extraClass = '') {
                return `<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">${label}</label><input type="${type}" value="${value || ''}" oninput="app.update('${path}', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm ${extraClass}"></div>`;
            },
            textarea(label, value, path) {
                return `<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">${label}</label><textarea oninput="app.update('${path}', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm resize-none" rows="2">${value || ''}</textarea></div>`;
            },
            
            // --- RICH TEXT EDITOR RENDERER ---
            renderRichEditor(label, value, onInputCode) {
                // Paste handler to strip formatting and insert clean text
                const pasteHandler = "event.preventDefault(); const text = (event.clipboardData || window.clipboardData).getData('text'); document.execCommand('insertText', false, text);";
                
                return `
                <div class="group">
                    ${label ? `<label class="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">${label}</label>` : ''}
                    <div class="rich-editor focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all">
                        <div class="rich-toolbar flex items-center">
                            <button class="rich-btn" onclick="document.execCommand('bold',false,null); event.preventDefault();" title="Bold"><i data-lucide="bold" width="14"></i></button>
                            <button class="rich-btn" onclick="document.execCommand('italic',false,null); event.preventDefault();" title="Italic"><i data-lucide="italic" width="14"></i></button>
                            <button class="rich-btn" onclick="document.execCommand('underline',false,null); event.preventDefault();" title="Underline"><i data-lucide="underline" width="14"></i></button>
                            <div class="w-px h-4 bg-slate-300 mx-1 self-center"></div>
                            <button class="rich-btn" onclick="document.execCommand('insertUnorderedList',false,null); event.preventDefault();" title="Bullet List"><i data-lucide="list" width="14"></i></button>
                        </div>
                        <div class="rich-content" contenteditable="true" oninput="${onInputCode}" onpaste="${pasteHandler}">${value || ''}</div>
                    </div>
                </div>`;
            },

            select(label, value, path, options) {
                return `<div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide">${label}</label><select onchange="app.update('${path}', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm bg-white cursor-pointer"><option value="">Select...</option>${options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select></div>`;
            },
            levelSelect(id, field, value, icon) {
                const levels = ["Beginner", "Intermediate", "Advanced", "Fluent", "Native"];
                return `<div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 flex items-center gap-1 uppercase tracking-wide"><i data-lucide="${icon}" width="10"></i> ${field}</label><select onchange="app.updateArray('languages', ${id}, '${field}', this.value)" class="w-full p-1.5 border border-slate-200 rounded-lg text-xs bg-slate-50 hover:bg-white cursor-pointer focus:ring-2 focus:ring-blue-100 outline-none">${levels.map(l => `<option value="${l}" ${value === l ? 'selected' : ''}>${l}</option>`).join('')}</select></div>`;
            },

            // --- STATE UPDATERS ---
            update(path, value) {
                const keys = path.split('.');
                let obj = this.data;
                for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
                obj[keys[keys.length - 1]] = value;
                this.save();
            },

            updateArray(section, id, field, value) {
                const item = this.data[section].find(i => i.id === id);
                if (item) { item[field] = value; this.save(); }
            },

            addItem(section) {
                const item = { id: Date.now(), role: "Role", company: "Company", website: "", location: "", start: "", end: "", description: "" };
                if (section === 'education') {
                    item.school = "School"; 
                    item.degree = "Degree";
                    item.website = "";
                    item.category = "Academic";
                    item.cgpa = "";
                    item.coursework = "";
                }
                this.data[section].push(item);
                this.renderEditor();
                this.save();
            },

            removeItem(section, id) {
                this.data[section] = this.data[section].filter(i => i.id !== id);
                this.renderEditor();
                this.save();
            },

            updateSkills(value) {
                this.data.skills = value.split(',').map(s => s.trim());
                this.save();
            },
            
            updateHobbies(value) {
                this.data.hobbies = value.split(',').map(s => s.trim());
                this.save();
            },

            // --- SCALE & PREVIEW ---
            adjustScale(delta) { this.scale = Math.max(0.3, Math.min(1.5, this.scale + delta)); this.applyScale(); },
            autoFit() { const wrapper = document.getElementById('preview-wrapper'); const availWidth = wrapper.clientWidth - 80; this.scale = Math.min(1, availWidth / 794); this.applyScale(); },
            applyScale() { const container = document.getElementById('preview-container'); container.style.transform = `scale(${this.scale})`; document.getElementById('zoom-level').innerText = `${Math.round(this.scale * 100)}%`; },

            // --- RENDER EDITOR ---
            renderEditor() {
                const container = document.getElementById('editor-content');
                const p = this.data.personal;
                let html = '';

                if (this.activeTab === 'personal') {
                    html = `
                    <div class="space-y-6 animate-in fade-in slide-in-from-left-4">
                        <!-- MODE TOGGLE -->
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center justify-between">
                            <span class="text-xs font-bold text-blue-800 uppercase tracking-wide">CV Type</span>
                            <div class="flex bg-white rounded-lg p-1 border border-blue-100 shadow-sm">
                                <button onclick="app.setCvType('experienced')" class="px-3 py-1 rounded-md text-[10px] font-bold transition-all ${this.data.cvType === 'experienced' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-600'}">Experienced</button>
                                <button onclick="app.setCvType('fresher')" class="px-3 py-1 rounded-md text-[10px] font-bold transition-all ${this.data.cvType === 'fresher' ? 'bg-green-500 text-white shadow' : 'text-slate-400 hover:text-slate-600'}">Fresher</button>
                            </div>
                        </div>

                        <div class="flex items-center gap-5 p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <!-- Photo Indicator (Image hidden in editor, shown only on template) -->
                            <div class="w-20 h-20 rounded-full bg-white border-2 border-white shadow-md overflow-hidden shrink-0 flex items-center justify-center">
                                ${p.photo ? 
                                    `<div class="text-center animate-in zoom-in">
                                        <i data-lucide="image" class="text-blue-500 mx-auto mb-1" width="24"></i>
                                        <span class="text-[8px] font-bold text-blue-600 uppercase tracking-wide block">Saved</span>
                                    </div>` : 
                                    `<div class="text-slate-300"><i data-lucide="user" width="32"></i></div>`
                                }
                            </div>
                            <div>
                                <label class="cursor-pointer bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-slate-50 shadow-sm transition-colors mb-1">
                                    <i data-lucide="camera" width="14"></i> ${p.photo ? 'Change Photo' : 'Upload Photo'}
                                    <input type="file" accept="image/*" class="hidden" onchange="app.handleImageUpload(this)">
                                </label>
                                ${p.photo ? `<button onclick="app.update('personal.photo', null)" class="text-[10px] text-red-400 hover:text-red-600 font-medium flex items-center gap-1"><i data-lucide="trash-2" width="10"></i> Remove</button>` : ''}
                            </div>
                        </div>
                        ${this.input('Full Name', p.fullName, 'personal.fullName')}
                        ${this.jobSelect('Job Title', p.title, 'personal.title')}
                        <div class="grid grid-cols-2 gap-4">${this.input('Email', p.email, 'personal.email')}${this.input('Phone', p.phone, 'personal.phone')}</div>
                        <div class="grid grid-cols-2 gap-4">${this.input('WhatsApp', p.whatsapp, 'personal.whatsapp')}${this.input('Alt Contact', p.alternativePhone, 'personal.alternativePhone')}</div>
                        <div class="grid grid-cols-1 gap-4">${this.input('Location', p.location, 'personal.location')}</div>
                        ${this.textarea('Postal Address', p.postalAddress, 'personal.postalAddress')}
                        
                        <div class="grid grid-cols-3 gap-4">
                            ${this.input('LinkedIn', p.linkedin, 'personal.linkedin')}
                            ${this.input('Facebook', p.facebook, 'personal.facebook')}
                            ${this.input('Instagram', p.instagram, 'personal.instagram')}
                        </div>

                        <div class="grid grid-cols-2 gap-4">${this.input('DOB', p.dob, 'personal.dob', 'text', 'date-picker')}${this.input('Nationality', p.nationality, 'personal.nationality')}</div>
                        <div class="grid grid-cols-2 gap-4">${this.input('Passport No', p.passportNumber, 'personal.passportNumber')}${this.input('Portfolio', p.portfolio, 'personal.portfolio')}</div>
                        <div class="grid grid-cols-2 gap-4">${this.select('Gender', p.gender, 'personal.gender', GENDER_OPTS)}${this.select('Marital Status', p.maritalStatus, 'personal.maritalStatus', MARITAL_OPTS)}</div>
                        
                        <div class="pt-4 border-t border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Professional Summary</label>
                                <div class="flex gap-2">
                                     <button onclick="app.startListening('summary')" class="text-[10px] text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors px-2 py-1 rounded bg-slate-50 hover:bg-slate-100 ${this.listening && this.listeningTarget?.type === 'summary' ? 'mic-listening' : ''}"><i data-lucide="mic" width="12"></i> Dictate</button>
                                     <button onclick="app.aiAssist('summary')" class="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded font-bold flex items-center gap-1 hover:bg-purple-100 transition-colors ${this.aiLoading === 'summary' ? 'ai-glow' : ''}" ${this.aiLoading === 'summary' ? 'disabled' : ''}>
                                        ${this.aiLoading === 'summary' ? '<i data-lucide="loader" class="animate-spin" width="10"></i>' : '<i data-lucide="sparkles" width="10"></i> AI Improve'}
                                     </button>
                                </div>
                            </div>
                            <!-- RICH TEXT EDITOR FOR SUMMARY (No duplicate label) -->
                            ${this.renderRichEditor('', p.summary, "app.update('personal.summary', this.innerHTML)")}
                        </div>
                    </div>`;
                } else if (this.activeTab === 'experience') {
                    html = `<div class="flex justify-between items-center mb-6"><h2 class="text-sm font-bold text-slate-700 uppercase">Work History</h2><button onclick="app.addItem('experience')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow-md hover:bg-blue-700 transition-all">Add</button></div>
                        <div class="space-y-6">${this.data.experience.map(exp => {
                            const isCurrent = exp.end === 'Present';
                            return `
                        <div class="bg-white p-5 rounded-xl border border-slate-200 relative shadow-sm">
                            <button onclick="app.removeItem('experience', ${exp.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" width="16"></i></button>
                            <div class="space-y-3">
                                <div class="grid grid-cols-1 gap-4 pr-8">
                                    ${this.jobSelect('Role / Position', exp.role, '', true, exp.id)}
                                    <div class="grid grid-cols-2 gap-4">
                                        <input value="${exp.company}" oninput="app.updateArray('experience', ${exp.id}, 'company', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm" placeholder="Company Name">
                                        <input value="${exp.website || ''}" oninput="app.updateArray('experience', ${exp.id}, 'website', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm" placeholder="Website (Optional)">
                                    </div>
                                    <input value="${exp.location || ''}" oninput="app.updateArray('experience', ${exp.id}, 'location', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm" placeholder="Location / Country">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                                        <input type="text" value="${exp.start}" oninput="app.updateArray('experience', ${exp.id}, 'start', this.value)" class="input-creative date-picker p-2.5 rounded-lg text-sm w-full" placeholder="Select Date">
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-xs font-bold text-slate-500 uppercase">End Date</label>
                                            <label class="flex items-center gap-1 cursor-pointer">
                                                <input type="checkbox" ${isCurrent ? 'checked' : ''} onchange="app.toggleCurrent('experience', ${exp.id}, this.checked)" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500">
                                                <span class="text-[10px] font-bold text-blue-600">Current</span>
                                            </label>
                                        </div>
                                        <input type="text" value="${isCurrent ? '' : exp.end}" ${isCurrent ? 'disabled' : ''} oninput="app.updateArray('experience', ${exp.id}, 'end', this.value)" class="input-creative ${!isCurrent ? 'date-picker' : ''} p-2.5 rounded-lg text-sm w-full ${isCurrent ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : ''}" placeholder="${isCurrent ? 'Present' : 'Select Date'}">
                                    </div>
                                </div>
                                <div class="relative pt-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Responsibilities</label>
                                        <div class="flex gap-2">
                                            <button onclick="app.startListening('exp', ${exp.id})" class="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded text-[10px] font-bold text-slate-400 hover:text-red-500 hover:bg-slate-100 transition-colors ${this.listening && this.listeningTarget?.id === exp.id ? 'mic-listening' : ''}">
                                                <i data-lucide="mic" width="12"></i> Dictate
                                            </button>
                                            <button onclick="app.aiAssist('exp', ${exp.id})" class="flex items-center gap-1 bg-purple-50 px-2 py-1 rounded text-[10px] font-bold text-purple-600 hover:bg-purple-100 transition-colors ${this.aiLoading === `exp-${exp.id}` ? 'ai-glow' : ''}" ${this.aiLoading === `exp-${exp.id}` ? 'disabled' : ''}>
                                                ${this.aiLoading === `exp-${exp.id}` ? '<i data-lucide="loader" class="animate-spin" width="12"></i>' : '<i data-lucide="sparkles" width="12"></i> AI Improve'}
                                            </button>
                                        </div>
                                    </div>
                                    <!-- RICH TEXT EDITOR FOR RESPONSIBILITIES -->
                                    ${this.renderRichEditor('Description', exp.description, `app.updateArray('experience', ${exp.id}, 'description', this.innerHTML)`)}
                                </div>
                            </div>
                        </div>`}).join('')}</div>`;
                } else if (this.activeTab === 'education') {
                    const isFresher = this.data.cvType === 'fresher';
                    html = `<div class="flex justify-between items-center mb-6"><h2 class="text-sm font-bold text-slate-700 uppercase">Education</h2><button onclick="app.addItem('education')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow-md hover:bg-blue-700 transition-all">Add</button></div>
                        <div class="space-y-4">${this.data.education.map(edu => `
                        <div class="bg-white p-5 rounded-xl border border-slate-200 relative shadow-sm">
                            <button onclick="app.removeItem('education', ${edu.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" width="16"></i></button>
                            <div class="space-y-3 pr-8">
                                <select onchange="app.updateArray('education', ${edu.id}, 'category', this.value)" class="input-creative w-full p-2 rounded-lg text-sm mb-2">${EDU_CATEGORIES.map(c => `<option value="${c}" ${edu.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                                <div class="grid grid-cols-2 gap-4">
                                    <input value="${edu.school}" oninput="app.updateArray('education', ${edu.id}, 'school', this.value)" class="input-creative w-full p-2.5 rounded-lg font-bold text-sm" placeholder="School">
                                    <input value="${edu.website || ''}" oninput="app.updateArray('education', ${edu.id}, 'website', this.value)" class="input-creative w-full p-2.5 rounded-lg text-sm" placeholder="Website (Optional)">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <input value="${edu.degree}" oninput="app.updateArray('education', ${edu.id}, 'degree', this.value)" class="input-creative w-full p-2 rounded-lg text-sm" placeholder="Major">
                                    <div>
                                        <input type="text" value="${edu.year}" oninput="app.updateArray('education', ${edu.id}, 'year', this.value)" class="input-creative date-picker w-full p-2.5 rounded-lg text-sm" placeholder="Select Date">
                                    </div>
                                </div>
                                ${isFresher ? `
                                <div class="grid grid-cols-1 gap-4 pt-2 border-t border-slate-100 animate-in fade-in">
                                    <div class="flex gap-4">
                                        <div class="w-1/3">
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">CGPA / Grade</label>
                                            <input value="${edu.cgpa || ''}" oninput="app.updateArray('education', ${edu.id}, 'cgpa', this.value)" class="input-creative w-full p-2 rounded-lg text-sm" placeholder="e.g. 3.8/4.0">
                                        </div>
                                        <div class="w-2/3">
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Relevant Coursework / Projects</label>
                                            <input value="${edu.coursework || ''}" oninput="app.updateArray('education', ${edu.id}, 'coursework', this.value)" class="input-creative w-full p-2 rounded-lg text-sm" placeholder="e.g. Data Structures, Marketing 101">
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>`).join('')}</div>`;
                } else if (this.activeTab === 'skills') {
                    html = `<div class="space-y-8 animate-in fade-in slide-in-from-left-4 duration-300">
                        <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="code" width="16"></i> Technical Skills</h2>
                                <button onclick="app.aiAssist('skills')" class="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded font-bold hover:bg-purple-100 transition-colors ${this.aiLoading === 'skills' ? 'ai-glow' : ''}" ${this.aiLoading === 'skills' ? 'disabled' : ''}>${this.aiLoading === 'skills' ? 'Loading...' : 'Suggest Skills'}</button>
                            </div>
                            <textarea oninput="app.updateSkills(this.value)" rows="4" class="input-creative w-full p-3 rounded-lg text-sm" placeholder="Comma separated list...">${this.data.skills.join(', ')}</textarea>
                            <div class="flex flex-wrap gap-2 mt-4">${this.data.skills.filter(s=>s).map(s => `<span class="bg-white border border-slate-200 text-slate-600 px-3 py-1 rounded-full text-xs font-medium shadow-sm">${s}</span>`).join('')}</div>
                        </div>

                         <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="smile" width="16"></i> Hobbies & Interests</h2>
                            </div>
                            <textarea oninput="app.updateHobbies(this.value)" rows="3" class="input-creative w-full p-3 rounded-lg text-sm" placeholder="Reading, Traveling...">${(this.data.hobbies || []).join(', ')}</textarea>
                            <div class="flex flex-wrap gap-2 mt-4">${(this.data.hobbies || []).filter(s=>s).map(s => `<span class="bg-white border border-slate-200 text-slate-600 px-3 py-1 rounded-full text-xs font-medium shadow-sm">${s}</span>`).join('')}</div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><h2 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="globe" width="16"></i> Languages</h2><button onclick="app.addItem('languages')" class="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold flex items-center gap-1 transition-colors"><i data-lucide="plus" width="14"></i> Add</button></div>
                            <div class="space-y-3">${(this.data.languages || []).map(l => `<div class="bg-white p-4 rounded-xl border border-slate-200 relative group shadow-sm hover:border-blue-300 transition-colors"><button onclick="app.removeItem('languages', ${l.id})" class="absolute top-3 right-3 text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" width="14"></i></button><div class="mb-3 pr-8"><input value="${l.name}" oninput="app.updateArray('languages', ${l.id}, 'name', this.value)" class="input-creative w-full p-2 rounded-lg text-sm font-bold" placeholder="Language Name"></div><div class="grid grid-cols-3 gap-2">${this.levelSelect(l.id, 'read', l.read, 'book-open')}${this.levelSelect(l.id, 'write', l.write, 'pen-tool')}${this.levelSelect(l.id, 'speak', l.speak, 'mic')}</div></div>`).join('')}</div>
                        </div>
                    </div>`;
                } else if (this.activeTab === 'cover_letter') {
                    const cl = this.data.coverLetter;
                    html = `<div class="space-y-6"><div class="bg-purple-50 p-5 rounded-xl border border-purple-100"><h2 class="text-sm font-bold text-purple-900 mb-4 flex items-center gap-2"><i data-lucide="sparkles" width="16"></i> AI Assistant</h2><div class="space-y-3">${this.input('Company', cl.companyName, 'coverLetter.companyName')}${this.input('Recipient', cl.recipient, 'coverLetter.recipient')}<textarea oninput="app.update('coverLetter.jobDescription', this.value)" rows="3" class="input-creative w-full p-3 rounded-lg text-sm" placeholder="Paste Job Description...">${cl.jobDescription || ''}</textarea><button onclick="app.generateCoverLetter()" class="w-full py-3 bg-purple-600 text-white rounded-xl text-sm font-bold hover:bg-purple-700 shadow-lg disabled:opacity-50 ${this.aiLoading === 'cover-letter' ? 'ai-glow' : ''}" ${this.aiLoading === 'cover-letter' ? 'disabled' : ''}>${this.aiLoading === 'cover-letter' ? 'Generating...' : 'AI Generate Letter'}</button></div></div><textarea oninput="app.update('coverLetter.content', this.value)" rows="12" class="input-creative w-full p-4 rounded-xl text-sm leading-relaxed">${cl.content}</textarea></div>`;
                } else if (this.activeTab === 'design') {
                    html = `<div class="space-y-8"><div><h2 class="text-sm font-bold text-slate-700 mb-4 uppercase">Fonts</h2><div class="grid grid-cols-2 gap-2 bg-slate-50 p-3 rounded-xl">${FONT_OPTIONS.map(f => `<button onclick="app.setFont('${f.class}')" class="p-2 border rounded-lg text-xs font-medium truncate ${this.data.theme.font === f.class ? 'border-blue-600 bg-white ring-1 ring-blue-600 shadow-sm' : 'bg-white border-slate-200 hover:border-slate-300'}">${f.label}</button>`).join('')}</div></div><div><h2 class="text-sm font-bold text-slate-700 mb-4 uppercase">Templates</h2><div class="grid grid-cols-2 gap-3">${TEMPLATES.map(t => `<button onclick="app.setTemplate('${t.id}')" class="p-4 border-2 rounded-xl text-left transition-all ${this.template === t.id ? 'border-blue-600 bg-blue-50 ring-1 ring-blue-600 shadow-md' : 'border-slate-100 bg-white hover:border-slate-300'}"><span class="font-bold text-sm block">${t.name}</span><span class="text-[10px] text-slate-400 mt-1 block">${t.desc}</span></button>`).join('')}</div></div><div><h2 class="text-sm font-bold text-slate-700 mb-4 uppercase">Color</h2><div class="flex flex-wrap gap-3 p-4 bg-white rounded-xl border border-slate-100 shadow-sm">${['#2563eb', '#059669', '#dc2626', '#d97706', '#7c3aed', '#db2777', '#111827'].map(c => `<button onclick="app.setColor('${c}')" class="w-10 h-10 rounded-full border-4 shadow-sm ${this.data.theme.color === c ? 'border-slate-300 scale-110' : 'border-transparent'}" style="background-color: ${c}"></button>`).join('')}</div></div></div>`;
                }

                container.innerHTML = html;
                if (window.lucide) lucide.createIcons();
                this.initDatePickers(); // Initialize Flatpickr after DOM update
                this.drawPageBreaks(); // Draw page markers
            },

            // --- RENDER PREVIEW (Fixed A4 & Sidebar) ---
            renderPreview() {
                const container = document.getElementById('preview-container');
                const p = this.data.personal;
                const theme = this.data.theme.color;
                const fontClass = this.data.theme.font || 'font-inter';
                const isFresher = this.data.cvType === 'fresher';
                
                container.className = `a4-page transition-transform duration-200 origin-top ${fontClass} text-slate-800`;

                if (this.activeTab === 'cover_letter') {
                    container.innerHTML = `
                    <div class="px-12 py-12 h-full flex flex-col font-sans">
                        <div class="border-b-2 pb-6 mb-8" style="border-color:${theme}">
                            <h1 class="text-5xl font-bold uppercase tracking-tight text-gray-900" style="color:${theme}">${p.fullName}</h1>
                            <p class="text-xl text-gray-600 font-medium mt-2">${p.title}</p>
                            <div class="flex flex-wrap gap-6 text-sm text-gray-500 mt-4">
                                <span class="flex items-center gap-2"><i data-lucide="mail" width="14"></i> ${p.email}</span>
                                <span class="flex items-center gap-2"><i data-lucide="phone" width="14"></i> ${p.phone}</span>
                                ${p.location ? `<span class="flex items-center gap-2"><i data-lucide="map-pin" width="14"></i> ${p.location}</span>` : ''}
                            </div>
                        </div>
                        <div class="mb-8 font-bold">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        <div class="mb-6 text-gray-900">
                            <p class="font-bold">${this.data.coverLetter.recipient}</p>
                            <p class="font-medium text-gray-600">${this.data.coverLetter.companyName}</p>
                        </div>
                        <div class="whitespace-pre-wrap text-justify leading-loose flex-1 text-base text-gray-700">${this.data.coverLetter.content}</div>
                    </div>`;
                    if(window.lucide) lucide.createIcons(); return;
                }

                let html = '';
                const formatList = (items) => items.map(s => `<span class="border border-slate-200 px-2 py-0.5 rounded-md text-[10px] bg-slate-50">${s}</span>`).join('');

                if (this.template === 'euro') {
                    // Update: COMPACT LAYOUT (Reduced padding/margins everywhere)
                    html = `
                    <div class="grid grid-cols-12 flex-1 min-h-[297mm] text-slate-800 relative" style="background: linear-gradient(to right, #f8fafc 33.333333%, #ffffff 33.333333%);">
                        <!-- SIDEBAR: Padding adjusted to px-5 py-5 for better fit -->
                        <div class="col-span-4 px-5 py-5 border-r border-slate-200 text-[10px] flex flex-col leading-tight">
                            ${p.photo ? 
                                `<div class="flex justify-center mb-4"><img src="${p.photo}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-md"></div>` : 
                                `<div class="flex justify-center mb-4"><div class="w-24 h-24 rounded-full bg-slate-200 border-4 border-white shadow-md flex items-center justify-center text-slate-400"><i data-lucide="user" width="36" height="36"></i></div></div>`
                            }
                            <h1 class="text-lg font-bold uppercase mb-1 leading-tight text-center break-words" style="color:${theme}">${p.fullName}</h1>
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-wider text-center">${p.title}</p>
                            
                            <div class="space-y-4">
                                <!-- Contact -->
                                <div class="space-y-1.5">
                                    <h3 class="font-bold uppercase border-b border-slate-300 pb-0.5 mb-1.5 text-[10px]" style="color:${theme}">Contact</h3>
                                    <p class="flex items-center gap-2"><i data-lucide="phone" width="10" style="color:${theme}"></i> ${p.phone}</p>
                                    ${p.whatsapp ? `<p class="flex items-center gap-2"><i data-lucide="message-circle" width="10" style="color:${theme}"></i> ${p.whatsapp}</p>` : ''}
                                    ${p.alternativePhone ? `<p class="flex items-center gap-2"><i data-lucide="phone-call" width="10" style="color:${theme}"></i> ${p.alternativePhone}</p>` : ''}
                                    <p class="flex items-center gap-2 break-all"><i data-lucide="mail" width="10" style="color:${theme}"></i> ${p.email}</p>
                                    <p class="flex items-center gap-2"><i data-lucide="map-pin" width="10" style="color:${theme}"></i> ${p.location}</p>
                                </div>

                                <!-- Socials -->
                                <div class="space-y-1.5">
                                    <h3 class="font-bold uppercase border-b border-slate-300 pb-0.5 mb-1.5 text-[10px]" style="color:${theme}">Socials</h3>
                                    ${p.linkedin ? `<a href="${p.linkedin}" target="_blank" class="flex items-center gap-2 hover:underline"><i data-lucide="linkedin" width="10" style="color:${theme}"></i> LinkedIn</a>` : ''}
                                    ${p.facebook ? `<a href="${p.facebook}" target="_blank" class="flex items-center gap-2 hover:underline"><i data-lucide="facebook" width="10" style="color:${theme}"></i> Facebook</a>` : ''}
                                    ${p.instagram ? `<a href="${p.instagram}" target="_blank" class="flex items-center gap-2 hover:underline"><i data-lucide="instagram" width="10" style="color:${theme}"></i> Instagram</a>` : ''}
                                </div>

                                <!-- Languages -->
                                <div>
                                    <h3 class="font-bold uppercase mb-1.5 border-b border-slate-300 pb-0.5 text-[10px]" style="color:${theme}">Languages</h3>
                                    ${(this.data.languages || []).map(l => `<div class="mb-1 flex justify-between items-center"><strong>${l.name}</strong><span class="opacity-70 text-[9px] bg-slate-200 px-1.5 py-0 rounded">${l.speak}</span></div>`).join('')}
                                </div>

                                <!-- Hobbies -->
                                <div>
                                    <h3 class="font-bold uppercase mb-1.5 border-b border-slate-300 pb-0.5 text-[10px]" style="color:${theme}">Hobbies</h3>
                                    <div class="flex flex-wrap gap-1">${(this.data.hobbies || []).map(s => `<span class="bg-white border border-slate-300 px-1.5 py-0.5 rounded shadow-sm text-[9px]">${s}</span>`).join('')}</div>
                                </div>

                                <!-- Personal Details -->
                                <div class="pt-4 border-t border-slate-200">
                                    <h3 class="font-bold uppercase mb-2 text-slate-400 tracking-wider text-[9px]">Personal Details</h3>
                                    <div class="space-y-1 text-[9px] text-slate-600">
                                        <div class="flex justify-between items-center"><span class="font-bold text-slate-700">Passport:</span> <span>${p.passportNumber || '-'}</span></div>
                                        <div class="flex justify-between items-center"><span class="font-bold text-slate-700">DOB:</span> <span>${p.dob || '-'}</span></div>
                                        <div class="flex justify-between items-center"><span class="font-bold text-slate-700">Nationality:</span> <span>${p.nationality || '-'}</span></div>
                                        <div class="flex justify-between items-center"><span class="font-bold text-slate-700">Gender:</span> <span>${p.gender || '-'}</span></div>
                                        <div class="flex justify-between items-center"><span class="font-bold text-slate-700">Marital:</span> <span>${p.maritalStatus || '-'}</span></div>
                                        <div class="flex justify-between items-center"><span class="font-bold text-slate-700">POB:</span> <span>${p.placeOfBirth || '-'}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- MAIN CONTENT: Padding adjusted to px-6 py-5 -->
                        <div class="col-span-8 px-6 py-5 flex flex-col">
                            <!-- About Me -->
                            <div class="mb-4">
                                <h3 class="font-bold text-xs text-slate-900 uppercase border-b-2 border-slate-300 pb-0.5 mb-2 flex items-center gap-2" style="color:${theme}"><i data-lucide="user" width="12"></i> About Me</h3>
                                <div class="text-[10px] text-justify leading-tight rich-content">${p.summary}</div>
                            </div>

                            <!-- Experience: HIDDEN if Fresher -->
                            ${!isFresher ? `
                            <div class="mb-3">
                                <h3 class="font-bold text-xs text-slate-900 uppercase border-b-2 border-slate-300 pb-0.5 mb-2 flex items-center gap-2" style="color:${theme}"><i data-lucide="briefcase" width="12"></i> Experience</h3>
                                ${this.data.experience.map(e => `
                                    <div class="mb-2.5 break-inside-avoid">
                                        <div class="flex justify-between items-baseline mb-0.5">
                                            <div class="flex-1">
                                                ${e.website 
                                                    ? `<a href="${e.website}" target="_blank" class="font-bold text-xs uppercase text-slate-800 inline-block mr-2 hover:underline flex items-center gap-1 group">${e.company} <i data-lucide="external-link" width="10" class="opacity-0 group-hover:opacity-100 transition-opacity"></i></a>` 
                                                    : `<h4 class="font-bold text-xs uppercase text-slate-800 inline-block mr-2">${e.company}</h4>`
                                                }
                                                <span class="text-[9px] text-slate-500 italic block sm:inline-block">${e.location || ''}</span>
                                            </div>
                                            <span class="text-[9px] font-bold text-slate-500 whitespace-nowrap ml-2">${app.formatDate(e.start)} - ${app.formatDate(e.end)}</span>
                                        </div>
                                        <p class="text-[10px] font-bold mb-0.5 italic" style="color:${theme}">${e.role}</p>
                                        <div class="text-[10px] text-justify leading-tight text-slate-600 rich-content">${e.description}</div>
                                    </div>
                                `).join('')}
                            </div>` : ''}

                            <!-- Education -->
                            <div class="mb-4">
                                <h3 class="font-bold text-xs text-slate-900 uppercase border-b-2 border-slate-300 pb-0.5 mb-2 flex items-center gap-2" style="color:${theme}"><i data-lucide="graduation-cap" width="12"></i> Education</h3>
                                ${this.data.education.map(e => `
                                    <div class="mb-2 break-inside-avoid">
                                        <div class="flex justify-between text-[9px] font-bold text-slate-500"><span>${app.formatDate(e.year)}</span></div>
                                        <div class="font-bold text-[11px] text-slate-800 uppercase">${e.degree}</div>
                                        <div class="text-[10px] flex gap-2 items-center">
                                            ${e.website 
                                                ? `<a href="${e.website}" target="_blank" class="hover:underline flex items-center gap-1 group">${e.school} <i data-lucide="external-link" width="8" class="opacity-0 group-hover:opacity-100 transition-opacity"></i></a>` 
                                                : e.school
                                            }
                                        </div>
                                        ${isFresher && e.cgpa ? `<div class="text-[10px] mt-0.5"><strong>Grade/CGPA:</strong> ${e.cgpa}</div>` : ''}
                                        ${isFresher && e.coursework ? `<div class="text-[10px] text-slate-600 mt-0.5"><strong>Coursework:</strong> ${e.coursework}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Technical Skills -->
                            <div class="mb-4">
                                <h3 class="font-bold text-xs text-slate-900 uppercase border-b-2 border-slate-300 pb-0.5 mb-2 flex items-center gap-2" style="color:${theme}"><i data-lucide="code" width="12"></i> Technical Skills</h3>
                                <div class="flex flex-wrap gap-1">${this.data.skills.map(s => `<span class="bg-white border border-slate-300 px-1.5 py-0.5 rounded shadow-sm text-[9px]">${s}</span>`).join('')}</div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    // ATS Template - Reduced padding (px-12 py-10)
                    html = `
                    <div class="px-12 py-10 flex-1 min-h-[297mm] text-black leading-tight flex flex-col">
                        <div class="text-center border-b pb-4 mb-5" style="border-color:${theme}">
                            <h1 class="text-3xl font-bold uppercase tracking-wide mb-1" style="color:${theme}">${p.fullName}</h1>
                            <p class="text-lg font-bold mb-2">${p.title}</p>
                            <div class="text-sm flex justify-center gap-4 flex-wrap mt-2">
                                <span>${p.location}</span>|<span>${p.email}</span>|<span>${p.phone}</span>
                                ${p.whatsapp ? `|<span>${p.whatsapp}</span>` : ''}
                                ${p.alternativePhone ? `|<span>${p.alternativePhone}</span>` : ''}
                                ${p.linkedin ? `| <span><a href="${p.linkedin}" class="text-inherit no-underline">LinkedIn</a></span>` : ''}
                                ${p.facebook ? `| <span><a href="${p.facebook}" class="text-inherit no-underline">Facebook</a></span>` : ''}
                                ${p.instagram ? `| <span><a href="${p.instagram}" class="text-inherit no-underline">Instagram</a></span>` : ''}
                            </div>
                        </div>
                        <div class="mb-5 break-inside-avoid">
                            <h3 class="font-bold uppercase text-sm border-b mb-2" style="border-color:${theme}; color:${theme}">Summary</h3>
                            <div class="text-sm text-justify rich-content">${p.summary}</div>
                        </div>
                        
                        <!-- Reduced Margin Below (mb-3) -->
                        <div class="mb-3">
                            <h3 class="font-bold uppercase text-sm border-b mb-3" style="border-color:${theme}; color:${theme}">Job and Duty</h3>
                            ${this.data.experience.map(e => `
                                <div class="mb-4 break-inside-avoid">
                                    <div class="flex justify-between font-bold text-sm">
                                        <span>${e.role}</span>
                                        <span class="whitespace-nowrap">${app.formatDate(e.start)} - ${app.formatDate(e.end)}</span>
                                    </div>
                                    <div class="flex justify-between italic text-sm mb-1">
                                        <span>
                                            ${e.website ? `<a href="${e.website}" class="text-inherit underline">${e.company}</a>` : e.company}
                                        </span>
                                        <span>${e.location || ''}</span>
                                    </div>
                                    <div class="text-sm text-justify pl-2 border-l-2 border-gray-200 rich-content">${e.description}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mb-5 break-inside-avoid">
                            <h3 class="font-bold uppercase text-sm border-b mb-2" style="border-color:${theme}; color:${theme}">Qualification</h3>
                            ${this.data.education.map(e => `
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-bold">${e.degree}</span>
                                    <span>
                                        ${e.website ? `<a href="${e.website}" class="text-inherit underline">${e.school}</a>` : e.school}, ${app.formatDate(e.year)}
                                    </span>
                                </div>
                                ${isFresher ? `
                                    <div class="text-xs mb-3 pl-2 border-l-2 border-gray-100">
                                        ${e.cgpa ? `<div><strong>Grade:</strong> ${e.cgpa}</div>` : ''}
                                        ${e.coursework ? `<div><strong>Coursework:</strong> ${e.coursework}</div>` : ''}
                                    </div>
                                ` : ''}
                            `).join('')}
                        </div>
                        <div class="mb-5 break-inside-avoid">
                            <h3 class="font-bold uppercase text-sm border-b mb-2" style="border-color:${theme}; color:${theme}">Professional Skills</h3>
                            <p class="text-sm leading-relaxed">${this.data.skills.join('  ')}</p>
                        </div>
                         <div class="mb-5 break-inside-avoid">
                            <h3 class="font-bold uppercase text-sm border-b mb-2" style="border-color:${theme}; color:${theme}">Hobbies & Interests</h3>
                            <p class="text-sm leading-relaxed">${(this.data.hobbies || []).join('  ')}</p>
                        </div>
                        <div class="mb-5 break-inside-avoid">
                            <h3 class="font-bold uppercase text-sm border-b mb-2" style="border-color:${theme}; color:${theme}">Language Skills</h3>
                            <div class="text-sm">${(this.data.languages || []).map(l => l.name).join('  ')}</div>
                        </div>
                    </div>`;
                }

                container.innerHTML = html;
                if(window.lucide) lucide.createIcons();
                this.initDatePickers(); // Initialize Flatpickr after DOM update
                this.drawPageBreaks(); // Draw page markers
            },

            // --- IMAGE & JSON HELPERS ---
            handleImageUpload(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Create image to detect dimensions before showing
                        const img = new Image();
                        img.onload = () => {
                            this.cropper.img = e.target.result;
                            document.getElementById('crop-img').src = this.cropper.img;
                            const modal = document.getElementById('cropper-modal');
                            modal.classList.remove('hidden');
                            setTimeout(() => modal.classList.remove('opacity-0'), 10);
                            
                            // Auto-fit logic: Calculate scale to cover the 256px crop area
                            const minDimension = Math.min(img.width, img.height);
                            // Default to slightly larger than cover to ensure no whitespace
                            let initialScale = (256 / minDimension) * 1.2; 
                            
                            // Set initial state
                            this.cropper.zoom = initialScale;
                            this.cropper.x = 0; 
                            this.cropper.y = 0; 
                            
                            // Update Slider Range dynamically based on image size
                            const slider = document.getElementById('zoom-slider');
                            slider.min = initialScale * 0.5;
                            slider.max = initialScale * 5;
                            slider.value = initialScale;
                            
                            this.updateCropTransform();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            closeCropper() {
                const modal = document.getElementById('cropper-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            },
            setupCropperEvents() {
                const area = document.getElementById('crop-area');
                const slider = document.getElementById('zoom-slider');
                area.onmousedown = (e) => { this.cropper.dragging = true; this.cropper.startX = e.clientX - this.cropper.x; this.cropper.startY = e.clientY - this.cropper.y; };
                window.onmousemove = (e) => { if (this.cropper.dragging) { this.cropper.x = e.clientX - this.cropper.startX; this.cropper.y = e.clientY - this.cropper.startY; this.updateCropTransform(); } };
                window.onmouseup = () => this.cropper.dragging = false;
                slider.oninput = (e) => { this.cropper.zoom = parseFloat(e.target.value); this.updateCropTransform(); };
            },
            updateCropTransform() { document.getElementById('crop-img').style.transform = `translate(-50%, -50%) translate(${this.cropper.x}px, ${this.cropper.y}px) scale(${this.cropper.zoom})`; },
            saveCrop() {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); 
                // High resolution output
                canvas.width = 400; 
                canvas.height = 400;
                
                // Create Circular Clipping Path
                ctx.beginPath();
                ctx.arc(200, 200, 200, 0, Math.PI * 2, true);
                ctx.closePath();
                ctx.clip();
                
                // Fill white background (optional, prevents transparency issues)
                ctx.fillStyle = '#FFFFFF'; 
                ctx.fillRect(0,0,400,400);

                const img = new Image(); img.src = this.cropper.img;
                img.onload = () => {
                    // Mapping UI (256px) -> Canvas (400px)
                    const scaleFactor = 400 / 256; 
                    
                    ctx.translate(200, 200); 
                    ctx.translate(this.cropper.x * scaleFactor, this.cropper.y * scaleFactor);
                    
                    // CRITICAL FIX: Scale the zoom by the ratio too
                    ctx.scale(this.cropper.zoom * scaleFactor, this.cropper.zoom * scaleFactor);
                    
                    ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
                    
                    this.data.personal.photo = canvas.toDataURL('image/png'); 
                    this.save(); 
                    this.renderEditor(); 
                    this.closeCropper();
                };
            },
            downloadJSON() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                const anchor = document.createElement('a'); anchor.setAttribute("href", dataStr); anchor.setAttribute("download", "cv_pro_backup.json");
                document.body.appendChild(anchor); anchor.click(); anchor.remove();
            },
            importJSON(input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { try { this.data = JSON.parse(e.target.result); this.save(); this.init(); alert("CV Restored!"); } catch (err) { alert("Invalid Backup File"); } };
                reader.readAsText(file);
            }
        };

        // Initialize App
        app.init();
    </script>
</body>
</html>