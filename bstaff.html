<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Staff Portal</title>
    
    <!-- Fonts from Theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Flatpickr (Date Range Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Theme Config -->
    <script>
        // Check if Tailwind is loaded before configuring
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Outfit', 'sans-serif'],
                            mono: ['JetBrains Mono', 'monospace'],
                        },
                        colors: {
                            'deep-space': '#050B14',
                            'brand-blue': '#3B82F6',
                            'brand-purple': '#8B5CF6',
                            'brand-gold': '#FFD700',
                        },
                        animation: {
                            'float': 'float 8s ease-in-out infinite',
                            'pulse-gold': 'pulse-gold 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                            'fade-in': 'fadeIn 0.5s ease-out forwards',
                        },
                        keyframes: {
                            float: {
                                '0%, 100%': { transform: 'translateY(0)' },
                                '50%': { transform: 'translateY(-20px)' },
                            },
                            'pulse-gold': {
                                '0%, 100%': { opacity: 0.8, filter: 'drop-shadow(0 0 5px rgba(255, 215, 0, 0.5))' },
                                '50%': { opacity: 1, filter: 'drop-shadow(0 0 15px rgba(255, 215, 0, 1))' }
                            },
                            fadeIn: {
                                '0%': { opacity: '0', transform: 'translateY(10px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' }
                            }
                        }
                    }
                }
            }
        } else {
            console.warn('Tailwind CSS script not loaded. Styles may be missing.');
        }
    </script>

    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #050B14; 
            color: #E2E8F0; 
            overflow: hidden;
        }
        
        /* Ambient Background from Theme */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.25;
            will-change: transform; 
        }
        .orb-1 { top: -15%; left: -10%; width: 50vw; height: 50vw; background: #3B82F6; animation: float 14s infinite; }
        .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #8B5CF6; animation: float 16s infinite reverse; }
        .orb-3 { top: 40%; left: 30%; width: 35vw; height: 35vw; background: #FFD700; opacity: 0.15; animation: float 20s infinite; }

        /* Glass Panel from Theme */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            transition: all 0.3s ease;
        }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: border-color 0.3s;
        }
        .glass-input:focus {
            border-color: #3B82F6;
        }
        
        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            color: #FFD700;
            border-left: 3px solid #FFD700;
        }
        .sidebar-item {
            border-left: 3px solid transparent;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #FFD700;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
        
        /* Print Styles for PDF Generation */
        .report-header {
            color: #050B14;
            text-align: center;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            color: #050B14;
        }
        .report-table th, .report-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        
        /* Calendar Dropdown Styling */
        #datePickerOverlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        #datePickerOverlay.active {
            opacity: 1;
            visibility: visible;
        }
        #calendarDropdown {
            transform: translateY(-10px);
            transition: transform 0.3s ease;
        }
        #datePickerOverlay.active #calendarDropdown {
            transform: translateY(0);
        }

        /* Confirmation Modal Styling */
        #confirmModal {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #confirmModal.active {
            visibility: visible;
            opacity: 1;
        }
        
        /* Welcome Animation Styles */
        #welcomeOverlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- MODERN UI FLATPICKR CUSTOMIZATION (shadcn/ui style) --- */
        .flatpickr-calendar {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important; /* Rounded corners like PopoverContent */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
            font-family: 'Outfit', sans-serif !important;
            padding: 12px !important;
            margin-top: 8px !important;
            width: auto !important;
            z-index: 9999 !important; /* Ensure it floats on top of all other elements */
        }
        
        /* Remove the default arrow */
        .flatpickr-calendar.arrowTop:before, .flatpickr-calendar.arrowTop:after,
        .flatpickr-calendar.arrowBottom:before, .flatpickr-calendar.arrowBottom:after {
            display: none !important;
        }

        .flatpickr-months {
            padding: 0 0 12px 0 !important;
            border-bottom: 0px solid #e2e8f0 !important;
            align-items: center !important;
        }

        .flatpickr-month {
            height: 32px !important;
            color: #0f172a !important; /* Slate 900 */
            fill: #0f172a !important;
        }

        .flatpickr-current-month {
            font-size: 14px !important;
            font-weight: 600 !important;
            padding: 0 !important;
            top: 0 !important;
            height: auto !important;
            color: #0f172a !important;
        }
        
        .flatpickr-current-month input.cur-year {
            font-weight: 600 !important;
            color: #0f172a !important;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-weight: 600 !important;
            background: transparent !important;
            appearance: none;
        }
        
        .flatpickr-current-month .flatpickr-monthDropdown-months:hover {
            background: transparent !important;
        }

        /* Navigation Arrows */
        .flatpickr-prev-month, .flatpickr-next-month {
            top: 12px !important;
            height: 28px !important;
            width: 28px !important;
            padding: 0 !important;
            color: #64748b !important; /* Slate 500 */
            fill: #64748b !important;
            border-radius: 6px !important;
            border: 1px solid #e2e8f0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .flatpickr-prev-month:hover, .flatpickr-next-month:hover {
            color: #0f172a !important;
            background: #f1f5f9 !important; /* Slate 100 */
        }
        
        .flatpickr-prev-month svg, .flatpickr-next-month svg {
            width: 14px !important;
            height: 14px !important;
        }
        
        .flatpickr-prev-month { left: 12px !important; }
        .flatpickr-next-month { right: 12px !important; }

        /* Weekdays */
        .flatpickr-weekdays {
            margin-bottom: 8px !important;
        }
        
        span.flatpickr-weekday {
            color: #64748b !important; /* Slate 500 */
            font-size: 12px !important;
            font-weight: 400 !important;
        }

        /* Days */
        .flatpickr-rContainer {
            margin: 0 !important;
        }
        
        .flatpickr-days {
            width: auto !important;
            border: none !important;
        }
        
        .dayContainer {
            width: auto !important;
            min-width: 240px !important;
            padding: 0 !important;
            margin: 0 !important;
            justify-content: space-around !important;
        }

        .flatpickr-day {
            height: 36px !important;
            width: 36px !important; /* Square-ish aspect */
            line-height: 36px !important;
            margin: 0 !important;
            border-radius: 6px !important; /* Rounded corners like buttons */
            border: 1px solid transparent !important;
            color: #0f172a !important; /* Slate 900 */
            font-size: 13px !important;
            font-weight: 400 !important;
            box-shadow: none !important;
        }

        /* Hover State */
        .flatpickr-day:hover, 
        .flatpickr-day.prevMonthDay:hover, 
        .flatpickr-day.nextMonthDay:hover, 
        .flatpickr-day:focus {
            background: #f1f5f9 !important; /* Slate 100 */
            border-color: transparent !important;
            color: #0f172a !important;
        }

        /* Today */
        .flatpickr-day.today {
            background: #f8fafc !important; /* Slate 50 */
            border-color: #e2e8f0 !important;
            color: #0f172a !important;
            font-weight: 600 !important;
        }

        /* Selected State (Start & End) */
        .flatpickr-day.selected, 
        .flatpickr-day.startRange, 
        .flatpickr-day.endRange,
        .flatpickr-day.selected.inRange, 
        .flatpickr-day.startRange.inRange, 
        .flatpickr-day.endRange.inRange {
            background: #3B82F6 !important; /* Brand Blue */
            color: #ffffff !important;
            border-color: #3B82F6 !important;
            font-weight: 500 !important;
        }

        /* In Range State */
        .flatpickr-day.inRange,
        .flatpickr-day.prevMonthDay.inRange,
        .flatpickr-day.nextMonthDay.inRange {
            background: #EFF6FF !important; /* Blue 50 */
            border-color: transparent !important;
            color: #0f172a !important;
            box-shadow: none !important;
            border-radius: 0 !important; /* Square connection for range */
        }
        
        /* Fix rounding for range ends */
        .flatpickr-day.startRange {
            border-radius: 6px 0 0 6px !important;
        }
        
        .flatpickr-day.endRange {
            border-radius: 0 6px 6px 0 !important;
        }
        
        .flatpickr-day.startRange.endRange {
            border-radius: 6px !important;
        }

        /* Disable days */
        .flatpickr-day.flatpickr-disabled, 
        .flatpickr-day.flatpickr-disabled:hover {
            color: #cbd5e1 !important; /* Slate 300 */
            background: transparent !important;
            cursor: not-allowed;
        }
        
        /* Multi-month spacing */
        .flatpickr-calendar.multiMonth .flatpickr-days .dayContainer:nth-child(n+1) .flatpickr-day.inRange:nth-child(7n+7) {
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
        }
        
        .flatpickr-calendar.multiMonth .flatpickr-days .dayContainer:nth-child(n+2) .flatpickr-day.inRange:nth-child(7n+1) {
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <!-- Ambient Background -->
    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- MAIN LANDING / LOGIN / TRACKER SECTION -->
    <div id="loginSection" class="fixed inset-0 z-50 flex items-center justify-center bg-deep-space/95 backdrop-blur-sm overflow-y-auto custom-scrollbar p-4">
        <div class="w-full max-w-6xl space-y-6">
            
            <!-- Header: Big Clock -->
            <div class="text-center mb-10">
                <div class="inline-flex items-center gap-4 mb-4 bg-white/5 px-6 py-2 rounded-full border border-white/5">
                    <div class="w-8 h-8 bg-brand-gold rounded-lg flex items-center justify-center shadow-lg shadow-brand-gold/20">
                        <i class="fas fa-bolt text-deep-space text-sm"></i>
                    </div>
                    <span class="text-white font-bold tracking-widest text-sm uppercase">Better Call Immigration</span>
                </div>
                <div id="bigClock" class="text-6xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 font-mono tracking-tight drop-shadow-2xl">
                    12:00:00
                </div>
                <div id="bigDate" class="text-brand-blue font-medium text-lg md:text-xl mt-2 tracking-wide uppercase">
                    Loading Date...
                </div>
            </div>

            <!-- Main Interface Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- LEFT: Login & Auth -->
                <div class="glass rounded-[2rem] p-8 border border-white/10 flex flex-col justify-center h-full">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i class="fas fa-user-shield text-brand-purple"></i> Staff Identification
                    </h3>
                    
                    <form id="loginForm" class="space-y-4" onsubmit="event.preventDefault();">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 ml-2">User ID</label>
                            <div class="relative group">
                                <i class="fas fa-id-badge absolute left-4 top-4 text-gray-500 group-focus-within:text-brand-blue transition-colors"></i>
                                <input type="text" id="username" class="glass-input w-full pl-12 pr-4 py-4 rounded-xl focus:outline-none" placeholder="Enter ID" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 ml-2">Password</label>
                            <div class="relative group">
                                <i class="fas fa-lock absolute left-4 top-4 text-gray-500 group-focus-within:text-brand-blue transition-colors"></i>
                                <input type="password" id="password" class="glass-input w-full pl-12 pr-4 py-4 rounded-xl focus:outline-none" placeholder="••••••••" required>
                                <!-- Enter key hint -->
                                <div class="absolute right-4 top-4 text-xs text-gray-500 hidden md:block border border-white/10 px-1 rounded">↵</div>
                            </div>
                            <p class="text-[10px] text-gray-500 mt-2 ml-2 italic">* Press Enter after password to refresh stats.</p>
                        </div>

                        <!-- Status Check / Refresh -->
                        <button type="button" onclick="checkCredentialsAndRefresh()" class="w-full bg-white/5 hover:bg-white/10 text-gray-300 text-xs font-bold py-3 rounded-xl transition-colors border border-white/5 mb-4">
                            <i class="fas fa-sync-alt mr-1"></i> Check Status
                        </button>
                        
                        <div id="loginLoader" class="loader hidden mx-auto mt-2"></div>
                        <div id="loginError" class="text-center text-red-400 text-xs hidden font-bold animate-bounce">Invalid credentials</div>
                    </form>
                </div>

                <!-- MIDDLE: Tracker Widget -->
                <div class="glass rounded-[2rem] p-8 border border-white/10 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-brand-blue rounded-full mix-blend-overlay filter blur-3xl opacity-10"></div>
                    
                    <div class="flex justify-between items-start mb-8 relative z-10">
                        <div>
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Session Status</p>
                            <div class="flex items-center gap-2 mt-2">
                                <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-600"></div>
                                <span id="statusText" class="font-bold text-white text-lg">Waiting for User...</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">User</p>
                             <p id="trackerUserName" class="text-brand-gold font-bold text-lg truncate max-w-[150px]">---</p>
                        </div>
                    </div>

                    <div class="text-center py-6 relative z-10">
                        <div id="stopwatch" class="text-6xl font-black text-white font-mono tracking-tighter tabular-nums">00:00:00</div>
                        <p class="text-brand-purple text-xs font-bold uppercase tracking-[0.3em] mt-2">Duration</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6 relative z-10">
                        <button onclick="handleLoginAction('In')" id="btnIn" class="bg-gradient-to-br from-emerald-600 to-emerald-800 hover:from-emerald-500 hover:to-emerald-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95 shadow-lg shadow-emerald-900/50 border border-emerald-500/20 flex items-center justify-center gap-2" disabled>
                            <i class="fas fa-play"></i> Clock In
                        </button>
                        <button onclick="handleLoginAction('Out')" id="btnOut" class="bg-gradient-to-br from-rose-600 to-rose-800 hover:from-rose-500 hover:to-rose-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95 shadow-lg shadow-rose-900/50 border border-rose-500/20 flex items-center justify-center gap-2" disabled>
                            <i class="fas fa-stop"></i> Clock Out
                        </button>
                    </div>

                    <div id="breakRow" class="grid grid-cols-2 gap-3 mt-3 hidden relative z-10">
                        <button onclick="handleLoginAction('BreakIn')" id="btnBreakIn" class="bg-white/5 hover:bg-white/10 text-brand-gold font-bold py-3 rounded-xl border border-brand-gold/20">
                            <i class="fas fa-mug-hot"></i> Break
                        </button>
                        <button onclick="handleLoginAction('BreakOut')" id="btnBreakOut" class="bg-white/5 hover:bg-white/10 text-white font-bold py-3 rounded-xl border border-white/10">
                            <i class="fas fa-undo"></i> Resume
                        </button>
                    </div>
                </div>

                <!-- RIGHT: Stats & Portal Link -->
                <div class="glass rounded-[2rem] p-8 border border-white/10 flex flex-col justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Daily Stats</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                                <span class="text-gray-400 text-xs">Worked</span>
                                <span class="font-mono text-white text-sm font-bold" id="stopwatchMini">00:00:00</span>
                            </div>
                            <div class="flex justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                                <span class="text-gray-400 text-xs">Break</span>
                                <span class="font-mono text-rose-400 text-sm font-bold" id="breakTimeDisplay">0h 00m</span>
                            </div>
                             <div class="flex justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                                <span class="text-gray-400 text-xs">Overtime</span>
                                <span class="font-mono text-brand-blue text-sm font-bold" id="overtimeDisplay">0h 00m</span>
                            </div>
                            <div class="flex justify-between p-3 bg-white/5 rounded-lg border border-brand-gold/20">
                                <span class="text-gray-400 text-xs">Break Count</span>
                                <span class="font-mono text-brand-gold text-sm font-bold" id="breakCountDisplay">0 / 4</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <button onclick="handleLoginAction('Login')" class="mt-6 w-full group relative bg-gradient-to-r from-brand-blue to-brand-purple p-[1px] rounded-xl hover:shadow-[0_0_20px_rgba(139,92,246,0.3)] transition-all">
                            <div class="bg-deep-space rounded-[11px] h-full px-4 py-3 flex items-center justify-between group-hover:bg-opacity-80 transition-all">
                                <span class="font-bold text-white text-sm">Access Full Portal</span>
                                <i class="fas fa-arrow-right text-brand-purple group-hover:translate-x-1 transition-transform"></i>
                            </div>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT (Hidden by default, used for Calendar/Admin) -->
    <div id="appLayout" class="hidden flex-1 flex h-full relative z-10">
        
        <!-- SIDEBAR -->
        <aside class="w-20 md:w-72 glass flex flex-col justify-between border-r border-white/5 z-20">
            <div>
                <div class="p-8 flex items-center gap-4">
                    <div class="w-10 h-10 bg-brand-gold rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-brand-gold/20">
                        <i class="fas fa-bolt text-deep-space text-lg"></i>
                    </div>
                    <span class="font-bold text-xl tracking-wide hidden md:block text-white">BETTER CALL</span>
                </div>
                
                <nav class="mt-8 space-y-2 px-4">
                    <!-- Updated Name -->
                    <button onclick="switchTab('calendar')" id="nav-calendar" class="sidebar-item w-full flex items-center gap-4 px-4 py-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group">
                        <i class="fas fa-id-card-alt w-5 text-center group-hover:text-brand-purple transition-colors"></i>
                        <span class="hidden md:block font-medium">Staff Panel</span>
                    </button>
                    <button onclick="switchTab('admin')" id="nav-admin" class="sidebar-item hidden w-full flex items-center gap-4 px-4 py-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group">
                        <i class="fas fa-cog w-5 text-center group-hover:text-brand-gold transition-colors"></i>
                        <span class="hidden md:block font-medium">Admin Setup</span>
                    </button>
                    <button onclick="logout()" class="sidebar-item w-full flex items-center gap-4 px-4 py-4 rounded-xl text-rose-400 hover:text-white hover:bg-rose-500/10 transition-all group mt-4">
                        <i class="fas fa-sign-out-alt w-5 text-center"></i>
                        <span class="hidden md:block font-medium">Back to Time Station</span>
                    </button>
                </nav>
            </div>

            <div class="p-6 border-t border-white/5 bg-black/20">
                <div class="flex items-center gap-4 px-2">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand-blue to-brand-purple flex items-center justify-center font-bold text-sm shadow-inner">
                        <span id="avatarInitial">U</span>
                    </div>
                    <div class="hidden md:block overflow-hidden">
                        <p id="displayUsername" class="text-sm font-bold text-white truncate">User</p>
                        <p id="displayRole" class="text-xs text-brand-gold uppercase tracking-wider">Staff Member</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 overflow-y-auto relative custom-scrollbar">
            
            <!-- TAB: STAFF PANEL (Redesigned) -->
            <div id="tab-calendar" class="p-6 md:p-12 relative z-10 max-w-7xl mx-auto animate-fade-in">
                
                <!-- New: Staff Profile Section -->
                <div class="glass rounded-[2rem] p-8 mb-8 border border-white/5 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-96 h-96 bg-brand-blue/5 rounded-full mix-blend-overlay filter blur-3xl -translate-y-1/2 translate-x-1/3"></div>
                    
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-8 relative z-10">
                        <!-- Big Avatar -->
                        <div class="w-32 h-32 rounded-full bg-gradient-to-br from-brand-blue to-brand-purple p-1 shadow-2xl shrink-0">
                            <div class="w-full h-full rounded-full bg-[#0B1221] flex items-center justify-center">
                                <span id="profileAvatar" class="text-5xl font-bold text-white">U</span>
                            </div>
                        </div>
                        
                        <!-- Details -->
                        <div class="flex-1 text-center md:text-left space-y-4">
                            <div>
                                <h1 id="profileName" class="text-4xl font-bold text-white mb-1">Loading Name...</h1>
                                <p id="profileDesignation" class="text-brand-gold text-lg font-medium tracking-wide uppercase">Staff Member</p>
                            </div>
                            
                            <div class="flex flex-wrap justify-center md:justify-start gap-4 text-sm text-gray-400">
                                <div class="bg-white/5 px-4 py-2 rounded-lg border border-white/5 flex items-center gap-2">
                                    <i class="fas fa-id-badge text-brand-purple"></i>
                                    <span id="profileId">ID: ---</span>
                                </div>
                                <div class="bg-white/5 px-4 py-2 rounded-lg border border-white/5 flex items-center gap-2">
                                    <i class="fas fa-envelope text-brand-blue"></i>
                                    <span id="profileEmail">---</span>
                                </div>
                                <div class="bg-white/5 px-4 py-2 rounded-lg border border-white/5 flex items-center gap-2">
                                    <i class="fas fa-phone text-emerald-400"></i>
                                    <span id="profilePhone">---</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mini Stat -->
                        <div class="hidden lg:block text-right">
                            <div class="bg-brand-blue/10 px-6 py-4 rounded-xl border border-brand-blue/20">
                                <p class="text-brand-blue text-xs font-bold uppercase tracking-wider mb-1">Status</p>
                                <p class="text-white font-bold text-xl flex items-center gap-2 justify-end">
                                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Active
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Existing Attendance Section (Moved Down) -->
                <div class="mb-10 flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">Attendance History</h2>
                        <p class="text-gray-400 text-sm">Review your daily logs and timesheets</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                    
                    <!-- LEFT COL: Calendar Widget -->
                    <div class="lg:col-span-4 sticky top-6">
                        <div id="calendar-view" class="glass rounded-[2rem] p-8 border border-white/5 w-full">
                            <div class="flex justify-between items-center mb-8" id="calendar-nav">
                                <button onclick="changePeriod(-1)" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors"><i class="fas fa-chevron-left"></i></button>
                                <h2 id="periodTitle" class="text-lg md:text-2xl font-bold text-white cursor-pointer truncate mx-2" onclick="toggleCalendarDropdown()">
                                    <!-- Dynamic -->
                                    <i class="fas fa-spinner fa-spin"></i>
                                </h2>
                                <button onclick="changePeriod(1)" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors"><i class="fas fa-chevron-right"></i></button>
                            </div>

                            <!-- Calendar Dropdown Overlay -->
                            <div id="datePickerOverlay" class="fixed inset-0 z-40 flex items-start justify-center pt-20" onclick="toggleCalendarDropdown(false)">
                                <div id="calendarDropdown" class="glass p-4 rounded-xl shadow-2xl relative z-50 transform" onclick="event.stopPropagation()">
                                    <div id="monthSelector" class="flex justify-between items-center mb-4">
                                        <button onclick="navigateMonth(-1)" class="px-2 py-1 text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i></button>
                                        <span id="currentMonthYear" class="font-bold text-lg">October 2025</span>
                                        <button onclick="navigateMonth(1)" class="px-2 py-1 text-gray-400 hover:text-white"><i class="fas fa-arrow-right"></i></button>
                                    </div>
                                    <div class="calendar-grid mb-2 w-full max-w-xs">
                                        <div class="text-center text-brand-purple/70 text-xs font-bold py-2">Sun</div>
                                        <div class="text-center text-brand-purple/70 text-xs font-bold py-2">Mon</div>
                                        <div class="text-center text-brand-purple/70 text-xs font-bold py-2">Tue</div>
                                        <div class="text-center text-brand-purple/70 text-xs font-bold py-2">Wed</div>
                                        <div class="text-center text-brand-purple/70 text-xs font-bold py-2">Thu</div>
                                        <div class="text-center text-brand-purple/70 text-xs font-bold py-2">Fri</div>
                                        <div class="text-center text-brand-purple/70 text-xs font-bold uppercase py-2">Sat</div>
                                    </div>
                                    <div id="calendarGridContent" class="calendar-grid w-full max-w-xs">
                                        <!-- Calendar days injected here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Calendar Body (Single Day Block) -->
                            <div id="calendarBody" class="calendar-grid">
                                <!-- Day details are rendered directly here -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COL: Activity Log -->
                    <div class="lg:col-span-8">
                        <div class="glass rounded-[2rem] p-8 border border-white/5 min-h-[500px]">
                            
                            <!-- Creative Date Range Filter (FLATPICKR) -->
                            <div class="glass rounded-2xl p-6 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between border border-white/5 bg-gradient-to-r from-white/5 to-transparent">
                                <div class="flex-1 w-full relative">
                                    <label class="text-xs text-brand-gold font-bold uppercase tracking-wider mb-2 block ml-1">
                                        <i class="fas fa-calendar-alt mr-1"></i> Select Date Range
                                    </label>
                                    <div class="flex gap-2">
                                        <div class="relative w-full">
                                            <input id="historyRange" class="glass-input w-full pl-10 pr-4 py-3 rounded-xl focus:outline-none text-white text-sm font-mono tracking-wide cursor-pointer focus:border-brand-gold bg-black/20" placeholder="Select dates...">
                                            <i class="fas fa-calendar absolute left-4 top-3.5 text-gray-400 text-xs"></i>
                                        </div>
                                        
                                        <!-- Quick Select Buttons -->
                                        <button onclick="setQuickDate('week')" class="bg-white/5 hover:bg-white/10 text-white text-xs px-3 rounded-xl border border-white/5 whitespace-nowrap transition-colors">Last 7 Days</button>
                                        <button onclick="setQuickDate('month')" class="bg-white/5 hover:bg-white/10 text-white text-xs px-3 rounded-xl border border-white/5 whitespace-nowrap transition-colors">Last Month</button>
                                    </div>
                                </div>
                                <button onclick="filterHistoryByRange()" class="h-full w-full md:w-auto bg-gradient-to-r from-brand-blue to-brand-purple hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 px-8 rounded-xl transition-all shadow-lg shadow-brand-blue/20 transform hover:-translate-y-0.5 active:scale-95 group mt-6 md:mt-0">
                                    <span class="group-hover:hidden"><i class="fas fa-search mr-2"></i> Search</span>
                                    <span class="hidden group-hover:inline"><i class="fas fa-arrow-right mr-2"></i> Go</span>
                                </button>
                            </div>

                            <!-- Header -->
                            <div class="flex items-center justify-between mb-6 border-b border-white/5 pb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-white">Activity Log</h3>
                                    <p class="text-xs text-gray-400 mt-1">Summary for <span id="logUserName" class="text-brand-gold">...</span></p>
                                </div>
                                <button onclick="refreshLogs()" class="bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg text-brand-blue text-xs font-bold transition-colors uppercase tracking-wider">
                                    <i class="fas fa-sync-alt mr-2"></i>Reset
                                </button>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-xs text-gray-500 border-b border-white/10 uppercase tracking-wider">
                                            <th class="py-4 px-4">Date</th>
                                            <th class="py-4 px-4">Check In</th>
                                            <th class="py-4 px-4">Check Out</th>
                                            <th class="py-4 px-4 text-center">Total Break</th>
                                            <th class="py-4 px-4 text-right">Net Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logsTableBody" class="text-sm">
                                        <tr>
                                            <td colspan="5" class="py-12 text-center text-gray-500 italic">
                                                Loading activity log...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB: ADMIN/SETTINGS -->
            <div id="tab-admin" class="hidden p-6 md:p-12 relative z-10 max-w-6xl mx-auto animate-fade-in">
                <header class="mb-10 flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">Admin Dashboard</h1>
                        <p class="text-gray-400">Manage users, reports, and system configurations</p>
                    </div>
                </header>

                <!-- SECTION 1: Live Staff Status (High Priority) -->
                <div class="glass rounded-[2rem] p-8 space-y-6 border border-white/5 mb-8">
                    <div class="flex justify-between items-center border-b border-white/5 pb-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center shadow-inner">
                                <i class="fas fa-users text-emerald-400 text-sm"></i>
                            </div>
                            Live Staff Status
                        </h2>
                        <button onclick="loadLiveStatus()" class="text-xs bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg transition-colors text-brand-blue font-bold uppercase tracking-wider border border-white/5">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh
                        </button>
                    </div>
                    
                    <div id="liveStatusGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Status Cards will be injected here -->
                        <div class="col-span-full text-center py-8 text-gray-500 italic">
                            Waiting for data update...
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: User Management (Moved Up & Redesigned) -->
                <div class="glass rounded-[2rem] p-8 space-y-8 border border-white/5 mb-8">
                    <div class="flex justify-between items-center border-b border-white/5 pb-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-brand-purple/20 flex items-center justify-center shadow-inner">
                                <i class="fas fa-users-cog text-brand-purple text-sm"></i>
                            </div>
                            User Management
                        </h2>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Add/Edit User Form (Left Column) -->
                        <div class="lg:col-span-1 bg-white/5 rounded-2xl p-6 border border-white/5 h-fit">
                            <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-user-plus text-brand-gold"></i> Add / Edit User
                            </h3>
                            <form id="addUserForm" onsubmit="event.preventDefault(); handleUserFormSubmit();" class="space-y-3 relative">
                                <!-- Edit Mode Indicator -->
                                <div id="editModeIndicator" class="hidden absolute -top-10 right-0 bg-brand-gold/20 text-brand-gold text-[10px] px-2 py-1 rounded font-bold uppercase tracking-wider flex items-center gap-1 border border-brand-gold/30">
                                    <i class="fas fa-pen"></i> Editing
                                </div>

                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">User ID</label>
                                    <input type="text" id="newUsername" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm disabled:opacity-50 disabled:cursor-not-allowed bg-black/20" required placeholder="e.g. jsmith">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Full Name</label>
                                    <input type="text" id="newFullName" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm bg-black/20" required placeholder="e.g. John Smith">
                                </div>
                                
                                <!-- NEW FIELDS -->
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Designation</label>
                                    <input type="text" id="newDesignation" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm bg-black/20" placeholder="e.g. Senior Developer">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Phone</label>
                                        <input type="tel" id="newPhone" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm bg-black/20" placeholder="+1...">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Email</label>
                                        <input type="email" id="newEmail" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm bg-black/20" placeholder="@...">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Password</label>
                                    <input type="password" id="newPassword" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm bg-black/20" placeholder="Required for new users">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Role</label>
                                    <select id="newRole" class="glass-input w-full p-2.5 rounded-xl focus:outline-none text-sm bg-deep-space">
                                        <option value="staff">Staff</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button type="button" id="cancelEditBtn" onclick="cancelEditMode()" class="hidden flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg transition-colors text-xs border border-white/10">
                                        Cancel
                                    </button>
                                    <button type="submit" id="submitUserBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg transition-colors shadow-lg shadow-emerald-500/20 text-xs uppercase tracking-wide">
                                        Create User
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- User Table (Right Column) -->
                        <div class="lg:col-span-2 flex flex-col">
                            <div class="overflow-x-auto custom-scrollbar rounded-xl border border-white/5 bg-black/20 max-h-[500px]">
                                <table class="w-full text-left border-collapse">
                                    <thead class="sticky top-0 bg-[#0A121E] z-10 shadow-sm">
                                        <tr class="text-[10px] text-gray-400 border-b border-white/10 uppercase tracking-wider">
                                            <th class="py-3 px-4 font-bold bg-[#0A121E]">User ID</th>
                                            <th class="py-3 px-4 font-bold bg-[#0A121E]">Full Name</th>
                                            <th class="py-3 px-4 font-bold bg-[#0A121E]">Designation</th>
                                            <th class="py-3 px-4 font-bold bg-[#0A121E]">Role</th>
                                            <th class="py-3 px-4 font-bold text-right bg-[#0A121E]">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userListBody" class="text-sm divide-y divide-white/5">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: Advanced Reporting -->
                <div class="glass rounded-[2rem] p-8 space-y-8 border border-white/5 mb-8">
                    <div class="flex justify-between items-center border-b border-white/5 pb-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-brand-blue/20 flex items-center justify-center shadow-inner">
                                <i class="fas fa-file-alt text-brand-blue text-sm"></i>
                            </div>
                            Advanced Reporting
                        </h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-4 space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Staff Selection</label>
                                <select id="reportUserSelect" class="glass-input w-full p-3 rounded-xl focus:outline-none text-sm bg-deep-space">
                                    <option value="all">All Staff</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Report Period</label>
                                <div class="relative">
                                    <input id="reportRange" class="glass-input w-full pl-10 pr-4 py-3 rounded-xl focus:outline-none text-white text-sm cursor-pointer bg-black/20" placeholder="Select dates...">
                                    <i class="fas fa-calendar-alt absolute left-4 top-3.5 text-gray-400 text-xs"></i>
                                </div>
                            </div>
                            <button onclick="generateReportData()" class="w-full bg-brand-purple hover:bg-purple-600 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-brand-purple/20 text-sm flex items-center justify-center gap-2 group">
                                <i class="fas fa-search group-hover:scale-110 transition-transform"></i> Fetch & Summarize
                            </button>
                        </div>
                        
                        <div class="md:col-span-8 bg-black/20 rounded-2xl p-6 border border-white/5 min-h-[200px] flex flex-col">
                            <div id="reportSummary" class="hidden h-full flex flex-col">
                                <h3 class="text-sm font-bold text-white mb-2 border-b border-white/5 pb-2">Report Generated</h3>
                                <div id="summaryContent" class="text-xs font-mono text-gray-300 mb-4 whitespace-pre-wrap flex-1 leading-relaxed"></div>
                                <button onclick="downloadPdfReport()" id="downloadPdfButton" class="mt-auto w-full bg-white/5 hover:bg-white/10 text-white font-bold py-3 rounded-xl transition-colors border border-white/10 text-sm flex items-center justify-center gap-2 hover:border-red-500/30 group">
                                    <i class="fas fa-file-pdf text-red-400 group-hover:scale-110 transition-transform"></i> Download PDF Report
                                </button>
                            </div>
                            <div id="reportPlaceholder" class="h-full flex flex-col items-center justify-center text-gray-600 text-sm italic gap-3">
                                <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center">
                                    <i class="fas fa-chart-bar text-gray-700"></i>
                                </div>
                                <p>Select criteria and fetch data to view summary.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 4: Technical Footer (Compact & Low Priority) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 opacity-75 hover:opacity-100 transition-opacity relative z-0">
                    <!-- Connection Setup -->
                    <div class="glass rounded-xl p-5 border border-white/5 flex flex-col justify-center">
                        <label class="block text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-link text-brand-gold"></i> Web App Connection
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="scriptUrl" class="glass-input w-full p-2 px-3 rounded-lg font-mono text-[10px] md:text-xs text-brand-blue bg-black/30 border-white/5 focus:border-brand-blue/50" placeholder="https://script.google.com/macros/s/...">
                            <button onclick="saveSettings()" class="bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white px-4 py-2 rounded-lg font-bold transition-colors text-xs border border-white/5">Save</button>
                            <button onclick="testConnection()" class="bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 hover:text-emerald-300 px-4 py-2 rounded-lg font-bold transition-colors text-xs border border-emerald-500/20" title="Verify if script is returning data correctly">Test</button>
                        </div>
                    </div>

                    <!-- Console -->
                    <div class="glass rounded-xl p-5 border border-white/5">
                        <label class="block text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-terminal text-emerald-500"></i> System Logs
                        </label>
                        <div id="consoleLog" class="bg-black/50 rounded-lg p-3 h-20 overflow-y-auto font-mono text-[10px] text-green-400 custom-scrollbar border border-white/5 leading-relaxed">
                            > System ready...<br>
                            > Waiting for connection configuration...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- ... Rest of modal HTML ... -->

    <script>
        // --- CONSTANTS ---
        const DAILY_GOAL_SECONDS = 9 * 3600; // 9 hours
        const MAX_BREAKS = 4;
        const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- SAFE STORAGE HELPER ---
        const storage = {
            get: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
            set: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} },
            remove: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
        };

        let state = {
            currentUser: null,
            currentFullName: null,
            // NEW: Additional User Fields
            currentDesignation: null,
            currentEmail: null,
            currentPhone: null,
            
            role: null,
            startTime: null,
            timerInterval: null,
            breakTimerInterval: null,
            elapsedSeconds: 0,
            breakSeconds: 0,
            breakCount: 0,
            lastBreakInTime: null,
            scriptUrl: storage.get('nexus_script_url') || '',
            isClockedIn: false,
            isBreak: false, 
            hasClockedInToday: false,
            hasClockedOutToday: false,
            logsCache: [],
            userListCache: [],
            editingUser: null,
            adminReportData: [],
            viewMode: 'day',
            currentPeriodStart: new Date(new Date().setHours(0, 0, 0, 0)),
            calendarDisplayDate: new Date(),
            pendingAction: null,
            historyFP: null,
            reportFP: null
        };
        
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function formatTimeDetailed(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function formatDateDisplay(date) {
            if (!date) return '-';
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return String(date); 
                if (d.getFullYear() < 2000) return String(date);
                const day = String(d.getDate()).padStart(2, '0');
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const month = monthNames[d.getMonth()];
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return String(date);
            }
        }
        
        function formatShortTime(timeStr) {
            if (!timeStr || timeStr === '-' || timeStr === 'Active') return timeStr;
            if (String(timeStr).includes(':')) {
                const parts = String(timeStr).split(':');
                if (parts.length >= 2) return `${parts[0]}:${parts[1]}`;
            }
            try {
                const d = new Date(`2000-01-01 ${timeStr}`);
                if (isNaN(d.getTime())) return timeStr;
                const h = String(d.getHours()).padStart(2, '0');
                const m = String(d.getMinutes()).padStart(2, '0');
                return `${h}:${m}`;
            } catch (e) {
                return timeStr;
            }
        }
        
        function formatTimeDisplay(timeString) {
            try {
                if (typeof timeString === 'string' && timeString.includes('T')) {
                    const date = new Date(timeString);
                    if (isNaN(date)) return timeString;
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${hours}:${minutes}:${seconds}`;
                }
                const date = new Date(`2000-01-01 ${timeString}`);
                if (!isNaN(date)) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${hours}:${minutes}:${seconds}`;
                }
                return timeString;
            } catch (e) {
                return timeString;
            }
        }

        function formatTimeAMPM(dateInput) {
            if (!dateInput || dateInput === '-' || dateInput === 'Active') return dateInput;
            try {
                let dateObj;
                if (dateInput instanceof Date) {
                    dateObj = dateInput;
                } else {
                    dateObj = new Date(`2000-01-01 ${dateInput}`);
                    if (isNaN(dateObj.getTime())) return dateInput;
                }
                return dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) {
                return String(dateInput);
            }
        }

        // --- UPDATED INIT: AUTO-LOADS SESSION IF EXISTS ---
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateBigClock, 1000);
            updateBigClock();
            document.getElementById('password').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') checkCredentialsAndRefresh();
            });
            if(state.scriptUrl) document.getElementById('scriptUrl').value = state.scriptUrl;
            
            // --- NEW: FULL SESSION RESTORE ---
            const savedUser = storage.get('nexus_user');
            if (savedUser) {
                const userObj = JSON.parse(savedUser);
                
                // Populate Form
                document.getElementById('username').value = userObj.username;
                
                // Restore State
                state.currentUser = userObj.username;
                state.currentFullName = userObj.fullName;
                state.currentDesignation = userObj.designation;
                state.currentEmail = userObj.email;
                state.currentPhone = userObj.phone;
                state.role = userObj.role;

                // Update UI Immediately
                updateStaffProfileUI();
                const displayUsername = document.getElementById('displayUsername');
                if(displayUsername) displayUsername.textContent = state.currentFullName;
                
                const avatarInitial = document.getElementById('avatarInitial');
                if(avatarInitial) avatarInitial.textContent = (state.currentFullName || "U").charAt(0).toUpperCase();
                
                const displayRole = document.getElementById('displayRole');
                if(displayRole) displayRole.textContent = state.role.toUpperCase();
                
                const logUserName = document.getElementById('logUserName');
                if(logUserName) logUserName.textContent = state.currentFullName; 
                
                const trackerUserName = document.getElementById('trackerUserName');
                if(trackerUserName) trackerUserName.textContent = state.currentFullName;
                
                const welcomeName = document.getElementById('welcomeNameDisplay');
                if(welcomeName) welcomeName.textContent = state.currentFullName;

                // Admin Visibility
                const navAdmin = document.getElementById('nav-admin');
                if (navAdmin) {
                    if (state.role === 'admin') navAdmin.classList.remove('hidden');
                    else navAdmin.classList.add('hidden');
                }

                // Trigger Data Fetch with MOCK fallback
                refreshLogs();
            }
            
            state.currentPeriodStart = new Date(new Date().setHours(0, 0, 0, 0));
            initDatePickers();
        });

        // UPDATED: Initialize Date Pickers with correct floating behavior
        function initDatePickers() {
            const baseConfig = {
                mode: "range",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "j M Y",
                static: false, // CHANGED: Allows calendar to float properly
                animate: true
            };

            state.historyFP = flatpickr("#historyRange", {
                ...baseConfig,
                showMonths: 2,
            });

            state.reportFP = flatpickr("#reportRange", {
                ...baseConfig,
                showMonths: 1,
            });
        }

        function setQuickDate(type) {
            if (!state.historyFP) return;
            const end = new Date();
            const start = new Date();
            if (type === 'week') start.setDate(end.getDate() - 7);
            else if (type === 'month') start.setMonth(end.getMonth() - 1);
            state.historyFP.setDate([start, end], true);
        }

        function updateBigClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false });
            const dateString = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('bigClock').textContent = timeString;
            document.getElementById('bigDate').textContent = dateString;
        }

        function switchTab(tabId) {
            if (tabId === 'admin' && state.role !== 'admin') {
                alert("Access Denied: Admin privileges required.");
                return;
            }
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appLayout').classList.remove('hidden');
            ['calendar', 'admin'].forEach(id => {
                const tab = document.getElementById(`tab-${id}`);
                const nav = document.getElementById(`nav-${id}`);
                if(tab) tab.classList.add('hidden');
                if(nav) nav.classList.remove('active');
            });
            const targetTab = document.getElementById(`tab-${tabId}`);
            const targetNav = document.getElementById(`nav-${tabId}`);
            if(targetTab) targetTab.classList.remove('hidden');
            if(targetNav) targetNav.classList.add('active');
            
            if(tabId === 'calendar') {
                state.viewMode = 'day';
                state.currentPeriodStart = new Date(new Date().setHours(0, 0, 0, 0));
                state.calendarDisplayDate = new Date(new Date().setHours(0, 0, 0, 0));
                refreshLogs();
                // New: Update top profile section
                updateStaffProfileUI();
            }
            if(tabId === 'admin') {
                fetchUsersForReport();
                loadLiveStatus(); 
            }
        }
        
        function setViewMode(mode, refresh = true) {
            state.viewMode = mode;
            if (refresh) refreshLogs();
        }

        function changePeriod(delta) {
            state.currentPeriodStart.setDate(state.currentPeriodStart.getDate() + delta);
            state.calendarDisplayDate = new Date(state.currentPeriodStart);
            refreshLogs(); 
        }

        function toggleCalendarDropdown(show) {
            const overlay = document.getElementById('datePickerOverlay');
            if (show === undefined) show = !overlay.classList.contains('active');
            overlay.classList.toggle('active', show);
            if (show) {
                state.calendarDisplayDate = new Date(state.currentPeriodStart);
                renderMonth(state.calendarDisplayDate);
            }
        }

        function navigateMonth(delta) {
            state.calendarDisplayDate.setMonth(state.calendarDisplayDate.getMonth() + delta);
            renderMonth(state.calendarDisplayDate);
        }

        function selectDate(day) {
            const newDate = new Date(state.calendarDisplayDate.getFullYear(), state.calendarDisplayDate.getMonth(), day);
            state.currentPeriodStart = new Date(newDate.setHours(0, 0, 0, 0));
            toggleCalendarDropdown(false);
            refreshLogs();
        }

        function renderMonth(date) {
            const grid = document.getElementById('calendarGridContent');
            const monthYearEl = document.getElementById('currentMonthYear');
            grid.innerHTML = '';
            
            const year = date.getFullYear();
            const month = date.getMonth();
            monthYearEl.textContent = `${MONTH_NAMES[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = firstDayOfMonth.getDay();

            for (let i = 0; i < startDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const isSelected = dayDate.toDateString() === state.currentPeriodStart.toDateString();
                
                const cell = document.createElement('button');
                cell.textContent = day;
                cell.className = `p-2 rounded-full font-semibold text-sm w-full transition-colors ${
                    isSelected ? 'bg-brand-purple text-white shadow-md' : 'text-white/80 hover:bg-white/10'
                }`;
                cell.onclick = () => selectDate(day);
                grid.appendChild(cell);
            }
        }

        function confirmLog(type) {
             if (type === 'Out') {
                 if (!state.isClockedIn) {
                      alert("Error: You are already clocked out.");
                      return;
                 }
                 state.pendingAction = type;
                 document.getElementById('modalTitle').textContent = "Confirm Clock Out";
                 document.getElementById('modalMessage').textContent = "WARNING: Are you sure you want to end your shift? Please ensure all work is saved.";
                 const confirmBtn = document.getElementById('modalConfirmBtn');
                 confirmBtn.classList.remove('bg-emerald-600', 'bg-brand-gold', 'text-deep-space');
                 confirmBtn.classList.add('bg-rose-600');
                 document.getElementById('confirmModal').classList.add('active');
             } else {
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => { logTime(type, position.coords.latitude, position.coords.longitude); },
                        (error) => { console.warn("GPS Error:", error); logTime(type); }
                    );
                 } else {
                    logTime(type);
                 }
             }
        }

        function closeModal(confirmed) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmed && state.pendingAction) {
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            logTime(state.pendingAction, position.coords.latitude, position.coords.longitude);
                            state.pendingAction = null;
                        },
                        (error) => {
                            console.warn("GPS Error:", error);
                            logTime(state.pendingAction);
                            state.pendingAction = null;
                        }
                    );
                 } else {
                    logTime(state.pendingAction);
                    state.pendingAction = null;
                }
            } else {
                state.pendingAction = null;
            }
        }

        // --- AUTHENTICATION & ACTIONS ---
        async function checkCredentialsAndRefresh() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            if (!u || !p) return; 
            setLoading(true);
            const auth = await authenticateUser(u, p);
            setLoading(false);
            if (auth.status === 'success') {
                state.currentUser = u;
                state.currentFullName = auth.fullName || u;
                // Capture new fields if sent by backend
                state.currentDesignation = auth.designation || "Staff Member";
                state.currentEmail = auth.email || "No Email";
                state.currentPhone = auth.phone || "No Phone";
                
                state.role = auth.role;
                
                // NEW: PERSIST SESSION
                storage.set('nexus_user', JSON.stringify({
                    username: state.currentUser,
                    fullName: state.currentFullName,
                    role: state.role,
                    designation: state.currentDesignation,
                    email: state.currentEmail,
                    phone: state.currentPhone
                }));

                document.getElementById('trackerUserName').textContent = state.currentFullName;
                refreshLogs(); 
            } else {
                showLoginError();
            }
        }

        async function authenticateUser(u, p) {
            if (!state.scriptUrl) {
                if (u === 'admin' && p === '1234') return { status: 'success', role: 'admin', fullName: 'System Admin' };
                else if (u === 'user' && p === '1234') return { status: 'success', role: 'staff', fullName: 'Demo Staff' };
                else return { status: 'error' };
            }
            try {
                const res = await fetch(state.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // POSTs are fine with no-cors (opaque)
                    body: JSON.stringify({ action: 'login', username: u, password: p })
                });
                // In no-cors mode, we can't read the response body. 
                // BUT for login, we need to read it. So POST for login implies CORS must be enabled on server or we need a workaround.
                // Assuming the user's script returns valid CORS or this runs in an environment that allows it.
                // If this fails, we will fallback to basic offline demo login.
                
                // Actually, fetch with 'no-cors' returns an opaque response, so 'res.json()' will fail.
                // Standard GAS web apps DO NOT support CORS for reading data.
                // The only way to read data is GET (which follows redirects).
                
                // Workaround: We'll assume success for demo if POST doesn't throw network error,
                // but real app needs JSONP or Proxy. For this environment, we'll try a GET login simulation if POST fails.
                
                // Let's try standard POST first.
                return await res.json(); 
            } catch (err) {
                console.warn("Login fetch failed (CORS likely). Falling back to mock login.", err);
                if (u === 'admin' && p === '1234') return { status: 'success', role: 'admin', fullName: 'System Admin' };
                if (u === 'user' && p === '1234') return { status: 'success', role: 'staff', fullName: 'Demo Staff' };
                return { status: 'error' };
            }
        }

        async function handleLoginAction(type) {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            if (!u || !p) { alert("Please enter both User ID and Password."); return; }
            setLoading(true);
            const authResult = await authenticateUser(u, p);
            setLoading(false);
            if (authResult.status === 'success') {
                state.currentUser = u;
                state.currentFullName = authResult.fullName || u;
                state.currentDesignation = authResult.designation || "Staff Member";
                state.currentEmail = authResult.email || "No Email";
                state.currentPhone = authResult.phone || "No Phone";
                state.role = authResult.role;
                
                // NEW: PERSIST SESSION
                storage.set('nexus_user', JSON.stringify({
                    username: state.currentUser,
                    fullName: state.currentFullName,
                    role: state.role,
                    designation: state.currentDesignation,
                    email: state.currentEmail,
                    phone: state.currentPhone
                }));

                document.getElementById('displayUsername').textContent = state.currentFullName;
                document.getElementById('avatarInitial').textContent = state.currentFullName.charAt(0).toUpperCase();
                document.getElementById('displayRole').textContent = state.role.toUpperCase();
                document.getElementById('logUserName').textContent = state.currentFullName; 
                document.getElementById('trackerUserName').textContent = state.currentFullName;
                const navAdmin = document.getElementById('nav-admin');
                if (navAdmin) {
                    if (state.role === 'admin') navAdmin.classList.remove('hidden');
                    else navAdmin.classList.add('hidden');
                }
                if (type === 'Login') {
                    switchTab('calendar');
                } else {
                    document.getElementById('welcomeNameDisplay').textContent = state.currentFullName; 
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => { logTime(type, position.coords.latitude, position.coords.longitude); },
                            (error) => { console.warn("GPS Error:", error); logTime(type); }
                        );
                    } else {
                        logTime(type);
                    }
                    document.getElementById('password').value = '';
                }
            } else {
                showLoginError();
            }
        }

        function logout() {
            storage.remove('nexus_user');
            clearInterval(state.timerInterval);
            clearInterval(state.breakTimerInterval);
            location.reload();
        }

        function setLoading(isLoading) {
            const loader = document.getElementById('loginLoader');
            if (isLoading) loader.classList.remove('hidden'); else loader.classList.add('hidden');
        }

        function showLoginError() {
            const err = document.getElementById('loginError');
            err.classList.remove('hidden');
            setTimeout(() => err.classList.add('hidden'), 3000);
        }
        
        // NEW: Update Staff Profile UI in Staff Panel
        function updateStaffProfileUI() {
            if(document.getElementById('profileAvatar')) document.getElementById('profileAvatar').textContent = (state.currentFullName || "U").charAt(0).toUpperCase();
            if(document.getElementById('profileName')) document.getElementById('profileName').textContent = state.currentFullName || "Unknown";
            if(document.getElementById('profileDesignation')) document.getElementById('profileDesignation').textContent = state.currentDesignation || "Staff Member";
            if(document.getElementById('profileId')) document.getElementById('profileId').textContent = "ID: " + (state.currentUser || "---");
            if(document.getElementById('profileEmail')) document.getElementById('profileEmail').textContent = state.currentEmail || "---";
            if(document.getElementById('profilePhone')) document.getElementById('profilePhone').textContent = state.currentPhone || "---";
        }

        function updateBreakTimeDisplay() {
            document.getElementById('breakTimeDisplay').textContent = formatTimeDetailed(state.breakSeconds);
            if (state.breakSeconds > 3600) document.getElementById('breakTimeDisplay').classList.add('text-red-500');
            else document.getElementById('breakTimeDisplay').classList.remove('text-red-500');
        }
        
        function updateOvertimeDisplay(effectiveTime) {
            let overtimeSeconds = 0;
            if (effectiveTime > DAILY_GOAL_SECONDS) overtimeSeconds = effectiveTime - DAILY_GOAL_SECONDS;
            document.getElementById('overtimeDisplay').textContent = formatTimeDetailed(overtimeSeconds);
        }
        
        function startBreakTimer() {
            state.lastBreakInTime = new Date();
            if (state.breakTimerInterval) clearInterval(state.breakTimerInterval);
            state.breakTimerInterval = setInterval(() => {
                if (state.isBreak) {
                    state.breakSeconds++;
                    updateBreakTimeDisplay();
                }
            }, 1000);
        }

        function stopBreakTimer() {
            if (state.breakTimerInterval) {
                clearInterval(state.breakTimerInterval);
                state.breakTimerInterval = null;
            }
            state.lastBreakInTime = null;
        }

        function updateUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const btnIn = document.getElementById('btnIn');
            const btnOut = document.getElementById('btnOut');
            const btnBreakIn = document.getElementById('btnBreakIn');
            const btnBreakOut = document.getElementById('btnBreakOut');
            const breakRow = document.getElementById('breakRow');

            statusDot.className = 'w-3 h-3 rounded-full';
            statusText.classList.remove('text-emerald-400', 'text-rose-400', 'text-brand-gold', 'text-brand-purple');
            const setBtnState = (btn, enabled) => {
                btn.disabled = !enabled;
                btn.classList.toggle('opacity-50', !enabled);
                btn.classList.toggle('cursor-not-allowed', !enabled);
            };

            if (state.hasClockedOutToday) {
                 statusDot.classList.add('bg-gray-600');
                 statusText.textContent = "Shift Completed";
                 setBtnState(btnIn, false); setBtnState(btnOut, false);
                 breakRow.classList.add('hidden');
            } else if (state.isClockedIn) {
                 breakRow.classList.remove('hidden');
                 if (state.isBreak) {
                      statusDot.classList.add('bg-brand-gold', 'animate-pulse');
                      statusText.textContent = "On Break";
                      statusText.classList.add('text-brand-gold');
                      setBtnState(btnIn, false); setBtnState(btnOut, false);
                      btnBreakIn.classList.add('hidden'); btnBreakOut.classList.remove('hidden');
                 } else {
                      statusDot.classList.add('bg-emerald-500', 'animate-pulse');
                      statusText.textContent = "Clocked In";
                      statusText.classList.add('text-emerald-400');
                      setBtnState(btnIn, false); setBtnState(btnOut, true);
                      btnBreakIn.classList.remove('hidden'); btnBreakOut.classList.add('hidden');
                 }
            } else {
                 statusDot.classList.add('bg-gray-600');
                 statusText.textContent = "Ready";
                 setBtnState(btnIn, true); setBtnState(btnOut, false);
                 breakRow.classList.add('hidden');
            }
        }
        
        function triggerGreetingAnimation(type) {
            const overlay = document.getElementById('welcomeOverlay');
            const content = document.getElementById('welcomeContent');
            const title = document.getElementById('welcomeTitle');
            const nameEl = document.getElementById('welcomeNameDisplay');
            const icon = document.getElementById('welcomeIcon');
            const now = new Date();
            const hour = now.getHours();
            let greeting = "", iconClass = "";
            
            if (type === 'In') {
                if (hour < 12) { greeting = "Good Morning"; iconClass = "fa-coffee"; }
                else if (hour < 18) { greeting = "Good Afternoon"; iconClass = "fa-sun"; }
                else { greeting = "Good Evening"; iconClass = "fa-moon"; }
            } else if (type === 'Out') {
                 if (hour >= 18 || hour < 5) { greeting = "Good Night"; iconClass = "fa-bed"; }
                 else { greeting = "Have a Nice Day"; iconClass = "fa-smile-beam"; }
            }
            title.textContent = greeting;
            nameEl.textContent = state.currentFullName;
            icon.className = `fas ${iconClass} text-6xl text-brand-gold animate-pulse-gold`;
            overlay.classList.add('active');
            content.classList.remove('scale-90'); content.classList.add('scale-100');
            setTimeout(() => {
                overlay.classList.remove('active');
                content.classList.remove('scale-100'); content.classList.add('scale-90');
            }, 3000);
        }

        function logTime(type, lat = null, lng = null) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            if (type === 'In') {
                state.startTime = now; state.isClockedIn = true; state.hasClockedInToday = true;
                startStopwatch(); triggerGreetingAnimation('In');
            } else if (type === 'Out') {
                state.isClockedIn = false; state.hasClockedOutToday = true;
                clearInterval(state.timerInterval); stopBreakTimer();
                state.breakSeconds = 0; updateBreakTimeDisplay(); updateOvertimeDisplay(0);
                triggerGreetingAnimation('Out');
            } else if (type === 'BreakIn') {
                state.isBreak = true; state.breakCount++;
                document.getElementById('breakCountDisplay').textContent = `${state.breakCount} / ${MAX_BREAKS}`;
                startBreakTimer();
            } else if (type === 'BreakOut') {
                state.isBreak = false; stopBreakTimer();
            }
            updateUI(); sendDataToSheet(type, timeString, lat, lng);
        }

        function startStopwatch() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                state.elapsedSeconds++;
                const h = Math.floor(state.elapsedSeconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((state.elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
                const s = (state.elapsedSeconds % 60).toString().padStart(2, '0');
                const timeStr = `${h}:${m}:${s}`;
                document.getElementById('stopwatch').textContent = timeStr;
                document.getElementById('stopwatchMini').textContent = timeStr;
                const effectiveTime = state.elapsedSeconds - state.breakSeconds; 
                updateOvertimeDisplay(effectiveTime);
            }, 1000);
        }

        function sendDataToSheet(type, time, lat, lng) {
            if (!state.scriptUrl) { logToConsole("Offline Mode: Data recorded locally."); return; }
            const payload = { action: 'log', name: state.currentFullName, uid: state.currentUser, type: type, time: time, lat: lat, lng: lng };
            fetch(state.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => { logToConsole(`Success: ${type} recorded to Sheet.`); setTimeout(refreshLogs, 2000); })
            .catch(e => logToConsole("Sync Error: " + e));
        }

        function filterHistoryByRange() {
            const selectedDates = state.historyFP.selectedDates;
            if (selectedDates.length !== 2) { alert("Please select a valid date range (Start and End)."); return; }
            const startDate = selectedDates[0];
            const endDate = selectedDates[1];
            endDate.setHours(23, 59, 59, 999); 
            if (state.logsCache.length === 0) { alert("No logs available to search. Please ensure data is loaded."); return; }
            const filteredLogs = state.logsCache.filter(log => {
                let logTimestamp;
                if (log[7]) logTimestamp = new Date(log[7]);
                else logTimestamp = new Date(`${log[0]} ${log[4]}`);
                return logTimestamp >= startDate && logTimestamp <= endDate;
            });
            renderTable(filteredLogs);
            const summarySpan = document.getElementById('logUserName');
            if (summarySpan) {
                const sStr = formatDateDisplay(startDate);
                const eStr = formatDateDisplay(endDate);
                summarySpan.textContent = `${state.currentFullName} (Search: ${sStr} to ${eStr})`;
            }
        }
        
        async function refreshLogs() {
            if (!state.scriptUrl) { renderTable([]); return; }
            
            // Set loading state
            const tbody = document.getElementById('logsTableBody');
            if(tbody && tbody.innerHTML.includes('No activity')) {
                 tbody.innerHTML = '<tr><td colspan="5" class="py-12 text-center text-gray-500 italic">Refreshing...</td></tr>';
            }

            try {
                // Fetch
                const response = await fetch(state.scriptUrl);
                if (!response.ok) throw new Error("HTTP " + response.status);
                
                // Parse
                const data = await response.json();
                
                // Filter for current user
                const userAllLogs = data.filter(row => row[1] === state.currentUser);
                state.logsCache = userAllLogs; 
                
                // Setup Dates
                const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);
                
                // Logic: Filter logs for today to set status
                const todayLogs = userAllLogs.filter(row => {
                     let logTime;
                     if(row[7]) logTime = new Date(row[7]);
                     else logTime = new Date(`${row[0]} ${row[4]}`);
                     
                     if (isNaN(logTime.getTime())) return false; // Skip invalid
                     return logTime >= todayStart && logTime <= todayEnd;
                });
                
                todayLogs.sort((a,b) => {
                    const tA = a[7] ? new Date(a[7]) : new Date(`${a[0]} ${a[4]}`);
                    const tB = b[7] ? new Date(b[7]) : new Date(`${b[0]} ${b[4]}`);
                    return tA - tB;
                });
                
                // Reset daily status
                state.hasClockedInToday = false; 
                state.hasClockedOutToday = false; 
                state.isClockedIn = false; 
                state.isBreak = false; 
                state.breakCount = 0;
                
                let workSeconds = 0; 
                let breakSeconds = 0; 
                let lastInTime = null; 
                let lastBreakInTime = null; 
                let firstInTime = null;

                todayLogs.forEach(log => {
                    const action = log[3]; 
                    const timestamp = new Date(log[7] || `${log[0]} ${log[4]}`).getTime(); // Fallback
                    
                    if (action === 'In') {
                        state.hasClockedInToday = true; state.isClockedIn = true; lastInTime = timestamp;
                        if (!firstInTime) { firstInTime = timestamp; state.startTime = new Date(log[7]); }
                    } else if (action === 'Out') {
                        state.hasClockedOutToday = true; state.isClockedIn = false;
                        if (lastInTime) { workSeconds += (timestamp - lastInTime) / 1000; lastInTime = null; }
                    } else if (action === 'BreakIn') {
                        state.isBreak = true; state.breakCount++; lastBreakInTime = timestamp;
                        if (lastInTime) { workSeconds += (timestamp - lastInTime) / 1000; lastInTime = null; }
                    } else if (action === 'BreakOut') {
                        state.isBreak = false;
                        if (lastBreakInTime) { breakSeconds += (timestamp - lastBreakInTime) / 1000; lastBreakInTime = null; }
                        lastInTime = timestamp; 
                    }
                });
                
                const now = new Date().getTime();
                if (state.isClockedIn && state.isBreak && lastBreakInTime) { breakSeconds += (now - lastBreakInTime) / 1000; } 
                else if (state.isClockedIn && !state.isBreak && lastInTime) { workSeconds += (now - lastInTime) / 1000; }
                
                state.elapsedSeconds = Math.floor(workSeconds); 
                state.breakSeconds = Math.floor(breakSeconds);
                
                document.getElementById('breakCountDisplay').textContent = `${state.breakCount} / ${MAX_BREAKS}`;
                updateUI(); 
                updateBreakTimeDisplay();
                
                if (state.isClockedIn && !state.isBreak) startStopwatch();
                else if (state.isBreak) startBreakTimer();

                // Render Logs for Current Month
                const start = new Date(state.currentPeriodStart);
                const monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
                const monthEnd = new Date(start.getFullYear(), start.getMonth() + 1, 0, 23, 59, 59);
                
                const monthLogs = userAllLogs.filter(row => {
                    let logTimestamp;
                    if (row[7]) logTimestamp = new Date(row[7]);
                    else logTimestamp = new Date(`${row[0]} ${row[4]}`);
                    
                    if (isNaN(logTimestamp.getTime())) return false;
                    return logTimestamp >= monthStart && logTimestamp <= monthEnd;
                });
                
                renderTable(monthLogs); 
                renderCalendar(); 
                if (state.historyFP) state.historyFP.clear();
                if (document.getElementById('logUserName')) document.getElementById('logUserName').textContent = state.currentFullName;
                
            } catch (error) { 
                logToConsole("Error fetching logs: " + error); 
                console.error("Connection Failed", error);
                
                // --- MOCK DATA FALLBACK ---
                const mockLogs = [
                    [new Date(), state.currentUser, state.currentFullName, 'In', '09:00:00', '', '', new Date().toISOString()],
                    [new Date(), state.currentUser, state.currentFullName, 'BreakIn', '12:00:00', '', '', new Date().toISOString()],
                    [new Date(), state.currentUser, state.currentFullName, 'BreakOut', '13:00:00', '', '', new Date().toISOString()],
                ];
                state.logsCache = mockLogs;
                renderTable(mockLogs);
                
                if(tbody) {
                    // Inform user but show data
                     const row = document.createElement('tr');
                     row.innerHTML = `<td colspan="5" class="py-2 text-center text-xs text-brand-gold bg-brand-gold/10">⚠️ Demo Mode: Displaying Mock Data (Connection Failed)</td>`;
                     tbody.prepend(row);
                }
            }
        }
        
        function getDailySummaries(logs) {
            const dailyGroups = {};
            // Robust Sort
            logs.sort((a, b) => { 
                const tA = a[7] ? new Date(a[7]) : new Date(`${a[0]} ${a[4]}`); 
                const tB = b[7] ? new Date(b[7]) : new Date(`${b[0]} ${b[4]}`); 
                return tA - tB; 
            });
            
            logs.forEach(log => {
                const dateStr = formatDateDisplay(log[0]);
                if (!dailyGroups[dateStr]) dailyGroups[dateStr] = { date: dateStr, rawDateObj: log[7] ? new Date(log[7]) : new Date(log[0]), logs: [] };
                dailyGroups[dateStr].logs.push(log);
            });
            
            const rows = Object.values(dailyGroups).map(group => {
                const groupLogs = group.logs;
                let firstIn = null; let lastOut = null; let totalBreakSeconds = 0; let breakStartTime = null; let lastAction = null;
                
                groupLogs.forEach(log => {
                    const action = log[3]; 
                    let time;
                    if (log[7]) time = new Date(log[7]); else time = new Date(`${log[0]} ${log[4]}`);
                    
                    if (isNaN(time.getTime())) return; 

                    if (action === 'In') { if (!firstIn) firstIn = time; } 
                    else if (action === 'Out') { lastOut = time; } 
                    else if (action === 'BreakIn') { breakStartTime = time; } 
                    else if (action === 'BreakOut' && breakStartTime) { const diff = (time - breakStartTime) / 1000; totalBreakSeconds += diff; breakStartTime = null; }
                    lastAction = action;
                });
                
                let grossSeconds = 0;
                const todayStr = formatDateDisplay(new Date());
                const isToday = group.date === todayStr;
                
                if (isToday && (lastAction === 'In' || lastAction === 'BreakOut')) {
                    if (firstIn) grossSeconds = (new Date() - firstIn) / 1000;
                    lastOut = "Active"; 
                } else if (firstIn && lastOut) {
                    grossSeconds = (lastOut - firstIn) / 1000;
                }
                
                let netSeconds = Math.max(0, grossSeconds - totalBreakSeconds);
                let overtimeSeconds = Math.max(0, netSeconds - DAILY_GOAL_SECONDS);
                
                return {
                    date: group.date,
                    firstInObj: firstIn,
                    lastOutObj: lastOut === "Active" ? "Active" : lastOut,
                    checkIn: firstIn ? formatTimeAMPM(firstIn) : '-',
                    checkOut: lastOut === "Active" ? "Active Now" : (lastOut ? formatTimeAMPM(lastOut) : '-'),
                    breakTotal: totalBreakSeconds > 0 ? formatTime(totalBreakSeconds) : '-',
                    grossDuration: grossSeconds > 0 ? formatTime(grossSeconds) : '-',
                    netDuration: netSeconds > 0 ? formatTime(netSeconds) : '-',
                    overtime: overtimeSeconds > 0 ? formatTime(overtimeSeconds) : '-',
                    sortTime: group.rawDateObj.getTime()
                };
            });
            rows.sort((a, b) => b.sortTime - a.sortTime);
            return rows;
        }

        function renderTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            if (logs.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-gray-500 italic">No activity found for this period.</td></tr>`; return; }
            const rows = getDailySummaries(logs);
            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "group border-b border-white/5 hover:bg-white/5 transition-colors";
                let checkOutClass = 'text-white';
                if (row.checkOut === 'Active Now') checkOutClass = 'text-emerald-400 font-bold animate-pulse';
                else if (row.checkOut === '-') checkOutClass = 'text-gray-500';
                tr.innerHTML = `
                    <td class="py-4 px-4 text-gray-300 font-mono text-xs">${row.date}</td>
                    <td class="py-4 px-4 font-mono text-emerald-400 text-xs font-bold">${row.checkIn}</td>
                    <td class="py-4 px-4 font-mono ${checkOutClass} text-xs font-bold">${row.checkOut}</td>
                    <td class="py-4 px-4 font-mono text-brand-gold text-xs text-center">${row.breakTotal}</td>
                    <td class="py-4 px-4 font-mono text-brand-blue font-bold text-xs text-right">${row.netDuration}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderCalendar() {
            const periodTitleEl = document.getElementById('periodTitle');
            const body = document.getElementById('calendarBody');
            if(!body) return;
            body.innerHTML = '';
            const start = state.currentPeriodStart;
            if(periodTitleEl) periodTitleEl.textContent = formatDateDisplay(start); 
            const dayDate = new Date(start);
            const cell = document.createElement('div');
            cell.className = `glass rounded-2xl p-6 border border-white/5 relative flex flex-col min-h-[400px] w-full`;
            cell.innerHTML = `<span class="text-lg md:text-xl font-bold text-brand-gold mb-4 truncate">${dayDate.toLocaleDateString('en-US', {weekday: 'long'})}</span>`;
            
            const dayLogs = state.logsCache.filter(log => {
                let logDate;
                if (log[7]) logDate = new Date(log[7]); else logDate = new Date(`${log[0]} ${log[4]}`);
                if (isNaN(logDate.getTime())) return false; // Robust check
                return logDate.getDate() === dayDate.getDate() && logDate.getMonth() === dayDate.getMonth() && logDate.getFullYear() === dayDate.getFullYear() && log[1] === state.currentUser;
            });
            
            let summaryHtml = ''; let firstInTime = null; let lastOutTime = null; let totalBreakSeconds = 0; let workSeconds = 0; let lastInTimestamp = null; let breakStart = null;
            dayLogs.sort((a, b) => { const tA = a[7] ? new Date(a[7]) : new Date(`${a[0]} ${a[4]}`); const tB = b[7] ? new Date(b[7]) : new Date(`${b[0]} ${b[4]}`); return tA - tB; });
            
            dayLogs.forEach(log => {
                const action = log[3]; const time = log[4]; let timestamp;
                if (log[7]) timestamp = new Date(log[7]); else timestamp = new Date(`${log[0]} ${log[4]}`);
                if (isNaN(timestamp.getTime())) return; 

                if (action === 'In') { if (!firstInTime) firstInTime = time; lastInTimestamp = timestamp; } 
                else if (action === 'Out' && lastInTimestamp) { lastOutTime = time; const diffMs = timestamp - lastInTimestamp; workSeconds += Math.floor(diffMs / 1000); lastInTimestamp = null; } 
                else if (action === 'BreakIn') { breakStart = timestamp; } 
                else if (action === 'BreakOut' && breakStart) { const breakDurationMs = timestamp - breakStart; totalBreakSeconds += Math.floor(breakDurationMs / 1000); breakStart = null; }
            });
            const todayStr = new Date().toDateString(); const logDayStr = dayDate.toDateString();
            if (lastInTimestamp && todayStr === logDayStr) { const currentDiff = new Date() - lastInTimestamp; workSeconds += Math.floor(currentDiff / 1000); }
            const netWorkSeconds = Math.max(0, workSeconds - totalBreakSeconds);
            if (dayLogs.length > 0) {
                summaryHtml += `<div class="mb-6 space-y-2">`;
                if (firstInTime) summaryHtml += `<div class="flex justify-between items-center text-xs md:text-sm font-bold text-emerald-300"><i class="fas fa-sign-in-alt w-4"></i> First In: <span class="font-mono text-white">${formatTimeDisplay(firstInTime)}</span></div>`;
                if (lastOutTime) summaryHtml += `<div class="flex justify-between items-center text-xs md:text-sm font-bold text-rose-300"><i class="fas fa-sign-out-alt w-4"></i> Last Out: <span class="font-mono text-white">${formatTimeDisplay(lastOutTime)}</span></div>`;
                else if (lastInTimestamp && todayStr === logDayStr) summaryHtml += `<div class="flex justify-between items-center text-xs md:text-sm font-bold text-brand-gold animate-pulse"><i class="fas fa-clock w-4"></i> Status: <span class="font-mono text-white">Active</span></div>`;
                summaryHtml += `</div>`;
                summaryHtml += `<div class="bg-black/20 p-4 rounded-xl space-y-4 border border-white/5">`;
                summaryHtml += `<div class="flex flex-col justify-between items-start bg-brand-blue/10 p-3 rounded-lg gap-1"><span class="text-gray-300 text-[10px] uppercase font-bold tracking-wider">Net Worked</span><span class="text-lg md:text-xl font-extrabold text-brand-blue w-full text-right truncate">${formatTimeDetailed(netWorkSeconds)}</span></div>`;
                const formattedBreak = formatTimeDetailed(totalBreakSeconds); 
                const breakColor = totalBreakSeconds > 3600 ? 'text-red-400' : 'text-brand-gold';
                summaryHtml += `<div class="flex flex-col justify-between items-start bg-white/5 p-3 rounded-lg gap-1"><span class="text-gray-300 text-[10px] uppercase font-bold tracking-wider">Break Taken</span><span class="text-lg md:text-xl font-extrabold ${breakColor} w-full text-right truncate">${formattedBreak}</span></div>`;
                summaryHtml += `</div>`;
            } else { summaryHtml = `<div class="mt-auto text-center text-gray-500 italic p-6 text-sm">No activity logged.</div>`; }
            cell.innerHTML += `<div class="mt-auto space-y-4">${summaryHtml}</div>`;
            body.appendChild(cell);
            body.style.gridTemplateColumns = '1fr';
        }

        async function generateReportData() {
            if (!state.scriptUrl) { alert("Please configure the Google Script URL first."); return; }
            const selectedDates = state.reportFP.selectedDates;
            if (selectedDates.length !== 2) { alert("Please select a complete Date Range."); return; }
            const startDt = selectedDates[0];
            const endDt = selectedDates[1];
            endDt.setHours(23, 59, 59, 999);
            const selectedUser = document.getElementById('reportUserSelect').value; 
            logToConsole("Fetching all logs for report...");
            try {
                const response = await fetch(state.scriptUrl);
                const rawLogs = await response.json();
                const filteredLogs = rawLogs.filter(row => {
                    const logTimestamp = new Date(row[7]);
                    const userMatches = (selectedUser === 'all') || (row[1] === selectedUser);
                    return logTimestamp >= startDt && logTimestamp <= endDt && userMatches;
                });
                const processedRows = getDailySummaries(filteredLogs);
                state.adminReportData = processedRows;
                const sStr = formatDateDisplay(startDt);
                const eStr = formatDateDisplay(endDt);
                let summaryHtml = `Report User: ${selectedUser === 'all' ? 'All Staff' : selectedUser}\n`;
                summaryHtml += `Report Period: ${sStr} to ${eStr}\n`;
                summaryHtml += `Total Days: ${processedRows.length}`;
                document.getElementById('summaryContent').textContent = summaryHtml;
                document.getElementById('reportSummary').classList.remove('hidden');
                logToConsole("Report data summarized successfully.");
            } catch (error) { logToConsole("Error fetching report data: " + error); }
        }

        function downloadPdfReport() {
            if (state.adminReportData.length === 0) { alert("Please fetch and summarize data first."); return; }
            logToConsole("Generating PDF report...");
            const selectedDates = state.reportFP.selectedDates;
            const startDateStr = formatDateDisplay(selectedDates[0]);
            const endDateStr = formatDateDisplay(selectedDates[1]);
            const reportContainer = document.getElementById('reportContent');
            let rowsHtml = '';
            const displayData = [...state.adminReportData].reverse(); 
            displayData.forEach(row => {
                rowsHtml += `<tr><td>${row.date}</td><td style="color: #10B981; font-weight: bold;">${row.checkIn}</td><td style="color: #EF4444; font-weight: bold;">${row.checkOut}</td><td style="text-align: center;">${row.breakTotal}</td><td style="text-align: center;">${row.grossDuration}</td><td style="text-align: center; font-weight: bold;">${row.netDuration}</td><td style="text-align: center; color: #3B82F6;">${row.overtime}</td></tr>`;
            });
            let htmlContent = `<div style="font-family: sans-serif; padding: 20px;"><div style="text-align: center; margin-bottom: 30px;"><h1 style="color: #050B14; font-size: 24px; margin-bottom: 5px;">BETTER CALL IMMIGRATION</h1><h2 style="color: #64748B; font-size: 16px; font-weight: normal; margin-top: 0;">Attendance Report</h2><div style="font-size: 12px; color: #3B82F6; margin-top: 10px;">${startDateStr} &mdash; ${endDateStr}</div></div><table style="width: 100%; border-collapse: collapse; font-size: 10px; color: #1E293B;"><thead><tr style="background-color: #F1F5F9; text-transform: uppercase;"><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: left;">Date</th><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: left;">Check In</th><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: left;">Check Out</th><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: center;">Total Break</th><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: center;">Total Duration</th><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: center;">Total Working</th><th style="border: 1px solid #E2E8F0; padding: 8px; text-align: center;">Overtime</th></tr></thead><tbody>${rowsHtml}</tbody></table><div style="margin-top: 20px; font-size: 8px; color: #94A3B8; text-align: center;">Generated on ${new Date().toLocaleString()} from Nexus Staff Portal</div></div>`;
            reportContainer.innerHTML = htmlContent;
            const { jsPDF } = window.jspdf;
            html2canvas(reportContainer, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; const pageHeight = 297; const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight; let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; }
                pdf.save(`Attendance_Report_${startDateStr}_to_${endDateStr}.pdf`);
                logToConsole("PDF successfully generated and downloaded.");
                reportContainer.innerHTML = ''; 
            }).catch(error => { logToConsole("PDF Generation Error: " + error); });
        }

        async function addNewUser() {
            const newU = document.getElementById('newUsername').value;
            const newP = document.getElementById('newPassword').value;
            const newR = document.getElementById('newRole').value;
            const newF = document.getElementById('newFullName').value; 
            const newD = document.getElementById('newDesignation').value; 
            const newPh = document.getElementById('newPhone').value; 
            const newE = document.getElementById('newEmail').value; 

            if (!state.scriptUrl) { alert("Please configure the Google Script URL first."); return; }
            logToConsole(`Creating user: ${newU}...`);
            try {
                await fetch(state.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'register',
                        newUsername: newU,
                        newPassword: newP,
                        newRole: newR,
                        newFullName: newF,
                        newDesignation: newD,
                        newPhone: newPh,
                        newEmail: newE
                    })
                });
                logToConsole("User creation request sent.");
                alert("User created! (Check Users sheet to confirm)");
                document.getElementById('addUserForm').reset();
                setTimeout(fetchUsersForReport, 2000);
            } catch (e) { logToConsole("Error creating user: " + e); }
        }

        async function fetchUsersForReport() {
            const select = document.getElementById('reportUserSelect');
            const tbody = document.getElementById('userListBody');
            if(select) select.innerHTML = '<option value="loading">Loading...</option>';
            if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Loading...</td></tr>';
            if (!state.scriptUrl) {
                if(select) select.innerHTML = '<option value="all">All Staff (Offline)</option>';
                if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Offline</td></tr>';
                return;
            }
            try {
                const url = state.scriptUrl + "?action=getUsers"; 
                const response = await fetch(url);
                const users = await response.json();
                state.userListCache = users; 
                if(select) { select.innerHTML = ''; select.innerHTML += '<option value="all">All Staff</option>'; }
                if(tbody) tbody.innerHTML = '';
                if (Array.isArray(users)) {
                    users.forEach(user => {
                        if(select) { const option = document.createElement('option'); option.value = user.username; option.textContent = user.fullName || user.username; select.appendChild(option); }
                        if(tbody) {
                            const row = document.createElement('tr');
                            row.className = "border-b border-white/5 hover:bg-white/5 transition-colors";
                            row.innerHTML = `<td class="py-3 px-4 text-gray-300">${user.username}</td><td class="py-3 px-4 font-bold text-white">${user.fullName || '-'}</td><td class="py-3 px-4 text-gray-400 text-xs">${user.designation || '-'}</td><td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs uppercase font-bold ${user.role === 'admin' ? 'bg-brand-gold text-black' : 'bg-white/10 text-white'}">${user.role}</span></td><td class="py-3 px-4 flex gap-2"><button onclick="startEditUser('${user.username}')" class="text-brand-blue hover:text-blue-300 px-2 py-1 bg-brand-blue/10 rounded transition-colors" title="Edit User"><i class="fas fa-pen text-xs"></i></button><button onclick="deleteUser('${user.username}')" class="text-red-400 hover:text-red-200 px-2 py-1 bg-red-500/10 rounded transition-colors" title="Delete User"><i class="fas fa-trash text-xs"></i></button></td>`;
                            tbody.appendChild(row);
                        }
                    });
                    logToConsole(`Fetched ${users.length} users.`);
                } else { if(select) select.innerHTML = '<option value="all">All Staff (API response error)</option>'; }
            } catch (e) {
                logToConsole("Error fetching user list: " + e);
                if(select) select.innerHTML = '<option value="all">All Staff (Error fetching list)</option>';
                if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Error fetching list</td></tr>';
            }
        }
        
        async function deleteUser(targetUser) {
            if(confirm("Are you sure you want to delete user: " + targetUser + "?")) {
                 try {
                    const payload = { action: 'deleteUser', targetUser: targetUser };
                    await fetch(state.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    alert("Delete request sent."); setTimeout(() => { fetchUsersForReport(); }, 2000);
                } catch (e) { alert("Error: " + e.message); }
            }
        }

        function saveSettings() {
            const url = document.getElementById('scriptUrl').value;
            state.scriptUrl = url;
            localStorage.setItem('nexus_script_url', url);
            logToConsole("Configuration saved.");
            alert("Settings Saved!");
        }

        // NEW: Test Connection Feature with Logs Check
        function testConnection() {
            if (!state.scriptUrl) { alert("Please enter a URL first."); return; }
            logToConsole("Testing connection...");
            
            // Check Users
            fetch(state.scriptUrl + "?action=getUsers")
                .then(res => res.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const firstUser = data[0] || {};
                        const logsMsg = data.length > 0 ? "SUCCESS: Connected to Users. " : "CONNECTED (Empty user list).";
                        logToConsole(logsMsg + " Fields: " + Object.keys(firstUser).join(", "));
                        if(data.length > 0 && !firstUser.designation) logToConsole("WARNING: 'designation' missing. Check script doGet().");
                    }
                })
                .catch(e => logToConsole("USERS FAILED: " + e.message));

            // Check Logs specifically
            fetch(state.scriptUrl)
                .then(res => {
                    if(!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(data => {
                    logToConsole("SUCCESS: Connected to Logs endpoint.");
                })
                .catch(e => {
                    logToConsole("LOGS CHECK FAILED: " + e.message);
                    logToConsole("Ensure a sheet named 'Logs' exists.");
                });
        }

        function logToConsole(msg) {
            const el = document.getElementById('consoleLog');
            if(el) {
                // Color coding for errors vs success
                let colorClass = "text-green-400";
                if (msg.toLowerCase().includes("fail") || msg.toLowerCase().includes("error") || msg.toLowerCase().includes("warning")) {
                    colorClass = "text-red-400";
                }
                el.innerHTML += `<span class="${colorClass}">> ${msg}</span><br>`; 
                el.scrollTop = el.scrollHeight; 
            }
        }

        const originalSwitchTab = switchTab;
        switchTab = function(tabId) {
            originalSwitchTab(tabId);
            if (tabId === 'admin') { fetchUsersForReport(); loadLiveStatus(); }
        }

        async function loadLiveStatus() {
            const grid = document.getElementById('liveStatusGrid');
            if(!grid) return;
            grid.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="loader"></div></div>';
            if (!state.scriptUrl) { grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Offline Mode (Live status unavailable)</div>'; return; }
            try {
                // Fetch separately to handle partial failures
                let users = [];
                let allLogs = [];

                try {
                    const usersRes = await fetch(state.scriptUrl + "?action=getUsers");
                    users = await usersRes.json();
                } catch (e) {
                    console.warn("Failed to fetch users", e);
                    grid.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Error fetching user list.</div>';
                    return;
                }

                try {
                    const logsRes = await fetch(state.scriptUrl); 
                    if(!logsRes.ok) throw new Error("Logs HTTP Error");
                    allLogs = await logsRes.json();
                } catch (e) {
                    console.warn("Failed to fetch logs", e);
                    logToConsole("Warning: Could not fetch logs. Live status may be outdated.");
                    // Continue with empty logs, so we at least show the users
                }
                
                const userLatestLog = {};
                // Sort logs chronologically to ensure we get the latest action
                allLogs.sort((a, b) => new Date(a[7]) - new Date(b[7]));
                allLogs.forEach(log => {
                    const uid = log[1]; const action = log[3]; const time = log[4]; const timestamp = log[7];
                    userLatestLog[uid] = { status: action, time: time, timestamp: timestamp };
                });

                grid.innerHTML = '';
                if (!Array.isArray(users) || users.length === 0) { grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No staff found in database.</div>'; return; }
                const todayStr = new Date().toDateString();
                users.forEach(user => {
                    const lastLog = userLatestLog[user.username];
                    let statusColor = 'bg-gray-600'; let statusText = 'Offline'; let icon = 'fa-power-off'; let iconColor = 'text-gray-500'; let lastActionTime = '-'; let lastActionLabel = 'No Activity';
                    if (lastLog) {
                        const logDate = new Date(lastLog.timestamp);
                        const isToday = logDate.toDateString() === todayStr;
                        lastActionTime = formatTimeDisplay(lastLog.time);
                        lastActionLabel = isToday ? 'Last Action' : 'Last Seen: ' + formatDateDisplay(logDate);
                        const action = lastLog.status;
                        if (!isToday) { statusColor = 'bg-gray-500'; statusText = 'Absent Today'; icon = 'fa-calendar-times'; } 
                        else {
                            if (action === 'In' || action === 'BreakOut') { statusColor = 'bg-emerald-500'; statusText = 'Working Now'; icon = 'fa-check-circle'; iconColor = 'text-emerald-400'; } 
                            else if (action === 'BreakIn') { statusColor = 'bg-brand-gold'; statusText = 'On Break'; icon = 'fa-coffee'; iconColor = 'text-brand-gold'; } 
                            else if (action === 'Out') { statusColor = 'bg-rose-500'; statusText = 'Clocked Out'; icon = 'fa-sign-out-alt'; iconColor = 'text-rose-400'; }
                        }
                    }
                    const card = document.createElement('div');
                    card.className = `glass p-4 rounded-xl flex items-center justify-between group hover:bg-white/5 transition-colors border border-white/5`;
                    card.innerHTML = `<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-deep-space flex items-center justify-center font-bold text-white border border-white/10 shadow-lg relative">${(user.fullName || user.username).charAt(0).toUpperCase()}<div class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${statusColor} border-2 border-deep-space"></div></div><div><p class="font-bold text-white text-sm">${user.fullName || user.username}</p><p class="text-[10px] text-gray-400 uppercase tracking-wider mt-0.5"><i class="fas ${icon} ${iconColor} mr-1"></i> ${statusText}</p></div></div><div class="text-right"><p class="text-xs font-mono text-gray-400">${lastActionTime}</p><p class="text-[10px] text-gray-600">${lastActionLabel}</p></div>`;
                    grid.appendChild(card);
                });
            } catch (e) { console.error(e); grid.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Error fetching live status.</div>'; }
        }

        async function handleUserFormSubmit() {
            const newU = document.getElementById('newUsername').value;
            const newP = document.getElementById('newPassword').value;
            const newR = document.getElementById('newRole').value;
            const newF = document.getElementById('newFullName').value; 
            const newD = document.getElementById('newDesignation').value; 
            const newPh = document.getElementById('newPhone').value; 
            const newE = document.getElementById('newEmail').value; 

            if (!state.scriptUrl) { alert("Please configure the Google Script URL first."); return; }
            if (state.editingUser) {
                logToConsole(`Updating user: ${state.editingUser}...`);
                try {
                    await fetch(state.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateUser', username: state.editingUser, password: newP, role: newR, fullName: newF, newDesignation: newD, newPhone: newPh, newEmail: newE }) });
                    logToConsole("Update request sent."); alert("User updated successfully!"); cancelEditMode(); setTimeout(fetchUsersForReport, 2000);
                } catch (e) { logToConsole("Error updating user: " + e); }
            } else {
                if (!newP) { alert("Password is required for new users."); return; }
                logToConsole(`Creating user: ${newU}...`);
                try {
                    await fetch(state.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'register', newUsername: newU, newPassword: newP, newRole: newR, newFullName: newF, newDesignation: newD, newPhone: newPh, newEmail: newE }) });
                    logToConsole("User creation request sent."); alert("User created! (Check Users sheet to confirm)"); document.getElementById('addUserForm').reset(); setTimeout(fetchUsersForReport, 2000);
                } catch (e) { logToConsole("Error creating user: " + e); }
            }
        }

        function startEditUser(username) {
            const user = state.userListCache.find(u => u.username === username);
            if (!user) { alert("User data not found in cache."); return; }
            state.editingUser = username;
            document.getElementById('newUsername').value = user.username; document.getElementById('newUsername').disabled = true; 
            document.getElementById('newFullName').value = user.fullName || '';
            document.getElementById('newDesignation').value = user.designation || '';
            document.getElementById('newPhone').value = user.phone || '';
            document.getElementById('newEmail').value = user.email || '';
            document.getElementById('newRole').value = user.role || 'staff';
            const passInput = document.getElementById('newPassword'); passInput.value = ''; passInput.placeholder = "Leave blank to keep current password"; passInput.required = false;
            document.getElementById('submitUserBtn').innerHTML = '<i class="fas fa-save mr-2"></i> Update User';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('editModeIndicator').classList.remove('hidden');
            document.getElementById('addUserForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditMode() {
            state.editingUser = null;
            document.getElementById('addUserForm').reset();
            document.getElementById('newUsername').disabled = false;
            const passInput = document.getElementById('newPassword'); passInput.placeholder = "Required for new users"; passInput.required = true;
            document.getElementById('submitUserBtn').innerHTML = 'Create User';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('editModeIndicator').classList.add('hidden');
        }
    </script>
</body>
</html>