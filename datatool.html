<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Resume Extractor & Application Tool</title>
    
    <!-- Puter.js for AI -->
    <script src="https://js.puter.com/v2/"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- OCR & Document Parsing Libraries -->
    <!-- Tesseract.js for Images -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    
    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Mammoth.js for DOCX Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- html2pdf.js for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- GLOBAL & LIGHT NEOMORPHISM STYLES --- */
        body {
            background-color: #eef2f6; /* Soft Blue-Gray Background */
            color: #334155;
        }

        /* Light Neomorphic Header */
        header {
            background-color: #eef2f6 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 20px -10px rgba(0,0,0,0.05);
        }

        /* Neomorphic Button Base (Light) */
        .neo-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 65px;
            height: 55px;
            border-radius: 16px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow:  7px 7px 14px #d1d9e6, 
                        -7px -7px 14px #ffffff;
            color: #64748b; /* Slate 500 */
            border: 1px solid rgba(255,255,255,0.4);
            transition: all 0.25s ease;
            position: relative;
            cursor: pointer;
        }

        .neo-btn i {
            font-size: 1.2rem;
            margin-bottom: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .neo-btn span {
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Hover States (Light Mode Glows) */
        .neo-btn:hover {
            transform: translateY(-2px);
            box-shadow:  8px 8px 16px #d1d9e6, 
                        -8px -8px 16px #ffffff;
        }

        /* Active/Pressed State */
        .neo-btn:active {
            transform: translateY(1px);
            background: #eef2f6;
            box-shadow: inset 6px 6px 12px #d1d9e6, 
                        inset -6px -6px 12px #ffffff;
            border-color: transparent;
        }

        /* Disabled State */
        .neo-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: inset 2px 2px 5px #e2e8f0, inset -2px -2px 5px #ffffff !important;
            background: #eef2f6;
            color: #cbd5e1;
        }

        /* Color Accents on Hover (Vibrant but suited for light theme) */
        .action-red:hover i { color: #ef4444; transform: scale(1.1); }
        .action-yellow:hover i { color: #d97706; transform: scale(1.1); }
        .action-indigo:hover i { color: #4f46e5; transform: scale(1.1); }
        .action-blue:hover i { color: #2563eb; transform: scale(1.1); }
        .action-purple:hover i { color: #9333ea; transform: scale(1.1); }
        .action-orange:hover i { color: #ea580c; transform: scale(1.1); }
        .action-cyan:hover i { color: #0891b2; transform: scale(1.1); }
        .action-green:hover i { color: #16a34a; transform: scale(1.1); }

        /* Neomorphic Container for AI Toggle */
        .neo-inset {
            background: #eef2f6;
            box-shadow: inset 5px 5px 10px #d1d9e6, 
                        inset -5px -5px 10px #ffffff;
            border-radius: 9999px;
            padding: 6px 14px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* Divider */
        .neo-divider {
            width: 2px;
            height: 40px;
            background: #cbd5e1;
            border-radius: 2px;
            margin: 0 8px;
            opacity: 0.5;
        }

        /* --- CREATIVE SCANNER ANIMATION --- */
        .scanner-wrapper {
            position: relative;
            width: 140px;
            height: 180px;
            perspective: 1000px;
        }
        
        .scanner-doc {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
            transform: rotateX(10deg);
            border: 1px solid #e2e8f0;
        }
        
        .doc-line { height: 8px; background: #e2e8f0; border-radius: 4px; width: 100%; }
        .doc-line.short { width: 60%; }
        .doc-photo { width: 40px; height: 40px; background: #cbd5e1; border-radius: 50%; align-self: flex-end; }

        .scan-laser {
            position: absolute;
            top: -20%;
            left: -10%;
            width: 120%;
            height: 20%;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0) 0%, rgba(59, 130, 246, 0.5) 50%, rgba(59, 130, 246, 0.8) 100%);
            filter: drop-shadow(0 0 15px #3b82f6);
            animation: cyberScan 2s ease-in-out infinite;
            z-index: 10;
            border-bottom: 2px solid #60a5fa;
            opacity: 0.8;
        }

        @keyframes cyberScan {
            0% { top: -20%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 110%; opacity: 0; }
        }

        /* --- SUCCESS OVERLAY STYLES --- */
        .success-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .success-card.active {
            transform: scale(1);
            opacity: 1;
        }

        /* --- PREVIEW & PRINT STYLES --- */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Arial', sans-serif; 
            color: #1a202c;
            overflow: hidden;
            position: relative;
            line-height: 1.2;
            text-transform: uppercase; 
        }

        @media print {
            body > * { display: none !important; }
            #editor-panel { display: none !important; }
            .flex-1 { display: block !important; height: auto !important; overflow: visible !important; }
            #preview-panel { width: 100% !important; background: white !important; margin: 0 !important; padding: 0 !important; display: block !important; overflow: visible !important; }
            #print-area { display: block !important; visibility: visible !important; position: relative !important; left: auto !important; top: auto !important; width: 100% !important; max-width: 210mm !important; margin: 0 auto !important; padding: 0 !important; box-shadow: none !important; border: none !important; min-height: auto !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { size: A4; margin: 10mm; }
        }

        .editor-scroll::-webkit-scrollbar { width: 6px; }
        .editor-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .editor-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .creative-header { background-color: #1e293b; color: white; padding: 8px 12px; margin-bottom: 10px; border-left: 5px solid #3b82f6; display: flex; justify-content: space-between; align-items: center; }
        .report-section { margin-bottom: 10px; }
        .section-title { color: #1e293b; font-weight: 800; border-bottom: 2px solid #3b82f6; margin-bottom: 8px; padding-bottom: 2px; font-size: 9pt; letter-spacing: 0.5px; display: flex; align-items: center; }
        .section-title i { margin-right: 6px; color: #3b82f6; }
        .data-label { font-size: 7pt; color: #64748b; font-weight: 700; margin-bottom: 0px; display: block; }
        .data-value { font-size: 8.5pt; color: #000; font-weight: 600; display: block; min-height: 12px; line-height: 1.2; }
        .info-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 4px 6px; border-radius: 4px; }
        table.creative-table { width: 100%; border-collapse: collapse; font-size: 8pt; }
        table.creative-table th { background-color: #3b82f6; color: white; font-weight: bold; text-align: left; padding: 2px 4px; font-size: 7.5pt; }
        table.creative-table td { padding: 2px 4px; border-bottom: 1px solid #e2e8f0; border-left: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; }
        table.creative-table tr:nth-child(even) { background-color: #f8fafc; }
        .checklist-item { font-size: 7.5pt; display: flex; align-items: center; margin-bottom: 1px; }
        .check-box-icon { width: 9px; height: 9px; border: 1px solid #333; margin-right: 4px; display: flex; align-items: center; justify-content: center; }
        .check-box-icon.checked { background-color: #333; border-color: #333; color: white; }

        /* Form Inputs */
        input:not([type="checkbox"]):not([type="file"]):not([readonly]), select, textarea { transition: all 0.3s ease; outline: none; }
        .highlight-empty { border-color: #f87171 !important; background-color: #fef2f2 !important; box-shadow: 0 0 0 1px #f87171 !important; }
        .highlight-empty:focus { border-color: #f87171 !important; background-color: #ffffff !important; box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important; }
        .highlight-filled { border-color: #4ade80 !important; background-color: #f0fdf4 !important; box-shadow: 0 0 0 1px #4ade80 !important; }
        .highlight-filled:focus { border-color: #4ade80 !important; background-color: #f0fdf4 !important; box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.2) !important; }

        /* Advanced Search */
        .adv-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .adv-search-tab { @apply px-4 py-2 text-xs font-bold rounded-lg transition-all duration-200 border border-transparent; }
        .adv-search-tab.active { @apply bg-indigo-600 text-white shadow-lg shadow-indigo-500/30; }
        .adv-search-tab.inactive { @apply text-slate-500 hover:bg-slate-100 hover:text-slate-700; }
        .adv-result-card { @apply p-4 rounded-xl border border-slate-200 bg-white transition-all duration-200 cursor-pointer; }
        .adv-result-card:hover { @apply border-indigo-400 shadow-md transform -translate-y-1 ring-1 ring-indigo-100; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col font-sans">

    <!-- Header / Top Bar (Light Neomorphism) -->
    <header class="p-3 shadow-sm z-10 shrink-0 border-b border-slate-200">
        <div class="flex justify-between items-center w-full px-2">
            
            <!-- Branding -->
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-md border border-slate-100">
                    <i class="fa-solid fa-file-invoice text-2xl text-blue-600"></i>
                </div>
                <div>
                    <h1 class="text-md font-extrabold uppercase tracking-widest text-slate-700">Resume<span class="text-blue-500">X</span>tractor</h1>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <p class="text-[9px] text-slate-400 font-medium tracking-wide">SYSTEM READY</p>
                    </div>
                </div>
            </div>

            <!-- Action Toolbar -->
            <div class="flex items-center gap-3">
                
                <!-- AI Switch (Light Inset) -->
                <div class="neo-inset flex items-center gap-3 mr-4">
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider"><i class="fa-solid fa-brain text-purple-500 mr-1"></i> Smart Scan</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="ai-toggle" class="sr-only peer" checked>
                        <div class="w-8 h-4 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-purple-500 peer-checked:after:bg-white shadow-inner"></div>
                    </label>
                </div>

                <!-- SECTION 1: Management -->
                <div class="flex gap-3">
                    <button onclick="resetForm()" class="neo-btn action-red" title="Reset Form">
                        <i class="fa-solid fa-rotate-right"></i>
                        <span>New</span>
                    </button>

                    <button onclick="toggleTemplatePanel()" class="neo-btn action-yellow" title="Settings">
                        <i class="fa-solid fa-sliders"></i>
                        <span>Template</span>
                    </button>

                    <button onclick="openAdvancedSearch()" class="neo-btn action-indigo" title="Search DB">
                        <i class="fa-solid fa-bolt"></i>
                        <span>Search</span>
                    </button>
                </div>

                <!-- Divider -->
                <div class="neo-divider"></div>

                <!-- SECTION 2: Processing -->
                <div class="flex gap-3">
                    <button onclick="openFileModal()" class="neo-btn action-blue" title="OCR Upload">
                        <i class="fa-solid fa-file-import"></i>
                        <span>OCR Files</span>
                    </button>

                    <button id="btn-save-data" onclick="saveDataToClickUp()" class="neo-btn action-purple" disabled title="Save Data Only">
                        <i class="fa-solid fa-database"></i>
                        <span>Save Data</span>
                    </button>

                    <button id="btn-upload-pdf" onclick="savePdfToClickUp()" class="neo-btn action-orange" disabled title="Upload PDF">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <span>Save PDF</span>
                    </button>
                </div>

                <!-- Divider -->
                <div class="neo-divider"></div>

                <!-- SECTION 3: Output -->
                <div class="flex gap-3">
                    <button id="btn-print" onclick="printReport()" class="neo-btn action-cyan" disabled title="Print">
                        <i class="fa-solid fa-print"></i>
                        <span>Print</span>
                    </button>

                     <button id="btn-pdf" onclick="downloadPDF()" class="neo-btn action-green" disabled title="Download">
                        <i class="fa-solid fa-download"></i>
                        <span>Img PDF</span>
                    </button>
                </div>

            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Search Modal (Simple - Deprecated by Advanced but kept for logic safety) -->
        <div id="search-modal" class="hidden absolute inset-0 bg-gray-900/50 z-[50] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white rounded-lg shadow-xl p-6 w-96 transform transition-all scale-100">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-magnifying-glass text-blue-600"></i> Search Candidate
                </h3>
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-gray-500 mb-1">REFERENCE ID</label>
                    <input type="text" id="modal-ref-id" class="w-full border-2 border-blue-200 rounded px-3 py-2 text-lg font-bold text-center uppercase tracking-widest focus:border-blue-500 focus:outline-none" placeholder="BC00001">
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeSearchModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button onclick="executeSearch()" id="modal-search-btn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                        <span>Search</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW: ADVANCED SEARCH MODAL -->
        <div id="advanced-search-modal" class="hidden absolute inset-0 bg-slate-900/60 z-[90] backdrop-blur-sm flex items-center justify-center p-4">
            <div class="adv-glass w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] transform transition-all scale-100">
                
                <!-- Modal Header -->
                <div class="bg-slate-900 px-6 py-4 flex justify-between items-center text-white shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center">
                            <i class="fa-solid fa-bolt text-sm"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg leading-tight">Advanced Search</h3>
                            <p class="text-[10px] text-slate-400">Global Candidate Database (ClickUp)</p>
                        </div>
                    </div>
                    <button onclick="closeAdvancedSearch()" class="text-slate-400 hover:text-white transition">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <!-- Tabs & Input -->
                <div class="p-6 border-b border-slate-200 bg-slate-50 shrink-0">
                    <!-- Tabs -->
                    <div class="flex gap-2 mb-4 bg-white p-1 rounded-xl border border-slate-200 w-fit">
                        <button onclick="setAdvSearchType('name')" id="tab-name" class="adv-search-tab active">
                            <i class="fa-regular fa-user mr-1"></i> Name
                        </button>
                        <button onclick="setAdvSearchType('passport')" id="tab-passport" class="adv-search-tab inactive">
                            <i class="fa-solid fa-passport mr-1"></i> Passport
                        </button>
                        <button onclick="setAdvSearchType('ref')" id="tab-ref" class="adv-search-tab inactive">
                            <i class="fa-solid fa-hashtag mr-1"></i> Reference ID
                        </button>
                    </div>

                    <!-- Search Input -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                        </div>
                        <!-- REMOVED onkeyup event to stop auto-searching -->
                        <input type="text" id="adv-search-input" class="block w-full pl-10 pr-12 py-3 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm shadow-sm transition-all" placeholder="Type to search candidates...">
                        
                        <!-- Search Trigger Button (Right side of input) -->
                         <button onclick="handleAdvSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-indigo-600 hover:text-indigo-800 cursor-pointer">
                            <span class="text-xs font-bold mr-1">GO</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>

                        <!-- Loading Spinner -->
                        <div id="adv-search-loader" class="hidden absolute inset-y-0 right-12 flex items-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-indigo-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Results Area -->
                <div class="flex-1 overflow-y-auto bg-slate-100 p-6 custom-scrollbar">
                    <div id="adv-search-results" class="space-y-3">
                        <!-- Initial State -->
                        <div class="flex flex-col items-center justify-center h-48 text-center opacity-60">
                            <i class="fa-solid fa-layer-group text-4xl text-slate-300 mb-3"></i>
                            <p class="text-sm font-medium text-slate-500">Enter a query above to find candidates.</p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-white px-6 py-3 border-t border-slate-200 flex justify-between items-center text-xs text-slate-500 shrink-0">
                    <span><span id="result-count">0</span> records found</span>
                    <div class="flex gap-2">
                        <span class="px-2 py-1 bg-slate-100 rounded">ESC to close</span>
                        <span class="px-2 py-1 bg-slate-100 rounded">Click to select</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- NEW: File Upload & Selection Modal -->
        <div id="file-upload-modal" class="hidden absolute inset-0 bg-gray-900/60 z-[70] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-[500px] transform transition-all flex flex-col max-h-[80vh]">
                <!-- Header -->
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up text-blue-600"></i> Upload Documents
                    </h3>
                    <button onclick="closeFileModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <!-- Body -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Drop Zone / Button -->
                    <div class="border-2 border-dashed border-blue-200 bg-blue-50 rounded-lg p-6 text-center hover:bg-blue-100 transition cursor-pointer mb-4" onclick="document.getElementById('hidden-file-input').click()">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm text-blue-600">
                            <i class="fa-solid fa-plus text-xl"></i>
                        </div>
                        <p class="text-sm font-semibold text-blue-800">Click to Select Files</p>
                        <p class="text-xs text-gray-500 mt-1">Supports Image, PDF, DOCX</p>
                    </div>
                    <input type="file" id="hidden-file-input" class="hidden" multiple accept="image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" onchange="handleFileSelect(this)">

                    <!-- File List -->
                    <div id="selected-files-container" class="space-y-2">
                        <!-- Items appended here by JS -->
                        <p class="text-center text-xs text-gray-400 italic mt-4" id="no-files-msg">No files selected yet.</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t bg-gray-50 rounded-b-xl flex justify-between items-center">
                    <span id="file-count-label" class="text-xs font-bold text-gray-500">0 Files Selected</span>
                    <div class="flex gap-2">
                        <button onclick="closeFileModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded-lg font-medium transition">Cancel</button>
                        <button onclick="startBatchOCR()" id="start-ocr-btn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Start OCR <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CREATIVE SCANNER ANIMATION OVERLAY -->
        <div id="scanner-overlay" class="hidden absolute inset-0 bg-white/98 z-[80] flex flex-col items-center justify-center backdrop-blur-md">
            <!-- Animation Box -->
            <div id="scan-anim-box" class="flex flex-col items-center transition-all duration-300">
                
                <div class="scanner-wrapper mb-6">
                    <div class="scanner-doc">
                        <div class="doc-photo"></div>
                        <div class="doc-line"></div>
                        <div class="doc-line"></div>
                        <div class="doc-line short"></div>
                        <div class="doc-line"></div>
                        <div class="doc-line short"></div>
                    </div>
                    <div class="scan-laser"></div>
                </div>

                <h3 class="text-2xl font-black text-slate-800 mb-2 tracking-tight">ANALYZING DOCUMENTS</h3>
                <p id="scanner-status" class="text-sm text-blue-500 font-medium font-mono uppercase tracking-widest">Initializing Neural Engine...</p>
                
                <!-- Progress Bar -->
                <div class="w-64 bg-slate-100 rounded-full h-2 mt-6 overflow-hidden shadow-inner">
                    <div id="scanner-progress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Success State (Hidden initially) -->
            <div id="scan-success-box" class="hidden flex flex-col items-center text-center transform scale-90 transition-all duration-300">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 scan-success-icon shadow-lg border-4 border-white">
                    <i class="fa-solid fa-check text-5xl text-green-500"></i>
                </div>
                <h3 class="text-3xl font-black text-slate-800 mb-2">Extraction Complete</h3>
                <p class="text-slate-500 text-sm mb-8">Data has been successfully parsed and populated.</p>
                <button onclick="closeScannerOverlay()" class="px-8 py-3 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition shadow-lg font-bold tracking-wide">
                    View Results
                </button>
            </div>
        </div>

        <!-- NEW: AUTO-DISMISS SUCCESS POPUP (Floating Window) -->
        <div id="success-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center pointer-events-none">
            <div class="success-card">
                <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-100">
                    <i class="fa-solid fa-check text-2xl text-green-500"></i>
                </div>
                <h3 id="success-title" class="text-xl font-bold text-slate-800 mb-2">Success!</h3>
                <p id="success-desc" class="text-sm text-slate-500 leading-relaxed max-w-xs mx-auto">Operation completed successfully.</p>
                
                <!-- Progress Bar for auto-close -->
                <div class="w-full bg-slate-100 h-1 mt-6 rounded-full overflow-hidden">
                    <div class="bg-green-500 h-full animate-[width_3s_linear_forwards]" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- Left Panel: Editor (Added ID for Print Hide) -->
        <div id="editor-panel" class="w-2/5 bg-white border-r border-gray-200 overflow-y-auto editor-scroll flex flex-col">
            
            <!-- Template Settings (Initially Hidden) -->
            <div id="template-panel" class="hidden bg-slate-100 p-4 border-b border-gray-200 shadow-inner">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-eye"></i> Report Visibility Settings
                </h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('header', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Header (Job Details)</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('personal', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Personal Info</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('passport', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Passport Info</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('contact', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Contact Info</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('experience', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Experience</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('education', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Education</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('languages', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Languages</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleSection('attachments', this)" class="rounded text-blue-600 focus:ring-blue-500">
                        <span>Checklists (Attachments)</span>
                    </label>
                </div>
            </div>

            <!-- Form Content -->
            <form id="app-form" oninput="updatePreview()" class="p-6 space-y-6">
                
                <!-- Unique Reference ID Block (READ ONLY) -->
                <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-blue-700 uppercase">Ref ID:</label>
                        <div class="flex items-center gap-1">
                            <input type="text" id="input-ref-id" value="BC00001" readonly class="border border-blue-300 rounded px-2 py-1 text-sm font-bold text-blue-800 w-24 text-center bg-gray-100 cursor-not-allowed outline-none uppercase">
                            <button type="button" onclick="fetchNextRefId()" class="text-blue-500 hover:text-blue-700 transition px-1" title="Refresh ID from Database">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Advisor Field (Hidden in Template, Saved to ClickUp) -->
                    <div class="flex items-center gap-2 border-l border-blue-200 pl-4">
                        <label class="text-xs font-bold text-blue-700 uppercase">Advisor:</label>
                        <input type="text" id="input-advisor" class="border border-blue-300 rounded px-2 py-1 text-sm font-bold text-blue-800 w-32 outline-none uppercase placeholder-blue-300" placeholder="NAME">
                    </div>
                </div>

                <!-- Section: Job Apply Details -->
                <div class="space-y-4">
                    <h2 class="text-sm font-bold text-slate-700 border-b pb-1">APPLICATION DETAILS</h2>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex gap-2">
                            <!-- Removed Client Input -->
                            <select id="input-country" class="w-full border rounded px-2 py-1.5 text-sm bg-white" onchange="updatePreview()">
                                <option value="" disabled selected>Select Country</option>
                                <option value="GERMANY">GERMANY</option>
                                <option value="SWEDEN">SWEDEN</option>
                                <option value="FINLAND">FINLAND</option>
                                <option value="SLOVAKIA">SLOVAKIA</option>
                                <option value="ITALY">ITALY</option>
                                <option value="NETHERLANDS">NETHERLANDS</option>
                                <option value="FRANCE">FRANCE</option>
                                <option value="POLAND">POLAND</option>
                                <option value="CZECH REPUBLIC">CZECH REPUBLIC</option>
                                <option value="LATVIA">LATVIA</option>
                                <option value="CROATIA">CROATIA</option>
                                <option value="MONTENEGRO">MONTENEGRO</option>
                                <option value="SERBIA">SERBIA</option>
                                <option value="MACEDONIA">MACEDONIA</option>
                                <option value="ALBANIA">ALBANIA</option>
                                <option value="BELARUS">BELARUS</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <select id="input-skill-type" class="border rounded px-2 py-1.5 text-sm w-1/3 bg-white" onchange="updatePreview()">
                                <option value="" disabled selected>Select Visa Type</option>
                                <option value="AIRPORT TRANSIT VISA">AIRPORT TRANSIT VISA</option>
                                <option value="SCHENGEN SHORT STAY VISA">SCHENGEN SHORT STAY VISA</option>
                                <option value="SCHENGEN LONG STAY VISA">SCHENGEN LONG STAY VISA</option>
                                <option value="TOURIST VISA">TOURIST VISA</option>
                                <option value="BUSINESS VISA">BUSINESS VISA</option>
                                <option value="VISIT VISA">VISIT VISA</option>
                                <option value="FAMILY VISIT VISA">FAMILY VISIT VISA</option>
                                <option value="MEDICAL VISA">MEDICAL VISA</option>
                                <option value="CULTURAL VISA">CULTURAL VISA</option>
                                <option value="SPORTS VISA">SPORTS VISA</option>
                                <option value="STUDENT VISA">STUDENT VISA</option>
                                <option value="LANGUAGE COURSE VISA">LANGUAGE COURSE VISA</option>
                                <option value="INTERNSHIP VISA">INTERNSHIP VISA</option>
                                <option value="TRAINEE VISA">TRAINEE VISA</option>
                                <option value="RESEARCH VISA">RESEARCH VISA</option>
                                <option value="WORK VISA">WORK VISA</option>
                                <option value="SKILLED WORKER VISA">SKILLED WORKER VISA</option>
                                <option value="HIGHLY SKILLED WORKER VISA">HIGHLY SKILLED WORKER VISA</option>
                                <option value="SEASONAL WORK VISA">SEASONAL WORK VISA</option>
                                <option value="TEMPORARY WORK VISA">TEMPORARY WORK VISA</option>
                                <option value="PERMANENT WORK VISA">PERMANENT WORK VISA</option>
                                <option value="INTRA COMPANY TRANSFER VISA">INTRA COMPANY TRANSFER VISA</option>
                                <option value="EU BLUE CARD">EU BLUE CARD</option>
                                <option value="JOB SEEKER VISA">JOB SEEKER VISA</option>
                                <option value="SELF EMPLOYMENT VISA">SELF EMPLOYMENT VISA</option>
                                <option value="FREELANCER VISA">FREELANCER VISA</option>
                                <option value="ENTREPRENEUR VISA">ENTREPRENEUR VISA</option>
                                <option value="STARTUP VISA">STARTUP VISA</option>
                                <option value="INVESTOR VISA">INVESTOR VISA</option>
                                <option value="GOLDEN VISA">GOLDEN VISA</option>
                                <option value="DIGITAL NOMAD VISA">DIGITAL NOMAD VISA</option>
                                <option value="REMOTE WORK VISA">REMOTE WORK VISA</option>
                                <option value="FAMILY REUNIFICATION VISA">FAMILY REUNIFICATION VISA</option>
                                <option value="DEPENDENT VISA">DEPENDENT VISA</option>
                                <option value="SPOUSE VISA">SPOUSE VISA</option>
                                <option value="WORKING HOLIDAY VISA">WORKING HOLIDAY VISA</option>
                                <option value="RESIDENCE VISA">RESIDENCE VISA</option>
                                <option value="TEMPORARY RESIDENCE PERMIT">TEMPORARY RESIDENCE PERMIT</option>
                                <option value="PERMANENT RESIDENCE PERMIT">PERMANENT RESIDENCE PERMIT</option>
                                <option value="HUMANITARIAN VISA">HUMANITARIAN VISA</option>
                                <option value="ASYLUM VISA">ASYLUM VISA</option>
                                <option value="REFUGEE VISA">REFUGEE VISA</option>
                                <option value="TRANSIT VISA">TRANSIT VISA</option>
                            </select>
                            
                            <!-- UPDATED: Position Input with Datalist -->
                            <input type="text" id="input-position" list="position-list" class="w-2/3 border rounded px-2 py-1.5 text-sm" placeholder="Type or Select Position" autocomplete="off" onchange="updatePreview()">
                            <datalist id="position-list">
                                <option value="Civil Engineer">
                                <option value="Civil Draughtsman">
                                <option value="Land Surveyor">
                                <option value="Civil Site Supervisor">
                                <option value="Construction Safety Engineer">
                                <option value="Construction Safety Officer">
                                <option value="Welder">
                                <option value="Fabricator">
                                <option value="Scaffolder">
                                <option value="RCC Fitter">
                                <option value="Wall Painter">
                                <option value="Concrete Mix Operator">
                                <option value="Dozer Operator">
                                <option value="Excavator Operator">
                                <option value="Tower Crane Operator">
                                <option value="Mobile Crane Operator">
                                <option value="Grader Operator">
                                <option value="Steel Fixer">
                                <option value="Mechanical Engineer">
                                <option value="Mechanical Supervisor">
                                <option value="Diesel Mechanical Tech">
                                <option value="Mechanical Draughtsman">
                                <option value="Electrical Engineer">
                                <option value="Electrical Supervisor">
                                <option value="Electrical Tech (HV)">
                                <option value="Electrical Draughtsman">
                                <option value="Auto Electrician">
                                <option value="Auto Spray Painter">
                                <option value="Auto AC Tech">
                                <option value="TV Mechanic">
                                <option value="Tire Man">
                                <option value="Water Helper">
                                <option value="Fuel Station Worker">
                                <option value="Workshop Helper">
                                <option value="Liner">
                                <option value="Tinker">
                                <option value="Roller Operator">
                                <option value="Glass Cutter">
                                <option value="Construction Helper">
                                <option value="Carpenter Shuttering">
                                <option value="Carpenter Furniture">
                                <option value="Mason Plaster">
                                <option value="Chief Cook">
                                <option value="Continental Cook">
                                <option value="Assistant Cook">
                                <option value="Head Chef">
                                <option value="Assistant Chef">
                                <option value="Pastry Chef">
                                <option value="Commis Chef">
                                <option value="Sous Chef">
                                <option value="Kitchen Helper">
                                <option value="Chef de Partie">
                                <option value="Catering Supervisor">
                                <option value="Restaurant Supervisor">
                                <option value="Steward Supervisor">
                                <option value="F&B Supervisor">
                                <option value="Housekeeping Supervisor">
                                <option value="Dishwasher">
                                <option value="Barista">
                                <option value="F&B Staff">
                                <option value="Pizza Chef">
                                <option value="Housekeeping Worker">
                                <option value="Laundry Worker">
                                <option value="Laundry Supervisor">
                                <option value="Food Quality Inspector">
                                <option value="Safety Engineer">
                                <option value="H&S Officer">
                                <option value="Fire Safety Officer">
                                <option value="Commis I, II">
                                <option value="Stewards">
                                <option value="Captain">
                                <option value="Waiter/Waitress">
                                <option value="Butcher">
                                <option value="Food Packing Worker">
                                <option value="Driver Light Duty">
                                <option value="Forklift Operator">
                                <option value="AC Technician">
                                <option value="Security Guard">
                                <option value="Electrician">
                                <option value="Plumber">
                                <option value="Time Keeper">
                                <option value="Transport Supervisor">
                                <option value="Sales (Duty-Free)">
                                <option value="Cashier (Duty-Free)">
                                <option value="CCTV Tech">
                                <option value="Generator Mechanic">
                                <option value="Lift Tech">
                                <option value="Alarm Tech">
                                <option value="Loading Worker">
                                <option value="Aircraft Cleaner">
                                <option value="Trolley Helper">
                                <option value="Store Keeper">
                                <option value="Data Entry Operator">
                                <option value="Office Assistant">
                                <option value="Accountant">
                                <option value="System Service Engineer">
                                <option value="Computer Operator">
                                <option value="Staff Bus Driver">
                                <option value="Heavy Tanker Driver">
                                <option value="Head Nurse">
                                <option value="Assistant Nurse">
                                <option value="Chief Lab Tech">
                                <option value="X-Ray Technician">
                                <option value="Chief Pharmacist">
                                <option value="Ambulance Driver">
                                <option value="Ward Assistant">
                                <option value="Sweeper">
                                <option value="Asst Pharmacist">
                                <option value="Asst Lab Tech">
                                <option value="Sales Supervisor">
                                <option value="Cam Supervisor">
                                <option value="System Engineer">
                                <option value="System Operator">
                                <option value="Sales Workers">
                                <option value="Office Clerk">
                                <option value="Tanker Driver Head Duty">
                                <option value="Staff Bus Driver Head Duty">
                                <option value="Packing Helper">
                                <option value="Loading Unloading Workers">
                                <option value="Cleaning Helper">
                                <option value="Cashier">
                                <option value="Hair Stylist (Barber)">
                                <option value="Tailor">
                                <option value="Tailor Cutting Master">
                                <option value="CCTV Technician">
                                <option value="Air Conditioning Technician">
                                <option value="Electrical Supervisor">
                                <option value="Fire & Safety Officer">
                                <option value="Fire Alarm Technician">
                                <option value="RO Water Technician">
                                <option value="Poultry Farm Worker">
                                <option value="Poultry Yard Cleaner">
                                <option value="Poultry Farm Supervisor">
                                <option value="Dairy Farm Worker">
                                <option value="Dairy Farm Supervisor">
                                <option value="Egg Collector">
                                <option value="Egg Packer">
                                <option value="Veterinary Technician">
                                <option value="Veterinary Pharmacist">
                                <option value="Agriculture Farm Supervisor">
                                <option value="Agriculture Pharmacist Technician">
                                <option value="Agriculture Field Officer">
                                <option value="Agriculture Farm Workers">
                                <option value="Automotive Assembly Operator">
                                <option value="Chassis Line Worker">
                                <option value="Quality Control Specialist">
                                <option value="Paint Shop Assistant">
                                <option value="Production Line Operator">
                                <option value="CNC Machine Operator">
                                <option value="Electronics Assembler">
                                <option value="Warehouse Associate">
                                <option value="Construction Specialist">
                                <option value="Factory Assistant">
                                <option value="Nursing Assistant (Pflegehelfer)">
                                <option value="Registered Nurse">
                                <option value="Truck Driver (LKW)">
                                <option value="IT Specialist">
                                <option value="Hotel Staff">
                                <option value="Greenhouse Worker">
                                <option value="Flower Picker">
                                <option value="Warehouse Order Picker">
                                <option value="IT Developer">
                                <option value="Marketing Specialist">
                                <option value="Solar Panel Installer">
                                <option value="Welder / Fitter">
                                <option value="Aircraft Mechanic">
                                <option value="Truck Driver (Code 95)">
                                <option value="Software Developer">
                                <option value="Specialist Doctor">
                                <option value="Construction Worker">
                                <option value="Truck Driver">
                                <option value="Hotel Staff (Albania)">
                                <option value="Farm Worker">
                                <option value="Butcher (Albania)">
                                <option value="Care Home Assistant (France)">
                                <option value="Office Clerk (France)">
                                <option value="HR Assistant">
                                <option value="Care Home Assistant (Italy)">
                                <option value="Sales Executive">
                                <option value="IT Professional">
                                <option value="Logistics Coordinator">
                                <option value="General Agriculture">
                                <option value="Tractor Driver (Belarus)">
                                <option value="Professional Tailor">
                                <option value="Factory Worker">
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Section: Personal Information -->
                <div class="space-y-4">
                    <h2 class="text-sm font-bold text-slate-700 border-b pb-1">PERSONAL INFORMATION</h2>
                    <div class="flex gap-3">
                        <div class="w-24 shrink-0">
                            <div class="border-2 border-dashed border-gray-300 rounded h-28 flex items-center justify-center cursor-pointer hover:bg-gray-50 relative overflow-hidden group" onclick="document.getElementById('photo-upload').click()">
                                <img id="photo-preview-input" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                                <div class="text-center p-1 group-hover:opacity-75 transition">
                                    <i class="fa-solid fa-camera text-gray-400"></i>
                                    <span class="block text-[10px] text-gray-400 leading-tight mt-1">Upload Photo</span>
                                </div>
                            </div>
                            <input type="file" id="photo-upload" class="hidden" accept="image/*" onchange="previewImage(this)">
                        </div>
                        <div class="flex-1 grid grid-cols-2 gap-2">
                            <input type="text" id="input-fname" class="border rounded px-2 py-1.5 text-sm" placeholder="First Name (As per Passport) *">
                            <input type="text" id="input-sname" class="border rounded px-2 py-1.5 text-sm" placeholder="Surname (As per Passport) *">
                            <select id="input-gender" class="border rounded px-2 py-1.5 text-sm bg-white" onchange="updatePreview()">
                                <option value="" selected disabled class="text-gray-400">Select Gender *</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                            <select id="input-marital" class="border rounded px-2 py-1.5 text-sm bg-white" onchange="updatePreview()">
                                <option value="" selected disabled class="text-gray-400">Select Status *</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                            </select>
                            <div class="relative">
                                <label class="absolute -top-1.5 left-2 bg-white px-1 text-[8px] text-gray-500 font-bold">DOB *</label>
                                <input type="date" id="input-dob" class="w-full border rounded px-2 py-1.5 text-sm" onchange="calculateAge()">
                            </div>
                            <input type="number" id="input-age" class="border rounded px-2 py-1.5 text-sm bg-gray-50" readonly placeholder="Age (Auto)">
                            <select id="input-residence" class="col-span-2 border rounded px-2 py-1.5 text-sm bg-white" onchange="updatePreview()">
                                <option value="" disabled selected>Present Residence *</option>
                                <option value="INDIA">INDIA</option>
                                <option value="PAKISTAN">PAKISTAN</option>
                                <option value="SRI LANKA">SRI LANKA</option>
                                <option value="NEPAL">NEPAL</option>
                                <option value="BANGLADESH">BANGLADESH</option>
                                <option value="PHILIPPINES">PHILIPPINES</option>
                                <option value="KENYA">KENYA</option>
                                <option value="EGYPT">EGYPT</option>
                                <option value="BAHRAIN">BAHRAIN</option>
                                <option value="KUWAIT">KUWAIT</option>
                                <option value="OMAN">OMAN</option>
                                <option value="QATAR">QATAR</option>
                                <option value="SAUDI ARABIA">SAUDI ARABIA</option>
                                <option value="UAE">UAE</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section: Passport Information -->
                <div class="space-y-4">
                    <h2 class="text-sm font-bold text-slate-700 border-b pb-1">PASSPORT INFO</h2>
                    <div class="grid grid-cols-2 gap-2">
                         <div class="col-span-2">
                             <label class="text-[10px] text-gray-500 font-bold">NATIONALITY *</label>
                             <select id="input-nationality" class="w-full border rounded px-2 py-1.5 text-sm uppercase bg-white" onchange="updatePreview()">
                                 <option value="" disabled selected>Select Nationality</option>
                                 <option value="INDIA">INDIA</option>
                                 <option value="PAKISTAN">PAKISTAN</option>
                                 <option value="SRI LANKA">SRI LANKA</option>
                                 <option value="NEPAL">NEPAL</option>
                                 <option value="BANGLADESH">BANGLADESH</option>
                                 <option value="PHILIPPINES">PHILIPPINES</option>
                                 <option value="KENYA">KENYA</option>
                                 <option value="EGYPT">EGYPT</option>
                             </select>
                         </div>
                        <input type="text" id="input-passport-no" class="border rounded px-2 py-1.5 text-sm uppercase" placeholder="Passport No *">
                        <div class="flex flex-col relative">
                             <label class="absolute -top-1.5 left-2 bg-white px-1 text-[8px] text-gray-500 font-bold">Expiry Date *</label>
                            <input type="date" id="input-passport-exp" class="border rounded px-2 py-1.5 text-sm">
                        </div>
                        <input type="text" id="input-pob" class="border rounded px-2 py-1.5 text-sm" placeholder="Place of Birth">
                        <input type="text" id="input-state-birth" class="border rounded px-2 py-1.5 text-sm" placeholder="State of Birth">
                        <input type="text" id="input-place-issue" class="col-span-2 border rounded px-2 py-1.5 text-sm" placeholder="Place of Issue">
                    </div>
                </div>

                <!-- Section: Contact Details -->
                <div class="space-y-4">
                    <h2 class="text-sm font-bold text-slate-700 border-b pb-1">CONTACT DETAILS</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="input-mobile" class="border rounded px-2 py-1.5 text-sm" placeholder="Mobile *">
                        <input type="text" id="input-whatsapp" class="border rounded px-2 py-1.5 text-sm" placeholder="WhatsApp *">
                        <input type="text" id="input-alt" class="border rounded px-2 py-1.5 text-sm" placeholder="Alt Phone">
                        <input type="email" id="input-email" class="border rounded px-2 py-1.5 text-sm" placeholder="Email *">
                        <textarea id="input-address" class="col-span-2 border rounded px-2 py-1.5 text-sm h-14 resize-none" placeholder="Postal Address"></textarea>
                        <input type="text" id="input-location" class="border rounded px-2 py-1.5 text-sm" placeholder="City/State">
                        <input type="text" id="input-zip" class="border rounded px-2 py-1.5 text-sm" placeholder="Zip Code">
                        <input type="text" id="input-linkedin" class="col-span-2 border rounded px-2 py-1.5 text-sm" placeholder="LinkedIn Profile">
                    </div>
                </div>

                <!-- Section: Experience (Moved above Education) -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center border-b pb-1">
                        <h2 class="text-sm font-bold text-slate-700">EXPERIENCE</h2>
                        <button type="button" onclick="addExperienceRow()" class="text-xs text-blue-600 hover:underline"><i class="fa-solid fa-plus"></i> Add</button>
                    </div>
                    <div id="experience-inputs" class="space-y-2"></div>
                </div>

                <!-- Section: Education (Moved below Experience) -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center border-b pb-1">
                        <h2 class="text-sm font-bold text-slate-700">EDUCATION</h2>
                        <button type="button" onclick="addEducationRow()" class="text-xs text-blue-600 hover:underline"><i class="fa-solid fa-plus"></i> Add</button>
                    </div>
                    <div id="education-inputs" class="space-y-2"></div>
                </div>

                <!-- Section: Languages -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center border-b pb-1">
                        <h2 class="text-sm font-bold text-slate-700">LANGUAGES</h2>
                        <button type="button" onclick="addLanguageRow()" class="text-xs text-blue-600 hover:underline"><i class="fa-solid fa-plus"></i> Add</button>
                    </div>
                    <div id="language-inputs" class="space-y-2"></div>
                </div>

                <!-- Section: Attachments -->
                <div class="grid grid-cols-1 gap-4">
                    <div class="space-y-2">
                        <h2 class="text-sm font-bold text-slate-700 border-b pb-1">ATTACHMENTS</h2>
                        <div class="space-y-1" id="attachments-list"></div>
                    </div>
                    <div class="space-y-2">
                        <h2 class="text-sm font-bold text-slate-700 border-b pb-1">SUBMISSION CHECKS</h2>
                        <div class="space-y-1" id="submission-list"></div>
                    </div>
                </div>

                <div class="h-8"></div>
            </form>
        </div>

        <!-- Right Panel: Live Preview (Added ID for Print Targeting) -->
        <div id="preview-panel" class="w-3/5 bg-gray-500 overflow-y-auto flex justify-center p-6">
            
            <div id="print-area" class="a4-page shadow-xl">
                
                <!-- Creative Header -->
                <div id="prev-section-header" class="relative mb-6 p-5 rounded-xl overflow-hidden bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-lg print:shadow-none print:border print:border-slate-800">
                    <!-- Decorative Background Elements -->
                    <div class="absolute -right-4 -top-4 w-24 h-24 rounded-full bg-blue-500/20 blur-xl"></div>
                    <div class="absolute left-10 bottom-0 w-32 h-32 rounded-full bg-purple-500/10 blur-xl"></div>

                    <!-- Ref ID Floating -->
                    <div class="absolute top-2 left-3">
                         <span class="text-[8px] text-slate-500 font-mono tracking-widest">REF: <span id="prev-ref-id" class="text-slate-300 font-bold"></span></span>
                    </div>

                    <!-- 3-Column Uniform Grid -->
                    <div class="relative z-10 grid grid-cols-3 gap-0 mt-2 divide-x divide-slate-700/50 items-start">
                        
                        <!-- Col 1: Position -->
                        <div class="text-center px-2 flex flex-col items-center justify-start h-full">
                            <span class="text-[8px] font-bold text-blue-400 uppercase tracking-widest block mb-2">Position</span>
                            <h1 class="text-lg font-black tracking-tight leading-none uppercase text-white break-words w-full">
                                <span id="prev-position"></span>
                            </h1>
                        </div>

                        <!-- Col 2: Country -->
                        <div class="text-center px-2 flex flex-col items-center justify-start h-full">
                            <span class="text-[8px] font-bold text-blue-400 uppercase tracking-widest block mb-2">Destination</span>
                            <span id="prev-country" class="text-lg font-black text-white uppercase leading-none tracking-wide break-words w-full"></span>
                        </div>

                        <!-- Col 3: Visa Type -->
                        <div class="text-center px-2 flex flex-col items-center justify-start h-full">
                            <span class="text-[8px] font-bold text-blue-400 uppercase tracking-widest block mb-2">Visa Category</span>
                            <div class="flex items-center justify-center h-full">
                                <span id="prev-visa-type" class="text-[9px] font-bold text-slate-900 bg-yellow-400 px-3 py-1 rounded shadow-sm uppercase tracking-wide leading-none"></span>
                            </div>
                            <!-- Hidden fields -->
                            <span id="prev-client" class="hidden"></span>
                            <span id="print-date" class="hidden"></span>
                        </div>
                    </div>
                </div>

                <!-- Profile Block (Combines Personal + Photo) -->
                <div id="prev-section-personal" class="report-section mb-3">
                    <div class="flex gap-4 items-start">
                        <div class="w-[35mm] h-[45mm] border-2 border-slate-200 bg-slate-50 shrink-0 flex items-center justify-center overflow-hidden">
                            <img id="prev-photo" src="" class="w-full h-full object-cover hidden">
                            <div id="prev-photo-placeholder" class="text-slate-300 text-[9px] text-center p-1 font-bold">
                                PHOTO
                            </div>
                        </div>

                        <!-- Info Grid -->
                        <div class="flex-1">
                            <h2 class="section-title"><i class="fa-solid fa-user"></i> PROFILE</h2>
                            
                            <!-- Redesigned Grid: 3 Rows Layout -->
                            <div class="grid grid-cols-6 gap-2">
                                
                                <!-- ROW 1: Name (Big Font) -->
                                <div class="col-span-3 info-box bg-blue-50/50 border-blue-100">
                                    <span class="data-label text-blue-800 text-[8pt]">FIRST NAME</span>
                                    <span id="prev-fname" class="data-value text-[13pt] font-black tracking-wide border-b border-gray-300 pb-1 mt-1 leading-none truncate uppercase"></span>
                                </div>
                                <div class="col-span-3 info-box bg-blue-50/50 border-blue-100">
                                    <span class="data-label text-blue-800 text-[8pt]">SURNAME</span>
                                    <span id="prev-sname" class="data-value text-[13pt] font-black tracking-wide border-b border-gray-300 pb-1 mt-1 leading-none truncate uppercase"></span>
                                </div>

                                <!-- ROW 2: Vitals (3 Columns) -->
                                <div class="col-span-2 info-box">
                                    <span class="data-label">BIRTH DATE</span>
                                    <span id="prev-dob" class="data-value font-semibold"></span>
                                </div>
                                <div class="col-span-2 info-box">
                                    <span class="data-label">AGE / GENDER</span>
                                    <span class="data-value"><span id="prev-age"></span> YRS / <span id="prev-gender"></span></span>
                                </div>
                                <div class="col-span-2 info-box">
                                    <span class="data-label">STATUS</span>
                                    <span id="prev-marital" class="data-value"></span>
                                </div>

                                <!-- ROW 3: Origin & Location (2 Columns) -->
                                <div class="col-span-3 info-box bg-gray-50 border-gray-200">
                                     <span class="data-label">NATIONALITY</span>
                                    <span id="prev-nationality" class="data-value font-bold truncate"></span>
                                </div>
                                <div class="col-span-3 info-box bg-gray-50 border-gray-200">
                                     <span class="data-label">PRESENT RESIDENCE</span>
                                    <span id="prev-residence" class="data-value truncate"></span>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Passport Strip (Compact) -->
                <div id="prev-section-passport" class="report-section mb-4">
                    <h2 class="section-title"><i class="fa-solid fa-passport"></i> PASSPORT DETAILS</h2>
                    <div class="grid grid-cols-4 gap-4 text-[8.5pt] bg-slate-50 border border-slate-200 p-3 rounded">
                        <div><span class="text-gray-500 font-bold block text-[7pt]">PASSPORT NO</span> <span id="prev-passport-no" class="font-bold"></span></div>
                        <div><span class="text-gray-500 font-bold block text-[7pt]">EXPIRY</span> <span id="prev-passport-exp"></span></div>
                        <div><span class="text-gray-500 font-bold block text-[7pt]">ISSUED AT</span> <span id="prev-place-issue"></span></div>
                        <div><span class="text-gray-500 font-bold block text-[7pt]">BIRTH PLACE</span> <span id="prev-pob"></span></div>
                    </div>
                </div>

                <!-- Contact Block (Redesigned to match Passport) -->
                <div id="prev-section-contact" class="report-section mb-6">
                    <h2 class="section-title mb-3"><i class="fa-solid fa-address-card"></i> CONTACT DETAILS</h2>
                    
                    <!-- Mobile/Email Grid -->
                    <div class="grid grid-cols-3 gap-4 text-[8.5pt] bg-slate-50 border border-slate-200 p-3 rounded mb-2">
                        <div><span class="text-gray-500 font-bold block text-[7pt]">MOBILE</span> <span id="prev-mobile" class="font-bold"></span></div>
                        <div><span class="text-gray-500 font-bold block text-[7pt]">WHATSAPP</span> <span id="prev-whatsapp" class="font-semibold"></span></div>
                        <div class="col-span-1"><span class="text-gray-500 font-bold block text-[7pt]">EMAIL</span> <span id="prev-email" class="break-all"></span></div>
                    </div>

                     <!-- Separate Address Area -->
                    <div class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded">
                        <span class="block text-slate-500 font-bold text-[7pt] mb-1">POSTAL ADDRESS</span>
                        <span class="font-semibold text-[10pt] leading-snug">
                            <span id="prev-address"></span> <span id="prev-location"></span> <span id="prev-zip"></span>
                        </span>
                    </div>
                </div>

                <!-- Section: Experience (Moved above Education) -->
                <div id="prev-section-experience" class="report-section mb-4">
                    <h2 class="section-title"><i class="fa-solid fa-briefcase"></i> EXPERIENCE</h2>
                    <table class="creative-table">
                        <thead>
                            <tr>
                                <th style="width: 30%">COMPANY</th>
                                <th style="width: 30%">POSITION</th>
                                <th style="width: 25%">DURATION</th>
                                <th style="width: 15%" class="text-center">TOTAL YRS</th>
                            </tr>
                        </thead>
                        <tbody id="prev-experience-body"></tbody>
                    </table>
                    <!-- NEW: Total Experience Display -->
                    <div id="prev-exp-total" class="text-right text-[9pt] font-bold mt-1 pt-1 border-t-2 border-slate-100 hidden text-slate-700">
                        TOTAL EXPERIENCE: <span id="exp-total-value" class="text-blue-800"></span>
                    </div>
                </div>

                <!-- Section: Education (Moved below Experience) -->
                <div id="prev-section-education" class="report-section mb-4">
                    <h2 class="section-title"><i class="fa-solid fa-graduation-cap"></i> EDUCATION</h2>
                    <table class="creative-table">
                        <thead>
                            <tr>
                                <th style="width: 40%">CERTIFICATE</th>
                                <th style="width: 45%">INSTITUTION</th>
                                <th style="width: 15%" class="text-center">YEAR</th>
                            </tr>
                        </thead>
                        <tbody id="prev-education-body"></tbody>
                    </table>
                </div>

                <!-- Section: Languages (Inline with Checklists if space allows, but strict rows requested) -->
                <div id="prev-section-languages" class="report-section mb-4">
                     <h2 class="section-title"><i class="fa-solid fa-language"></i> LANGUAGES</h2>
                     <table class="creative-table">
                        <thead>
                            <tr>
                                <th style="width: 40%">LANGUAGE</th>
                                <th style="width: 20%" class="text-center">SPEAK</th>
                                <th style="width: 20%" class="text-center">READ</th>
                                <th style="width: 20%" class="text-center">WRITE</th>
                            </tr>
                        </thead>
                        <tbody id="prev-language-body"></tbody>
                    </table>
                </div>

                <!-- Footer Grid: Checklists (Updated with Dynamic Visibility) -->
                <div id="prev-section-attachments" class="report-section mt-4 pt-2 border-t border-slate-800 hidden">
                    <!-- Compact vertical stack for the two sections -->
                    <div class="flex flex-col gap-3">
                        
                        <div id="prev-col-attachments" class="hidden w-full">
                            <h4 class="text-[8pt] font-bold text-slate-800 uppercase mb-1 bg-slate-100 p-1">ATTACHMENTS PROVIDED</h4>
                            <!-- FLEX WRAP: Items flow horizontally to save vertical space -->
                            <ul class="flex flex-wrap gap-x-4 gap-y-1" id="prev-attachments"></ul>
                        </div>

                        <div id="prev-col-submission" class="hidden w-full">
                            <h4 class="text-[8pt] font-bold text-slate-800 uppercase mb-1 bg-slate-100 p-1">SUBMISSION CHECKLIST</h4>
                            <!-- FLEX WRAP: Items flow horizontally to save vertical space -->
                            <ul class="flex flex-wrap gap-x-4 gap-y-1" id="prev-submission"></ul>
                        </div>
                        
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CLICKUP_API_KEY = "pk_260468481_S4KLO3ZGV6P1PL1POHKXNS1LA5ISSG0P";
        const CLICKUP_LIST_ID = "901814555582";

        // Define Required Fields for Validation
        const REQUIRED_FIELDS = [
            'input-fname', 
            'input-sname', 
            'input-nationality', 
            'input-residence', 
            'input-marital', 
            'input-gender', // Added Gender
            'input-dob', 
            'input-passport-no', 
            'input-passport-exp', 
            'input-mobile', 
            'input-whatsapp', 
            'input-email'
        ];

        // --- Configuration & Initialization ---
        const attachments = [
            "Complete CV", "Photo", "Passport Scan", "Old Passport", 
            "Edu. Certificates", "Exp. Certificates", "Awards", 
            "National ID", "Police Clearance", "Bank Statement"
        ];
        const submissions = [
            "Embassy Appt", "App. Form", "Work Permit", 
            "Contract", "Accom. Proof", "Marriage Cert", 
            "Relationship Cert", "Affidavit"
        ];

        // GLOBAL: Store selected files for OCR
        let filesToProcess = [];

        document.addEventListener('DOMContentLoaded', () => {
            renderCheckboxes('attachments-list', attachments, 'att');
            renderCheckboxes('submission-list', submissions, 'sub');
            
            addEducationRow();
            addExperienceRow();
            addLanguageRow();

            const today = new Date();
            const formattedToday = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            document.getElementById('print-date').innerText = formattedToday;

            fetchNextRefId();
            updatePreview();
        });

        // --- HELPER: Get ClickUp Custom Field Value ---
        function getClickUpField(task, fieldId) {
            if (!task.custom_fields) return "";
            const field = task.custom_fields.find(f => f.id === fieldId);
            if (!field) return "";
            
            if (field.value) {
                if (field.type === 'drop_down' && field.type_config && field.type_config.options) {
                    const option = field.type_config.options[field.value];
                    return option ? option.name : "";
                }
                return field.value;
            }
            return "";
        }

        // --- NEW: Fetch Next ID from ClickUp ---
        async function fetchNextRefId() {
            const input = document.getElementById('input-ref-id');
            const originalValue = input.value;
            // Show temporary loading state
            input.value = "SCANNING...";
            
            try {
                // Fetch tasks from ClickUp
                const response = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task?include_closed=true&subtasks=true`, {
                    method: 'GET',
                    headers: { 'Authorization': CLICKUP_API_KEY }
                });
                
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);

                const result = await response.json();
                const tasks = result.tasks || [];
                
                let maxId = 0;
                const refFieldId = "a25c1d42-6191-4fde-8eb4-7f2059fd71e3";

                if (tasks.length > 0) {
                    tasks.forEach(task => {
                        const ref = getClickUpField(task, refFieldId);
                        
                        // Match format BC followed by digits
                        if (ref && typeof ref === 'string' && ref.match(/^BC\d+$/i)) {
                            const num = parseInt(ref.toUpperCase().replace('BC', ''), 10);
                            if (!isNaN(num) && num > maxId) maxId = num;
                        }
                    });
                }
                
                // Generate next ID
                const nextId = maxId + 1;
                const newRefStr = "BC" + String(nextId).padStart(5, '0');
                
                input.value = newRefStr;
                
                // Update preview specifically for Ref ID
                const output = document.getElementById('prev-ref-id');
                if(output) output.innerText = newRefStr;

            } catch (e) {
                console.error("Failed to fetch next ID from ClickUp", e);
                // Fallback to basic logic if API fails
                const lastLocal = localStorage.getItem('lastRefId');
                if (lastLocal) {
                    input.value = generateNextRefId(lastLocal);
                } else {
                    input.value = originalValue !== "SCANNING..." ? originalValue : "BC00001";
                }
                // Update preview for fallback
                const output = document.getElementById('prev-ref-id');
                if(output) output.innerText = input.value;
            }
        }

        // --- HELPER: Gather Table Data for Export ---
        function getTableData() {
            const education = [];
            document.querySelectorAll('#education-inputs > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if(inputs[0].value) education.push({
                    degree: inputs[0].value,
                    institution: inputs[1].value,
                    year: inputs[2].value
                });
            });

            const experience = [];
            document.querySelectorAll('#experience-inputs > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if(inputs[0].value) experience.push({
                    company: inputs[0].value,
                    position: inputs[1].value,
                    dates: inputs[2].value,
                    years: inputs[3].value
                });
            });

            const languages = [];
            document.querySelectorAll('#language-inputs > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const selects = row.querySelectorAll('select');
                if(inputs[0].value) languages.push({
                    language: inputs[0].value,
                    speak: selects[0].value,
                    read: selects[1].value,
                    write: selects[2].value
                });
            });

            return { education, experience, languages };
        }

        // --- ADVANCED SEARCH LOGIC ---

        let currentAdvSearchType = 'name';
        let cachedCandidates = []; // Store data locally for fuzzy search
        let isDataLoaded = false;

        function openAdvancedSearch() {
            const modal = document.getElementById('advanced-search-modal');
            modal.classList.remove('hidden');
            const input = document.getElementById('adv-search-input');
            input.focus();
            
            // Add Enter key listener
            input.onkeydown = function(e) {
                if(e.key === 'Enter') handleAdvSearch();
            };
            
            // Reload data every time modal opens to ensure freshness
            if (!isDataLoaded || cachedCandidates.length === 0) {
                loadAllCandidates();
            }
        }

        async function loadAllCandidates() {
            const loader = document.getElementById('adv-search-loader');
            const resultsContainer = document.getElementById('adv-search-results');
            loader.classList.remove('hidden');
            
            try {
                // Fetch ALL tasks from ClickUp
                const response = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task?include_closed=true&subtasks=true`, {
                    method: 'GET',
                    headers: { 'Authorization': CLICKUP_API_KEY }
                });
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const result = await response.json();
                const tasks = result.tasks || [];
                
                // Field IDs Mapping
                const F = {
                    ref: "a25c1d42-6191-4fde-8eb4-7f2059fd71e3",
                    passport: "b8798515-8962-40a7-a8cd-2685f9fd676c",
                    mobile: "5693724c-ee50-469b-a4a9-3848fe6d3115",
                    email: "2e18821e-1c19-4de5-afb8-77ff11ee6327",
                    surname: "34d446a2-fe50-45bc-8e3b-64660ebdd6f7",
                    position: "410dd336-f23f-4893-859f-d04e420f6431",
                    country: "dab9b7e7-5f2b-4958-aac8-de76f24e213b",
                    dob: "72d7dec6-eb69-4d1d-b5ea-af6e99d28a38",
                    exp: "5aa1bec5-f188-4ef7-8f7d-2b4778fbe738",
                    age: "f4ba427f-6e9c-4aa2-ae5c-8159e1254d2c",
                    alt: "343cabc5-9af5-48ca-a54e-f5bffd8c245d",
                    whatsapp: "87b4eee7-444f-4ec4-9882-441965757a68",
                    linkedin: "a60c7069-d4a9-4c17-90ba-9dfa7305e1a1",
                    marital: "03d06003-2084-4906-8514-31b2f862c83d",
                    address: "ae3be10a-cc2d-459e-a80a-1727115b2f0c",
                    gender: "fda5d956-0642-44f3-bbe7-c6c06b27fb2e",
                    location: "41c89ec2-4e22-4e85-ae57-de0e614bea88",
                    nationality: "4402d5e4-93b4-447e-8647-3417abf1a6e2",
                    residence: "20cb0f76-df42-4761-96e5-a268855f0eb9",
                    advisor: "a220503d-5a45-4f0b-b83d-6547a28ca0b5" // NEW ADVISOR FIELD
                };

                // Map Tasks to internal Cache structure
                cachedCandidates = tasks.map(task => ({
                    refId: getClickUpField(task, F.ref),
                    firstName: task.name, // ClickUp Task Name is used as First Name
                    surname: getClickUpField(task, F.surname),
                    passportNo: getClickUpField(task, F.passport),
                    mobile: getClickUpField(task, F.mobile),
                    email: getClickUpField(task, F.email),
                    position: getClickUpField(task, F.position),
                    country: getClickUpField(task, F.country),
                    // Capture description for complex data parsing
                    description: task.description || "",
                    // Store other fields for filling form
                    dob: getClickUpField(task, F.dob) ? new Date(parseInt(getClickUpField(task, F.dob))).toISOString().split('T')[0] : "",
                    passportExp: getClickUpField(task, F.exp) ? new Date(parseInt(getClickUpField(task, F.exp))).toISOString().split('T')[0] : "",
                    age: getClickUpField(task, F.age),
                    altPhone: getClickUpField(task, F.alt),
                    whatsapp: getClickUpField(task, F.whatsapp),
                    linkedin: getClickUpField(task, F.linkedin),
                    maritalStatus: getClickUpField(task, F.marital),
                    address: getClickUpField(task, F.address),
                    gender: getClickUpField(task, F.gender),
                    location: getClickUpField(task, F.location),
                    nationality: getClickUpField(task, F.nationality),
                    residence: getClickUpField(task, F.residence),
                    advisor: getClickUpField(task, F.advisor) // CACHE ADVISOR
                }));

                if (cachedCandidates.length > 0) {
                    isDataLoaded = true;
                    console.log(`Loaded ${cachedCandidates.length} candidates from ClickUp.`);
                    // If results container is showing error, clear it
                    if(resultsContainer.innerText.includes("Could not load") || resultsContainer.innerText.includes("Connection Failed")) {
                        resultsContainer.innerHTML = `<div class="text-center p-4 text-gray-400 text-xs">Database loaded from ClickUp. Ready to search.</div>`;
                    }
                } else {
                    console.warn("ClickUp loaded but task list is empty.");
                }
            } catch (e) {
                console.error("Background data load failed:", e);
                isDataLoaded = false;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function closeAdvancedSearch() {
            document.getElementById('advanced-search-modal').classList.add('hidden');
        }

        function setAdvSearchType(type) {
            currentAdvSearchType = type;
            ['name', 'passport', 'ref'].forEach(t => {
                const tab = document.getElementById(`tab-${t}`);
                if (t === type) { tab.classList.add('active'); tab.classList.remove('inactive'); }
                else { tab.classList.add('inactive'); tab.classList.remove('active'); }
            });
            const input = document.getElementById('adv-search-input');
            if(type === 'ref') input.placeholder = "Enter Reference ID...";
            else if(type === 'passport') input.placeholder = "Enter Passport Number...";
            else input.placeholder = "Enter Name...";
        }

        async function handleAdvSearch() {
            const query = document.getElementById('adv-search-input').value.trim();
            const resultsContainer = document.getElementById('adv-search-results');
            const loader = document.getElementById('adv-search-loader');

            if (!query) return;

            loader.classList.remove('hidden');

            if (!isDataLoaded || cachedCandidates.length === 0) {
                await loadAllCandidates();
                if (cachedCandidates.length === 0) {
                    resultsContainer.innerHTML = `<div class="text-center p-4 text-red-500 text-sm">Connection Failed. Could not retrieve data from ClickUp.</div>`;
                    loader.classList.add('hidden');
                    return;
                }
            }
            
            const results = cachedCandidates.filter(c => {
                const q = query.toLowerCase();
                let target = "";
                if (currentAdvSearchType === 'name') target = (c.firstName + " " + c.surname).toLowerCase();
                else if (currentAdvSearchType === 'passport') target = (c.passportNo || "").toLowerCase();
                else if (currentAdvSearchType === 'ref') target = (c.refId || "").toLowerCase();

                if (target.includes(q)) return true;
                if (q.length >= 3) {
                    const distance = levenshteinDistance(q, target);
                    const maxLength = Math.max(q.length, target.length);
                    const similarity = 1 - (distance / maxLength);
                    return similarity >= 0.5;
                }
                return false;
            });

            loader.classList.add('hidden');
            renderAdvancedResults(results);
            document.getElementById('result-count').innerText = results.length;
        }

        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) { matrix[i][j] = matrix[i - 1][j - 1]; }
                    else { matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)); }
                }
            }
            return matrix[b.length][a.length];
        }

        function renderAdvancedResults(results) {
            const container = document.getElementById('adv-search-results');
            container.innerHTML = '';

            if (!results || results.length === 0) {
                container.innerHTML = `<div class="text-center p-6 opacity-60"><p>No candidates found.</p></div>`;
                return;
            }
            
            const displayResults = results.slice(0, 50);
            displayResults.forEach(c => {
                const card = document.createElement('div');
                card.className = "adv-result-card group";
                card.onclick = function() { selectAdvancedCandidate(c); };
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold border border-slate-200 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                ${c.firstName[0] || '?'}${c.surname[0] || ''}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm group-hover:text-indigo-700 uppercase">${c.firstName} ${c.surname}</h4>
                                <p class="text-xs text-slate-500">${c.position || 'N/A'}  ${c.country || 'N/A'}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-[10px] font-mono font-bold border border-indigo-100">${c.refId || 'N/A'}</span>
                    </div>`;
                container.appendChild(card);
            });
        }

        function selectAdvancedCandidate(data) {
            closeAdvancedSearch();
            document.getElementById('input-ref-id').value = data.refId || "";
            document.getElementById('input-advisor').value = data.advisor || ""; // FILL ADVISOR
            document.getElementById('input-fname').value = data.firstName || "";
            document.getElementById('input-sname').value = data.surname || "";
            document.getElementById('input-position').value = data.position || "";
            document.getElementById('input-country').value = data.country || "";
            document.getElementById('input-passport-no').value = data.passportNo || "";
            document.getElementById('input-mobile').value = data.mobile || "";
            document.getElementById('input-email').value = data.email || "";
            document.getElementById('input-gender').value = data.gender || "";
            document.getElementById('input-marital').value = data.maritalStatus || "";
            document.getElementById('input-dob').value = data.dob || "";
            document.getElementById('input-age').value = data.age || "";
            document.getElementById('input-passport-exp').value = data.passportExp || "";
            document.getElementById('input-nationality').value = data.nationality || "";
            document.getElementById('input-residence').value = data.residence || "";
            document.getElementById('input-address').value = data.address || "";
            document.getElementById('input-alt').value = data.altPhone || "";
            document.getElementById('input-whatsapp').value = data.whatsapp || "";
            document.getElementById('input-linkedin').value = data.linkedin || "";
            document.getElementById('input-location').value = data.location || "";

            document.getElementById('education-inputs').innerHTML = '';
            document.getElementById('experience-inputs').innerHTML = '';
            document.getElementById('language-inputs').innerHTML = '';

            let extraData = {};
            if (data.description) {
                const jsonMatch = data.description.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch && jsonMatch[1]) {
                    try { extraData = JSON.parse(jsonMatch[1]); } catch(e) {}
                }
            }

            const edu = Array.isArray(extraData.education) ? extraData.education : [];
            const exp = Array.isArray(extraData.experience) ? extraData.experience : [];
            const lang = Array.isArray(extraData.languages) ? extraData.languages : [];

            edu.forEach(item => addEducationRow(item));
            exp.forEach(item => addExperienceRow(item));
            lang.forEach(item => addLanguageRow(item));

            if(document.getElementById('education-inputs').children.length === 0) addEducationRow();
            if(document.getElementById('experience-inputs').children.length === 0) addExperienceRow();
            if(document.getElementById('language-inputs').children.length === 0) addLanguageRow();

            calculateAge();
            updatePreview();
            
            const successOverlay = document.getElementById('success-overlay');
            if(successOverlay) {
                document.getElementById('success-title').innerText = "Candidate Loaded";
                document.getElementById('success-desc').innerHTML = `Candidate <b>${data.refId || data.firstName}</b> data populated from ClickUp.`;
                showSuccessOverlay();
            }
        }

        // --- HELPER FUNCTIONS ---

        function executeSearch() {
            alert("Please use the 'Adv. Search' button for the new ClickUp integration.");
        }

        function getValueSafe(id) {
            const el = document.getElementById(id);
            return el ? el.value : "";
        }

        function getValUpper(id) {
            const val = getValueSafe(id);
            return val ? val.toUpperCase() : "";
        }

        function sanitizePhoneForClickUp(phone) {
            if (!phone) return null;
            const cleaned = phone.replace(/[^0-9+]/g, '');
            if (cleaned.length < 5) return null; 
            return cleaned;
        }

        function formatDate(dateString) {
            if(!dateString) return "";
            const [year, month, day] = dateString.split('-');
            if(year && month && day) {
                return `${day}/${month}/${year}`;
            }
            return dateString;
        }

        function generateNextRefId(currentId) {
            const prefix = "BC";
            const match = currentId.match(/\d+$/);
            if (match) {
                const number = parseInt(match[0], 10) + 1;
                return prefix + String(number).padStart(5, '0');
            }
            return "BC00001";
        }

        function renderCheckboxes(containerId, list, prefix) {
            const container = document.getElementById(containerId);
            list.forEach((item, index) => {
                const id = `${prefix}-${index}`;
                const div = document.createElement('div');
                div.className = "flex items-center gap-2";
                div.innerHTML = `
                    <input type="checkbox" id="input-${id}" onchange="updatePreview()" class="w-3.5 h-3.5 text-blue-600 rounded focus:ring-blue-500">
                    <label for="input-${id}" class="text-xs text-slate-600 uppercase">${item}</label>
                `;
                container.appendChild(div);
            });
        }

        function addEducationRow(data = {}) {
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center group";
            div.innerHTML = `
                <input type="text" placeholder="Degree/Cert" value="${data.degree || ''}" class="border rounded p-1 text-xs w-2/5" oninput="updatePreview()">
                <input type="text" placeholder="Institution" value="${data.institution || ''}" class="border rounded p-1 text-xs w-2/5" oninput="updatePreview()">
                <input type="text" placeholder="Year" value="${data.year || ''}" class="border rounded p-1 text-xs w-1/5" oninput="updatePreview()">
                <button type="button" onclick="this.parentElement.remove(); updatePreview()" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
            `;
            document.getElementById('education-inputs').appendChild(div);
        }

        function addExperienceRow(data = {}) {
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center group";
            div.innerHTML = `
                <input type="text" placeholder="Company" value="${data.company || ''}" class="border rounded p-1 text-xs w-1/4" oninput="updatePreview()">
                <input type="text" placeholder="Position" value="${data.position || ''}" class="border rounded p-1 text-xs w-1/4" oninput="updatePreview()">
                <input type="text" placeholder="Dates" value="${data.dates || ''}" class="border rounded p-1 text-xs w-1/4" oninput="updatePreview()">
                <input type="text" placeholder="Yrs" value="${data.years || ''}" class="border rounded p-1 text-xs w-1/6" oninput="updatePreview()">
                <button type="button" onclick="this.parentElement.remove(); updatePreview()" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
            `;
            document.getElementById('experience-inputs').appendChild(div);
        }

        function addLanguageRow(data = {}) {
            const levels = `<option>NATIVE</option><option>FLUENT</option><option selected>INTERMEDIATE</option><option>BASIC</option>`;
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center group";
            div.innerHTML = `
                <input type="text" placeholder="Language" value="${data.language || ''}" class="border rounded p-1 text-xs w-1/4" oninput="updatePreview()">
                <select class="border rounded p-1 text-[10px] w-1/5" onchange="updatePreview()">${levels}</select>
                <select class="border rounded p-1 text-[10px] w-1/5" onchange="updatePreview()">${levels}</select>
                <select class="border rounded p-1 text-[10px] w-1/5" onchange="updatePreview()">${levels}</select>
                <button type="button" onclick="this.parentElement.remove(); updatePreview()" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
            `;
            document.getElementById('language-inputs').appendChild(div);
        }

        function resetForm() {
            if(!confirm("Are you sure you want to clear all data and start a new extraction?")) return;

            const inputs = document.querySelectorAll('#app-form input:not([type="checkbox"]), #app-form textarea, #app-form select');
            inputs.forEach(input => {
                if(input.id !== 'input-ref-id') { 
                    input.value = '';
                }
            });

            const checkboxes = document.querySelectorAll('#app-form input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);

            const templateCheckboxes = document.querySelectorAll('#template-panel input[type="checkbox"]');
            templateCheckboxes.forEach(cb => {
                cb.checked = true; 
                const onchangeAttr = cb.getAttribute('onchange');
                if (onchangeAttr) {
                    const match = onchangeAttr.match(/'([^']+)'/);
                    if (match && match[1]) {
                        const section = match[1];
                        const el = document.getElementById(`prev-section-${section}`);
                        if (el) el.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('education-inputs').innerHTML = '';
            document.getElementById('experience-inputs').innerHTML = '';
            document.getElementById('language-inputs').innerHTML = '';

            addEducationRow();
            addExperienceRow();
            addLanguageRow();

            document.getElementById('photo-preview-input').src = "";
            document.getElementById('photo-preview-input').classList.add('hidden');
            document.getElementById('prev-photo').src = "";
            document.getElementById('prev-photo').classList.add('hidden');
            document.getElementById('prev-photo-placeholder').classList.remove('hidden');

            filesToProcess = [];
            renderFileList();
            
            isDataLoaded = false;
            cachedCandidates = [];
            
            fetchNextRefId();

            updatePreview();
        }

        function toggleTemplatePanel() {
            const panel = document.getElementById('template-panel');
            panel.classList.toggle('hidden');
        }

        function toggleSection(section, checkbox) {
            const el = document.getElementById(`prev-section-${section}`);
            if(el) {
                if(checkbox.checked) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
        }

        function openFileModal() {
            document.getElementById('file-upload-modal').classList.remove('hidden');
        }

        function closeFileModal() {
            document.getElementById('file-upload-modal').classList.add('hidden');
        }

        function handleFileSelect(input) {
            if (input.files) {
                for (let file of input.files) {
                    filesToProcess.push(file);
                }
            }
            input.value = "";
            renderFileList();
        }

        function removeFileFromQueue(index) {
            filesToProcess.splice(index, 1);
            renderFileList();
        }

        function renderFileList() {
            const container = document.getElementById('selected-files-container');
            const noFilesMsg = document.getElementById('no-files-msg');
            const countLabel = document.getElementById('file-count-label');
            const startBtn = document.getElementById('start-ocr-btn');

            container.innerHTML = '';
            
            if (filesToProcess.length === 0) {
                noFilesMsg.classList.remove('hidden');
                startBtn.disabled = true;
                countLabel.innerText = "0 Files Selected";
                return;
            }

            noFilesMsg.classList.add('hidden');
            startBtn.disabled = false;
            countLabel.innerText = `${filesToProcess.length} Files Selected`;

            filesToProcess.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm";
                
                let iconClass = "fa-file";
                let colorClass = "text-gray-500";
                
                if (file.type.includes('image')) { iconClass = "fa-file-image"; colorClass = "text-purple-500"; }
                else if (file.type.includes('pdf')) { iconClass = "fa-file-pdf"; colorClass = "text-red-500"; }
                else if (file.type.includes('word')) { iconClass = "fa-file-word"; colorClass = "text-blue-500"; }

                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-solid ${iconClass} ${colorClass} text-lg"></i>
                        <div class="truncate">
                            <p class="text-sm font-medium text-slate-700 truncate">${file.name}</p>
                            <p class="text-[10px] text-gray-400 uppercase">${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                    </div>
                    <button onclick="removeFileFromQueue(${index})" class="text-gray-300 hover:text-red-500 transition">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        function updatePreview() {
            const fields = [
                'ref-id', 'country', 'client', 'position', 'skill-type', 'fname', 'sname', 
                'nationality', 'gender', 'marital', 'age', 'residence', 'passport-no', 
                'pob', 'place-issue', 'state-birth', 'mobile', 
                'whatsapp', 'email', 'alt', 'linkedin', 'address', 'location', 'zip'
            ];

            fields.forEach(id => {
                const input = document.getElementById(`input-${id}`);
                const output = document.getElementById(`prev-${id}`);
                if(input && output) output.innerText = input.value || "";
            });

            // Special: Visa Type append to Country header
            const skillType = document.getElementById('input-skill-type');
            const visaOutput = document.getElementById('prev-visa-type');
            if(skillType && visaOutput) visaOutput.innerText = skillType.value || "";

            const dobInput = document.getElementById('input-dob');
            const dobOutput = document.getElementById('prev-dob');
            if(dobInput && dobOutput) dobOutput.innerText = formatDate(dobInput.value);

            const expInput = document.getElementById('input-passport-exp');
            const expOutput = document.getElementById('prev-passport-exp');
            if(expInput && expOutput) expOutput.innerText = formatDate(expInput.value);

            // Update Tables - SMART ROW FILTERING
            updateTable('education-inputs', 'prev-education-body', (inputs) => `
                <td class="font-bold">${inputs[0].value}</td>
                <td>${inputs[1].value}</td>
                <td class="text-center">${inputs[2].value}</td>
            `);

            updateTable('experience-inputs', 'prev-experience-body', (inputs) => {
                // Helper to format the display column nicely
                const rawDuration = inputs[3].value;
                const formattedDuration = formatDurationDisplay(rawDuration);
                
                return `
                <td class="font-bold">${inputs[0].value}</td>
                <td>${inputs[1].value}</td>
                <td>${inputs[2].value}</td>
                <td class="text-center font-semibold text-blue-900">${formattedDuration}</td>
            `});

            // --- NEW: Calculate Total Experience ---
            calculateTotalExperience();

            updateTable('language-inputs', 'prev-language-body', (inputs, row) => {
                const selects = row.querySelectorAll('select');
                return `
                    <td class="font-bold">${inputs[0].value}</td>
                    <td class="text-center text-[8pt]">${selects[0].value}</td>
                    <td class="text-center text-[8pt]">${selects[1].value}</td>
                    <td class="text-center text-[8pt]">${selects[2].value}</td>
                `;
            });

            updateCheckboxList(attachments, 'att', 'prev-attachments');
            updateCheckboxList(submissions, 'sub', 'prev-submission');
            
            // --- NEW: Dynamic Visibility for Checklists ---
            const attList = document.getElementById('prev-attachments');
            const subList = document.getElementById('prev-submission');
            const attCol = document.getElementById('prev-col-attachments');
            const subCol = document.getElementById('prev-col-submission');
            const sectionFooter = document.getElementById('prev-section-attachments');

            const hasAttachments = attList.children.length > 0;
            const hasSubmissions = subList.children.length > 0;

            // Toggle individual columns
            if (hasAttachments) {
                attCol.classList.remove('hidden');
            } else {
                attCol.classList.add('hidden');
            }

            if (hasSubmissions) {
                subCol.classList.remove('hidden');
            } else {
                subCol.classList.add('hidden');
            }

            // Toggle main section (only show if at least one column has data)
            if (hasAttachments || hasSubmissions) {
                sectionFooter.classList.remove('hidden');
            } else {
                sectionFooter.classList.add('hidden');
            }

            // --- NEW: Highlight Logic for Required Fields Only ---
            // 1. Reset all highlights first
            const allInputs = document.querySelectorAll('#app-form input, #app-form select, #app-form textarea');
            allInputs.forEach(el => el.classList.remove('highlight-empty', 'highlight-filled'));

            let allRequiredFilled = true;

            // 2. Check only required fields
            REQUIRED_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const val = el.value.trim();
                    if (!val) {
                        el.classList.add('highlight-empty');
                        allRequiredFilled = false;
                    } else {
                        el.classList.add('highlight-filled');
                    }
                }
            });

            // 3. Enable/Disable Buttons based on validity
            const actionBtns = ['btn-save-data', 'btn-upload-pdf', 'btn-print', 'btn-pdf']; // Updated IDs
            actionBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if(btn) {
                    btn.disabled = !allRequiredFilled;
                    if(!allRequiredFilled) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        // Optional: Add tooltip logic here if desired, e.g. title attr
                        btn.title = "Please fill all required fields marked with *";
                    } else {
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.title = "";
                    }
                }
            });
        }

        function updateTable(inputId, previewId, renderFn) {
            const container = document.getElementById(inputId);
            const tbody = document.getElementById(previewId);
            tbody.innerHTML = '';
            Array.from(container.children).forEach(row => {
                const inputs = row.querySelectorAll('input');
                let hasData = false;
                inputs.forEach(input => {
                    if (input.value.trim() !== '') hasData = true;
                });
                
                if (hasData) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = renderFn(inputs, row);
                    tbody.appendChild(tr);
                }
            });
        }

        // --- NEW FUNCTION: Calculate Grand Total Years & Months ---
        function calculateTotalExperience() {
            let totalMonths = 0;
            const rows = document.querySelectorAll('#experience-inputs > div');
            let hasValue = false;

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const datesInput = inputs[2];
                const yrsInput = inputs[3];
                
                let rowMonths = 0;
                
                // 1. Try to Parse Date Range (e.g., "2021-11-15 to Present")
                if (datesInput && datesInput.value.trim()) {
                    const parsed = parseExperienceMonths(datesInput.value);
                    if (parsed !== null) {
                        rowMonths = parsed;
                        // Auto-fill Yrs field if empty
                        if (!yrsInput.value.trim()) {
                            const y = Math.floor(rowMonths / 12);
                            const m = Math.round(rowMonths % 12);
                            let str = "";
                            if (y > 0) str += `${y} Years `;
                            if (m > 0) str += `${m} Months`;
                            if (!str) str = "0 Months";
                            yrsInput.value = str.trim();
                        }
                    }
                }

                // 2. Parse the Yrs Input for Total Calculation
                if (yrsInput && yrsInput.value.trim()) {
                    hasValue = true;
                    const val = yrsInput.value.trim();
                    rowMonths = parseDurationToMonths(val);
                }
                
                totalMonths += rowMonths;
            });

            const displayEl = document.getElementById('prev-exp-total');
            const valueEl = document.getElementById('exp-total-value');

            if (hasValue && totalMonths > 0) {
                const years = Math.floor(totalMonths / 12);
                const months = Math.round(totalMonths % 12);
                
                let text = "";
                if (years > 0) text += `${years} Years `;
                if (months > 0) text += `${months} Months`;
                
                if (years > 0 && months === 0) text = `${years} Years`;
                if (years === 0 && months > 0) text = `${months} Months`;

                valueEl.innerText = text;
                displayEl.classList.remove('hidden');
            } else {
                displayEl.classList.add('hidden');
            }
        }

        // Helper: Convert "6.5", "6 Years 2 Months" to total months count
        function parseDurationToMonths(val) {
            if (!val) return 0;
            val = val.toLowerCase();
            let months = 0;

            // Regex for "X Years Y Months"
            const yearMatch = val.match(/(\d+(?:\.\d+)?)\s*(?:y|yrs?|years?)/);
            const monthMatch = val.match(/(\d+(?:\.\d+)?)\s*(?:m|mos?|months?)/);

            if (yearMatch) months += parseFloat(yearMatch[1]) * 12;
            if (monthMatch) months += parseFloat(monthMatch[1]);

            // Regex for pure decimal "6.7" -> Treat as Years (Standard decimal)
            if (!yearMatch && !monthMatch) {
                const floatVal = parseFloat(val);
                if (!isNaN(floatVal)) {
                    months += floatVal * 12;
                }
            }
            return months;
        }

        // Helper: Format display string (e.g. "6.7" -> "6 Years 8 Months")
        function formatDurationDisplay(val) {
            if (!val) return "";
            // If it already contains letters, return as is (assumed pre-formatted)
            if (val.match(/[a-z]/i)) return val;

            // If it's a pure number like "6.7"
            const floatVal = parseFloat(val);
            if (!isNaN(floatVal)) {
                const years = Math.floor(floatVal);
                // Convert decimal fraction to months (e.g. 0.5 * 12 = 6)
                const months = Math.round((floatVal - years) * 12);
                
                let parts = [];
                if (years > 0) parts.push(`${years} Years`);
                if (months > 0) parts.push(`${months} Months`);
                if (parts.length === 0) return "0 Months";
                return parts.join(" ");
            }
            return val;
        }

        // Helper to parse date ranges like "2021-11-15 to Present"
        function parseExperienceMonths(dateStr) {
            if (!dateStr) return null;
            
            // Normalize separators: Replace 'to', 'till', 'until' with hyphen
            let cleanStr = dateStr.replace(/\s+(?:to|till|until)\s+/gi, ' - ');
            // Split by hyphen or en/em-dash
            const parts = cleanStr.split(/\s*[-]\s*/);
            
            if (parts.length !== 2) return null; 
            
            let startStr = parts[0].trim();
            let endStr = parts[1].trim().toLowerCase();
            
            // Parse Helper
            const parseDate = (s) => {
                // Handle "Nov 2021" -> "1 Nov 2021"
                if (s.match(/^[a-zA-Z]+\s+\d{4}$/)) return new Date("1 " + s);
                // Handle "2021" -> "1 Jan 2021"
                if (s.match(/^\d{4}$/)) return new Date("1 Jan " + s);
                const d = new Date(s);
                return isNaN(d.getTime()) ? null : d;
            };

            const startDate = parseDate(startStr);
            if (!startDate) return null;

            // Parse End
            let endDate = new Date(); // Default to Now
            const currentKeywords = ['present', 'now', 'current', 'today', 'till date', 'date'];
            
            // If NOT a keyword, try to parse as date
            if (!currentKeywords.some(k => endStr.includes(k))) {
                const parsedEnd = parseDate(endStr);
                if (parsedEnd) endDate = parsedEnd;
                else return null; // Invalid end date
            }

            // Calculate Difference
            let months = (endDate.getFullYear() - startDate.getFullYear()) * 12;
            months -= startDate.getMonth();
            months += endDate.getMonth();
            
            // Adjust for day of month (e.g. Started 20th, ended 10th -> not full month)
            if (endDate.getDate() < startDate.getDate()) {
                months--;
            }
            
            return months < 0 ? 0 : months;
        }

        function updateCheckboxList(list, prefix, targetId) {
            const target = document.getElementById(targetId);
            target.innerHTML = '';
            list.forEach((item, index) => {
                const cb = document.getElementById(`input-${prefix}-${index}`);
                if(cb.checked) {
                    const li = document.createElement('li');
                    li.className = "checklist-item";
                    li.innerHTML = `<span class="check-box-icon checked"><i class="fa-solid fa-check text-[7px]"></i></span> ${item}`;
                    target.appendChild(li);
                } 
            });
        }

        function calculateAge() {
            const dob = document.getElementById('input-dob').value;
            if (dob) {
                const today = new Date();
                const birthDate = new Date(dob);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                document.getElementById('input-age').value = age;
            } else {
                 document.getElementById('input-age').value = "";
            }
            updatePreview();
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photo-preview-input').src = e.target.result;
                    document.getElementById('photo-preview-input').classList.remove('hidden');
                    document.getElementById('prev-photo').src = e.target.result;
                    document.getElementById('prev-photo').classList.remove('hidden');
                    document.getElementById('prev-photo-placeholder').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function downloadPDF() {
            const element = document.getElementById('print-area');
            const clone = element.cloneNode(true);
            clone.style.boxShadow = 'none';
            clone.style.margin = '0';
            clone.style.width = '210mm'; 
            clone.style.minHeight = 'auto'; 
            clone.style.height = 'auto'; 

            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.width = '210mm'; 
            container.appendChild(clone);
            document.body.appendChild(container);

            const opt = {
                margin: 0, 
                filename: 'Application_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0, windowWidth: 794 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } 
            };

            html2pdf().set(opt).from(clone).save().then(() => {
                document.body.removeChild(container);
            }).catch(e => {
                alert("PDF Error: " + e.message);
                document.body.removeChild(container);
            });
        }

        function printReport() {
            window.print();
        }

        function closeScannerOverlay() {
            document.getElementById('scanner-overlay').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('scan-anim-box').classList.remove('hidden');
                document.getElementById('scan-success-box').classList.add('hidden');
                document.getElementById('scan-success-box').classList.add('scale-90');
                document.getElementById('scanner-progress').style.width = '0%';
            }, 500);
        }
        
        async function startBatchOCR() {
            closeFileModal();
            const overlay = document.getElementById('scanner-overlay');
            const status = document.getElementById('scanner-status');
            const progress = document.getElementById('scanner-progress');
            const useAI = document.getElementById('ai-toggle').checked;
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            let combinedText = "";
            let filesProcessed = 0;
            const totalFiles = filesToProcess.length;

            try {
                for (let file of filesToProcess) {
                    status.innerText = `Scanning: ${file.name} (${filesProcessed + 1}/${totalFiles})...`;
                    progress.style.width = `${((filesProcessed) / totalFiles) * 80}%`;
                    
                    let text = "";
                    if (file.type === 'application/pdf') {
                        text = await extractTextFromPDF(file);
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        text = await extractTextFromDOCX(file);
                    } else if (file.type.startsWith('image/')) {
                        text = await extractTextFromImage(file);
                    }
                    combinedText += `\n--- FILE: ${file.name} ---\n` + text;
                    filesProcessed++;
                }

                progress.style.width = "90%";
                if (useAI) {
                    status.innerText = "Analyzing with Puter AI...";
                    await analyzeWithPuter(combinedText);
                } else {
                    status.innerText = "Running Deep Regex & MRZ Engine...";
                    await new Promise(r => setTimeout(r, 800));
                    fillFromOCR(combinedText);
                }
                
                progress.style.width = "100%";
                setTimeout(() => {
                    document.getElementById('scan-anim-box').classList.add('hidden');
                    const successBox = document.getElementById('scan-success-box');
                    successBox.classList.remove('hidden');
                    setTimeout(() => {
                        successBox.classList.remove('scale-90');
                        successBox.classList.add('scale-100');
                    }, 50);
                }, 500);

            } catch (error) {
                console.error(error);
                closeScannerOverlay();
                alert("Error processing files: " + error.message);
            }
        }

        async function analyzeWithPuter(text) {
            const prompt = `
                Extract structured data from the following resume text. 
                Return strictly a valid JSON object (no markdown, no backticks).
                Dates should be YYYY-MM-DD format.
                
                Required JSON Structure:
                {
                    "firstName": "String",
                    "surname": "String",
                    "email": "String",
                    "mobile": "String",
                    "nationality": "String",
                    "gender": "String",
                    "maritalStatus": "String",
                    "dob": "YYYY-MM-DD",
                    "passportNo": "String",
                    "passportExpiry": "YYYY-MM-DD",
                    "pob": "String",
                    "placeIssue": "String",
                    "address": "String",
                    "education": [{"degree": "", "institution": "", "year": ""}],
                    "experience": [{"company": "", "position": "", "dates": "", "years": ""}]
                }
                
                Text to Analyze:
                ${text.substring(0, 30000)}
            `;

            try {
                // Using Puter.js chat API
                const response = await puter.ai.chat(prompt);
                
                // Handle different response formats (string vs object)
                let rawText = "";
                if (typeof response === 'string') {
                    rawText = response;
                } else if (response && response.message && response.message.content) {
                    rawText = response.message.content;
                } else {
                    console.log("Unexpected Puter Response:", response);
                    throw new Error("Invalid response format from AI");
                }

                // Clean up potential markdown formatting
                const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const extractedData = JSON.parse(jsonStr);
                applyDataToForm(extractedData);

            } catch (err) {
                console.error("AI Analysis Failed:", err);
                // Fallback to Regex if AI fails
                fillFromOCR(text); 
                alert("AI Analysis encountered an issue. Switched to standard extraction.");
            }
        }

        function applyDataToForm(data) {
            const fill = (id, val) => {
                const el = document.getElementById(id);
                if (el && !el.value && val) el.value = val;
            };

            if(data.firstName) fill('input-fname', data.firstName);
            if(data.surname) fill('input-sname', data.surname);
            if(data.email) fill('input-email', data.email);
            if(data.mobile) fill('input-mobile', data.mobile);
            if(data.nationality) fill('input-nationality', data.nationality);
            if(data.passportNo) fill('input-passport-no', data.passportNo);
            if(data.dob) { fill('input-dob', data.dob); calculateAge(); }
            if(data.passportExpiry) fill('input-passport-exp', data.passportExpiry);
            if(data.pob) fill('input-pob', data.pob);
            if(data.placeIssue) fill('input-place-issue', data.placeIssue);
            if(data.address) fill('input-address', data.address);
            if(data.gender) {
                const g = data.gender.toLowerCase();
                const sel = document.getElementById('input-gender');
                if(!sel.value && g.startsWith('m')) sel.value = 'Male';
                if(!sel.value && g.startsWith('f')) sel.value = 'Female';
            }
            if(data.education && Array.isArray(data.education)) {
                data.education.forEach(edu => addEducationRow(edu));
            }
            if(data.experience && Array.isArray(data.experience)) {
                data.experience.forEach(exp => addExperienceRow(exp));
            }
            updatePreview();
        }

        async function extractTextFromImage(file) {
            const result = await Tesseract.recognize(file, 'eng');
            return result.data.text;
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";
            const page1 = await pdf.getPage(1);
            const textContent = await page1.getTextContent();
            const hasText = textContent.items.length > 5; 

            if (hasText) {
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(" ");
                    fullText += pageText + "\n";
                }
            } else {
                const pagesToScan = Math.min(pdf.numPages, 2);
                const status = document.getElementById('scanner-status');
                if(status) status.innerText = "Scanned PDF detected. Running Deep OCR...";

                for (let i = 1; i <= pagesToScan; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    const imgData = canvas.toDataURL('image/png');
                    const ocrResult = await Tesseract.recognize(imgData, 'eng');
                    fullText += ocrResult.data.text + "\n";
                }
            }
            return fullText;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value;
        }

        // --- NEW: STRONG OCR ENGINE (REGEX + MRZ + CONTEXT) ---
        function fillFromOCR(text) {
            console.log("Starting Deep Regex Engine Analysis..."); 
            const fill = (id, val) => {
                const el = document.getElementById(id);
                // Only fill if empty to avoid overwriting user edits or previous better matches
                if (el && !el.value && val) el.value = val.trim();
            };

            // 1. Clean Text
            const cleanText = text.replace(/\|/g, 'I').replace(/\[/g, 'I').replace(/\]/g, 'I'); 
            
            // 2. MRZ PARSING (Machine Readable Zone for Passports) - HIGH CONFIDENCE
            // Look for lines starting with P< or I< or V<
            const mrzLines = cleanText.match(/[PIVA]<[A-Z0-9<]{30,}/g);
            if (mrzLines && mrzLines.length >= 2) {
                console.log("MRZ Detected - Extracting Passport Data");
                try {
                    const line2 = mrzLines.find(l => l.match(/[A-Z0-9]{9}\d{1}[A-Z]{3}\d{6}/)); // Contains number, dob, expiry
                    const line1 = mrzLines.find(l => l.startsWith('P<')); // Name line

                    if (line2) {
                        // Passport Number (First 9 chars)
                        let pptNo = line2.substring(0, 9).replace(/</g, '');
                        fill('input-passport-no', pptNo);
                        
                        // DOB (Chars 13-19: YYMMDD)
                        let dobRaw = line2.substring(13, 19);
                        let dobDate = parseCompactDate(dobRaw); 
                        if(dobDate) { fill('input-dob', dobDate); calculateAge(); }

                        // Sex (Char 20)
                        let sex = line2.charAt(20);
                        if(sex === 'M') document.getElementById('input-gender').value = 'Male';
                        if(sex === 'F') document.getElementById('input-gender').value = 'Female';

                        // Expiry (Chars 21-27: YYMMDD)
                        let expRaw = line2.substring(21, 27);
                        let expDate = parseCompactDate(expRaw, true); // true = future bias
                        if(expDate) fill('input-passport-exp', expDate);

                         // Nationality (Chars 10-13)
                         let natCode = line2.substring(10, 13).replace(/</g, '');
                         if(natCode && natCode.length === 3) fill('input-nationality', natCode); 
                    }

                    if (line1) {
                        // Name Extraction: P<USASURNAME<<GIVEN<NAME<<<<
                        let namePart = line1.substring(5);
                        let parts = namePart.split('<<');
                        if(parts.length >= 1) fill('input-sname', parts[0].replace(/</g, ' '));
                        if(parts.length >= 2) fill('input-fname', parts[1].replace(/</g, ' '));
                    }
                    
                    // Auto-check passport attachment if MRZ found
                    document.getElementById('input-att-2').checked = true;

                } catch (e) { console.error("MRZ Parse Error", e); }
            }

            // 3. STRONG REGEX PARSING (Fallback & Supplement)

            // Email (Refined to avoid noise)
            const emailMatch = cleanText.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/);
            if(emailMatch) fill('input-email', emailMatch[0].toLowerCase());

            // Phone (International format bias)
            // Looks for numbers starting with + or 00, or explicitly labelled
            const phoneContext = cleanText.match(/(?:Mobile|Phone|Cell|Tel|WhatsApp)[:\s.-]*([+\d\s()-]{8,20})/i);
            if (phoneContext) fill('input-mobile', phoneContext[1].replace(/[^\d+]/g, ''));
            else {
                // Fallback: finding lone phone-like strings
                const phoneMatch = cleanText.match(/(?:\+91|\+971|\+1|\+44|00)[-\s]?[0-9]{3}[-\s]?[0-9]{3,}/);
                if(phoneMatch) fill('input-mobile', phoneMatch[0]);
            }

            // Dates (Context Aware)
            const findDateWithContext = (keywords, elementId, futureBias = false) => {
                const lines = cleanText.split('\n');
                const datePattern = /\b(\d{1,2})[\/\-\.](\d{1,2}|[A-Za-z]{3})[\/\-\.](\d{2,4})\b/; // Matches 12/01/2020 or 12-Jan-2020
                
                for (let line of lines) {
                    if (keywords.some(k => line.toLowerCase().includes(k))) {
                        const match = line.match(datePattern);
                        if (match) {
                            const iso = convertToISODate(match[0], futureBias);
                            if(iso) { fill(elementId, iso); return; }
                        }
                    }
                }
            };

            findDateWithContext(['birth', 'dob', 'born'], 'input-dob', false);
            findDateWithContext(['expiry', 'expires', 'valid until'], 'input-passport-exp', true);

            // Names (If not filled by MRZ)
            if (!document.getElementById('input-fname').value) {
                const nameContext = cleanText.match(/(?:Name|Given Name)[:\s]+([A-Z][a-z]+(?:\s[A-Z][a-z]+)*)/);
                if(nameContext) fill('input-fname', nameContext[1]);
            }
            if (!document.getElementById('input-sname').value) {
                const surContext = cleanText.match(/(?:Surname|Family Name|Last Name)[:\s]+([A-Z][a-z]+)/);
                if(surContext) fill('input-sname', surContext[1]);
            }

            // Gender (Regex)
            const genderMatch = cleanText.match(/\b(Male|Female|Sex\s*[:\s-]*[MF])\b/i);
            if (genderMatch) {
                const g = genderMatch[0].toUpperCase();
                if (g.includes('FEMALE') || g.includes(' F')) document.getElementById('input-gender').value = 'Female';
                else if (g.includes('MALE') || g.includes(' M')) document.getElementById('input-gender').value = 'Male';
            }

            // Passport Number (Fallback if MRZ failed)
            if (!document.getElementById('input-passport-no').value) {
                // Look for 1 letter followed by 7-9 digits (Standard format)
                const pptMatch = cleanText.match(/\b[A-Z]{1}\d{7,9}\b/);
                if(pptMatch) fill('input-passport-no', pptMatch[0]);
            }

            // Nationality (Keyword Search)
            const natMatch = cleanText.match(/(?:Nationality|Citizen of)[:\s]*([A-Za-z]+)/i);
            if(natMatch) fill('input-nationality', natMatch[1].toUpperCase());

            // Checklists Inference
            if(cleanText.toLowerCase().includes("resume") || cleanText.toLowerCase().includes("curriculum vitae")) document.getElementById('input-att-0').checked = true;
            if(cleanText.toLowerCase().includes("diploma") || cleanText.toLowerCase().includes("degree")) document.getElementById('input-att-4').checked = true;
            
            // Trigger calculations
            if(document.getElementById('input-dob').value) calculateAge();
            updatePreview();
        }

        // --- NEW: Save Data Only Function ---
        async function saveDataToClickUp() {
            const btn = document.getElementById('btn-save-data');
            const originalText = btn ? btn.innerHTML : "Save Data";
            if(btn) {
                btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Saving...`;
                btn.disabled = true;
            }

            try {
                const taskName = getValUpper('input-fname');
                const refId = getValUpper('input-ref-id');
                
                if(!taskName || !refId) throw new Error("First Name and Reference ID are required.");

                const complexData = getTableData();
                const descriptionContent = `
Imported via Resume Extractor Tool
Reference ID: ${refId}

---
**Structured Data (Do Not Edit Manually):**
\`\`\`json
${JSON.stringify(complexData, null, 2)}
\`\`\`
---
`;
                const taskId = await createOrUpdateTask(refId, taskName, descriptionContent);
                
                document.getElementById('success-title').innerText = "Data Saved!";
                document.getElementById('success-desc').innerHTML = `Candidate <span class="font-bold text-gray-800">${refId}</span> data has been successfully saved to ClickUp (ID: ${taskId}).`;
                showSuccessOverlay();

            } catch (error) {
                console.error(error);
                alert("Save Failed: " + error.message);
            } finally {
                if(btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // --- NEW: Save PDF Only Function ---
        async function savePdfToClickUp() {
            const btn = document.getElementById('btn-upload-pdf');
            const originalText = btn ? btn.innerHTML : "Upload PDF";
            if(btn) {
                btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Uploading...`;
                btn.disabled = true;
            }

            try {
                const taskName = getValUpper('input-fname');
                const refId = getValUpper('input-ref-id');
                
                if(!taskName || !refId) throw new Error("First Name and Reference ID are required.");

                // 1. Find Task
                const taskId = await findTaskByRefId(refId);
                
                if (!taskId) {
                    throw new Error("Task not found in ClickUp. Please click 'Save Data' first to create the record.");
                }

                // 2. Generate PDF (Clone method to avoid visual glitches)
                const element = document.getElementById('print-area');
                const clone = element.cloneNode(true);
                clone.style.boxShadow = 'none';
                clone.style.margin = '0';
                clone.style.width = '210mm'; 
                clone.style.minHeight = 'auto'; 
                clone.style.height = 'auto'; 

                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '0';
                container.style.width = '210mm'; 
                container.appendChild(clone);
                document.body.appendChild(container);

                let pdfBlob;
                try {
                    const opt = {
                        margin: 0, 
                        filename: 'Application_Report.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, scrollY: 0, windowWidth: 794 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } 
                    };
                    // Get blob directly
                    pdfBlob = await html2pdf().set(opt).from(clone).output('blob');
                } catch(pdfErr) {
                    throw new Error("PDF Generation Failed: " + pdfErr.message);
                } finally {
                    document.body.removeChild(container);
                }

                // 3. Upload Attachment
                const formData = new FormData();
                formData.append('attachment', pdfBlob, `${taskName.replace(/\s+/g, '_')}_Report.pdf`);

                const attachResponse = await fetch(`https://api.clickup.com/api/v2/task/${taskId}/attachment`, {
                    method: 'POST',
                    headers: { 'Authorization': CLICKUP_API_KEY },
                    body: formData
                });

                if (!attachResponse.ok) throw new Error("Failed to upload PDF attachment to ClickUp.");

                document.getElementById('success-title').innerText = "PDF Uploaded!";
                document.getElementById('success-desc').innerHTML = `PDF Report successfully attached to candidate <span class="font-bold text-gray-800">${refId}</span>.`;
                showSuccessOverlay();

            } catch (error) {
                console.error(error);
                alert("Upload Failed: " + error.message);
            } finally {
                if(btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // --- HELPER: Find Task ID by Ref ID ---
        async function findTaskByRefId(refId) {
            const refFieldId = "a25c1d42-6191-4fde-8eb4-7f2059fd71e3";
            const query = JSON.stringify([{ "field_id": refFieldId, "operator": "=", "value": refId }]);
            
            const searchResponse = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task?custom_fields=${encodeURIComponent(query)}&include_closed=true`, {
                method: 'GET',
                headers: { 'Authorization': CLICKUP_API_KEY }
            });
            
            if(searchResponse.ok) {
                const searchResult = await searchResponse.json();
                if (searchResult.tasks && searchResult.tasks.length > 0) {
                    return searchResult.tasks[0].id;
                }
            }
            return null;
        }

        // --- HELPER: Create or Update Task Logic ---
        async function createOrUpdateTask(refId, taskName, description) {
            const getDateTs = (id) => { const val = getValueSafe(id); return val ? new Date(val).getTime() : null; };
            
            // Fetch Fields to validate
            const fieldsResponse = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/field`, {
                method: 'GET',
                headers: { 'Authorization': CLICKUP_API_KEY }
            });
            const fieldsData = await fieldsResponse.json();
            const validFieldIds = new Set(fieldsData.fields.map(f => f.id));

            const potentialFields = [
                { id: "72d7dec6-eb69-4d1d-b5ea-af6e99d28a38", value: getDateTs('input-dob') },
                { id: "5aa1bec5-f188-4ef7-8f7d-2b4778fbe738", value: getDateTs('input-passport-exp') },
                { id: "2e18821e-1c19-4de5-afb8-77ff11ee6327", value: getValUpper('input-email') },
                { id: "f4ba427f-6e9c-4aa2-ae5c-8159e1254d2c", value: parseInt(getValueSafe('input-age')) || 0 },
                { id: "343cabc5-9af5-48ca-a54e-f5bffd8c245d", value: sanitizePhoneForClickUp(getValueSafe('input-alt')) },
                { id: "5693724c-ee50-469b-a4a9-3848fe6d3115", value: sanitizePhoneForClickUp(getValueSafe('input-mobile')) },
                { id: "87b4eee7-444f-4ec4-9882-441965757a68", value: sanitizePhoneForClickUp(getValueSafe('input-whatsapp')) },
                { id: "a25c1d42-6191-4fde-8eb4-7f2059fd71e3", value: refId },
                { id: "a60c7069-d4a9-4c17-90ba-9dfa7305e1a1", value: getValUpper('input-linkedin') },
                { id: "03d06003-2084-4906-8514-31b2f862c83d", value: getValUpper('input-marital') },
                { id: "b8798515-8962-40a7-a8cd-2685f9fd676c", value: getValUpper('input-passport-no') },
                { id: "34d446a2-fe50-45bc-8e3b-64660ebdd6f7", value: getValUpper('input-sname') },
                { id: "ae3be10a-cc2d-459e-a80a-1727115b2f0c", value: getValUpper('input-address') },
                { id: "fda5d956-0642-44f3-bbe7-c6c06b27fb2e", value: getValUpper('input-gender') },
                { id: "410dd336-f23f-4893-859f-d04e420f6431", value: getValUpper('input-position') },
                { id: "41c89ec2-4e22-4e85-ae57-de0e614bea88", value: getValUpper('input-location') },
                { id: "dab9b7e7-5f2b-4958-aac8-de76f24e213b", value: getValUpper('input-country') },
                { id: "4402d5e4-93b4-447e-8647-3417abf1a6e2", value: getValUpper('input-nationality') },
                { id: "20cb0f76-df42-4761-96e5-a268855f0eb9", value: getValUpper('input-residence') },
                { id: "a220503d-5a45-4f0b-b83d-6547a28ca0b5", value: getValUpper('input-advisor') } // SAVE ADVISOR
            ];

            const cleanCustomFields = potentialFields.filter(f => 
                f.value !== null && f.value !== "" && !Number.isNaN(f.value) && validFieldIds.has(f.id)
            );

            let taskId = await findTaskByRefId(refId);

            if (taskId) {
                // UPDATE
                await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: taskName, description: description })
                });
                for (const field of cleanCustomFields) {
                    try {
                        await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${field.id}`, {
                            method: 'POST',
                            headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: field.value })
                        });
                    } catch(e) { console.warn(`Failed to update field ${field.id}:`, e); }
                }
            } else {
                // CREATE
                const taskPayload = {
                    name: taskName,
                    description: description,
                    custom_fields: cleanCustomFields
                };
                const createTaskResponse = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task`, {
                    method: 'POST',
                    headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskPayload)
                });

                if (!createTaskResponse.ok) {
                    // Fallback if full payload fails
                    const fallbackResponse = await fetch(`https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task`, {
                        method: 'POST',
                        headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: taskName, description: description })
                    });
                    if(!fallbackResponse.ok) throw new Error("Task Creation Failed");
                    const taskData = await fallbackResponse.json();
                    taskId = taskData.id;
                    // Update fields separately
                    for (const field of cleanCustomFields) {
                        await fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${field.id}`, {
                            method: 'POST',
                            headers: { 'Authorization': CLICKUP_API_KEY, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: field.value })
                        });
                    }
                } else {
                    const taskData = await createTaskResponse.json();
                    taskId = taskData.id;
                }
            }
            return taskId;
        }

        function showSuccessOverlay() {
            const overlay = document.getElementById('success-overlay');
            const overlayCard = overlay.querySelector('div');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                overlayCard.classList.remove('scale-90');
                overlayCard.classList.add('scale-100');
            }, 10);
            setTimeout(() => {
                overlay.classList.add('opacity-0');
                overlayCard.classList.remove('scale-100');
                overlayCard.classList.add('scale-90');
                setTimeout(() => { overlay.classList.add('hidden'); }, 3000);
            }, 3000);
        }
    </script>
</body>
</html>